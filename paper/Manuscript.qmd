---
title: "School closures and consolidations: the active travel and emission implications of reduced accessibility"
bibliography: 
  - "`r system('kpsewhich ../bibliography/bibliography.bib', intern=TRUE)`"
format:
  nature-pdf: 
    journal: "default"
    keep-tex: true
editor: source
execute: 
  freeze: auto
  
author:
  - name: "Anastasia Soukhov"
    email: "soukhoa@mcmaster.ca"
    affiliations:
      - id: 1
        address: "School of Earth, Environment and Society, McMaster University, 1241 Main St. West, Hamilton, ON, L8S 4K1, Canada"
    attributes:
      corresponding: true
  - name: "Christopher D. Higgins"
    email: "cd.higgins@utoronto.ca"
    affiliations:
      - id: 2
        address: "Department of Human Geography, University of Toronto Scarborough, 1265 Military Trail, Toronto, ON, M1C 1A4, Canada"
  - name: "Antonio PÃ¡ez"
    email: "paezha@mcmaster.ca"
    affiliations:
      - id: 1
        address: "School of Earth, Environment and Society, McMaster University, 1241 Main St. West, Hamilton, ON, L8S 4K1, Canada"
  - name: "Moataz Mohamed"
    email: "mmohame@mcmaster.ca"
    affiliations:
      - id: 3
        address: "Department of Civil Engineering, McMaster University, 1241 Main St. West, Hamilton, ON, L8S 4K1, Canada"
abstract: | 
  | Reducing emissions and increasing active travel are top priorities for many communities. Often, though, these priorities are confronted with pressures to reduce the fiscal burden of public services, including schools. Public schools have been strained to do more with less, and governments are opting to close under-capacity schools and expand existing schools to accommodate lost capacity. The objective of this study is to quantify the travel burdens of school consolidation/closure policies. We do this through the case of Hamilton, a mid-sized city in Ontario, Canada. Between the years 2011 and 2015, 7% of the elementary schools closed in the city. We study how these closures changed the accessibility landscape for the elementary school aged population, as well as the active travel and emission implications. In terms of methods, we use spatial availability, a singly-constrained multimodal measure of spatial accessibility. Thanks to its proportional allocation mechanism, spatial availability allows for an interpretable comparison between 'before' and 'after' the implementation of school closure/consolidation policy. Analysis is conducted at the parcel-level with all school seats being eligible and travel behaviour based on observed home-to-school patterns for motorized and non-motorized modes. We report estimates of system-wide impacts that result from the closures, such as potential growth in GHG emission and reduction of walking minutes. Findings demonstrate that overall, spatial availability decreased in the city. Though the school consolidation policy may have resulted in cost-savings in operation and maintenance of facilities, students, families, and communities pay the price in reduced opportunities for physical activity and greater motorized mobility-related pollution.
keywords: [accessibility; spatial availability; carbon emissions; journey-to-school; walkability; active transportation; school consolidation policy; service provision thresholds]
---
<!--NOTE WHEN PREPARING THE .TEX for journal submission I ran into errors as their system uses PDFlatex+Bibtex to compile. The following packages only work in lualatex, so do the following:
- remove "  \usepackage[T1]{fontenc}" 
- remove "\usepackage{fontspec}" 
- add "\DeclareUnicodeCharacter{394}{$\Delta$}" to the tex preamble (this is because PHDtex does not recognize unicode? So need to explicitly define) (add to line 5) -->

```{r knitr-setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  cache = FALSE,
  warning = FALSE,
  message = FALSE,
  comment = '', 
  out.width = "1\\linewidth")
```

```{r, include=FALSE}
rm(list=ls())
```

```{r, include=FALSE}
library(dplyr) # A Grammar of Data Manipulation
library(ggplot2) # Create Elegant Data Visualisations Using the Grammar of Graphics
library(ggspatial) # Spatial Data Framework for ggplot2
library(here) # A Simpler Way to Find Your Files
library(patchwork) # The Composer of Plots
library(scales) # Scale Functions for Visualization
library(sf) # Simple Features for R
library(stplanr) # Sustainable Transport Planning
library(tidyverse) # Easily Install and Load the 'Tidyverse'
library(tmap) # Thematic Maps
library(units) # Measurement Units for R Vectors
library(miscTools) # Miscellaneous Tools and Utilities
library(huxtable)
library(tiff)
library(grid)
```

```{r, include=FALSE}
#lake and bay for mapping purposes
hydro_p_LakeOntario <- st_read(paste0(here::here(),"/data-prep/data-inputs/Boundaries/hydro_p_LakeOntario.shp")) |> st_transform(crs=4326)

ham_bay <- st_read(paste0(here::here(),"/data-prep/data-inputs/Boundaries/Waterbodies.shp")) |> st_transform(crs=4326) |> filter(FEATURE_TY == "Lake")
```

```{r, include=FALSE}
load(file = paste0(here::here(),"/data-prep/data-products/cen_data_2011_hamiltononly.Rdata"))
cen_data_2011_hamiltononly <- cen_data_2011_1 |> filter(Region.Name == "Hamilton") #NOTE: GEOUID 35250242, 35250133, 35250457 do not have any child population
rm("cen_data_2011_1")
load(file=paste0(here::here(),"/data-prep/data-products/cen_data_2016_hamiltononly.Rdata"))
cen_data_2016_hamiltononly <- cen_data_2016_1 |> filter(Region.Name == "Hamilton") #NOTE: GEOUID 35250133, 35250398, 35250427 do not have any child population
rm("cen_data_2016_1")

ham_city_bound <- st_read(paste0(here::here(),"/data-prep/data-inputs/Boundaries/City_Boundary.shp"),
                          quiet = TRUE) |> st_transform(st_crs(cen_data_2016_hamiltononly))
ham_community_bounds <- st_read(paste0(here::here(),"/data-prep/data-inputs/Boundaries/Community_Boundaries.shp"),quiet = TRUE) |> 
  st_transform(st_crs(cen_data_2016_hamiltononly)) |> 
  mutate(COMMUNITY = case_when(COMMUNITY_ == "Ancaster" ~ "AN",
                               COMMUNITY_ == "Dundas" ~ "DU",
                               COMMUNITY_ == "Flamborough" ~ "FL",
                               COMMUNITY_ == "Glanbrook" ~ "GL",
                               COMMUNITY_ == "Hamilton" ~ "HA",
                               COMMUNITY_ == "Stoney Creek" ~ "SC"),
         COMMUNITY_ = ifelse(COMMUNITY_ == "Hamilton", "Hamilton Central", COMMUNITY_)) |> st_transform(st_crs(cen_data_2016_hamiltononly))
```

```{r, include=FALSE}
cen_data_2011_hamiltononly <- 
  cen_data_2011_hamiltononly %>% dplyr::select( #removing the variables we don't need for this analysis
    -c("Shape.Area", "Quality.Flags", "Type", "CD_UID", "NHS.Non.Return.Rate", "CSD_UID", "CT_UID", "CT_UID","NHS.Non.Return.Rate.1", "v_CA11N_2564..Median.after.tax.household.income..", "v_CA11F_17..15.to.19.years")) %>%
  rename( #renaming the variables
    "DA_households" = "Households",
    "DA_dwellings" = "Dwellings",
    "DA_tot_pop" = "Population",
    "DA_med_AT_family_income" = "v_CA11N_2458..Median.after.tax.family.income..",
    "DA_med_AT_lone-family_income" = "v_CA11N_2476..Median.after.tax.family.income..",
    "DA_prev_LIMAT_under18" = "v_CA11N_2609..Less.than.18.years..",
    "DA_pop_5to9" = "v_CA11F_11..5.to.9.years",
    "DA_pop_10to14" = "v_CA11F_14..10.to.14.years") %>%
  mutate(DA_pop_5to14 = DA_pop_5to9+(DA_pop_10to14)) |> #*0.9)) %>%
  dplyr::select(-c("DA_pop_5to9","DA_pop_10to14"))

cen_data_2016_hamiltononly <- 
  cen_data_2016_hamiltononly %>% dplyr::select( #removing the variables we don't need for this analysis
    -c("Shape.Area",  "Type", "CD_UID", "CSD_UID", "CT_UID", "CT_UID", "v_CA16_2398..Median.after.tax.income.of.households.in.2015....", "v_CA16_64..15.to.19.years")) %>%
  rename( #renaming the variables
    "DA_households" = "Households",
    "DA_dwellings" = "Dwellings",
    "DA_tot_pop" = "Population",
    "DA_med_AT_family_income" = "v_CA16_2448..Median.after.tax.income.of.economic.families.in.2015....",
    "DA_med_AT_lone-family_income" = "v_CA16_2460..Median.after.tax.income.of.lone.parent.economic.families.in.2015....",
    "DA_prev_LIMAT_under18" = "v_CA16_2543..0.to.17.years....",
    "DA_pop_5to9" = "v_CA16_25..5.to.9.years",
    "DA_pop_10to14" = "v_CA16_43..10.to.14.years") %>% mutate(DA_pop_5to14 = DA_pop_5to9+(DA_pop_10to14)) |> #*0.9)) %>%
    dplyr::select(-c("DA_pop_5to9","DA_pop_10to14"))
```

```{r, include=FALSE}
library(hamONdests) # A R package of Hamilton, Ontario destinations

data(Schools_2011_2016)
ALL_SCHOOLS_Elem <- Schools_2011_2016 %>% filter(Level == "Elementary")
rm("Schools_2011_2016")

# add community label to schools
ALL_SCHOOLS_Elem <- st_intersection(ham_community_bounds,
                        ALL_SCHOOLS_Elem |> st_transform(st_crs(cen_data_2016_hamiltononly)))

data(School_Catchments_2011_2016)
ALL_SCHOOLS_CATCH_Elem <- School_Catchments_2011_2016 %>% filter(Level == "Elementary")
rm("School_Catchments_2011_2016")

load(file = paste0(here::here(),"/data-prep/data-products/TTS_gamma2011_motor.Rdata"))
load(file = paste0(here::here(),"/data-prep/data-products/TTS_gamma2016_motor.Rdata"))
load(file = paste0(here::here(),"/data-prep/data-products/TTS_exp2011_nonmotor.Rdata"))
load(file = paste0(here::here(),"/data-prep/data-products/TTS_exp2016_nonmotor.Rdata"))
```

```{r}
# # maybe consider using year 2021 as a comparision? 2011 vs 2016 vs 2021?
# SCHOOLS_2023 <- st_read("data-prep/data-inputs/Educational_Institutions-2023/Educational_Institutions.shp") |> filter(CATEGORY == "Elementary School" & (SCHOOL_BOA == "Hamilton-Wentworth Catholic District School Board" | SCHOOL_BOA == "Hamilton-Wentworth District School Board" )) |> st_transform(st_crs(cen_data_2011_hamiltononly))
```

```{r augmenting-catchment, include=FALSE}
ALL_SCHOOLS_CATCH_Elem_extra2011 <- ALL_SCHOOLS_CATCH_Elem |>
  left_join(ALL_SCHOOLS_Elem |> st_drop_geometry() |> group_by(CID2011) |> 
              summarize(OTGC = sum(OTGC2011, na.rm = T)), 
            by = c("CID" = "CID2011")) |> filter(!is.na(OTGC))

ALL_SCHOOLS_CATCH_Elem_extra2016 <- ALL_SCHOOLS_CATCH_Elem |>
  left_join(ALL_SCHOOLS_Elem |> st_drop_geometry() |> group_by(CID2016) |> 
              summarize(OTGC = sum(OTGC2016, na.rm = T)), 
            by = c("CID" = "CID2016")) |> filter(!is.na(OTGC))

ALL_SCHOOLS_CATCH_Elem_extra <- rbind(ALL_SCHOOLS_CATCH_Elem_extra2011, ALL_SCHOOLS_CATCH_Elem_extra2016)
rm(ALL_SCHOOLS_CATCH_Elem_extra2011,ALL_SCHOOLS_CATCH_Elem_extra2016)

#checks
sum(ALL_SCHOOLS_Elem$OTGC2011, na.rm=T) + sum(ALL_SCHOOLS_Elem$OTGC2016, na.rm=T)
ALL_SCHOOLS_CATCH_Elem_extra$OTGC |> sum(na.rm=T)

#reformating schools for mapping
ALL_SCHOOLS_Elem_nochangeorexpanded <- ALL_SCHOOLS_Elem |> filter(Year == "2011 and 2016") |> mutate(Year = ifelse(Year == "2011 and 2016", "2011", Year))
ALL_SCHOOLS_Elem_formapping <- rbind(ALL_SCHOOLS_Elem, ALL_SCHOOLS_Elem_nochangeorexpanded)
rm(ALL_SCHOOLS_Elem_nochangeorexpanded)
ALL_SCHOOLS_Elem_formapping <- ALL_SCHOOLS_Elem_formapping |> mutate(Year = ifelse(Year == "2011 and 2016", "2016", Year))
```

```{r descriptive-catchment-schools-plot, eval=FALSE}
tmap_defaults <-
  tm_scale_bar(position = c("LEFT", "BOTTOM"), breaks = c(0, 5, 10, 15))+
  tm_compass(size = 1.5, position = c("right", 'top')) +
  tm_layout(legend.position = c("left", "top")) #legend.hist.size = 10, 

catchment_schools_plot <-
   tm_shape(ham_bay, bbox=ham_community_bounds) + tm_polygons(col="skyblue", border.alpha = 0) +
  tm_shape(hydro_p_LakeOntario, bbox=ham_community_bounds) + tm_polygons(col="skyblue", border.alpha = 0)+
  tm_shape(ALL_SCHOOLS_CATCH_Elem_extra) +
  tm_polygons(col = "OTGC", border.alpha=0.1, palette = "RdPu",
              labels = c("[181-318)", "[318-406)", "[406-566)","[566-1417]"),
              breaks = c(181, 318, 406, 566, 1417),
              title = "On the ground\ncapacity (OTGC)")+
  tm_facets(by=c("System","Year"))+
  tm_shape(ALL_SCHOOLS_Elem_formapping) +
  tm_symbols(shape = "Status",
             size=0.15,
          title.shape = "School status",
          shapes = c(24,25,21,23,22),
          shapes.labels = c(
          "Expanded after 2011",
          "Moved before 2016",
          "New after 2011",
          "No change btwn 2011-16",
          "Closed before 2016")
  ) +
  tm_facets(by=c("System","Year"))+
  tm_credits(c("52 schools\n(18,771 OTGC)","49 schools\n(18,039 OTGC)",
                "95 schools\n(41,796 OTGC)","88 schools\n(40,249 OTGC)"),
             position = c("LEFT", "BOTTOM")) +
  tmap_defaults +
  tm_layout(bg.color = "grey85",
            panel.labels = list(c('HWDCSB (Catholic Public)','HWDSB (Public)'),
                                c('2011','2016')),
            panel.label.bg.color = "white")
   
catchment_schools_plot
```

```{r descriptive-catchment-schools-plot2, eval=FALSE}
tmap_save(catchment_schools_plot, paste0(here::here(),"/Figures/Fig1.tiff"), height=7, width=12, dpi=600)
```

```{r,include=FALSE}
load(file = paste0(here::here(),"/data-prep/data-products/avail_2011.RData"))
load(file = paste0(here::here(),"/data-prep/data-products/avail_2016.RData"))
```

```{r}
community_car_perc_2011 <- avail_2011 |>
  group_by(COMMUNITY) |> 
  summarize(TAZOrig_car_perc = mean(TAZOrig_car_perc, na.rm=T))

community_car_perc_2016 <- avail_2016 |> group_by(COMMUNITY) |> summarize(TAZOrig_car_perc = mean(TAZOrig_car_perc, na.rm=T))
```

```{r, eval=FALSE}
#check to make sure that V_i is equal to the total capacity in Hamilton. It is!
avail_2011$V_ij %>% sum()
ALL_SCHOOLS_Elem$OTGC2011 %>% sum(na.rm = TRUE)

avail_2016$V_ij %>% sum()
ALL_SCHOOLS_Elem$OTGC2016 %>% sum(na.rm = TRUE)

#this should equal 58,265, still does -- great!
avail_2011 %>%
  group_by(ID) %>%
  summarize(kid_popadj = sum(kid_popadj)) |> dplyr::select(kid_popadj) %>% sum()

#this should equal 58,865, still does -- great!
avail_2016 %>%
  group_by(ID) %>%
  summarize(kid_popadj = sum(kid_popadj)) |> dplyr::select(kid_popadj) %>% sum()
```

```{r}
#calc spatial availability and other associated variables at the DA 2011 level
SAvail_im_DA2011 <- avail_2011 %>%
  group_by(GeoUID, 
           mode) %>%
  summarize(COMMUNITY = first(COMMUNITY),
            total_tt = sum(travel_time_p50*kid_popadj),
            V_im = sum(V_ij),
            kid_popadj_m = sum(kid_popadj),
            DA_pop_5to14 = mean(DA_pop_5to14, na.rm=T),
            DA_prev_LIMAT_under18 = mean(DA_prev_LIMAT_under18),
            .groups = "drop") |>
  mutate(emissions_total_car_tt = ifelse(mode == "c", 0.1*total_tt, 0),
         v_im_kid_popadj = V_im/kid_popadj_m,
         v_im_kid_popadj_LIMAT = v_im_kid_popadj*(DA_prev_LIMAT_under18/100),
         v_im_kid_popadj_LIMAT = ifelse(is.na(v_im_kid_popadj_LIMAT) | is.nan(v_im_kid_popadj_LIMAT), 0, v_im_kid_popadj_LIMAT),
         V_i_kid_popadj_LIMAT = V_im*(DA_prev_LIMAT_under18/100),
         V_i_kid_popadj_LIMAT = ifelse(is.na(V_i_kid_popadj_LIMAT) | is.nan(V_i_kid_popadj_LIMAT), 0, V_i_kid_popadj_LIMAT)) |>
  filter(GeoUID != 35250242 & GeoUID != 35250133 & GeoUID != 35250457 ) #these GeoUID's have 0 kid population, so let's drop so we don't have zeros

#calc spatial availability and other associated variables at the DA 2016 level
SAvail_im_DA2016 <- avail_2016 %>%
  group_by(GeoUID, 
           mode) %>%
  summarize(COMMUNITY = first(COMMUNITY),
            total_tt = sum(travel_time_p50*kid_popadj),
            V_im = sum(V_ij),
            kid_popadj_m = sum(kid_popadj),
            DA_pop_5to14 = mean(DA_pop_5to14, na.rm=T),
            DA_prev_LIMAT_under18 = mean(DA_prev_LIMAT_under18),
            .groups = "drop") |>
  mutate(emissions_total_car_tt = ifelse(mode == "c", 0.1*total_tt, 0),
         v_im_kid_popadj = V_im/kid_popadj_m,
         v_im_kid_popadj = ifelse(is.na(v_im_kid_popadj) | is.nan(v_im_kid_popadj), 0, v_im_kid_popadj),
         v_im_kid_popadj_LIMAT = v_im_kid_popadj*(DA_prev_LIMAT_under18/100),
         v_im_kid_popadj_LIMAT = ifelse(is.na(v_im_kid_popadj_LIMAT) | is.nan(v_im_kid_popadj_LIMAT), 0, v_im_kid_popadj_LIMAT),
         V_i_kid_popadj_LIMAT = V_im*(DA_prev_LIMAT_under18/100),
         V_i_kid_popadj_LIMAT = ifelse(is.na(V_i_kid_popadj_LIMAT) | is.nan(V_i_kid_popadj_LIMAT), 0, V_i_kid_popadj_LIMAT)) |>
  filter(GeoUID != 35250398 & GeoUID != 35250133 & GeoUID != 35250427 ) #these GeoUID's have 0 kid population, so let's drop so we don't have zeros

#add the geometries -- census DAs
SAvail_im_DA2011 <- SAvail_im_DA2011 |>
  left_join(cen_data_2011_hamiltononly |> filter(Region.Name == "Hamilton") |> dplyr::select(GeoUID), by="GeoUID") |> st_set_geometry("geometry")

SAvail_im_DA2016 <- SAvail_im_DA2016 |>
  left_join(cen_data_2016_hamiltononly |> filter(Region.Name == "Hamilton") |> dplyr::select(GeoUID), by="GeoUID") |> st_set_geometry("geometry")

#Create 1 sf with data joined (no changes, just 2011 and 2016)
SAvail_im_DA <-
  rbind(SAvail_im_DA2011 |> mutate(year ="2011"),
        SAvail_im_DA2016 |> mutate(year ="2016")) |>
  mutate(mode = case_when(mode == "c" ~ "motorized",
                          mode == "w" ~ "non-motorized"))
```

```{r}
#calc changes between the years - but at the 2016 DA level 
SAvail_im_DA2011_forGeoUID2016 <- avail_2011 %>%
  group_by(GeoUID_2016, 
           mode) %>%
  summarize(COMMUNITY = first(COMMUNITY),
            total_tt = sum(travel_time_p50*kid_popadj),
            V_im = sum(V_ij),
            kid_popadj_m = sum(kid_popadj),
            DA_pop_5to14 = mean(DA_pop_5to14, na.rm=T),
            DA_prev_LIMAT_under18 = mean(DA_prev_LIMAT_under18),
            .groups = "drop") |>
  mutate(emissions_total_car_tt = ifelse(mode == "c", 0.1*total_tt, 0),
         v_im_kid_popadj = V_im/kid_popadj_m,
         v_im_kid_popadj = ifelse(is.na(v_im_kid_popadj) | is.nan(v_im_kid_popadj), 0, v_im_kid_popadj),
         v_im_kid_popadj_LIMAT = v_im_kid_popadj*(DA_prev_LIMAT_under18/100),
         v_im_kid_popadj_LIMAT = ifelse(is.na(v_im_kid_popadj_LIMAT) | is.nan(v_im_kid_popadj_LIMAT), 0, v_im_kid_popadj_LIMAT),
         V_i_kid_popadj_LIMAT = V_im*(DA_prev_LIMAT_under18/100),
         V_i_kid_popadj_LIMAT = ifelse(is.na(V_i_kid_popadj_LIMAT) | is.nan(V_i_kid_popadj_LIMAT), 0, V_i_kid_popadj_LIMAT))


SAvail_im_DA_changes <- full_join(SAvail_im_DA2011_forGeoUID2016,
                                  SAvail_im_DA2016, by=c("GeoUID_2016"="GeoUID", 
                                                         "mode")) %>%
  transmute(GeoUID_2016,
            mode = case_when(mode == "c" ~ "motorized",
                             mode == "w" ~ "non-motorized"),
            COMMUNITY = dplyr::coalesce(COMMUNITY.x, COMMUNITY.y),
            c_total_tt = total_tt.y - total_tt.x, #2016 minus 2011 tt
            c_total_tt = ifelse(is.na(c_total_tt), -total_tt.x, c_total_tt),
            c_total_ttperkid = (total_tt.y/kid_popadj_m.y) - (total_tt.x/kid_popadj_m.x),
            c_total_ttperkid = ifelse(is.na(c_total_ttperkid), -(total_tt.x/kid_popadj_m.x), c_total_ttperkid),
            c_V_im = V_im.y -V_im.x,
            c_V_im = ifelse(is.na(c_V_im), -V_im.x,c_V_im),
            c_V_im_perc = (V_im.y -V_im.x)/V_im.x,
            c_kid_popadj_m = kid_popadj_m.y - kid_popadj_m.x,
            c_DA_pop_5to14 = DA_pop_5to14.y - DA_pop_5to14.x,
            c_DA_prev_LIMAT_under18 = DA_prev_LIMAT_under18.y - DA_prev_LIMAT_under18.x,
            emissions_total_car_tt_2016 = emissions_total_car_tt.y,
            emissions_total_car_tt_2011 = emissions_total_car_tt.x,
            c_emissions_total_car_tt = emissions_total_car_tt.y - emissions_total_car_tt.x,
            c_emissions_total_car_tt = ifelse(is.na(c_emissions_total_car_tt), -emissions_total_car_tt.x, c_emissions_total_car_tt),
            emissions_perkid_2011 = emissions_total_car_tt.x/kid_popadj_m.x,
            emissions_perkid_2016 = emissions_total_car_tt.y/kid_popadj_m.y,
            c_emissions_perkid = ((emissions_perkid_2016 - emissions_perkid_2011)/
                                      emissions_perkid_2011),
            c_emissions_perkid = ifelse(is.na(emissions_perkid_2016), -emissions_perkid_2011, c_emissions_perkid),
            c_v_im_kid_popadj = v_im_kid_popadj.y - v_im_kid_popadj.x,
            c_v_im_kid_popadj = ifelse(is.na(c_v_im_kid_popadj), -v_im_kid_popadj.x, c_v_im_kid_popadj),
            c_v_im_kid_popadj_perc = (v_im_kid_popadj.y - v_im_kid_popadj.x)/v_im_kid_popadj.x,
            c_v_im_kid_popadj_LIMAT = v_im_kid_popadj_LIMAT.y - v_im_kid_popadj_LIMAT.x,
            c_V_i_kid_popadj_LIMAT = V_i_kid_popadj_LIMAT.y - V_i_kid_popadj_LIMAT.x) |>
  left_join(cen_data_2016_hamiltononly|>dplyr::select(c("GeoUID")), 
            by=c("GeoUID_2016" = "GeoUID")) %>% st_as_sf

```

```{r}
#repeat but for all 1 mode
SAvail_i_DA2011 <- avail_2011 %>%
  group_by(GeoUID) %>%
  summarize(COMMUNITY = first(COMMUNITY),
            total_tt = sum(travel_time_p50*kid_popadj, na.rm = T),
            V_i = sum(V_ij, na.rm = T),
            DA_pop_5to14 = mean(DA_pop_5to14, na.rm=T),
            kid_pop_DAavg = mean(kid_pop, na.rm = T),
            DA_prev_LIMAT_under18 = mean(DA_prev_LIMAT_under18, na.rm = T),
            .groups = "drop") |>
  filter(GeoUID != 35250242 & GeoUID != 35250133 & GeoUID != 35250457 ) #these GeoUID's have 0 kid population, so let's drop so we don't have zeros
SAvail_i_DA2016 <- avail_2016 %>%
  group_by(GeoUID) %>%
  summarize(COMMUNITY = first(COMMUNITY),
            total_tt = sum(travel_time_p50*kid_popadj),
            V_i = sum(V_ij, na.rm = T),
            DA_pop_5to14 = mean(DA_pop_5to14, na.rm=T),
            kid_pop_DAavg = mean(kid_pop, na.rm = T),
            DA_prev_LIMAT_under18 = mean(DA_prev_LIMAT_under18, na.rm = T),
            .groups = "drop") |>
  filter(GeoUID != 35250398 & GeoUID != 35250133 & GeoUID != 35250427 ) #these GeoUID's have 0 kid population, so let's drop so we don't have zeros
#add the geometries -- census DAs
SAvail_i_DA2011 <- SAvail_i_DA2011 |>
  left_join(cen_data_2011_hamiltononly |> filter(Region.Name == "Hamilton") |> dplyr::select(GeoUID), by="GeoUID") |> mutate(Year = "2011") |> st_set_geometry("geometry")
SAvail_i_DA2016 <- SAvail_i_DA2016 |>
  left_join(cen_data_2016_hamiltononly |> filter(Region.Name == "Hamilton") |> dplyr::select(GeoUID), by="GeoUID") |> mutate(Year = "2016") |> st_set_geometry("geometry")
#join them together!
SAvail_i_DA_extra <- rbind(SAvail_i_DA2011, SAvail_i_DA2016)
rm(SAvail_i_DA2011,SAvail_i_DA2016)
```

```{r}
#calc changes between the years - but between communities with geom for mapping
SAvail_im_COMM2011 <- avail_2011 %>%
  group_by(COMMUNITY, 
           mode) %>%
  summarize(total_tt = sum(travel_time_p50*kid_popadj),
            V_im = sum(V_ij),
            kid_popadj_m = sum(kid_popadj),
            .groups = "drop") |>
  mutate(emissions_total_car_tt = ifelse(mode == "c", 0.1*total_tt, 0),
         v_im_kid_popadj = V_im/kid_popadj_m) 

SAvail_im_COMM2016 <- avail_2016 %>%
  group_by(COMMUNITY, 
           mode) %>%
  summarize(total_tt = sum(travel_time_p50*kid_popadj),
            V_im = sum(V_ij),
            kid_popadj_m = sum(kid_popadj),
            .groups = "drop") |>
  mutate(emissions_total_car_tt = ifelse(mode == "c", 0.1*total_tt, 0),
         v_im_kid_popadj = V_im/kid_popadj_m,
         v_im_kid_popadj = ifelse(is.na(v_im_kid_popadj) | is.nan(v_im_kid_popadj), 0, v_im_kid_popadj)) 

#add the geometries -- census DAs
SAvail_im_COMM2011 <- SAvail_im_COMM2011 |>
  left_join(ham_community_bounds |> dplyr::select(c("COMMUNITY_","COMMUNITY")), by=c("COMMUNITY"))|> st_set_geometry("geometry")

SAvail_im_COMM2016 <- SAvail_im_COMM2016 |>
  left_join(ham_community_bounds |> dplyr::select(c("COMMUNITY_","COMMUNITY")), by=c("COMMUNITY"))|> st_set_geometry("geometry")


#calc changes between the years - make that 1 sf
SAvail_im_COMM_changes <- full_join(SAvail_im_COMM2011|>st_drop_geometry(),
                                  SAvail_im_COMM2016, by=c("COMMUNITY", "mode")) |>
  transmute(COMMUNITY,
            mode = case_when(mode == "c" ~ "motorized",
                             mode == "w" ~ "non-motorized"),
            c_total_tt = total_tt.y - total_tt.x, #2016 minus 2011 tt
            c_total_ttperkid = (total_tt.y/kid_popadj_m.y) - (total_tt.x/kid_popadj_m.x),
            c_V_im = V_im.y -V_im.x,
            c_V_im_perc = (V_im.y -V_im.x)/V_im.x,
            c_kid_popadj_m = kid_popadj_m.y - kid_popadj_m.x,
            c_emissions_total_car_tt = emissions_total_car_tt.y - emissions_total_car_tt.x,
            c_v_im_kid_popadj = v_im_kid_popadj.y - v_im_kid_popadj.x,
            c_v_im_kid_popadj_perc = (v_im_kid_popadj.y - v_im_kid_popadj.x)/v_im_kid_popadj.x,
            geometry,
            kid_2011 = kid_popadj_m.x,
            kid_2016 = kid_popadj_m.y,
            c_kid_perc = ((kid_popadj_m.y - kid_popadj_m.x)/kid_popadj_m.x) |> scales::percent(accuracy = 2L),
            kid_proportion_2011 = (kid_2011/sum(kid_2011)),
            kid_proportion_2016 = (kid_2016/sum(kid_2016)),
            c_kid_proportion_perc = ((kid_proportion_2016 - kid_proportion_2011)/kid_proportion_2011)
            %>% scales::percent(accuracy = 2L),
            # kid_proportion_2011_perc = (kid_proportion_2011) |> scales::percent(accuracy = 2L),
            # kid_proportion_2016_perc = (kid_proportion_2016) |> scales::percent(accuracy = 2L),
            V_im_2011 = V_im.x,
            V_im_2016 = V_im.y,
            c_V_im_perc = ((V_im.y -V_im.x)/V_im.x) |> scales::percent(accuracy = 2L),
            V_im_proportion_2011 = (V_im.x/sum(V_im.x)),
            V_im_proportion_2016 = (V_im.y/sum(V_im.y)),
            c_V_im_proportion_perc = ((V_im_proportion_2016 -V_im_proportion_2011)/V_im_proportion_2011) %>% scales::percent(accuracy = 2L),
            # V_im_proportion_2011_perc = (V_im_proportion_2011) |> scales::percent(accuracy = 2L),
            # V_im_proportion_2016_perc = (V_im_proportion_2016) |> scales::percent(accuracy = 2L),
            v_im_2011 = v_im_kid_popadj.x,
            v_im_2016 = v_im_kid_popadj.y,
            c_v_im_perc = ((v_im_kid_popadj.y - v_im_kid_popadj.x)/v_im_kid_popadj.x) |> scales::percent(accuracy = 2L),
            total_tt_2011 = total_tt.x,
            total_tt_2016 = total_tt.y,
            # total_tt_proportion_2011 = (total_tt.x/sum(total_tt.x)),
            # total_tt_proportion_2016 = (total_tt.y/sum(total_tt.y)),
            # c_total_tt_proportion_perc = ((total_tt_proportion_2016 - total_tt_proportion_2011)/total_tt_proportion_2011)
            # %>% scales::percent(accuracy = 2L),
            # total_tt_proportion_2011 = (total_tt_proportion_2011) |> scales::percent(accuracy = 2L),
            # total_tt_proportion_2016 = (total_tt_proportion_2016) |> scales::percent(accuracy = 2L),
            c_total_tt_perc = ((total_tt.y - total_tt.x)/
                                  total_tt.x)|> scales::percent(accuracy = 2L),
            total_tt_perkid_2011 = total_tt.x/kid_2011,
            total_tt_perkid_2016 = total_tt.y/kid_2016,
            c_total_ttperkid_perc = ((total_tt_perkid_2016 - total_tt_perkid_2011)/
                                       total_tt_perkid_2011)|> scales::percent(accuracy = 2L),
            emissions_2011 = emissions_total_car_tt.x,
            emissions_2016 = emissions_total_car_tt.y,
            c_emissions_perc = ((emissions_total_car_tt.y - emissions_total_car_tt.x)/emissions_total_car_tt.x)|> scales::percent(accuracy = 2L),
            # emissions_proportion_2011 = (emissions_2011/sum(emissions_2011)),
            # emissions_proportion_2016 = (emissions_2016/sum(emissions_2016)),
            # c_emissions_proportion = ((emissions_proportion_2016 - emissions_proportion_2011)/emissions_proportion_2011)
            # %>% scales::percent(accuracy = 2L),
            # emissions_proportion_2011_perc = (emissions_proportion_2011) |> scales::percent(accuracy = 2L),
            # emissions_proportion_2016_perc = (emissions_proportion_2016) |> scales::percent(accuracy = 2L),
            emissions_perkid_2011 = emissions_total_car_tt.x/kid_popadj_m.x,
            emissions_perkid_2016 = emissions_total_car_tt.y/kid_popadj_m.y,
            c_emissions_perkid_perc = ((emissions_perkid_2016 - emissions_perkid_2011)/
                                      emissions_perkid_2011)|> scales::percent(accuracy = 2L)
            ) |> mutate_if(is.numeric, round, 1) |> st_as_sf()
```

```{r student-popabs-lowincperc-poprate-plot, eval=FALSE}
tmap_defaults <-
  tm_scale_bar(position = c("LEFT", "BOTTOM"), breaks = c(0, 5, 10, 15))+
  tm_compass(size = 1.5, position = c("right", 'top')) +
  tm_layout(legend.position = c("left", "top")) #legend.hist.size = 10, 

student_pop_absolute_plot <-
    tm_shape(ham_bay, bbox=ham_community_bounds) + tm_polygons(col="skyblue", border.alpha = 0) +
  tm_shape(hydro_p_LakeOntario, bbox=ham_community_bounds) + tm_polygons(col="skyblue", border.alpha = 0)+
  tm_shape(SAvail_i_DA_extra |> mutate(extra_col_for_panel = "HAMILTON")) +
  tm_polygons(col = "DA_pop_5to14", border.alpha=0, 
              palette = "Greens",
              labels = c("[0-40)", "[40-50)", "[50-75)","[75-835]"),
              breaks = c(0, 40, 50, 75, 835),
              title = "Pop. aged 5 to 14"
  )+
  tm_facets(by=c("Year"), ncol=2, nrow=1)+
    tm_credits(c("City total: 58,265","City total: 58,865"),
             position = c("LEFT", "BOTTOM")) +
  tmap_defaults +
  tm_layout(bg.color = "grey85",
            panel.label.bg.color = "white",
            panel.label.height = 0.8)


student_pop_rate_plot <-
  tm_shape(ham_bay, bbox=ham_community_bounds) + tm_polygons(col="skyblue", border.alpha = 0) +
  tm_shape(hydro_p_LakeOntario, bbox=ham_community_bounds) + tm_polygons(col="skyblue", border.alpha = 0)+
  tm_shape(SAvail_i_DA_extra) +
  tm_polygons(col = "kid_pop_DAavg", border.alpha=0, 
              palette = "Blues",
              labels = c("[0-0.0018)", "[0.0018-0.0025)", "[0.0025-0.0038)","[0.0038-0.59]"),
              breaks = c(0, 0.0018, 0.0025, 0.0038, 0.60),
              title = "Avg. pop. aged 5 to 14\nper residential unit"
  )+
  tm_facets(by=c("Year"), ncol=2, nrow=1)+
  
  tmap_defaults +
  tm_layout(bg.color = "grey85",
            panel.show=FALSE)

LIMAT_under18_DA_plot <-
  tm_shape(ham_bay, bbox=ham_community_bounds) + tm_polygons(col="skyblue", border.alpha = 0) +
  tm_shape(hydro_p_LakeOntario, bbox=ham_community_bounds) + tm_polygons(col="skyblue", border.alpha = 0)+
  tm_shape(SAvail_i_DA_extra) +
  tm_polygons(col = "DA_prev_LIMAT_under18", border.alpha=0, 
              palette = "Reds",
              labels = c("[0-4.3)", "[4.3-13.0)", "[13.0-30.8)","[30.8-100)"),
              breaks = c(0, 4.30, 13.00, 30.8, 150),
              colorNA = "black",
              textNA = "Unavailable",
              title = "Prop. of LIM-AT households\n with dependents < 18"
  )+
  tm_facets(by=c("Year"), ncol=2, nrow=1)+
  tmap_defaults  +
  tm_layout(bg.color = "grey85",
            panel.show=FALSE)

stud_pop_rate_LIM_plot <- tmap_arrange(student_pop_absolute_plot, student_pop_rate_plot, LIMAT_under18_DA_plot, nrow = 3)

stud_pop_rate_LIM_plot
```

```{r student-popabs-lowincperc-poprate-plot2, eval=FALSE}
tmap_save(stud_pop_rate_LIM_plot, paste0(here::here(),"/Figures/Fig2.tiff"), height=10, width=12, dpi=500)
```

```{r importing-taz-and-associated-flows, include=FALSE}
#reading boundaries of TAZs and PDs from the TTS2016R package (same TAZ for both 2011 and 2016)
library(TTS2016R) # A R package of the 2016 TTS
data(ggh_taz)
data(ggh_pd)

ham_taz <- ggh_taz %>% dplyr::filter(REGION==6) #Filter out everything other than Planning District 6 = Hamilton
```

```{r include=FALSE}
#the tts origin-destination trips, by mode
load(file = paste0(here::here(),"/data-prep/data-inputs/TTS/od_trips_perc_2011.Rdata"))
load(file = paste0(here::here(),"/data-prep/data-inputs/TTS/od_trips_perc_2016.Rdata"))

ham_taz_centroids <- ham_taz |> st_centroid() |> dplyr::select(GTA06)

od_trips_perc_car <- rbind(
  rbind(od_trips_perc_2011 |> group_by(Origin) |> 
          summarize(TAZOrig_car_perc = 
                      sum(TAZOrig_car_trips, na.rm = T)/sum(TAZOrig_walk_trips+TAZOrig_car_trips, na.rm = T)) |>
          mutate(year = "2011")),
  od_trips_perc_2016 |> group_by(Origin) |> 
    summarize(TAZOrig_car_perc = 
                sum(TAZOrig_car_trips, na.rm = T)/sum(TAZOrig_walk_trips+TAZOrig_car_trips, na.rm = T)) |>
    mutate(year = "2016"))

od_trips_perc_car <- left_join(ham_taz,od_trips_perc_car, by=c("GTA06"="Origin"))

od_trips_perc_walk <- rbind(
  rbind(od_trips_perc_2011 |> group_by(Origin) |> 
          summarize(TAZOrig_walk_perc = 
                      sum(TAZOrig_walk_trips)/sum(TAZOrig_walk_trips+TAZOrig_car_trips)) |>
          mutate(year = "2011")),
  od_trips_perc_2016 |> group_by(Origin) |> 
    summarize(TAZOrig_walk_perc = 
                sum(TAZOrig_walk_trips)/sum(TAZOrig_walk_trips+TAZOrig_car_trips)) |>
    mutate(year = "2016"))

od_trips_perc_walk <- left_join(ham_taz, od_trips_perc_walk, by=c("GTA06"="Origin"))

desire_lines_ham_2011 <- od2line(od_trips_perc_2011, ham_taz_centroids)
desire_lines_ham_2011 <- desire_lines_ham_2011 |> mutate(all = TAZOrig_car_trips + TAZOrig_walk_trips,
                                                         Year = "2011")

desire_lines_ham_2016 <- od2line(od_trips_perc_2016, ham_taz_centroids)
desire_lines_ham_2016 <- desire_lines_ham_2016 |> mutate(all = TAZOrig_car_trips + TAZOrig_walk_trips,
                                                         Year = "2016")

desire_lines_ham <- rbind(desire_lines_ham_2011, desire_lines_ham_2016)
rm(desire_lines_ham_2011, desire_lines_ham_2016)
```

```{r ploting-od-taz-flows, eval=FALSE}
tmap_defaults <-
  tm_scale_bar(position = c("LEFT", "BOTTOM"), breaks = c(0, 5, 10, 15))+
  tm_compass(size = 1.5, position = c("right", 'top')) +
  tm_layout(legend.position = c("left", "top")) #legend.hist.size = 10, 

car_OD_flow_plot <-  
    tm_shape(ham_bay, bbox=ham_community_bounds) + tm_polygons(col="skyblue", border.alpha = 0) +
  tm_shape(hydro_p_LakeOntario, bbox=ham_community_bounds) + tm_polygons(col="skyblue", border.alpha = 0)+
  tm_shape(od_trips_perc_car |> mutate(mode = "motorized"), bbox=SAvail_i_DA_extra) +
  tm_polygons(col = "TAZOrig_car_perc", border.alpha = 0.4, border.col = "grey20", lwd=0.2,
              palette = "Greys",
              breaks = c(0, .25, .50, .75, 1),
              title = "Proportion of mode use",
              textNA = "Unavailable",
              colorNA = "black")+
  #tm_shape(SAvail_i_DA_extra) + tm_borders(alpha = 0.4, col = "grey20", lwd=0.2)+
  tm_shape(ham_taz) + tm_borders(alpha=0.4, col = "grey40", lwd=0.2) +
  tm_shape(ham_community_bounds %>% st_cast("MULTILINESTRING")) + 
  tm_lines(col = "COMMUNITY_", 
           palette = c("#365C8DFF", "#277F8EFF", "#1FA187FF", "#4AC16DFF", "#9FDA3AFF", "#FDE725FF"),
           title.col = "Hamilton communities", lwd = 1.5) + 
  tm_shape(ham_taz_centroids) + tm_dots(alpha=0.5, col="darkblue", size=0.01) +
  tm_shape(desire_lines_ham |> mutate(mode = "motorized")) +
  tm_lines(palette = "Reds", breaks = c(6, 22, 26, 52, 353),
           title.col = "Number of trips",
           col = "TAZOrig_car_trips",
           alpha = 0.9,
           scale = 3,
           lwd = "all",
           legend.lwd.show = FALSE) +
  tm_facets(by = c("mode","Year"), nrow=1)+
  tmap_defaults +
  tm_layout(bg.color = "grey85",
            panel.label.bg.color = "white",
            panel.label.height = 0.8)


walk_OD_flow <- tm_shape(ham_bay, bbox=ham_community_bounds) + tm_polygons(col="skyblue", border.alpha = 0) +
  tm_shape(hydro_p_LakeOntario, bbox=ham_community_bounds) + tm_polygons(col="skyblue", border.alpha = 0)+
  tm_shape(od_trips_perc_walk |> mutate(mode = "non-motorized"), bbox=SAvail_i_DA_extra) +
  tm_polygons(col = "TAZOrig_walk_perc", border.alpha = 0.4, border.col = "grey20", lwd=0.2,
              palette = "Greys",
              breaks = c(0, .25, .50, .75, 1),
              title = "Proportion of mode use",
              textNA = "Unavailable",
              colorNA = "black",
              legend.show=FALSE)+
  #tm_shape(SAvail_i_DA_extra) + tm_borders(alpha = 0.4, col = "cornflowerblue", lwd=0.2)+
  tm_shape(ham_taz) + tm_borders(alpha=0.4, col = "grey40", lwd=0.2) +
  tm_shape(ham_community_bounds %>% st_cast("MULTILINESTRING")) + 
  tm_lines(col = "COMMUNITY_", 
           palette = c("#365C8DFF", "#277F8EFF", "#1FA187FF", "#4AC16DFF", "#9FDA3AFF", "#FDE725FF"),
           title.col = "Hamilton communities", lwd = 1.5, legend.col.show=FALSE) + 
  tm_shape(ham_taz_centroids) + tm_dots(alpha=0.5, col="darkblue", size=0.01) +
  tm_shape(desire_lines_ham |> filter(TAZOrig_walk_trips >= 1) 
           |> mutate(mode = "non-motorized")) +
  tm_lines(palette = "Reds", breaks = c(6, 22, 26, 52, 353),
           title.col = "Number of trips (non-motorized)",
           col = "TAZOrig_walk_trips",
           alpha = 0.9,
           scale = 4,
           lwd = "all",
           legend.col.show = FALSE,
           legend.lwd.show = FALSE) +
  tm_facets(by = c("mode","Year"), nrow=1)+
  tmap_defaults +
  tm_layout(bg.color = "grey85",
            panel.label.bg.color = "white",
            panel.label.height = c(0.8,0,0)) +
  tm_add_legend(type = "line", 
                col = c("grey40","lightblue"),
                labels = c("TAZ boundary","Community boundary"))+
  tm_add_legend(type = "symbol",
                col = "darkblue",
                labels = "TAZ centroid")

OD_flow_plot <- tmap_arrange(car_OD_flow_plot, walk_OD_flow, nrow = 2)
OD_flow_plot 

tmap_save(OD_flow_plot, paste0(here::here(),"/Figures/Fig3.tiff"), height=7, width=12, dpi=600)
```

```{r quartiles-of-tts-estimated-tt}
od_trips_perc_tt <- data.frame(x=c(gamma2011_motor$data, exp2011_nonmotor$data,
                                   gamma2016_motor$data, exp2016_nonmotor$data),
                               mode = c(rep("motorized", length(gamma2011_motor$data)),
                                        rep("non-motorized", length(exp2011_nonmotor$data)),
                                        rep("motorized", length(gamma2016_motor$data)),
                                        rep("non-motorized", length(exp2016_nonmotor$data))),
                               year = c(rep("2011", length(gamma2011_motor$data)),
                                        rep("2011", length(exp2011_nonmotor$data)),
                                        rep("2016", length(gamma2016_motor$data)),
                                        rep("2016", length(exp2016_nonmotor$data)))
)


q_motorized_2011 <- stats::quantile(od_trips_perc_tt |>
                                      filter(mode == "motorized", year == "2011") |>
                                      pull(x),
                                    probs = c(0.25, 0.5, 0.75), na.rm=T)

q_nonmotorized_2011 <- stats::quantile(od_trips_perc_tt  |>
                                         filter(mode == "non-motorized",
                                                year == "2011") |> 
                                         pull(x),
                                       probs = c(0.25, 0.5, 0.75), na.rm=T)

q_motorized_2016 <- stats::quantile(od_trips_perc_tt  |>
                                      filter(mode == "motorized",
                                             year == "2016") |>
                                      pull(x),
                                    probs = c(0.25, 0.5, 0.75), na.rm=T)

q_nonmotorized_2016 <- stats::quantile(od_trips_perc_tt |> 
                                         filter(mode == "non-motorized",
                                                year == "2016") |>
                                         pull(x),
                                       probs = c(0.25, 0.5, 0.75), na.rm=T)


q_1 <- data.frame(
  label = paste0("Q1:\n", c(q_motorized_2011[1], q_nonmotorized_2011[1]|> round(),
                            q_motorized_2016[1], q_nonmotorized_2016[1]|> round())),
  mode   = c("motorized", "non-motorized", "motorized", "non-motorized"),
  year = c("2011", "2011", "2016", "2016"),
  x     = c(q_motorized_2011[1], q_nonmotorized_2011[1] |> round(),
            q_motorized_2016[1], q_nonmotorized_2016[1]|> round()),
  y     = c(0.11, 0.11, 0.11, 0.11)
)

q_2 <- data.frame(
  label = paste0("Q2:\n", c(q_motorized_2011[2], q_nonmotorized_2011[2]|> round(),
                            q_motorized_2016[2], q_nonmotorized_2016[2]|> round())),
  mode   = c("motorized", "non-motorized", "motorized", "non-motorized"),
  year = c("2011", "2011", "2016", "2016"),
  x     = c(q_motorized_2011[2], q_nonmotorized_2011[2] |> round(),
            q_motorized_2016[2], q_nonmotorized_2016[2]|> round()),
  y     = c(0.11, 0.11, 0.11, 0.11)
)

q_3 <- data.frame(
  label = paste0("Q3:\n", c(q_motorized_2011[3], q_nonmotorized_2011[3]|> round(),
                            q_motorized_2016[3], q_nonmotorized_2016[3]|> round())),
  mode   = c("motorized", "non-motorized", "motorized", "non-motorized"),
  year = c("2011", "2011", "2016", "2016"),
  x     = c(q_motorized_2011[3], q_nonmotorized_2011[3] |> round(),
            q_motorized_2016[3], q_nonmotorized_2016[3]|> round()),
  y     = c(0.11, 0.11, 0.11, 0.11)
)
```

```{r tts-theoretical-curve-creation}
x <- data.frame(t = seq(0, 45, 0.1))
X_shorter <-data.frame(t = seq(0, 27, 0.1))

x_motorized_2011 <- x %>%
  mutate(f = dgamma(t,
                    gamma2011_motor$estimate[1],
                    gamma2011_motor$estimate[2]),
         mode = "motorized",
         year = "2011")

x_nonmotorized_2011 <- X_shorter %>%
  mutate(f = dexp(t,
                  exp2011_nonmotor$estimate[1]),
         mode = "non-motorized",
         year = "2011")

x_motorized_2016 <- x %>%
  mutate(f = dgamma(t,
                    gamma2016_motor$estimate[1],
                    gamma2016_motor$estimate[2]),
         mode = "motorized",
         year = "2016")

x_nonmotorized_2016 <- X_shorter %>%
  mutate(f = dexp(t,
                  exp2016_nonmotor$estimate[1]),
         mode = "non-motorized",
         year = "2016")

tld_theoretical <- rbind(x_motorized_2011,
                         x_nonmotorized_2011,
                         x_motorized_2016,
                         x_nonmotorized_2016) %>%
  mutate(mode = factor(mode, levels = c("motorized", "non-motorized")),
         year = factor(year, levels = c("2011", "2016")))
```

```{r ploting-empirical-and-theo-curve-TLD-tts, eval=FALSE}
TLD_empirical_wtheo_curve_plot <- ggplot() + 
  geom_histogram(data = od_trips_perc_tt,
                 aes(x = x, 
                     y = ..density..),
                 colour = "grey70",
                 fill = "grey70",
                 boundary = 0,
                 binwidth = 3) +
  geom_vline(data = q_1, mapping = aes(xintercept = x), colour = "grey60") +
  geom_vline(data = q_2, mapping = aes(xintercept = x), colour = "grey60") +
  geom_vline(data = q_3, mapping = aes(xintercept = x), colour = "grey60") +
  geom_line(data = tld_theoretical, aes(x = t, y = f), colour = "blue", size=0.8, alpha=0.6) + 
  xlab("Estimated travel time associated with TTS OD flows (minutes)") +
  ylab("Density") +
  scale_x_continuous(breaks = seq(0,45,10), expand=c(0,0))+
  scale_y_continuous(breaks = seq(0,0.12,0.04), limits = c(0,0.12))+
  facet_grid(~mode~year)+
  geom_text(data = q_1, 
            mapping = aes(x = x, y = y, label = label), colour = "grey20", size=4) +
  geom_text(data = q_2,
            mapping = aes(x = x, y = y, label = label), colour = "grey20", size=4) +
  geom_text(data = q_3,
            mapping = aes(x = x, y = y, label = label), colour = "grey20", size=4) +
  theme_classic() +
  theme(axis.title = element_text(size = 11),
        panel.border = element_rect(colour = "grey80", fill=NA),
        strip.text = element_text(size=11))
TLD_empirical_wtheo_curve_plot
ggsave(paste0(here::here(),"/Figures/Fig4.tiff"), height=7, width=10, dpi=600)
```
```{r}
ALL_SCHOOLS_Elem_formapping2 <- ALL_SCHOOLS_Elem_formapping |> mutate(Mode = "motorized")
ALL_SCHOOLS_Elem_formapping3 <- ALL_SCHOOLS_Elem_formapping |> mutate(Mode = "non-motorized")
ALL_SCHOOLS_Elem_formapping2 <- rbind(ALL_SCHOOLS_Elem_formapping2, ALL_SCHOOLS_Elem_formapping3)
rm(ALL_SCHOOLS_Elem_formapping3)
```

```{r, eval=FALSE}
Vim_20112016_plot <-  
  tm_shape(ham_bay, bbox=ham_community_bounds) + tm_polygons(col="skyblue", border.alpha = 0) +
  tm_shape(hydro_p_LakeOntario, bbox=ham_community_bounds) + tm_polygons(col="skyblue", border.alpha = 0)+
  tm_shape(SAvail_im_DA, bbox=SAvail_im_DA) +
  tm_polygons(col = "V_im", border.alpha = 0, border.col = "grey20", lwd=0.2,
              palette = "Purples",
              style="quantile", n=4,
              labels = c("[0-0.2)", "[0.2-12.8)", "[12.8-56.4)", "[56.4-672.9)"),
              title = expression(V[i]^m),
              textNULL = "Unavailable",
              colorNULL = "black")+
  tm_facets(by = c("mode","year"), nrow=1)+
  tm_shape(ham_community_bounds %>% st_cast("MULTILINESTRING")) + 
  tm_lines(col = "COMMUNITY_", 
           palette = c("#365C8DFF", "#277F8EFF", "#1FA187FF", "#4AC16DFF", "#9FDA3AFF", "#FDE725FF"),
           title.col = "Hamilton communities", lwd = 2, legend.col.show = FALSE) + 
  tm_shape(ALL_SCHOOLS_Elem_formapping2) +
  tm_symbols(shape = "Status",
             size=0.1,
             alpha=0.5,
          title.shape = "School status",
          shapes = c(24,25,22,21,23),
          shapes.labels = c(
          "Expanded after 2011",
          "Moved before 2016",
          "New after 2011",
          "No change btwn 2011-16",
          "Closed before 2016"),
          legend.shape.show = FALSE
  ) +
  tm_facets(by=c("Mode","Year"))+
  tm_credits(c("60,220 spatial availability \n(99.4% of the 60,567 city-wide OTGC)",
               "58,101 spatial availability\n(99.7% of the 58,287 city-wide OTGC)",
                "347 spatial availability \n(0.6% of the 60,567 city-wide OTGC)",
               "186 spatial availability\n(0.3% of the 58,287 city-wide OTGC)"),
             position = c("LEFT", "BOTTOM")) +
  tmap_defaults +
  tm_layout(bg.color = "grey85",
            panel.label.bg.color = "white",
            panel.label.height = 0.8)

vvim_20112016_plot <-  
  tm_shape(ham_bay, bbox=ham_community_bounds) + tm_polygons(col="skyblue", border.alpha = 0) +
  tm_shape(hydro_p_LakeOntario, bbox=ham_community_bounds) + tm_polygons(col="skyblue", border.alpha = 0)+
  tm_shape(SAvail_im_DA, bbox=SAvail_im_DA) +
  tm_polygons(col = "v_im_kid_popadj", border.alpha = 0, border.col = "grey20", lwd=0.2,
              palette = "RdYlGn",
              midpoint = 1.0,
              title = expression(v[i]^m),
              # style="quantile", n=4,
              breaks = c(0, 0.62, 0.9, 1.22, 2.1), #note the highest value is ~10.29, I'm breaking the values early for the purpose of visualisation
              labels = c("[0-0.62)", "[0.62-0.9)", "[0.9-1.22)", "[1.22-10.26)"),
              textNULL = "Unavailable",
              colorNULL = "black")+
  tm_facets(by = c("mode","year"), nrow=1)+
  tm_shape(ham_community_bounds %>% st_cast("MULTILINESTRING")) + 
  tm_lines(col = "COMMUNITY_", 
           palette = c("#365C8DFF", "#277F8EFF", "#1FA187FF", "#4AC16DFF", "#9FDA3AFF", "#FDE725FF"),
           title.col = "Hamilton communities", lwd = 2) + 
  tm_shape(ALL_SCHOOLS_Elem_formapping2) +
  tm_symbols(shape = "Status",
             size=0.1,
             alpha=0.5,
          title.shape = "School status",
          shapes = c(24,25,21,23,22),
          shapes.labels = c(
          "Expanded after 2011",
          "Moved before 2016",
          "New after 2011",
          "No change btwn 2011-16",
          "Closed before 2016")
  ) +
  tm_facets(by=c("Mode","Year"))+
  tm_credits(c("1.09 avg. spatial availability per capita",
               "1.05 avg. spatial availability per capita",
                "0.85 avg. spatial availability per capita",
               "0.71 avg. spatial availability per capita"),
             position = c("LEFT", "BOTTOM")) +
  tmap_defaults +
  tm_layout(bg.color = "grey85",
            panel.label.bg.color = "white",
            panel.label.height = 0.8)

Vim_vvim_20112016_plot <- tmap_arrange(Vim_20112016_plot, vvim_20112016_plot, nrow=2)

tmap_save(Vim_vvim_20112016_plot, paste0(here::here(),"/Figures/Fig5.tiff"), height=12, width=12, dpi=450)
```

```{r, eval=FALSE}
tmap_defaults <-
  tm_scale_bar(position = c("LEFT", "BOTTOM"), breaks = c(0, 5, 10, 15))+
  tm_compass(size = 1.5, position = c("right", 'top')) +
  tm_layout(legend.position = c("left", "top")) #legend.hist.size = 10, 

Vim_20112016_CHANGE_plot <-  
  tm_shape(ham_bay, bbox=ham_community_bounds) + tm_polygons(col="skyblue", border.alpha = 0) +
  tm_shape(hydro_p_LakeOntario, bbox=ham_community_bounds) + tm_polygons(col="skyblue", border.alpha = 0)+
  tm_shape(SAvail_im_DA_changes, bbox=SAvail_im_DA) +
  tm_polygons(col = "c_V_im", border.alpha = 0, border.col = "grey20", lwd=0.2,
              palette = "RdBu", #midpoint=0,
              # style="quantile", n=4,
              breaks = c(-20, -4.1, -0.2, 0, 20),
              labels = c("[-208 to -4.1)", "[-4.1 to -0.2)", "[-0.2 to 0)","[0 to 283.6]"),
              title = expression("Change in "*V[i]^m),
              textNA = "No V in 2016 or 2011",
              colorNA = "white")+
  tm_facets(by = c("mode"), nrow=1)+
  tm_shape(ham_community_bounds %>% st_cast("MULTILINESTRING")) + 
  tm_lines(col = "COMMUNITY_", 
           palette = c("#365C8DFF", "#277F8EFF", "#1FA187FF", "#4AC16DFF", "#9FDA3AFF", "#FDE725FF"),
           title.col = "Hamilton communities", lwd = 2, 
           legend.col.show = FALSE) + 
  tm_shape(ALL_SCHOOLS_Elem_formapping |> 
             filter(Status != "NoChange" & Status != "Moved")|>
             mutate(Status_change = case_when(Status == "Removed" ~ "Closed",
                                              (Status == "Expanded" | Status == "New" ) ~ "New or Expanded"))) +
  tm_symbols(shape = "Status_change",
             size=0.1,
             alpha=0.5,
          title.shape = "Schools that changed status",
          shapes = c(22,21),
          # shapes.labels = c(
          # "New or expanded after 2011",
          # "Closed before 2016"),
          legend.shape.show = FALSE) +
  tmap_defaults +
  tm_layout(bg.color = "grey85",
             panel.label.bg.color = "white",
            panel.label.height = 0.8)

vvim_20112016_CHANGE_plot <-
  tm_shape(ham_bay, bbox=ham_community_bounds) + tm_polygons(col="skyblue", border.alpha = 0) + 
  tm_shape(hydro_p_LakeOntario, bbox=ham_community_bounds) + tm_polygons(col="skyblue", border.alpha = 0)+
  tm_shape(SAvail_im_DA_changes, bbox=SAvail_im_DA) +
  tm_polygons(col = "c_v_im_kid_popadj", border.alpha = 0, border.col = "grey20", lwd=0.2,
              palette = "RdBu", midpoint=0,
              breaks = c(-0.1, -0.08, -0.05, 0, 0.1),
              labels = c("[-3.77 to -0.08)", "[-0.08 to -0.05)", "[-0.05 to 0)", 
                         "[0 to 1.46]"),
              title = expression("Change in "*v[i]^m),
              textNA = "No V in 2016 or 2011",
              colorNA = "white")+
  tm_facets(by = c("mode"), nrow=1)+
  tm_shape(ham_community_bounds %>% st_cast("MULTILINESTRING")) + 
  tm_lines(col = "COMMUNITY_", 
           palette = c("#365C8DFF", "#277F8EFF", "#1FA187FF", "#4AC16DFF", "#9FDA3AFF", "#FDE725FF"),
           title.col = "Hamilton communities", lwd = 2) + 
  tm_shape(ALL_SCHOOLS_Elem_formapping |> 
             filter(Status != "NoChange" & Status != "Moved")|>
             mutate(Status_change = case_when(Status == "Removed" ~ "Closed",
                                              (Status == "Expanded" | Status == "New" ) ~ "New or Expanded"))) +
  tm_symbols(shape = "Status_change",
             size=0.1,
             alpha=0.5,
          title.shape = "Schools that changed status",
          shapes = c(22,21),
          shapes.labels = c(
          "Closed before 2016",
          "New or expanded after 2011")
  ) +
  tmap_defaults +
  tm_layout(bg.color = "grey85",
             panel.label.bg.color = "white",
            panel.label.height = 0.8)

Vim_vvim_20112016_CHANGE_plot <- tmap_arrange(Vim_20112016_CHANGE_plot, vvim_20112016_CHANGE_plot, nrow=2)
```

```{r, eval=FALSE}
tmap_save(Vim_vvim_20112016_CHANGE_plot, 
          paste0(here::here(),"/Figures/Fig6.tiff"),
          height=7,
          width=12, 
          dpi=600)
```

```{r, eval=FALSE}
tmap_defaults <-
  tm_scale_bar(position = c("LEFT", "BOTTOM"), breaks = c(0, 5, 10, 15))+
  tm_compass(size = 1.5, position = c("right", 'top')) +
  tm_layout(legend.position = c("left", "top")) #legend.hist.size = 10, 

ttim_20112016_CHANGE_plot <-  
  tm_shape(ham_bay, bbox=ham_community_bounds) + tm_polygons(col="skyblue", border.alpha = 0) +
  tm_shape(hydro_p_LakeOntario, bbox=ham_community_bounds) + tm_polygons(col="skyblue", border.alpha = 0)+
  tm_shape(SAvail_im_DA_changes |> filter(mode == "non-motorized"), 
           bbox=SAvail_im_DA ) +
  tm_polygons(col = "c_total_tt", border.alpha = 0, border.col = "grey20", lwd=0.2,
              palette = "RdYlGn", midpoint=0,
              #style="quantile", n=4, 
              breaks = c(-10, -5.67, -2.94, 0, 10),
              labels = c("[-69.0 to -5.7)", "[-5.7 to -2.94)", "[-2.94 to 0)","[0 to 20.81]"),
              title = c("Non-motorized travel time (minutes)"))+
  tm_shape(ham_community_bounds %>% st_cast("MULTILINESTRING")) + 
  tm_lines(col = "COMMUNITY_", 
           palette = c("#365C8DFF", "#277F8EFF", "#1FA187FF", "#4AC16DFF", "#9FDA3AFF", "#FDE725FF"),
           title.col = "Hamilton communities", lwd = 2, 
           legend.col.show = FALSE) + 
  tm_shape(ALL_SCHOOLS_Elem_formapping |> 
             filter(Status != "NoChange" & Status != "Moved")|>
             mutate(Status_change = case_when(Status == "Removed" ~ "Closed",
                                              (Status == "Expanded" | Status == "New" ) ~ "New or Expanded"))) +
  tm_symbols(shape = "Status_change",
             size=0.1,
             alpha=0.5,
          title.shape = "Schools that changed status",
          shapes = c(22,21),
          # shapes.labels = c(
          # "New or expanded after 2011",
          # "Closed before 2016"),
          legend.shape.show = FALSE) +
  tmap_defaults +
  tm_layout( bg.color = "grey85",
             panel.label.bg.color = "white",
             panel.label.height = 0.9,
             panel.labels = "Change in non-motorized minutes between 2011-16",
             legend.outside = TRUE)

GHGim_20112016_CHANGE_plot <-
  tm_shape(ham_bay, bbox=ham_community_bounds) + tm_polygons(col="skyblue", border.alpha = 0) +
  tm_shape(hydro_p_LakeOntario, bbox=ham_community_bounds) + tm_polygons(col="skyblue", border.alpha = 0)+
  tm_shape(SAvail_im_DA_changes |> filter(mode == "motorized"), bbox=SAvail_im_DA) +
  tm_polygons(col = "c_emissions_total_car_tt", border.alpha = 0, border.col = "grey20", lwd=0.2,
              palette = "-RdYlGn", midpoint=0,
              #style="quantile", n=4,
              breaks = c(-200, -15, -4, 10, 200),
              labels = c("[-197 to -15)", "[-15 to -4)", "[-4 to 0)", "[0 to 10)", "[10 to 1,220]"),
              title = expression("kg CO"[2]*"e for potential home-school trips"),
              textNA = "No V in 2016 or 2011",
              colorNA = "white")+
  tm_shape(ham_community_bounds %>% st_cast("MULTILINESTRING")) + 
  tm_lines(col = "COMMUNITY_", 
           palette = c("#365C8DFF", "#277F8EFF", "#1FA187FF", "#4AC16DFF", "#9FDA3AFF", "#FDE725FF"),
           title.col = "Hamilton communities", lwd = 2) + 
  tm_shape(ALL_SCHOOLS_Elem_formapping |> 
             filter(Status != "NoChange" & Status != "Moved")|>
             mutate(Status_change = case_when(Status == "Removed" ~ "Closed",
                                              (Status == "Expanded" | Status == "New" ) ~ "New or Expanded"))) +
  tm_symbols(shape = "Status_change",
             size=0.1,
             alpha=0.5,
          title.shape = "Schools that changed status",
          shapes = c(22,21),
          shapes.labels = c(
          "Closed before 2016",
          "New or expanded after 2011")
  ) +
  tmap_defaults +
  tm_layout( bg.color = "grey85",
             panel.label.bg.color = "white",
             panel.label.height = 0.9,
             panel.labels = "Change in GHG emissions between 2011-16",
             legend.outside = TRUE)

ttim_GHGim_20112016_CHANGE_plot <- tmap_arrange(ttim_20112016_CHANGE_plot, GHGim_20112016_CHANGE_plot, nrow=2)
```

```{r, eval=FALSE}
tmap_save(ttim_GHGim_20112016_CHANGE_plot, 
          paste0(here::here(),"/Figures/Fig7.tiff"),
          height=5.5,
          width=7.5, 
          dpi=600)
```

```{r, eval=FALSE}
#some community summary tables?
SAvail_im_DA2011  |> st_drop_geometry() |> group_by(COMMUNITY, mode) |> summarise(
  LIM = mean(DA_prev_LIMAT_under18, na.rm = T)*mean(kid_popadj_m, na.rm = T),
  sum_total_tt = sum(total_tt),
  emis_perkid = sum(emissions_total_car_tt)/sum(kid_popadj_m),
  sum_V_im = sum(V_im),
  mn_v_im = mean(v_im_kid_popadj),
  mn_v_im_LIM = mean(v_im_kid_popadj_LIMAT))

SAvail_im_DA2016  |> st_drop_geometry() |> group_by(COMMUNITY, mode) |> summarise(
  LIM = mean(DA_prev_LIMAT_under18, na.rm = T)*mean(kid_popadj_m, na.rm = T),
  sum_total_tt = sum(total_tt),
  emis_perkid = sum(emissions_total_car_tt)/sum(kid_popadj_m),
  sum_V_im = sum(V_im),
  mn_v_im = mean(v_im_kid_popadj),
  mn_v_im_LIM = mean(v_im_kid_popadj_LIMAT))                                                
```

```{r creating-desc-stats-table-tt, echo=FALSE}
#forming a complete descriptive statistic table
# Statistics <- data.frame("Statistic" = c("Parcel pts", "Trips",
#                                          "TT min.", "TT 1st qu.", "TT mean", "TT 3rd qu.", "TT max."))
# `2011` <- data.frame(`Y2011` = c(ALL_nearest_network_point %>% filter(Year != "2016") %>% pull(ROLL_NUM) %>% length() %>% round() ,
#                                 ALL_PARCELS %>% filter(ParYear != "2016" & Level == "Elementary") %>% pull(ROLL_NUM) %>% length()%>% round(),
#                                 ALL_PARCELS %>% filter(ParYear != "2016" & Level == "Elementary") %>% pull(car_tt) %>% min()%>% round(),
#                                 ALL_PARCELS %>% filter(ParYear != "2016" & Level == "Elementary") %>% pull(car_tt) %>% quantile(0.25) %>% as.numeric()%>% round(), 
#                                 ALL_PARCELS %>% filter(ParYear != "2016" & Level == "Elementary") %>% pull(car_tt) %>% mean()%>% round(),
#                                 ALL_PARCELS %>% filter(ParYear != "2016" & Level == "Elementary") %>% pull(car_tt) %>% quantile(0.75) %>% as.numeric()%>% round(),
#                                 ALL_PARCELS %>% filter(ParYear != "2016" & Level == "Elementary") %>% pull(car_tt) %>% max()%>% round()
#                                 ))
# `2016` <- data.frame(`Y2016` = c(ALL_nearest_network_point %>% filter(Year != "2011") %>% pull(ROLL_NUM) %>% length()%>% round(),
#                                 ALL_PARCELS %>% filter(ParYear != "2011" & Level == "Elementary") %>% pull(ROLL_NUM) %>% length()%>% round(),
#                                 ALL_PARCELS %>% filter(ParYear != "2011" & Level == "Elementary") %>% pull(car_tt) %>% min()%>% round(),
#                                 ALL_PARCELS %>% filter(ParYear != "2011" & Level == "Elementary") %>% pull(car_tt) %>% quantile(0.25) %>% as.numeric()%>% round(), 
#                                 ALL_PARCELS %>% filter(ParYear != "2011" & Level == "Elementary") %>% pull(car_tt) %>% mean()%>% round(),
#                                 ALL_PARCELS %>% filter(ParYear != "2011" & Level == "Elementary") %>% pull(car_tt) %>% quantile(0.75) %>% as.numeric()%>% round(),
#                                 ALL_PARCELS %>% filter(ParYear != "2011" & Level == "Elementary") %>% pull(car_tt) %>% max()%>% round()
#                                 ))
# desc_stats_tt <- cbind(Statistics,`2011`, `2016`)
# 
# #kable tabling
# desc_stats_tt %>%
#   kableExtra::kable(format = "latex",
#         align="lrrrrrr",
#         booktabs = T,
#         col.names = c("Statistic", "2011", "2016"),
#         caption = "\\label{tab:desc-stats-table-tt}Descriptive statistics of the parcels, trips, and calculated origin-destination car travel times.") %>%
#   kableExtra::kable_styling(full_width = "T",
#                 latex_options = c("scale_down"),
#                 position = "center")
```

# Introduction

Communities are by nature in flux: economic and demographic shifts, rural and urban configurations, and political pressures all combine to produce change. These forces spur the re-organization and consolidation of public facilities in communities around the world where changes to service provision may improve the quality of service for some but not for all [@Christiaanse_2020; @Rosik_Pulawska-Obiedowska_Goliszek_2021]. While change is natural, oftentimes top-down consolidation decisions are driven by operational cost-savings that do not take into consideration the full extent of losses in benefits.

From this perspective, school closure policies have been pursued by governments to optimize per-student operational cost-efficiency [@rongReviewResearchLowcarbon2022; @Dai_Wang_Zhang_Liao_Liu_2019] but other implications, such as the impact of closures on property values [@MerrallWhatsASchool2024], their effects on the social infrastructure of communities [@butlerClosureRideau2019a; @irwinSchoolClosure2012], and particularly their travel implications have often been overlooked by decision makers [@bierbaumMobilityJusticeLinking2021; @Lee_Lubienski_2017]. This seems a mistake: journey-to-school trips are tremendously important, and travel for this purpose is currently the largest contributor of carbon emissions from personal travel after the journey-to-work [@rongReviewResearchLowcarbon2022; @pantelakiImpactHomeschoolCommuting2024], where it could be instead an excellent opportunity for physical activity [@desjardinsFramingActive2024]. Alas, in many communities globally, schools are closing [@sageman2022]. For instance, 65% of comprehensive schools (e.g. grades 1 through 9) in rural Finland since 1990 closed [@Autti_Hyry-Beihammer_2014], 10% of elementary schools (kindergarten through grade 8) in Chicago, USA in 2013 [@Lee_Lubienski_2017], and 7% of primary and lower secondary schools (kindergarten through grade 9) were closed in Denmark between 2010-2011 [@Beuchert_Humlum_Nielsen_Smith_2018]. School closures often increase the distance to school for many students and thus tend to induce motorized trips [@rongReviewResearchLowcarbon2022]. 

We focus on the transportation implications of school closure and consolidation policies. While some research has considered the "steps in reserve", that is, the potential for active travel hidden behind motorized trips [@morencyStepsReserve2009; @morencyHowMany2007], school closures potentially make actual steps vanish, sent to the reserve for the foreseeable future. In exchange for less physical activity, communities get more motorized travel, with the concomitant costs and burdens, including emissions. Quantification of losses in potential active travel and associated growth in carbon emissions is scarce in the literature, and the focus of this paper. In addition to its empirical contributions, this work makes use of a novel multimodal and singly-constrained accessibility measure, called spatial availability [@soukhovIntroducingSpatialAvailability2023; @soukhovMultimodalSpatialAvailability2024], which we use to estimate the changes in accessibility and travel after a recent wave of school closures/consolidations in Hamilton, Ontario.

The results of the research indicate that, overall, school seats became less spatially available in the city. This change happened unevenly, with some communities being disproportionately affected. Though the school consolidation policy pursued by the province and implemented by the local school board may have resulted in cost-savings in operation and maintenance of facilities, families, students, and communities now pay the price in terms of lost opportunities for healthier active travel, as well as increased emissions from motorized travel. 

# Background

Hamilton is a mid-size city (\~570,000 pop) with rural, suburban and urban characteristics in the province of Ontario, Canada [@governmentofcanadaProfileTableCensus2022]. In 2013, the Hamilton-Wentworth District School Board (HWDSB), the largest public English school board in the city, released its Long Term Facilities Master Plan [@hwdsbLongTermFacilities2013]. To ensure "equitable, affordable and sustainable learning facilities", the Master Plan indicated that 80% of its elementary schools (attended by students aged 5 to 13) would be subjected to accommodation evaluations, including an "Accommodation Review", the outcome of which historically has been school closures/consolidations [@hwdsbLongTermFacilities2013; @craggsBoardEvaluatingFuture2013; @seasonsSchoolClosurePolicy2014]. These decisions, underhandedly supported by the province, were in part motivated by a search for operational savings based on projected reductions in student population and underutilized school capacity [@craggsAxeCouldFall2012]. Hamilton was particularly affected, as the HWDSB underwent an unprecedented number of Accommodation Reviews relative to other school boards [@seasons2014ARCCatalogues2014]. 

Though the Accommodation Review guidelines outline a community-focused process to assess the value that a school provides to students, the community, and the local economy [@seasonsSchoolClosurePolicy2014; @ministryofeducationPupilAccommodationReview2006], in practice residents felt that a wholesome breakdown of costs to repair/maintain schools was not made consistently available [@kleinhuisSeriousConcernsSchool2013]. Further, others pointed to flawed incentive structures motivating the HWDSB: "By closing three schools the HWDSB would have a strong case with the Ministry of Education to receive full funding for a new school" [@kleinhuisSeriousConcernsSchool2013]. Along with insufficient funding to maintain schools in a state of good repair [@auditorgeneralofontarioAnnualReport20152015], the operational savings as a case for school closures is a long-standing critique of the school "funding formula" established by the conservative provincial government in 1998 [@mackenzieBlueprintFixOntario2018; @irwinSchoolClosure2012]. Within a backdrop of budget cuts, the funding formula pits the financing of school maintenance and student needs against the financial compensation of staff and the powers of local school boards, which depend on the province for the allocation of resources [@mackenzieBlueprintFixOntario2018].

In the wave of school accommodation reviews between 2013 and 2016, `r ALL_SCHOOLS_Elem %>% filter(Year == "2011" & Level == "Elementary" & Status == "Removed") %>% pull(SchoolID) %>% length()` elementary schools closed in Hamilton. These closures represented a `r ((ALL_SCHOOLS_Elem %>% filter(Year != "2016") %>% pull(SchoolID) %>% length() - ALL_SCHOOLS_Elem %>% filter(Year != "2011") %>% pull(SchoolID) %>% length())/ALL_SCHOOLS_Elem %>% filter(Year != "2016" & Level == "Elementary") %>% pull(SchoolID) %>% length()) %>% scales::percent()` and `r  (( ((avail_2011 |> group_by(SchoolID) |> summarize(OTGC = first(OTGC2011)) |> select(OTGC) |> sum())) - (avail_2016 |> group_by(SchoolID) |> summarize(OTGC = first(OTGC2016)) |> select(OTGC) |> sum())) / (avail_2016 |> group_by(SchoolID) |> summarize(OTGC = first(OTGC2016)) |> select(OTGC) |> sum()) ) |> scales::percent()` decline in elementary school locations and capacity between 2011 (before the school closures) and 2016, despite the elementary-aged student population in the city slightly increasing between 2011 and 2016( from `r avail_2011$kid_popadj %>% sum(na.rm=T) %>% prettyNum(big.mark=",")` students to `r avail_2016$kid_popadj %>% sum(na.rm=T) %>% prettyNum(big.mark=",")` students). 

While accommodation reviews were undertaken to reduce operational costs, how might have the closure of schools impacted local communities? In this paper, we hypothesize that the school consolidation policy reduced accessibility to schools for many students. By extension, this loss in access and the consequent displacement of active trips to school increased transportation-related emissions. To test these hypotheses, the paper examines the following: how does the (1) spatial availability, (2) loss in walk minutes and (3) associated carbon emissions change for home-to-school trips after a city closes and consolidates schools? Further, this work examines (4) what communities, based on low-income prevalence, experienced the greatest losses as a result of this policy. 

Spatial availability, a singly-constrained measure of spatial accessibility [@soukhovIntroducingSpatialAvailability2023; @soukhovMultimodalSpatialAvailability2024], is used to quantify accessibility before- and after- school closures, and the associated impacts for the city of Hamilton and the elementary school-aged student population as a result of a policy with narrowly defined benefits. The methods used in this paper can be applied by decision-makers to evaluate the spatial and transport-related impacts of public service provision policy. Furthermore, to increase the diffusion of this analysis, all work is transparent and reproducible, following best practices in the spatial sciences [@brunsdonOpeningPractice2021; @paezOpenSpatial2021c]. Accordingly, all associated code and data will be publicly available within the lead author's [GitHub repository](https://github.com/soukhova/School-closures-accessibility-impacts)

# Data

Our focus is to evaluate the impact of school consolidations between 2011 and 2016 on multimodal school spatial availability and travel-related GHG emission in Hamilton. To facilitate comparison, two scenarios are generated. Each scenario reflects the conditions in 2011 and 2016 respectively, assuming the school configurations in each year, as well as average student population and low-income prevalence of households, residential parcel locations, and estimated modal travel times. The difference between the two scenarios is quantified in terms of accessibility, emissions and equity implications and discussed in context with the school consolidation policy. Data was retrieved at different levels of spatial granularity from the following sources.

## Schools 

First, schools and associated school catchments were retrieved from the City's school boards. In Hamilton, the majority of student-aged population attends a school in one of the two English public school boards [@faoOntarioSchoolBoards2023]. One board is referred to as *public* (i.e., Hamilton Wentworth District School Board (HWDSB)) in our work and the other is referred to as *public-catholic* (Hamilton Wentworth Catholic District School Board (HWCDSB)). These catchments indicate what residential property is assigned to what school, by default. Families can decide to attend schools out of catchment; in fact, 21%-23% <!--calculated in 03-travel-times-TTS.qmd--> of motorized school trips are out of catchment according to the regional travel survey, the Transportation Tomorrow Survey (TTS) in 2011 and 2016 [@data_management_group_tts_2018]. The elementary school locations and catchments were provided by the HWDSB and HWCDSB for the 2010-2011 and 2015-2016 academic years, and are shown in @fig-Fig1.

Formally, elementary schools are defined as schools that provide instruction to any combination of grades between kindergarten to grade 8 (i.e. typically children aged 5 to 14). As such, elementary includes middle schools that only instruct grades 6 to 8 (*MidElem*), primary schools that only instruct kindergarten to grade 5 or 6 (*JrElem*), and all grade elementary schools (*Elem*) which instruct all grades from kindergarten to grade 8. The number of 'seats' available in the school beyond or below which it will be over/under- capacity is calculated by the provincial Ministry of Education; this value is referred to as the on-the-ground capacity (*OTGC*), and is assigned to each school. The current/historic OTGCs are not publicly available [@ontarioSchoolFacilityInventory2017]. However, for schools that underwent the full Accommodation Review process, OTGCs for a given year could be obtained from publicly available School Information Profiles. A regression model was used to estimate the OTGCs for schools that lacked OTGC information. The independent variables in the model were 1) the school's building footprint (*F*) in units of ($m^2$); 2) the school's shortest Euclidean distance from the centroid of Hamilton's central business district area (*DistCBD*) defined in units of (m); and 3) coefficients associated with a binary variable indicating the type of school grade instruction (*MidElem*, *JrElem*, *Elem*). The building footprint from an archived spatial data set [@DMTI_Spatial_2015] and the 2016 footprints were retrieved from OSM [@OpenStreetMap_2021]. Because the age of construction for different schools is not available, we used each school's distance from the centroid of the Downtown Business Improvement Area [@Hamilton_2014] as a proxy for school age as the oldest buildings are generally located closer to the city centre [@Merrall_2021]. Of note, the models were also used to estimate OTGC of secondary schools (*Sec*) though not included in the scope of this work; these public institutions provide instruction for grades 9 to 12 (i.e., children aged 14 to 17).

Equations (\ref{eq:OTGC-public}) and (\ref{eq:OTGC-catholic}) describe the estimated OTGC for public schools and catholic schools respectively. School status and OTGC summed by catchment is also visualised in @fig-Fig1. As seen in Table \ref{TabA1-OTGC} in the Appendix, the coefficient of determination for these models is $R^2 = 0.999$ and $R^2 = 0.998$ for the Public $OTGC_{Public}$ and Catholic $OTGC_{Catholic}$ Boards respectively, and the residual standard deviation is $\sigma = 0.212$ and $sigma = 0.331$. 
<!-- [AS]: model estimation here: https://github.com/soukhova/hamONdests/blob/master/data-raw/01-school-data-preparation.Rmd -->

```{=tex}
\begin{equation}
\label{eq:OTGC-public}
OTGC_{Public} = F^{0.346}-e^{0.00003*DistCBD}+e^{3.123*JrElem}+e^{3.752*Elem}+ e^{3.068*MidElem} 
\end{equation}
```

```{=tex}
\begin{equation}
\label{eq:OTGC-catholic}
OTGC_{Catholic} =F^{0.471}-e^{0.00003*DistCBD}+e^{2.333*Elem}
\end{equation}
```

```{r}
#| label: fig-Fig1
#| fig-cap: "The school catchments, estimated On The Ground Capacity (OTGC) of schools summed per catchment, and school status for both public and public catholic school boards for year 2011 and 2016. OTGC scale is presented by quartiles."
#| echo: false
#| out-width: "120%"

grid.raster(readTIFF(paste0(here::here(),"/Figures/Fig1.tiff")))
```
<!--perhaps in the legend of this map, I add the number of schools in brackets (for "school status between 2011 and 2016")? And the number of schools on the map in each box? what do you think? I'll also make the font on the panels bigger-->

<!-- Number of schools? Yes Also, make the symbols that map the schools bigger, and use different shapes in addition to different colors. As an alternative, the OTGC could be the color, and the school category the shape. -->

## Students, residential locations and low-income prevelance

In addition to OTGC for schools, statistics about the student population and proportion of low-income after tax (LIM-AT) households were retrieved from the 2011 and 2016 Canadian Census [@Statistics_Canada_2011; @Statistics_Canada_2016] using the {cancensus} `R` package [@von_Bergmann_Shkolnik_Jacobs_2021]. The census releases population data by age group category, so the population aged between 5-9 years and 10-14 years were retained. LIM-AT refers to the proportion of private households that are below the median after-tax income [@governmentofcanadaDictionaryCensusPopulation2017]. The LIM-AT prevalence for households with children under 18 (there is no LIM-AT prevalence tabulated for households with exclusively elementary aged children) was retrained. Population and LIM-AT variables were taken at the Dissemination Area (DA) level, which is the finest geographic unit publicly available. DAs are designed by Statistics Canada with the aim of population uniformity hence DAs greatly vary in area but represent between approximately 400 and 700 (1st and 3rd quartile) in total population. The population aged 5 to 14 and the proportion of LIM-AT are visualised in the first and last rows in @fig-Fig2.

The third source of data consists of centroids of residential parcels in 2011 and 2016 that are used to represent residential locations [@Teranet_2009]. There are 134,340 and 139,467 residential locations in 2011 and 2016 respectively, representing `r cen_data_2011_hamiltononly$DA_households |> sum() |> prettyNum(big.mark = ",")` and `r cen_data_2016_hamiltononly$DA_households |> sum() |> prettyNum(big.mark = ",")` dwellings (according to the Canadian Census [@Statistics_Canada_2011; @Statistics_Canada_2016]). As the number of children per parcel are publicly unavailable, the average number of 5 to 14 year olds for each DA is divided by the number of residential households in that DA. Then the potential number of children at each dwelling is calculated by multiplying this DA rate by the number of dwellings in each parcel. <!-- NOTE: We consider the parcel centroids instead of DA centroids to more precisely calc. travel times. Since we do not know parcel student population, we assume a uniform spatial distribution of population across each DA. This assumption is a limitation, but it is better than what's typically done in studies that only consider the centroid of the census track. --> Due to the proprietary nature of the parcel data, the middle row in @fig-Fig2 visualises an aggregation of the information: the average rate of 5-14 year olds per residential household at the DA level. 

```{r}
#| label: fig-Fig2
#| fig-cap: "The magnitude (top row) and rate per residential unit (middle row) of elementary aged student population per DA in 2011 and 2016. Bottom row: the proportion of low-income households (prevelance of low-income after-tax, LIM-AT, measured by the 2011 and 2016 Canadian Census) with dependents under 18 years old shown. All scales are represented in quartiles."
#| echo: false
#| out-width: "120%"
#| fig-pos: "H"

grid.raster(readTIFF(paste0(here::here(),"/Figures/Fig2.tiff")))
```

## Estimated travel times and emissions 

It is assumed that children can go to any elementary school, but there is a preference for facilities that are more proximate. Based on this assumption, the fourth source of data is information regarding the mode-used and origin-destination locations of home-to-school trips from the 2011 and 2016 TTS [@data_management_group_tts_2018]. The TTS is a travel survey conducted in the Greater Golden Horseshoe Area in Ontario every five years. With a target 5% sampling rate, the survey is expanded to be representative at the traffic analysis zone (TAZ) level of geography. TAZ are spatial units created for the purpose of the TTS and pulled from the R data package {TTS2016R} [@soukhovTTS2016RDataSet2023]; a few DAs typically nest within each TAZ. The trip-level travel data extracted for this paper represent `r od_trips_perc_2011$TAZOrig_car_trips |> sum() |> prettyNum(big.mark = ",")` and `r od_trips_perc_2016$TAZOrig_car_trips |> sum() |> prettyNum(big.mark = ",")` motorized trips (mode used includes private car passenger, school bus, taxi, and transit) and `r od_trips_perc_2011$TAZOrig_walk_trips |> sum() |> prettyNum(big.mark = ",")` and `r od_trips_perc_2016$TAZOrig_walk_trips |> sum() |> prettyNum(big.mark = ",")` non-motorized trips (mode used includes walk and cycling) for 5 to 13 year olds from home-to-school in 2011 and 2016 respectively. The travel times for motorized and non-motorized travel are estimated using {r5r} [@Pereira2021r5r], which interfaces with the java-based R5 routing engine developed separately by Conveyal [@conveyalConveyalR5Routing2022]. As travel times are not associated with the TTS, motorized and non-motorized travel times are estimated for all TAZ centroids to all TAZ centroids. We estimate motorized travel to be by car and non-motorized travel to be by walk as those are the most used modes in their respective categories. The travel times and the intensity of modal home-to-school flows are visualised in @fig-Fig3 along with the boundaries of the TAZ and DAs. In @fig-Fig3, not all TAZs capture an elementary school trip by both modes. For this reason, the proportion of motorized modal share is aggregated at the community level. Hamilton (Ancaster: `r community_car_perc_2011$TAZOrig_car_perc[1] |> percent()`-`r community_car_perc_2016$TAZOrig_car_perc[1] |> percent()`, Dundas: `r community_car_perc_2011$TAZOrig_car_perc[2] |> percent()`-`r community_car_perc_2016$TAZOrig_car_perc[2] |> percent()`, Flamborough: `r community_car_perc_2011$TAZOrig_car_perc[3] |> percent()`-`r community_car_perc_2016$TAZOrig_car_perc[3] |> percent()`, Glanbrook: `r community_car_perc_2011$TAZOrig_car_perc[4] |> percent()`-`r community_car_perc_2016$TAZOrig_car_perc[4] |> percent()`, Hamilton Central: `r community_car_perc_2011$TAZOrig_car_perc[5] |> percent()`-`r community_car_perc_2016$TAZOrig_car_perc[5] |> percent()`, and Stoney Creek: `r community_car_perc_2011$TAZOrig_car_perc[6] |> percent()`-`r community_car_perc_2016$TAZOrig_car_perc[6] |> percent()`). <!--Unrelated: did you use information from TTS2016R? Or can you add it to the data package? And then cite your data paper. [AS]: fantastic idea! Added! for now I just have the TAZ boundaries in TTS2016R. The package can be expanded to include school travel but I'd need to add the full GTHA region. For this analysis I only exported Hamilton (PD region 6) beginning/ending trips.-->

```{r}
#| label: fig-Fig3
#| fig-cap: "The origin-destination flows from home-based motorized and non-motorized school trips for students between 5-13 years old as retrieved from TTS 2011 and 2016. Flows are mapped atop the proportion of TAZ non/motorized modal share from the TTS 2011 and 2016, DA boundaries, and Hamilton community boundaries."
#| echo: false
#| out-width: "120%"
#| fig-pos: "H"

grid.raster(readTIFF(paste0(here::here(),"/Figures/Fig3.tiff")))
```

The fifth source of data consists of estimated travel time matrices from all residential parcel locations to all elementary schools for both motorized and non-motorized travel. The travel times are also estimated using the {r5r} package [@Pereira2021r5r], with car mode and walking representing motorized and non-motorized travel respectively. For both motorized and non-motorized modes, the inputs assume a maximum travel time threshold of 60 minutes and the free-flow OpenStreetMap road network of Hamilton (retrieved using Geofabrik [@geofabrikOntarioOpenStreetMapGeofabrik2022] and manually edited to only include the network within Hamilton). Further, only walking trips shorter than 27 min minutes were retained. This travel time is approximately equivalent to 1.6 km which is the point within-catchment students qualify for transport provided by the school board [@HWDSB_2019]. Estimated trip-weighted motorized travel times are on average 16.5 minutes in 2011 and 16.8 minutes in 2016 (summary statistics for both years are approximately; min: 0.5, Q1: 11.0, Q2: 16.0, Q3: 21.0, max: 60.0). Estimated trip-weighted non-motorized travel times are on average 18.0 minutes in 2011 and 18.1 minutes in 2016 (summary statistics for both years are approximately; min: 0.5, Q1: 13.0, Q2: 19.0, Q3: 24.0, max: 27.0).
<!--to calc. the summary statistics i loaded "OD_2011" and "OD_2016" from data-products (big files) and ran: quantile(OD_2011|>filter(mode=="w" & travel_time_p50 <= 27)|>pull(travel_time_p50), weights=OD_2011|>filter(mode=="w")|>pull(kid_popadj)) 
and 
mean(OD_2011|>filter(mode=="w" & travel_time_p50 <= 27)|>pull(travel_time_p50), weights=OD_2011|>filter(mode=="w")|>pull(kid_popadj))
-->

These travel time matrices along with the origin-destination flows were used to create modal trip length distribution (TLD) functions. Analysis of the TLD is a useful technique to calibrate impedance functions as they are a representation of the propensity of travel by trip length [@horbachov_theoretical_2018; @batista_estimation_2019]. The empirical TLD is used to fit a density distribution using maximum likelihood and moment matching techniques and the Nelder-Mead and Brent methods for direct optimization available within the {fitdistrplus} package [@fitdistrplus_2015]. Based on goodness-of-fit criteria and diagnostics, the gamma and exponential distributions were selected for the motorized and non-motorized modal distributions respectively. The gamma distribution is defined by the shape ($\alpha$) parameter of `r round(gamma2011_motor$estimate[1], 3)` (2011) and `r round(gamma2016_motor$estimate[1], 3)` (2016) and the rate ($\beta$) of `r round(gamma2011_motor$estimate[2], 3)` (2011) and `r round(gamma2016_motor$estimate[2], 3)` (2016). The exponential distribution is defined by the rate ($\beta$) parameter of `r round(exp2011_nonmotor$estimate[1], 3)` (2011) and `r round(exp2016_nonmotor$estimate[1], 3)` (2016). The TLDs for the motorized and non-motorized trips are shown in @fig-Fig4. For reference, the gamma distribution and the exponential distribution function are displayed in Equations (\ref{eq:exp-dist}) and (\ref{eq:gamma-dist}) where $x$ is $c_{ij}$:

```{=tex}
\begin{equation}
\label{eq:exp-dist}
f(x) = \beta e ^{-\beta x}
\end{equation}
```

```{=tex}
\begin{equation}
\label{eq:gamma-dist}
\begin{aligned}
f(x, \alpha, \beta) = \frac {x^{\alpha-1}e^{-\frac{x}{\beta}}}{ \beta^{\alpha}\Gamma(\alpha)} \quad \text{for } 0 \leq x \leq \infty \\
\Gamma(\alpha) =  \int_{0}^{\infty} x^{\alpha-1}e^{-x} \,dx
\end{aligned}
\end{equation}
```

```{r}
#| label: fig-Fig4
#| fig-cap: "Empirical (grey bars) and theoretical (blue curves) motorized and non-motorized impedance functions. Motorized theoretical impedance function is based on the gamma distribution function and non-motorized on the expoential distribution function"
#| echo: false
#| out-width: "100%"
#| fig-pos: "H"

grid.raster(readTIFF(paste0(here::here(),"/Figures/Fig4.tiff")))
```

The sixth and final data source relates to motorized GHG estimations. It assumed that all non-motorized trips produce no emissions and those that are motorized take the average emission factor of 0.1 kg $CO_{2}e$  per minute travel. This emission factor is assumed based on an average speed of 40 km/h, the 2,380 g $CO_{2}e$ produced when 1 L of gasoline (well-to-wheel) is combusted, and an internal combustion engine passenger vehicle fuel efficiency of 7 g/100km as discussed in @soukhovOccupancyGHGEmissions2022.

# Methods: Multimodal spatial availability

Accessibility is defined as the "potential for spatial interaction". It is classically presented as the gravity-based measure popularized by @hansenHowAccessibilityShapes1959. It takes the following general multimodal formulation (Equation (\ref{eq:multimodal-conventional-accessibility})):

```{=tex}
\begin{equation}
\label{eq:multimodal-conventional-accessibility}
S_i^m = \sum_{j=1}^JO_j \cdot f^m(c_{ij}^m)
\end{equation}
```
\noindent where:

-   $m$ is a set of modes.
-   $c_{ij}^m$ is a measure of the cost of moving between $i$ and $j$ for each $m$.
-   $f^m(\cdot)$ is an impedance function of $c_{ij}^m$ for each $m$; it can take the form of any monotonically decreasing function chosen based on positive or normative criteria [@paez2012measuring].
-   $i$ is a set of origin locations ($i = 1,\cdots,N$).
-   $j$ is a set of destination locations ($j = 1,\cdots,J$).
-   $O_j$ is the number of opportunities at location $j$.
-   $S$ is Hansen-type accessibility as weighted sum of opportunities.

As indicators of urban structure, Hansen-type measures are informative, but the meaning of 10,000 accessible school-seats is harder to pin down: how many opportunities must any single student have access to? Furthermore, in scenario comparisons, the interpretation of the percentage change in accessible school seats is unclear. The interpretability of Hansen-type accessibility has been discussed in numerous studies, including recently by @hu_2019_measuring, @kelobonye2020measuring, and in greater depth by @merlin2017competition along with @soukhovIntroducingSpatialAvailability2023 and @soukhovMultimodalSpatialAvailability2024. The interpretation of accessibility is suggested to depend on how many people demand the opportunity, especially for exclusive opportunity-types like schools-seats (i.e., one school-seat is for one student).

In this paper, we benefit from new developments in accessibility research, particularly the multimodal spatial availability measure [@soukhovIntroducingSpatialAvailability2023; @soukhovMultimodalSpatialAvailability2024]. Spatial availability is a singly-constrained accessibility measure that accounts for competition by students using different modes for exclusive opportunities, such as school seats. The measureâs single constraint ensures that the marginals at the destination are met and thus the number of estimated school seats (opportunities) are preserved and allocated proportionally to the mode-using student population. This proportional allocation of opportunities yields an interpretable and meaningful measure of opportunity access, particularly when comparing across modes, at the spatial resolution of a residential parcel, and multiple time periods. See @soukhovMultimodalSpatialAvailability2024 for further discussion, multimodal spatial availability $V_{i}^m$ is defined as given by Equation (\ref{eq:spatial-availability}).

```{=tex}
\begin{equation}
\label{eq:spatial-availability}
V_{i}^{m} = \sum_{j=1}^J O_j\ F^{tm}_{ij}
\end{equation}
```
\noindent where:

-   $F^{tm}_{ij}$ is a balancing factor that depends on the population and cost of movement in the system as part of the gravity modelling framework and is captured in Equation (\ref{eq:balancing-factors}) for mode $m$.
-   $O_j$ is the number of opportunities at $j$.
-   $V_i^m$ is the number of spatially available opportunities from the perspective of $i$ for mode $m$.

$F^{tm}_{ij}$ can be understood as the joint probability of allocating opportunities, where $F^{pm}_{i}$ is the population-based balancing factor that grants a larger share of opportunities to larger $m$ population spatial units and $F^{cm}_{ij}$ is the impedance-based balancing factor that grants a larger share of the opportunities to less $m$-travel costly centers. Together $F^{tm}_{ij}$ ensures proportional allocation such that opportunities $O$ (like school-seats) are preserved for the whole region (i.e., $O = \sum_{j} O_j = \sum_{i} V_i = \sum_{m}\sum_{i} V_i^m$ ) and is reflected in Equation (\ref{eq:balancing-factors}):

```{=tex}
\begin{equation}
\label{eq:balancing-factors}
F^{tm}_{ij} = \frac{F^{pm}_{i} \cdot F^{cm}_{ij}}{\sum_{i} F^{pm}_{i} \cdot F^{cm}_{ij}}
\end{equation}
```
\noindent where:

- The factor for allocation by population for each $m$ at each $i$ is $F^{pm}_{i} = \frac{P_{i}^m}{\sum_{m}\sum_{i} P_{i}^m}$
- The factor for allocation by travel cost for each $m$ at each $i$ and $j$ is $F^{cm}_{ij} = \frac{f^m(c^m_{ij})}{\sum_{m}\sum_{i} f^m(c^m_{ij})}$

It should be noted that, when summed over all spatial units in the region, the population-based allocation factors $F^{pm}_{i}$ always equal 1 ($\sum_{m}\sum_{i} F^{pm}_{i}= 1$), likewise for impedance-based allocation factors $F^{cm}_{i}$ ($\sum_{m}\sum_{i} F^{cm}_{ij} = 1$).

Hansen-type accessibility is not designed to preserve the number of opportunities in the region, it simply counts the intensity of opportunities that those in a zone can potentially interact with (weighted by the friction of distance). Also, as discussed in @soukhovIntroducingSpatialAvailability2023, popular competitive accessibility measures such as the 2SFCA [@josephMeasuringPotentialPhysical1982; @weibullAxiomaticApproachMeasurement1976; @shenLocationCharacteristicsInnercity1998; @luoMeasuresSpatialAccessibility2003] are internally inconsistent, and the only way it preserves the number of opportunities is if the effect of the impedance function is ignored when expanding the values of opportunities per capita to obtain the total number of opportunities. On the other hand, the proportional allocation procedure associated with calculating multimodal spatial availability $V_i^m$ consistently returns a number of opportunities available to populations by mode that matches the total number of opportunities in the region when summed. By doing this consistently, it is possible to define a measure of multimodal spatial availability per capita as presented in Equation (\ref{eq:SA-per-capita}) for use as a benchmark to compare against the regional opportunities per capita ($\frac{\sum_{j} O_j}{\sum_{i} P_i}$).

```{=tex}
\begin{equation}
\label{eq:SA-per-capita}
v_i^m = \frac{V_i^m}{P_i^m}
\end{equation}
```

This paper uses the multimodal spatial availability $V_i^m$ and spatial availability per student $v_i^m$ measures to quantify accessibility changes for the following reasons. 

First, all residential parcels are associated to their respective census DA, TTS TAZ, and community boundary based on spatial location (aggregated by DA and shown as a per capita rate in the second row of @fig-Fig2). Each parcel is assigned a number of 'potential' motorized and non-motorized student aged population (from DA) and modal share (from TTS) to calculate a motorized and non-motorized population balancing factor $F_{i}^{pm}$. For each parcel, the following is retained: the 2011 and 2016 census average elementary-aged student population per parcel (@fig-Fig2 second row) and the average motorized and non-motorized share as informed by the TTS aggregated by community (@fig-Fig3). 

Second, the school capacity $O_j$ is estimated and associated with each school (@fig-Fig1). All residential locations are assumed to be able to access all schools by non-motorized and/or motorized mode. All origins (residential locations) can reach all schools by motorized mode, but few residential locations can reach schools within a 27 minute non-motorized trip. 

Third, the motorized and non-motorized impedance-balancing factors $F_{ij}^{cm}$ are calculated using a mode-specific impedance function (@fig-Fig4) based on the respective estimated travel times for each origin (parcel) to school combination (OD flows retained from the TTS). Using network estimated travel time sensitive to observed parcel origin to school destination flows conceptually addresses the aggregation error that could result from using less granular zonal units to represent origin/destinations [@kaneParcelsPointsProximity2020; @kwanSpaceTimeIntegralMeasures1998; @hewkoMeasuringNeighbourhoodSpatial2002]. Finally, outputs from all three stages are joined together. $F_{i}^{pm}$ joined with $F_{ij}^{cm}$ yields the total balancing factor $F^{tm}_{ij}$ which serves to proportionally allocate the school capacity $O_j$ to each parcel. The value is multimodal spatial availability $V_i^m$ which can be interpreted as the number of school-seats that are available to the mode-using population at that parcel. $V_i^m$ is then summed and represented at the DA and community level along with the calculated $v_i^m$ for interpretation.

# Results

The motorized and non-motorized spatial availabilities of school seats $V_i^m$ for both 2011 and 2016 are presented in the top half of @fig-Fig5. The sum of $V_i^m$ values in a year for both motorized and non-motorized population equals the city-wide OTGC (across both public and catholic school boards) in that year. This is a result of $V_i^m$'s proportional allocation mechanism, singly-constraining opportunities through the proportion allocation balancing factors. In this way, $V_i^m$ results can be interpreted as a proportion of the total OTGC in that year as the sum of $V_i^m$ for both modes in a year is equal to the total OTGC in that year. In @fig-Fig5, $i$ is a DA, so $V_i^m$ is the sum of the school seat availability per parcel in each DA. Each parcel is assigned a potential student population based on the average rate of school-aged population per residential parcel in that DA and the travel impedance weighted travel time to all schools. The top four plots of @fig-Fig5 demonstrate different magnitudes in part due to significantly lower non-motorized modal share (refer to @fig-Fig3), however it is apparent that both mode using populations have higher spatial availability when they are more proximate to schools. Hence, all DAs have higher values within Hamilton Central and those more proximate to schools in less-urban communities. Trends appear similar for both 2011 and 2016: this aligns with intuition, proximate populations using motorized modes benefit from the ability to reach more distant destinations than non-motorized modes.

When $V_i^m$ is divided by the number of students by mode in that DA, $v_i^m$ is derived (bottom four plots in @fig-Fig5). The $v_i^m$ plots demonstrate different spatial distribution trends than $V_i^m$ plots. If our aim is to provide sufficient availability to schools for both motorized and non-motorized populations (e.g., greater than 1.0 $v_i^m$ school-seat availability per student), this rate is only achieved in the core of the city for motorized modes (greens and yellows). Notably, this rate is only available to non-motorized populations in DAs that are in less-densely populated rural areas that are school proximate and very few pockets of Hamilton Central. The majority of schools closed were within Hamilton Central, so non-motorized populations in DAs within Hamilton Central were the most negatively impacted by losses in availability while certain motorized populations captured these losses as availability gains. 

```{r}
#| label: fig-Fig5
#| fig-cap: "Multimodal spatial availability (purples) and spatial availability per mode-using student (diverging reds and greens) aggregated at the DA level for 2011 and 2016. Scales are represented in quartiles."
#| echo: false
#| out-width: "120%"
#| fig-pos: "H"

grid.raster(readTIFF(paste0(here::here(),"/Figures/Fig5.tiff")))
```

To highlight this point, @fig-Fig6 visualises the change in school spatial availability between 2016 and 2011 for both mode where $i$ are 2016 DAs. Though the 2011 and 2016 DAs system are very similar (see @fig-Fig2 and @fig-Fig3), they are not identical: `r (cen_data_2011_hamiltononly$GeoUID %in% cen_data_2016_hamiltononly$GeoUID |> length() - cen_data_2011_hamiltononly$GeoUID %in% cen_data_2016_hamiltononly$GeoUID |> sum()) + (cen_data_2016_hamiltononly$GeoUID %in% cen_data_2011_hamiltononly$GeoUID |> length() - cen_data_2016_hamiltononly$GeoUID %in% cen_data_2011_hamiltononly$GeoUID |> sum())` DAs changed in their spatial extent (i.e., added, removed, changed boundaries). The proportional allocation mechanism of spatial availability provides flexibility in aggregating parcel-level values at whichever spatial unit is meaningful. For this case, the change in $V_i^m$ and $v_i^m$ represented is the subtraction between the value aggregated at 2016 DA for the 2016 and 2011 scenario.

```{r}
#| label: fig-Fig6
#| fig-cap: "Change in multimodal spatial availability and spatial availability per mode-using student between 2016 and 2011. Change is the subtraction of parcel-level results between 2016 and 2011 scenarios summed for each DA in the 2016 Canadian Census DA system. Scales are represented in quartiles, with Q4 rounded to 0."
#| echo: false
#| out-width: "120%"
#| fig-pos: "H"

grid.raster(readTIFF(paste0(here::here(),"/Figures/Fig6.tiff")))
```

From @fig-Fig6 (top plots), it is apparent that decreases (pinks and reds) in $V_i^m$ appear across the city for both mode-using populations. As the majority of closed schools are within the core of the city: the more urban Hamilton Central and urban-areas of other communities see a concentration of this decreased spatial availability to school seats. Evidently, the number of OTGC in the city (equal to the sum of $V_i^m$) decreased between the two years, so some sort of decrease is to be expected. However, even when spatial availability is divided by the mode-using population (which also decreased between the years) $v_i^m$ (bottom plots) continues to demonstrate decreases, especially those locally proximate to closed schools.

This decrease follows different patterns depending on the mode. $v_i^{non-motorized}$ is most impacted for parcels within a 27 minute walk travel time to schools that closed: these DAs demonstrate the most dramatic decrease. Smaller-area DAs (in Hamilton-Central) and larger-area DAs (in rural communities) proximate to closed schools present Q1 decreases (red). For $v_i^{motorized}$, the range offered by motorized mode (estimated by shortest-path car travel times) is city-wide, so since the majority of schools were centrally located, the decrease is concentrated within the downtown core of Hamilton Central. Some motorized-mode using populations in DAs do experience an increase in $V_i^m$ and $v_i^m$: these DAs are often relatively proximate to schools but more immediately outside walking range. Under competitive and constrained calculations, these DAs benefit from the losses in spatial availability that are predominately experienced by the non-motorized populations within Hamilton Central. 

The decrease in school seat spatial availability can be further interpreted. How does potential non-motorized travel to school decrease? How does the increase in potential motorized travel minutes impact GHG emissions? @fig-Fig7 visualises these related intermediates for one-way home-to-school travel in a given day. The top plot of @fig-Fig7 demonstrates the sum of the change in non-motorized minutes per 2016 DA. These travel time minutes are the difference between the aggregated 2016 and 2011 scenarios for non-motorized travel times multiplied by the proportion of walking/cycling mode-use and rate of student population associated with the parcels in each 2016 DA. It can be seen that Q1 decreases are proximate to closed schools. Smaller decreases (and even a few increases) are apparent in a range further from closed schools, especially those also in proximity to the few opened/expanded schools. Intuitively, these trends mirror what is shown within the $V^{non-motorized}$ landscape in @fig-Fig6 (Pearson correlation coefficient of `r cor(SAvail_im_DA_changes |> filter(mode == "non-motorized") |> pull(c_total_tt), SAvail_im_DA_changes |> filter(mode == "non-motorized") |> pull(c_V_im)) |> round(digits=3)`) as travel time is an input into the cost balancing factor $F^{cm}_{ij}$. Similarly, the bottom plot (@fig-Fig7) visualises the change in estimated emissions from motorized travel minutes. The change in GHG emissions is also highly correlated with $V^{motorized}$ in @fig-Fig6 (Pearson correlation coefficient of `r cor(SAvail_im_DA_changes |> filter(mode == "motorized") |> pull(c_emissions_total_car_tt), SAvail_im_DA_changes |> filter(mode == "motorized") |> pull(c_V_im)) |> round(digits=3)`) as it is also a product of travel time. 

```{r}
#| label: fig-Fig7
#| fig-cap: "Change in active travel time minutes (top plot) and home-to-school GHG emissions (bottom plot) between 2011 and 2016 scenarios. Change is the subtraction of parcel-level results between 2016 and 2011 scenarios summed for each DA in the 2016 Canadian Census DA system. Scales are represented in quartiles, with Q4 rounded to 0."
#| echo: false
#| out-width: "90%"
#| fig-pos: "H"

grid.raster(readTIFF(paste0(here::here(),"/Figures/Fig7.tiff")))
```

Notably, the mode type of spatial availability loss is important. The change in active travel minutes and GHG emissions highlights the negative externalities of _decreased_ non-motorized spatial availability. Normatively, our cities should be increasing spatial availability for non-motorized mode users given the climate crisis. The wave of school closures in Hamilton increased motorized spatial availability and, hence, potential GHG emissions. The policy drastically reduced non-motorized spatial availability, and this is seen in the decrease in potential non-motorized travel minutes as well as increased GHG emissions in rural areas that did benefit from motorized spatial availability gains. The proportion of non-motorized mode use is low in both 2011 and 2016, however, the closure of schools that are more proximate to student-population density eliminates the potential of those trips ever becoming active. And who is most impacted by the reduction of non-motorized spatial availability? A summary of spatial availability per Hamilton community and associated dimensions in 2016, along with the percentage change between 2011 and 2016, is summarized in @tbl-Tab1.

\pagebreak

```{r include=FALSE}
SAvail_im_COMM_changes_df <- SAvail_im_COMM_changes |> st_drop_geometry()

LIMAT_COMM <- SAvail_im_DA |> st_drop_geometry() |> filter(mode == "motorized" & year == "2016") |>
  group_by(COMMUNITY) |> 
  summarise(COMM_prev_LIMAT_under18_2016 = mean(DA_prev_LIMAT_under18, na.rm=T)) 

LIMAT_COMM_2011 <- SAvail_im_DA |> st_drop_geometry() |> 
  filter(mode == "motorized" & year == "2011") |>
  group_by(COMMUNITY) |> 
  summarise(COMM_prev_LIMAT_under18_2011 = mean(DA_prev_LIMAT_under18, na.rm=T)) 

LIMAT_COMM <- left_join(LIMAT_COMM, LIMAT_COMM_2011, by = "COMMUNITY") |>  
  mutate(c_COMM_prev_LIMAT_under18 = ((COMM_prev_LIMAT_under18_2016 - COMM_prev_LIMAT_under18_2011)/COMM_prev_LIMAT_under18_2011) |>
           scales::percent(accuracy = 2L)) 
rm(LIMAT_COMM_2011)

SCHOOL_SEATS_COMM <- ALL_SCHOOLS_Elem |> st_drop_geometry() |> group_by(COMMUNITY) |> 
  summarise(OTGC2011 = sum(OTGC2011, na.rm=T),
            OTGC2016 = sum(OTGC2016, na.rm=T)) |>
  mutate(c_OTGC_perc = ((OTGC2016 - OTGC2011)/OTGC2011) |> scales::percent(accuracy = 2L)) 

SAvail_im_COMM_changes_df <- SAvail_im_COMM_changes_df |> left_join(LIMAT_COMM, by="COMMUNITY") 
SAvail_im_COMM_changes_df <- SAvail_im_COMM_changes_df |> left_join(SCHOOL_SEATS_COMM, by="COMMUNITY") |> mutate_if(is.numeric, round, 1) 
```

```{r include=FALSE}
SAvail_im_COMM_changes_df <- SAvail_im_COMM_changes_df |> 
  dplyr::select(c("COMMUNITY",
                  "mode",
                  "COMM_prev_LIMAT_under18_2016",
                  "c_COMM_prev_LIMAT_under18",
                  "kid_2016",
                  "c_kid_perc",
                  "OTGC2016",
                  "c_OTGC_perc",
                  
                  "V_im_2016",
                  "c_V_im_perc",
                  "v_im_2016",
                  "c_v_im_perc",
                  
                  "emissions_2016",
                  "c_emissions_perc",
                  "emissions_perkid_2016",
                  "c_emissions_perkid_perc",
                  
                  "total_tt_2016",
                  "c_total_tt_perc",
                  "total_tt_perkid_2016",
                  "c_total_ttperkid_perc")) |> arrange(desc(COMM_prev_LIMAT_under18_2016))
```

```{r include=FALSE}
tdata_1 <- SAvail_im_COMM_changes_df |> 
  filter(mode == "motorized")|> 
  dplyr::select(c("COMMUNITY",
                  "COMM_prev_LIMAT_under18_2016",
                  "kid_2016",
                  "OTGC2016"))

tdata_1 <- insertRow(tdata_1 |> as.matrix(),2,
          SAvail_im_COMM_changes_df |> 
            filter(mode == "motorized" & COMMUNITY == "HA") |> 
            dplyr::select(c("COMMUNITY", 
                            "c_COMM_prev_LIMAT_under18", 
                            "c_kid_perc",
                            "c_OTGC_perc")) |> as.matrix())

tdata_1 <- insertRow(tdata_1,4,
          SAvail_im_COMM_changes_df |> 
            filter(mode == "motorized" & COMMUNITY == "DU") |> 
            dplyr::select(c("COMMUNITY", 
                            "c_COMM_prev_LIMAT_under18", 
                            "c_kid_perc",
                            "c_OTGC_perc")) |> as.matrix())

tdata_1 <- insertRow(tdata_1,6,
          SAvail_im_COMM_changes_df |> 
            filter(mode == "motorized" & COMMUNITY == "SC") |> 
            dplyr::select(c("COMMUNITY", 
                            "c_COMM_prev_LIMAT_under18", 
                            "c_kid_perc",
                            "c_OTGC_perc")) |> as.matrix())

tdata_1 <- insertRow(tdata_1,8,
          SAvail_im_COMM_changes_df |> 
            filter(mode == "motorized" & COMMUNITY == "AN") |> 
            dplyr::select(c("COMMUNITY", 
                            "c_COMM_prev_LIMAT_under18", 
                            "c_kid_perc",
                            "c_OTGC_perc")) |> as.matrix())

tdata_1 <- insertRow(tdata_1,10,
          SAvail_im_COMM_changes_df |> 
            filter(mode == "motorized" & COMMUNITY == "FL") |> 
            dplyr::select(c("COMMUNITY", 
                            "c_COMM_prev_LIMAT_under18", 
                            "c_kid_perc",
                            "c_OTGC_perc")) |> as.matrix())

tdata_1 <- insertRow(tdata_1,12,
          SAvail_im_COMM_changes_df |> 
            filter(mode == "motorized" & COMMUNITY == "GL") |> 
            dplyr::select(c("COMMUNITY", 
                            "c_COMM_prev_LIMAT_under18", 
                            "c_kid_perc",
                            "c_OTGC_perc")) |> as.matrix())
```

```{r}
tdata_2 <- SAvail_im_COMM_changes_df |> 
  filter(mode == "motorized")|> 
  dplyr::select(c("COMMUNITY",
                  "V_im_2016",
                  "v_im_2016",
                  "emissions_2016",
                  "emissions_perkid_2016"))

tdata_2 <- insertRow(tdata_2 |> as.matrix(),2,
          SAvail_im_COMM_changes_df |> 
            filter(mode == "motorized" & COMMUNITY == "HA") |> 
            dplyr::select(c("COMMUNITY", 
                            "c_V_im_perc", 
                            "c_v_im_perc",
                            "c_emissions_perc",
                            "c_emissions_perkid_perc")) |> as.matrix())

tdata_2 <- insertRow(tdata_2,4,
          SAvail_im_COMM_changes_df |> 
            filter(mode == "motorized" & COMMUNITY == "DU") |> 
            dplyr::select(c("COMMUNITY", 
                            "c_V_im_perc", 
                            "c_v_im_perc",
                            "c_emissions_perc",
                            "c_emissions_perkid_perc")) |> as.matrix())

tdata_2 <- insertRow(tdata_2,6,
          SAvail_im_COMM_changes_df |> 
            filter(mode == "motorized" & COMMUNITY == "SC") |> 
            dplyr::select(c("COMMUNITY", 
                            "c_V_im_perc", 
                            "c_v_im_perc",
                            "c_emissions_perc",
                            "c_emissions_perkid_perc")) |> as.matrix())

tdata_2 <- insertRow(tdata_2,8,
          SAvail_im_COMM_changes_df |> 
            filter(mode == "motorized" & COMMUNITY == "AN") |> 
            dplyr::select(c("COMMUNITY", 
                            "c_V_im_perc", 
                            "c_v_im_perc",
                            "c_emissions_perc",
                            "c_emissions_perkid_perc")) |> as.matrix())

tdata_2 <- insertRow(tdata_2,10,
          SAvail_im_COMM_changes_df |> 
            filter(mode == "motorized" & COMMUNITY == "FL") |> 
            dplyr::select(c("COMMUNITY", 
                            "c_V_im_perc", 
                            "c_v_im_perc",
                            "c_emissions_perc",
                            "c_emissions_perkid_perc")) |> as.matrix())

tdata_2 <- insertRow(tdata_2,12,
          SAvail_im_COMM_changes_df |> 
            filter(mode == "motorized" & COMMUNITY == "GL") |> 
            dplyr::select(c("COMMUNITY", 
                            "c_V_im_perc", 
                            "c_v_im_perc",
                            "c_emissions_perc",
                            "c_emissions_perkid_perc")) |> as.matrix())
```

```{r}
tdata_3 <- SAvail_im_COMM_changes_df |> 
  filter(mode == "non-motorized")|> 
  dplyr::select(c("COMMUNITY",
                  "V_im_2016",
                  "v_im_2016",
                  "total_tt_2016",
                  "total_tt_perkid_2016"))

tdata_3 <- insertRow(tdata_3 |> as.matrix(),2,
          SAvail_im_COMM_changes_df |> 
            filter(mode == "non-motorized" & COMMUNITY == "HA") |> 
            dplyr::select(c("COMMUNITY", 
                            "c_V_im_perc", 
                            "c_v_im_perc",
                            "c_total_tt_perc",
                            "c_total_ttperkid_perc")) |> as.matrix())

tdata_3 <- insertRow(tdata_3,4,
          SAvail_im_COMM_changes_df |> 
            filter(mode == "non-motorized" & COMMUNITY == "DU") |> 
            dplyr::select(c("COMMUNITY", 
                            "c_V_im_perc", 
                            "c_v_im_perc",
                            "c_total_tt_perc",
                            "c_total_ttperkid_perc")) |> as.matrix())

tdata_3 <- insertRow(tdata_3,6,
          SAvail_im_COMM_changes_df |> 
            filter(mode == "non-motorized" & COMMUNITY == "SC") |> 
            dplyr::select(c("COMMUNITY", 
                            "c_V_im_perc", 
                            "c_v_im_perc",
                            "c_total_tt_perc",
                            "c_total_ttperkid_perc")) |> as.matrix())

tdata_3 <- insertRow(tdata_3,8,
          SAvail_im_COMM_changes_df |> 
            filter(mode == "non-motorized" & COMMUNITY == "AN") |> 
            dplyr::select(c("COMMUNITY", 
                            "c_V_im_perc", 
                            "c_v_im_perc",
                            "c_total_tt_perc",
                            "c_total_ttperkid_perc")) |> as.matrix())

tdata_3 <- insertRow(tdata_3,10,
          SAvail_im_COMM_changes_df |> 
            filter(mode == "non-motorized" & COMMUNITY == "FL") |> 
            dplyr::select(c("COMMUNITY", 
                            "c_V_im_perc", 
                            "c_v_im_perc",
                            "c_total_tt_perc",
                            "c_total_ttperkid_perc")) |> as.matrix())

tdata_3 <- insertRow(tdata_3,12,
          SAvail_im_COMM_changes_df |> 
            filter(mode == "non-motorized" & COMMUNITY == "GL") |> 
            dplyr::select(c("COMMUNITY", 
                            "c_V_im_perc", 
                            "c_v_im_perc",
                            "c_total_tt_perc",
                            "c_total_ttperkid_perc")) |> as.matrix())
```

```{r include=FALSE}
tdata_1 <- t(tdata_1) |> data.frame() 
tdata_2 <- t(tdata_2) |> data.frame() 
tdata_3 <- t(tdata_3) |> data.frame()

tdata <- rbind(tdata_1,tdata_2,tdata_3)
tdata <- tdata[-c(5,10),]
rownames(tdata) <- c("", "LIM-AT", "Pop.", "OTGC", 
                     "V (mt)", "v (mt)", "GHG", "GHG/pop",
                     "V (nmt)", "v (nmt)", "tt", "tt/pop")
```

```{r}
#| label: tbl-Tab1
#| tbl-cap: "Spatial availability and associated dimensions aggregated by communities"
#| out-width: "90%"

tdata_hux <- as_hux(tdata) %>% set_escape_contents(FALSE)
# tdata_hux[1,1:12] <- c("Hamilton C.", "", "Dundas" ,"", "Stoney Creek", "", "Ancaster", "", "Flamborough", "", "Glanbrook", "")
# # tdata_hux[1,1:12] <- c("HA", "", "DU" ,"", "SC", "", "AN", "", "FL", "", "GL", "")
# tdata_hux[2,1:12] <- c("", "% {\\Delta}", "" , "% {\\Delta}", "", "% {\\Delta}Î", "", "% ${\\Delta}", "", "% {\\Delta}", "", "% {\\Delta}")

tdata_hux <- set_contents(tdata_hux,
                          row= c(1),
                          col = c(1:12),
                          value = c("Hamilton C.", "", "Dundas" ,"", "Stoney Creek", "", "Ancaster", "", "Flamborough", "", "Glanbrook", ""))
tdata_hux <- set_contents(tdata_hux,
                          row= c(2),
                          col = c(1:12),
                          value = c("", "% Î", "", "% Î", "", "% Î", "", "% Î",
                                    "", "% Î", "", "% Î"))

options("huxtable.latex_use_fontspec" = TRUE) #use the same font as the document

tdata_hux %>% 
  insert_row("Motorized", fill = "", colspan=12, after=5) %>% 
  insert_row("Non-motorized", fill = "", colspan=12, after=10) %>% 
  merge_across(1,c(1:2)) %>%
  merge_across(1,c(3:4)) %>%
  merge_across(1,c(5:6)) %>%
  merge_across(1,c(7:8)) %>%
  merge_across(1,c(9:10)) %>%
  merge_across(1,c(11:12)) %>%
  add_rownames() |>
  
  set_text_color(c(3,10), 3, "darkgreen") |>
  set_text_color(c(4,5,7,8,9,12,13,14), 3, "darkred") |>
  
  set_text_color(c(3), 5, "darkgreen") |>
  set_text_color(c(4,7,9,12,13,14), 5, "darkred") |>
  
  set_text_color(c(3,4,5,7,9,15), 7, "darkgreen") |>
  set_text_color(c(12,13,14), 7, "darkred") |>
  
  set_text_color(c(3,4,5,7,9,10,15), 9, "darkgreen") |>
  set_text_color(c(8,12,13,14), 9, "darkred") |>
  
  set_text_color(c(3,5,8,15), 11, "darkgreen") |>
  set_text_color(c(4,7,9,12,13,14,15), 11, "darkred") |>
  
  set_text_color(c(4,5,7,9,10), 13, "darkgreen") |>
  set_text_color(c(3,12,13,14,15), 13, "darkred") |>
  set_font_size(everywhere, everywhere, 6) |> 
  set_all_padding(0) |>
  set_bold(everywhere, 1, value = TRUE) |>
  set_bold(1:2, everywhere, value = TRUE) |>
  set_bold(c(6,11), everywhere, value = TRUE) |>
  set_contents(c(1,6,11), 1, "") |>
  set_right_border(c(3:15), c(3,5,7,9,11), brdr(1, "solid", "grey")) |>
  #set_bottom_border(c(2,5,6,10,11), c(2:13), brdr(1, "solid", "grey")) |>
  set_align(everywhere, everywhere, "left")|>
  set_align(c(1,2,6,11), everywhere, "center")|>
  set_caption("Spatial availability and associated dimensions aggregated by communities") |>
  set_label("tbl-Tab1") |> as_flextable()

```

Due to spatial availability's flexible proportional allocation mechanism and this cases' calculation at the parcel level, results can also be summarized by community (@tbl-Tab1). The majority of schools were closed in Hamilton Central. This community represents `r SAvail_im_COMM_changes |> st_drop_geometry() |> filter(COMMUNITY == "HA") |> dplyr::select("kid_proportion_2016") |> sum() |> scales::percent()` of the 5-14 year old population in 2016. Though the population between 2011 and 2016 decreased, the rate of school-seat spatial availability decreased disproportionately more (population by `r SAvail_im_COMM_changes |> st_drop_geometry() |> filter(COMMUNITY == "HA") |> transmute(calc = ((sum(kid_2016)-sum(kid_2011))/sum(kid_2011)) |> scales::percent()) |> pull() |> first()` and spatial availability by `r SAvail_im_COMM_changes |> st_drop_geometry() |> filter(COMMUNITY == "HA") |> transmute(calc = ((sum(V_im_2016)-sum(V_im_2011))/sum(V_im_2011)) |> scales::percent()) |> pull() |> first()`). This disproportionate decrease is greatest in Hamilton Central than any other community. This may have equity concerns as Hamilton Central has the highest LIM-AT prevalence, with `r SAvail_im_COMM_changes_df |> filter(COMMUNITY == "HA" & mode == "motorized") |> dplyr::select("COMM_prev_LIMAT_under18_2016") |> paste0("%")` of households LIM-AT in 2016, 3.7 times greater than Glanbrook, a community with the lowest level of LIM-AT prevalence in the city. Between 2016 and 2011, Hamilton Central had the lowest levels of emissions per student and saw the highest per student increase in 2016. Hamilton Center had the highest non-motorized trip potential, and it was reduced in part by the school closure policies.

Conversely, communities with the lowest LIM-AT benefit the most, notably in gains to motorized spatial availability. Glanbrook, Flamborough and Ancaster have the lowest prevalence of LIM-AT of any Hamilton Community and together account for `r SAvail_im_COMM_changes |> st_drop_geometry() |> filter(COMMUNITY == "FL" | COMMUNITY == "GL" | COMMUNITY == "AN") |> dplyr::select("kid_proportion_2016") |> sum() |> scales::percent()` of the 5-14 year old population in 2016. These communities experienced a growth in student population (or only a small decrease) and proportionally benefited from an increase in motorized spatial availability. 

Across the city, those who commute by non-motorized mode see the most drastic lose in spatial availability. In all communities, spatial availability decreases at greater levels than population. Notably in Dundas (2nd highest LIM-AT), the only school in the community closed, leaving the population in the community with no other option but to use motorized modes. Glanbrook (lowest LIM-AT), which experienced a relatively sharp increase in student population along with non-motorized using population, suffered a lose in non-motorized spatial availability despite seeing the highest increase in motorized spatial availability. Overall, the gain in motorized spatial availability resulted in a further erosion of non-motorized spatial availability. This erosion is related to a lose in potential active home-to-school travel minutes (`r ((SAvail_im_COMM_changes |> filter(mode == "non-motorized") |> pull(total_tt_2011)  |> sum()) -  (SAvail_im_COMM_changes |> filter(mode == "non-motorized") |> pull(total_tt_2016)  |> sum())) |> round(digit=2)` fewer minutes than in 2011, decreasing the potential active travel time per (all mode using) student from `r ((SAvail_im_COMM_changes |> filter(mode == "non-motorized") |> pull(total_tt_2011)  |> sum()) / (SAvail_im_COMM_changes |> st_drop_geometry() |> pull(kid_2011) |> sum())) |> round(digit=2)` to `r ((SAvail_im_COMM_changes |> filter(mode == "non-motorized") |> pull(total_tt_2016)  |> sum()) / (SAvail_im_COMM_changes |> st_drop_geometry() |> pull(kid_2016) |> sum())) |> round(digit=2)` minutes), as well as an increase in potential GHG emissions city-wide (`r (SAvail_im_COMM_changes |> st_drop_geometry() |> pull(emissions_2016) |> sum()) -  (SAvail_im_COMM_changes |> st_drop_geometry() |> pull(emissions_2011) |> sum()) |> round(digit=2)` kg $CO_2e$ more emission than in 2011, increasing the kg $CO_2e$ per child rate for home-to-school trips from `r ((SAvail_im_COMM_changes |> st_drop_geometry() |> pull(emissions_2011) |> sum()) / (SAvail_im_COMM_changes |> st_drop_geometry() |> pull(kid_2011) |> sum())) |> round(digit=2)` to `r ((SAvail_im_COMM_changes |> st_drop_geometry() |> pull(emissions_2016) |> sum()) / (SAvail_im_COMM_changes |> st_drop_geometry() |> pull(kid_2016) |> sum())) |> round(digit=2)`). 

# Conclusion

In this paper, we estimate the change in multimodal spatial availability as a result of school consolidations/closures between the years of 2011 and 2016 in an empirical case study of Hamilton, a mid-size city (\~570,000 pop) in Ontario, Canada [@governmentofcanadaProfileTableCensus2022]. The spatial availability and spatial availability per student are calculated at the parcel level and aggregated at the Canadian Census DA spatial unit and at the six Hamilton communities for comparison. Schools closed and the number of school seats decreased so spatial availability declined overall: we discuss where, for whom, and with what potential impacts.

Overall, the closure of `r ((ALL_SCHOOLS_Elem %>% filter(Year != "2016" & Level == "Elementary") %>% pull(SchoolID) %>% length() - ALL_SCHOOLS_Elem %>% filter(Year != "2011" & Level == "Elementary") %>% pull(SchoolID) %>% length())/ALL_SCHOOLS_Elem %>% filter(Year != "2016" & Level == "Elementary") %>% pull(SchoolID) %>% length()) %>% scales::percent()` of elementary schools in Hamilton between 2011 and 2016 resulted in `r (((SAvail_im_COMM_changes$V_im_2016 |> sum()) - (SAvail_im_COMM_changes$V_im_2011 |> sum()))  / SAvail_im_COMM_changes$V_im_2011 |> sum()) |> scales::percent()` decline in school-seat availability city-wide (`r (ALL_SCHOOLS_Elem %>% st_drop_geometry() %>% filter( (Year == "2011" | Year == "2011 and 2016") & Level == "Elementary") %>% dplyr::select(OTGC2011) %>% sum() - ALL_SCHOOLS_Elem %>% st_drop_geometry() %>% filter( (Year == "2016" | Year == "2011 and 2016") & Level == "Elementary") %>% dplyr::select(OTGC2016) %>% sum()) %>% prettyNum(big.mark=",", digits=1)` fewer school-seats), but specifically a `r (((SAvail_im_COMM_changes |> filter(mode == "non-motorized") |> pull(V_im_2016) |> sum()) - (SAvail_im_COMM_changes  |> filter(mode == "non-motorized") |> pull(V_im_2011) |> sum()))  / SAvail_im_COMM_changes  |> filter(mode == "non-motorized") |> pull(V_im_2011) |> sum()) |> scales::percent()` decline in non-motorized spatial availability. Though non-motorized modal share was low in both 2011 and 2016, the _potential_ for active transport trips was significantly eroded as schools within a 27 minute walk catchment were closed in the more densely populated and central areas of the city. Further, the communities with the highest LIM-AT prevalence were the most impacted: communities like Hamilton Central and Dundas saw the most drastic loss in non-motorized spatial availability while communities with lower LIM-AT prevalence saw gains in motorized spatial availability (as a handful of rural schools opened). The motivation of operational savings associated with public service consolidation for the school boards did not account for the mobility-related burdens _certain_ families are now saddled with. 

In addition to spatial availability impacts, associated mobility measures are assessed. City-wide, home-to-school non-motorized minutes (for a one-way trip) reduced by `r SAvail_im_COMM_changes |> st_drop_geometry() |> filter(mode == "non-motorized") |> transmute(total_tt = total_tt_2016-total_tt_2011) |> sum() %>% abs() %>% prettyNum(big.mark=",", digits=1)` and GHG emissions associated with motorized home-to-school travel increased by `r SAvail_im_COMM_changes |> st_drop_geometry() |> filter(mode == "motorized") |> transmute(emissions = emissions_2016-emissions_2011) |> sum() %>% abs() %>% prettyNum(big.mark=",", digits=1)` kg $CO_2e$. The decision to consolidate schools, increase the length of motorized travel and decrease the potential for non-motorized impacts will have daily impacts on students and their families [@mandicAdolescentsPerceptionsWalking2022; @pabayoImportanceActiveTransportation2012], the broader community [@pietrabissaSchoolAccessCity2023;@MerrallWhatsASchool2024; @bittencourtEvaluatingAccessibilityAvailability2023] and the environment [@pantelakiImpactHomeschoolCommuting2024; @rongReviewResearchLowcarbon2022]. 

Like many other localities [@Lee_Lubienski_2017; @Autti_Hyry-Beihammer_2014; @Beuchert_Humlum_Nielsen_Smith_2018], Hamilton is not immune to top-down operational efficiency assessments that determine if community infrastructure is underutilized and closed. From the perspective of the provincial government of Ontario, the school closures which occurred in Hamilton resulted in operational savings-per-student. We demonstrate how these decisions resulted in both families and students paying a price through spatial availability, lost potential walk minutes, and increased GHG emissions.
 
By quantifying the spatial availability, environmental, and active-travel implications of school closure/consolidation policies in Hamilton, our paper offers a methodology for spatial policy analysis scenario. The presented methodology can be used by researchers and decision-makers to plan and evaluate equitable and sustainable urban planning policies from a spatial perspective. At the core of the method is spatial availability [@soukhovIntroducingSpatialAvailability2023; @soukhovMultimodalSpatialAvailability2024], a singly-constrained accessibility measure that can be calculated at the finest spatial resolution (in our paper, parcel-level) and aggregated at whichever spatial unit is most meaningful for interpretation. We urge policy-makers to view the 'spatial availability' of public resources from a per-capita perspective, plan capacity and location of service provision with the cost of travel (and associated implications such as GHG emissions, active transportation mode, safety of active travel modes, etc.) that sufficiently serves the target population. In this work, we suggest and assume a benchmark of 1.0 school-seats per student which accounts for sufficiency. Spatial availability can be used to obtain this benchmark since the total number of opportunities (i.e., school capacity) is preserved in the region of analysis unlike unconstrained forms of accessibility measurement e.g., Hansen-type measure [@hansenHowAccessibilityShapes1959]. As such, the assigned spatial availability can be divided by population at each zone to yield an interpretable per capita measurement.

Ultimately, this case study furnishes evidence that consolidation of schools was particularly ill-timed: with the advent of the COVID-19 pandemic, the education system lacked the resiliency to accommodate reduced classroom capacities and left parents who once lived within active transportation distance to schools relying on motorized transportation for their children. These top-down austerity measures left the Hamilton local school system more vulnerable to the impacts of COVID-19 by undervaluing the societal role of schools in neighbourhoods. By identifying the impact of school consolidation policies in Ontario we anticipate that researchers and decision-makers will have better information to center the wellbeing of all residents, including students, and the planet in urban planning policies.  

As with all studies, our work is associated with limitations on how results should be interpreted. The calculated spatial availability assumes any residential parcel can have a student (at the DA rate of students per residential unit) so all parcels are assigned a DA rate weighted by how many residential units are contained within the parcel. Each parcel can also visit any school, though travel times based on observed origin-destination behaviour (from the TTS) are more likely through the use of the empirical travel impedance functions. In this way, the spatial availability demonstrates what _potential interaction_ a student could have based on historic and average travel behaviour and shortest network-path travel times if residing in point in space. This representation is average, and by design obfuscates considerations that could make non-average and shortest-path travel unrealistic such as safety and built-environment concerns [@leeNeighborhoodEnvironmentsUtilitarian2021; @yumitaSchoolCommutingBarriers2021] nor considers significant non-transportation factors [@palmRolePublicTransit2020]. Further, this study does not consider transit, school-bus, or cycling modes which have implications on how the GHG emissions estimation can be interpreted. Transit and school bus modes often taken more circuitous routes [@yumitaSchoolCommutingBarriers2021] but pool students thereby reducing emissions. Cycling reduces travel time over the same walking distance at no extra emitted GHG. Lastly, this study also ascribes a static emission factor to represent motorized travel minutes based on an average diesel passenger car. In reality, GHG emissions emitted per minute of driving varies extensively depending on operating conditions and vehicle characteristics [@soukhovOccupancyGHGEmissions2022]. In these ways, the assumptions made are to illustrate _potential_ and _average_ changes that resulted in a backdrop of school consolidation/closures to illustrate accessibility-related impacts for the city of Hamilton.

# Declarations

**Ethical approval**
Not applicable

**Participate consent**
Not applicable

**Competing interests**
The authors declare there are no personal or financial conflicts of interest. 

**Authors' contributions**
A.S., A.P., C.D.H., and M.M. all contributed to the study conception and design. Material preparation, data collection
and formal analysis were performed by A.S., A.P, and C.D.H. All visuals and the first draft of the manuscript was written by A.S. A.S., A.P., C.D.H., and M.M. commented on earlier versions of the manuscript. A.S., A.P., C.D.H., and M.M.  reviewed the final manuscript.

**Funding declaration**
This work was supported by the Mobilizing Justice Partnership and the Canada Graduate ScholarshipsâDoctoral Program from the Social Sciences and Humanities Research Council of Canada (SSHRC).

**Availability of data and materials**
The manuscript text, code, analysis and data supporting this work is available in the lead author's GitHub repository : https://github.com/soukhova/School-closures-accessibility-impacts

\pagebreak

# References

::: {#refs}
:::

\pagebreak

# Appendix

\input{TabA1.tex} 
<!--made in the hamONdests repo-->