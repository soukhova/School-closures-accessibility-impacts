---
title: "Ten years of school closures and consolidations in Hamilton, Canada and the impact on multimodal accessibility"
bibliography: 
  - "`r system('kpsewhich ../bibliography/bibliography.bib', intern=TRUE)`"
format:
  nature-pdf: 
    journal: "default"
    keep-tex: true
editor: source
execute: 
  freeze: auto
author:
  - name: "Anastasia Soukhov"
    email: "soukhoa@mcmaster.ca"
    affiliations:
      - id: 1
        address: "School of Earth, Environment and Society, McMaster University, 1241 Main St. West, Hamilton, ON, L8S 4K1, Canada"
    attributes:
      corresponding: true
  - name: "Christopher D. Higgins"
    email: "cd.higgins@utoronto.ca"
    affiliations:
      - id: 2
        address: "Department of Human Geography, University of Toronto Scarborough, 1265 Military Trail, Toronto, ON, M1C 1A4, Canada"
  - name: "Antonio PÃ¡ez"
    email: "paezha@mcmaster.ca"
    affiliations:
      - id: 1
        address: "School of Earth, Environment and Society, McMaster University, 1241 Main St. West, Hamilton, ON, L8S 4K1, Canada"
  - name: "Moataz Mohamed"
    email: "mmohame@mcmaster.ca"
    affiliations:
      - id: 3
        address: "Department of Civil Engineering, McMaster University, 1241 Main St. West, Hamilton, ON, L8S 4K1, Canada"
abstract: | 
  | Reducing motorized travel and increased active travel are top priorities for many communities. However, these goals are challenged by pressures that make governments reluctant to re/invest in public services, including schools. Public school boards are increasingly asked to do more with less, a directive often accomplished by closing and consolidating schools. Such policies can reduce the proximity of schools for many students, thereby limiting opportunities for active travel. In this paper, we examine the City of Hamilton, a mid-sized city in Ontario, Canada, which saw numerous elementary schools closures between 2011 and 2021. Our analysis evaluates how school closures and consolidations reshaped accessibility for elementary school students, both by motorized and active travel. We use spatial availability, a singly-constrained multimodal measure of spatial accessibility. This method's proportional allocation mechanisms allow us to make consistent comparisons in accessibility between time periods. The analysis is conducted at the parcel level, taking into account the on-the-ground-capacity (OTGC) of schools and observed home-to-school trip lengths for motorized and active modes. Overall, our findings reveal a decline in school spatial availability in the city. While the school closure and consolidation policy pursued by the province may have achieved cost savings in facility operation and maintenance, it imposed ongoing costs on students, families, and communities through reduced opportunities for physical activity and entrenched reliance on motorized travel.
  
keywords: [accessibility; spatial availability; carbon emissions; journey-to-school; walkability; active transportation; school consolidation policy; service provision thresholds]
---
<!--NOTE WHEN PREPARING THE .TEX for journal submission I ran into errors as their system uses PDFlatex+Bibtex to compile. The following packages only work in lualatex, so do the following:
- remove "  \usepackage[T1]{fontenc}" 
- remove "\usepackage{fontspec}" 
- add "\DeclareUnicodeCharacter{394}{$\Delta$}" to the tex preamble (this is because PHDtex does not recognize unicode? So need to explicitly define) (add to line 5) -->

<!--Chat with Antonio about the assumption regarding the 'student population' per parcel. As it stands, when the student pop for the OD matrix is summed, it equals the total student population in the city. Each parcel is assigned a DA-pop/(the number of potential parcel trips in a DA * the potential parcels trips from that parcel). This is highly correlated with the value just weighted by DA-pop/DA-dwellings (but need to double check).  --->

```{r knitr-setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  cache = FALSE,
  warning = FALSE,
  message = FALSE,
  comment = '', 
  out.width = "1\\linewidth")
```

```{r, include=FALSE}
rm(list=ls())
```

```{r, include=FALSE}
library(dplyr) # A Grammar of Data Manipulation
library(ggplot2) # Create Elegant Data Visualisations Using the Grammar of Graphics
library(ggspatial) # Spatial Data Framework for ggplot2
library(here) # A Simpler Way to Find Your Files
library(patchwork) # The Composer of Plots
library(scales) # Scale Functions for Visualization
library(sf) # Simple Features for R
library(stplanr) # Sustainable Transport Planning
library(tidyverse) # Easily Install and Load the 'Tidyverse'
library(tmap) # Thematic Maps
library(units) # Measurement Units for R Vectors
library(miscTools) # Miscellaneous Tools and Utilities
# library(huxtable)
library(tiff)
library(grid)
library(cowplot)
library(flextable)
library(gt)
```

```{r, include=FALSE}
#lake and bay for mapping purposes
hydro_p_LakeOntario <- st_read(paste0(here::here(),"/data-prep/data-inputs/Boundaries/hydro_p_LakeOntario.shp")) |> st_transform(crs=4326)

ham_bay <- st_read(paste0(here::here(),"/data-prep/data-inputs/Boundaries/Waterbodies.shp")) |> st_transform(crs=4326) |> filter(FEATURE_TY == "Lake")
```

```{r, include=FALSE}
load(paste0(here::here(),file="/data-prep/data-products/cen_data_2011_hamiltononly.RData"))
cen_data_2011_hamiltononly <- cen_data_2011_1 |> filter(`Region Name` == "Hamilton") #NOTE: GEOUID 35250242, 35250133, 35250457 do not have any child population
rm("cen_data_2011_1")
load(paste0(here::here(),file="/data-prep/data-products/cen_data_2016_hamiltononly.RData"))
cen_data_2016_hamiltononly <- cen_data_2016_1 |> filter(`Region Name` == "Hamilton") #NOTE: GEOUID 35250133, 35250398, 35250427 do not have any child population
rm("cen_data_2016_1")
load(paste0(here::here(),file="/data-prep/data-products/cen_data_2021_hamiltononly.RData"))
cen_data_2021_hamiltononly <- cen_data_2021_1 
rm("cen_data_2021_1")

ham_city_bound <- st_read(paste0(here::here(),"/data-prep/data-inputs/Boundaries/City_Boundary.shp"),
                          quiet = TRUE) |> st_transform(st_crs(cen_data_2016_hamiltononly))

#Add % urbanization to the label for ham_community_bounds
# SAvail_im_DA <- left_join(SAvail_im_DA, DA_2021_URBvsRUR, by="GeoUID")
# 
# SAvail_im_DA |> filter(mode == "Motorized") |> st_drop_geometry() |> group_by(COMMUNITY) |> 
#   summarise(perc_urb = mean(perc_urb, na.rm=TRUE))

ham_community_bounds <- st_read(paste0(here::here(),"/data-prep/data-inputs/Boundaries/Community_Boundaries.shp"),quiet = TRUE) |> 
  st_transform(st_crs(cen_data_2016_hamiltononly)) |> 
  mutate(COMMUNITY = case_when(COMMUNITY_ == "Ancaster" ~ "AN",
                               COMMUNITY_ == "Dundas" ~ "DU",
                               COMMUNITY_ == "Flamborough" ~ "FL",
                               COMMUNITY_ == "Glanbrook" ~ "GL",
                               COMMUNITY_ == "Hamilton" ~ "HA",
                               COMMUNITY_ == "Stoney Creek" ~ "SC")) |> st_transform(st_crs(cen_data_2016_hamiltononly)) |> 
  mutate(COMMUNITY_URB = case_when(COMMUNITY == "AN" ~ "Ancaster (87%)",
                               COMMUNITY == "DU" ~ "Dundas (96%)",
                               COMMUNITY == "FL" ~ "Flamborough (37%)",
                               COMMUNITY == "GL" ~ "Glanbrook (47%)",
                               COMMUNITY == "HA" ~ "Hamilton Central (100%)" ,
                               COMMUNITY == "SC" ~"Stoney Creek (94%)"),
         COMMUNITY_ = ifelse(COMMUNITY=="HA", "Hamilton Central", COMMUNITY_))

ggh_taz <- st_read(paste0(here::here(),"/data-prep/data-inputs/TTS/tts06_83_region.shp")) |> st_transform(st_crs(cen_data_2011_hamiltononly))
```

```{r, include=FALSE}
cen_data_2011_hamiltononly <- 
  cen_data_2011_hamiltononly %>% dplyr::select( #removing the variables we don't need for this analysis
  -c("Shape Area", "Quality Flags", "Type", "CD_UID", "NHS Non-Return Rate", "CSD_UID", "CT_UID", "CT_UID","NHS Non Return Rate", "v_CA11N_2564: Median after-tax household income $", "v_CA11F_17: 15 to 19 years")) %>%
  rename( #renaming the variables
    "DA_households" = "Households",
    "DA_dwellings" = "Dwellings",
    "DA_tot_pop" = "Population",
    "DA_med_AT_family_income" = "v_CA11N_2458: Median after-tax family income $",
    "DA_med_AT_lone-family_income" = "v_CA11N_2476: Median after-tax family income $",
    "DA_prev_LIMAT_under18" = "v_CA11N_2609: Less than 18 years %",
    "DA_pop_5to9" = "v_CA11F_11: 5 to 9 years",
    "DA_pop_10to14" = "v_CA11F_14: 10 to 14 years") %>%
  mutate(DA_pop_5to14 = DA_pop_5to9+(DA_pop_10to14)) |> #*0.9)) %>%
  dplyr::select(-c("DA_pop_5to9","DA_pop_10to14"))

cen_data_2016_hamiltononly <- 
  cen_data_2016_hamiltononly %>% dplyr::select( #removing the variables we don't need for this analysis
  -c("Shape Area",  "Type", "CD_UID", "CSD_UID", "CT_UID", "CT_UID", "v_CA16_2398: Median after-tax income of households in 2015 ($)",  "v_CA16_64: 15 to 19 years"  )) %>%
  rename( #renaming the variables
    "DA_households" = "Households",
    "DA_dwellings" = "Dwellings",
    "DA_tot_pop" = "Population",
    "DA_med_AT_family_income" = "v_CA16_2448: Median after-tax income of economic families in 2015 ($)",
    "DA_med_AT_lone-family_income" = "v_CA16_2460: Median after-tax income of lone-parent economic families in 2015 ($)",
         "DA_prev_LIMAT_under18" = "v_CA16_2543: 0 to 17 years (%)",
         "DA_pop_5to9" = "v_CA16_25: 5 to 9 years",
         "DA_pop_10to14" = "v_CA16_43: 10 to 14 years") %>% mutate(DA_pop_5to14 = DA_pop_5to9+(DA_pop_10to14)) |> #*0.9)) %>%
         dplyr::select(-c("DA_pop_5to9","DA_pop_10to14"))


cen_data_2021_hamiltononly <- 
  cen_data_2021_hamiltononly %>% dplyr::select( #removing the variables we don't need for this analysis
  -c("Shape Area",  "Type", "CD_UID", "CSD_UID", "CT_UID", "CT_UID", "v_CA21_566: Median after-tax income in 2020 among recipients ($)" ,"v_CA21_71: 15 to 19 years")) %>%
  rename( #renaming the variables
    "DA_households" = "Households",
    "DA_dwellings" = "Dwellings",
    "DA_tot_pop" = "Population",
    "DA_med_AT_family_income" = "v_CA21_966: Median after-tax income of economic family in 2020 ($)",
    "DA_med_AT_lone-family_income" = "v_CA21_978: Median after-tax income of one-parent economic families in 2020 ($)",
    "DA_prev_LIMAT_under18" =  "v_CA21_1043: 0 to 17 years",
    "DA_pop_5to9" = "v_CA21_32: 5 to 9 years",
    "DA_pop_10to14" = "v_CA21_50: 10 to 14 years") %>%
    mutate(DA_pop_5to14 = DA_pop_5to9+(DA_pop_10to14)) |> #*0.9)) %>%
         dplyr::select(-c("DA_pop_5to9","DA_pop_10to14"))

#adding $ URBAN to the 2021 census DA file... retrieved from parcel points. No other year of parcel points provide this information 
load(paste0(here::here(),file="/data-prep/data-products/DA_2021_URBvsRUR.RData"))
cen_data_2021_hamiltononly <- cen_data_2021_hamiltononly |> left_join(DA_2021_URBvsRUR, by="GeoUID")
```

```{r, include=FALSE}
# library(hamONdests) # A R package of Hamilton, Ontario destinations
load(file=paste0(here::here(),"/data-prep/data-products/SCHOOLS.Rdata")) #for this paper, the schools under analysis

# add community label to schools
SCHOOLS <- st_intersection(ham_community_bounds,
                        SCHOOLS |> st_transform(st_crs(cen_data_2016_hamiltononly)))

# data(School_Catchments_2011_2016)
# ALL_SCHOOLS_CATCH_Elem <- School_Catchments_2011_2016 %>% filter(Level == "Elementary")
# rm("School_Catchments_2011_2016")

load(file = paste0(here::here(),"/data-prep/data-products/TTS_gamma2011_motor.Rdata"))
load(file = paste0(here::here(),"/data-prep/data-products/TTS_gamma2016_motor.Rdata"))
load(file = paste0(here::here(),"/data-prep/data-products/TTS_exp2011_nonmotor.Rdata"))
load(file = paste0(here::here(),"/data-prep/data-products/TTS_exp2016_nonmotor.Rdata"))
```

```{r formatting-schools-for-mapping, include=FALSE}
#reformatting schools for mapping
ALL_SCHOOLS_Elem_formapping_11 <- SCHOOLS |>
  filter(Year == "2011 and 2016" & Year_2 == "2016 and 2021" & Status == "NoChange" & Status_2 == "NoChange") |>
  mutate(combo_status = "1) No change",
         combo_year = "2011",
         OTGC = OTGC2011) 
ALL_SCHOOLS_Elem_formapping_12 <- SCHOOLS |>
  filter(Year == "2011 and 2016" & Year_2 == "2016 and 2021" & Status == "NoChange" & Status_2 == "NoChange") |>
  mutate(combo_status = "1) No change",
         combo_year = "2016",
         OTGC = OTGC2016) 
ALL_SCHOOLS_Elem_formapping_13 <- SCHOOLS |>
  filter(Year == "2011 and 2016" & Year_2 == "2016 and 2021" & Status == "NoChange" & Status_2 == "NoChange") |>
  mutate(combo_status = "1) No change",
         combo_year = "2021",
         OTGC = OTGC2021) 

ALL_SCHOOLS_Elem_formapping_21 <- SCHOOLS |>
  filter(Year == "2011 and 2016" & Year_2 == "2016 and 2021" & Status == "Expanded" & Status_2 == "NoChange") |>
  mutate(combo_status = "2) Expanded between 2011-16",
         combo_year = "2011",
         OTGC = OTGC2011)
ALL_SCHOOLS_Elem_formapping_22 <- SCHOOLS |>
  filter(Year == "2011 and 2016" & Year_2 == "2016 and 2021" & Status == "Expanded" & Status_2 == "NoChange") |>
  mutate(combo_status = "2) Expanded between 2011-16",
         combo_year = "2016",
         OTGC = OTGC2016)
ALL_SCHOOLS_Elem_formapping_23 <- SCHOOLS |>
  filter(Year == "2011 and 2016" & Year_2 == "2016 and 2021" & Status == "Expanded" & Status_2 == "NoChange") |>
  mutate(combo_status = "2) Expanded between 2011-16",
         combo_year = "2021",
         OTGC = OTGC2021)

ALL_SCHOOLS_Elem_formapping_31 <- SCHOOLS |>
  filter(Year == "2016" & Year_2 == "2016 and 2021" & Status == "Moved" & Status_2 == "NoChange") |>
  mutate(combo_status = "3) Relocated + expanded between 2011-16",
         combo_year = "2016",
         OTGC = OTGC2016)
ALL_SCHOOLS_Elem_formapping_32 <- SCHOOLS |>
  filter(Year == "2016" & Year_2 == "2016 and 2021" & Status == "Moved" & Status_2 == "NoChange") |>
  mutate(combo_status = "3) Relocated + expanded between 2011-16",
         combo_year = "2021",
         OTGC = OTGC2021)

ALL_SCHOOLS_Elem_formapping_41 <- SCHOOLS |>
  filter(Year == "2011" & is.na(Year_2) & Status == "Moved" & is.na(Status_2)) |>
  mutate(combo_status = "3) Relocated + expanded between 2011-16",
         combo_year = "2011",
         OTGC = OTGC2011) 

ALL_SCHOOLS_Elem_formapping_51 <- SCHOOLS |>
  filter(Year == "2016" & Year_2 == "2016 and 2021" & Status == "New" & Status_2 == "NoChange") |>
  mutate(combo_status = "6) Opened between 2011-16",
         combo_year = "2016",
         OTGC = OTGC2016) 
ALL_SCHOOLS_Elem_formapping_52 <- SCHOOLS |>
  filter(Year == "2016" & Year_2 == "2016 and 2021" & Status == "New" & Status_2 == "NoChange") |>
  mutate(combo_status = "6) Opened between 2011-16",
         combo_year = "2021",
         OTGC = OTGC2021) 

ALL_SCHOOLS_Elem_formapping_81 <- SCHOOLS |>
  filter(is.na(Year) & Year_2 == "2021" & is.na(Status) & Status_2 == "New") |>
  mutate(combo_status = "7) Opened between 2016-21",
         combo_year = "2021",
         OTGC = OTGC2021) 

ALL_SCHOOLS_Elem_formapping_71 <- SCHOOLS |>
  filter(Year == "2011" & is.na(Year_2) & Status == "Removed" & is.na(Status_2)) |>
  mutate(combo_status = "4) Closed between 2011-16",
         combo_year = "2011",
         OTGC = OTGC2011) 

ALL_SCHOOLS_Elem_formapping_61 <- SCHOOLS |>
  filter(Year == "2011 and 2016" & Year_2 == "2016" & Status == "NoChange" & Status_2 == "Removed") |>
  mutate(combo_status = "5) Closed between 2016-21",
         combo_year = "2011",
         OTGC = OTGC2011) 

ALL_SCHOOLS_Elem_formapping_62 <- SCHOOLS |>
  filter(Year == "2011 and 2016" & Year_2 == "2016" & Status == "NoChange" & Status_2 == "Removed") |>
  mutate(combo_status = "5) Closed between 2016-21",
         combo_year = "2016",
         OTGC = OTGC2016) 

ALL_SCHOOLS_Elem_formapping <- rbind(
  ALL_SCHOOLS_Elem_formapping_11,ALL_SCHOOLS_Elem_formapping_12, ALL_SCHOOLS_Elem_formapping_13,
  ALL_SCHOOLS_Elem_formapping_21,ALL_SCHOOLS_Elem_formapping_22,ALL_SCHOOLS_Elem_formapping_23, 
  ALL_SCHOOLS_Elem_formapping_31,ALL_SCHOOLS_Elem_formapping_32, 
  ALL_SCHOOLS_Elem_formapping_41,
  ALL_SCHOOLS_Elem_formapping_51,ALL_SCHOOLS_Elem_formapping_52,
  ALL_SCHOOLS_Elem_formapping_61,ALL_SCHOOLS_Elem_formapping_62,
  ALL_SCHOOLS_Elem_formapping_71,
  ALL_SCHOOLS_Elem_formapping_81
  )

rm(ALL_SCHOOLS_Elem_formapping_11,ALL_SCHOOLS_Elem_formapping_12, ALL_SCHOOLS_Elem_formapping_13,
  ALL_SCHOOLS_Elem_formapping_21,ALL_SCHOOLS_Elem_formapping_22,ALL_SCHOOLS_Elem_formapping_23, 
  ALL_SCHOOLS_Elem_formapping_31,ALL_SCHOOLS_Elem_formapping_32, 
  ALL_SCHOOLS_Elem_formapping_41,
  ALL_SCHOOLS_Elem_formapping_51,ALL_SCHOOLS_Elem_formapping_52,
  ALL_SCHOOLS_Elem_formapping_61,ALL_SCHOOLS_Elem_formapping_62,
  ALL_SCHOOLS_Elem_formapping_71,
  ALL_SCHOOLS_Elem_formapping_81)
```

```{r descriptive-schools-plot, eval=FALSE}
tmap_defaults <-
  tm_scale_bar(position = c("LEFT", "BOTTOM"), breaks = c(0, 5, 10, 15))+
  tm_compass(size = 1.5, position = c("right", 'top')) +
  tm_layout(legend.position = c("left", "top")) #legend.hist.size = 10,

schools_plot <-
  tm_shape(ham_bay, bbox=ham_community_bounds) + tm_polygons(col="lightblue", border.alpha = 0) +
  tm_shape(hydro_p_LakeOntario, bbox=ham_community_bounds) + tm_polygons(col="lightblue", border.alpha = 0)+
  
  tm_shape(cen_data_2021_hamiltononly |> filter(!is.na(perc_urb))) +
  tm_polygons(col = "perc_urb", border.alpha=0, 
              alph=0.7,
              palette = c("yellow3","yellow4"),
              #labels = c("[0-50%)", "[25-50%)", "[50-75%)","[75-100%]"),
              breaks = c(0,  0.25, .5, .75,  1),
              legend.is.portrait = FALSE,
              style="cont",
              title = "% Urbanisation") +
  
  tm_shape(ALL_SCHOOLS_Elem_formapping) +
  tm_symbols(shape = "combo_status",
             col="grey85",
             size= "OTGC",
             alpha=0.9,
             scale = 0.4,
             shapes = c(1,
                        17,24,
                        15,22,
                        18, 23),
          title.shape = "School status",
          title.size = "OTGC",
          shapes.labels =  c(
          "No change (btwn 2011-21)", 
          "Expanded (btwn 2011-16)", 
          "Relocated + expanded (btwn 2011-16)",
          "Closed (btwn 2011-16)", 
          "Closed (btwn 2016-21)",
          "Opened (btwn 2011-16)", 
          "Opened (btwn 2016-21)")) +
  tm_facets(by=c("System","combo_year"), nrow = 3)+
  
  tm_credits(c("52 schools open\n(18,771 OTGC)","49 schools open\n(18,039 OTGC)", "49 schools open\n(18,218 OTGC)",
                "95 schools open\n(41,796 OTGC)","88 schools open\n(40,249 OTGC)","83 schools open\n(39,478 OTGC)"),
             position = c("LEFT", "BOTTOM")) +
  tm_shape(ham_city_bound)+  tm_borders(col = "grey80", lwd=0.5)+
  tmap_defaults +
  tm_layout(bg.color = "grey99",
            panel.labels = list(c('HWDCSB (Catholic Public)','HWDSB (Public)'),
                                c('2011','2016','2021')),
            panel.label.bg.color = "white")

tmap_save(schools_plot, paste0(here::here(),"/Figures/Fig2.tiff"), height=4.5, width=10, dpi=600)
```

```{r,include=FALSE}
load(file = paste0(here::here(),"/data-prep/data-products/avail_2011.RData"))
load(file = paste0(here::here(),"/data-prep/data-products/avail_2016.RData"))
load(file = paste0(here::here(),"/data-prep/data-products/avail_2021.RData"))
```

```{r cache=FALSE}
community_car_perc_2011 <- avail_2011 |>
  group_by(COMMUNITY) |> 
  summarize(TAZOrig_car_perc = mean(TAZOrig_car_perc, na.rm=T))

community_car_perc_2016 <- avail_2016 |> group_by(COMMUNITY) |> summarize(TAZOrig_car_perc = mean(TAZOrig_car_perc, na.rm=T))
```

```{r, include=FALSE}
#check to make sure that V_i is equal to the total capacity in Hamilton. It is!
avail_2011$V_ij %>% sum()
SCHOOLS$OTGC2011 %>% sum(na.rm = TRUE)

avail_2016$V_ij %>% sum()
SCHOOLS$OTGC2016 %>% sum(na.rm = TRUE)

avail_2021$V_ij %>% sum()
SCHOOLS$OTGC2021 %>% sum(na.rm = TRUE)

#this should equal 58,265, still does -- great!
avail_2011 %>%
  group_by(ID) %>%
  summarize(kid_popadj = sum(kid_popadj)) |> dplyr::select(kid_popadj) %>% sum()

#this should equal 58,865, still does -- great!
avail_2016 %>%
  group_by(ID) %>%
  summarize(kid_popadj = sum(kid_popadj)) |> dplyr::select(kid_popadj) %>% sum()

#this should equal 62195, still does -- great!
avail_2021 %>%
  group_by(ID) %>%
  summarize(kid_popadj = sum(kid_popadj)) |> dplyr::select(kid_popadj) %>% sum()
```

```{r}
#calc spatial availability and other associated variables at the DA 2011 level
SAvail_im_DA2011 <- avail_2011 %>%
  group_by(GeoUID, 
           mode) %>%
  summarize(COMMUNITY = first(COMMUNITY),
            total_tt = sum(travel_time_p50*kid_popadj),
            V_im = sum(V_ij),
            kid_popadj_m = sum(kid_popadj),
            DA_pop_5to14 = mean(DA_pop_5to14, na.rm=T),
            DA_prev_LIMAT_under18 = mean(DA_prev_LIMAT_under18),
            .groups = "drop") |>
  mutate(emissions_total_car_tt = ifelse(mode == "c", 0.1*total_tt, 0),
         v_im_kid_popadj = V_im/kid_popadj_m,
         v_im_kid_popadj_LIMAT = v_im_kid_popadj*(DA_prev_LIMAT_under18/100),
         v_im_kid_popadj_LIMAT = ifelse(is.na(v_im_kid_popadj_LIMAT) | is.nan(v_im_kid_popadj_LIMAT), 0, v_im_kid_popadj_LIMAT),
         V_i_kid_popadj_LIMAT = V_im*(DA_prev_LIMAT_under18/100),
         V_i_kid_popadj_LIMAT = ifelse(is.na(V_i_kid_popadj_LIMAT) | is.nan(V_i_kid_popadj_LIMAT), 0, V_i_kid_popadj_LIMAT)) |>
  filter(GeoUID != 35250242 & GeoUID != 35250133 & GeoUID != 35250457 ) #these GeoUID's have 0 kid population, so let's drop so we don't have zeros

#calc spatial availability and other associated variables at the DA 2016 level
SAvail_im_DA2016 <- avail_2016 %>%
  group_by(GeoUID, 
           mode) %>%
  summarize(COMMUNITY = first(COMMUNITY),
            total_tt = sum(travel_time_p50*kid_popadj),
            V_im = sum(V_ij),
            kid_popadj_m = sum(kid_popadj),
            DA_pop_5to14 = mean(DA_pop_5to14, na.rm=T),
            DA_prev_LIMAT_under18 = mean(DA_prev_LIMAT_under18),
            .groups = "drop") |>
  mutate(emissions_total_car_tt = ifelse(mode == "c", 0.1*total_tt, 0),
         v_im_kid_popadj = V_im/kid_popadj_m,
         v_im_kid_popadj = ifelse(is.na(v_im_kid_popadj) | is.nan(v_im_kid_popadj), 0, v_im_kid_popadj),
         v_im_kid_popadj_LIMAT = v_im_kid_popadj*(DA_prev_LIMAT_under18/100),
         v_im_kid_popadj_LIMAT = ifelse(is.na(v_im_kid_popadj_LIMAT) | is.nan(v_im_kid_popadj_LIMAT), 0, v_im_kid_popadj_LIMAT),
         V_i_kid_popadj_LIMAT = V_im*(DA_prev_LIMAT_under18/100),
         V_i_kid_popadj_LIMAT = ifelse(is.na(V_i_kid_popadj_LIMAT) | is.nan(V_i_kid_popadj_LIMAT), 0, V_i_kid_popadj_LIMAT)) |>
  filter(GeoUID != 35250398 & GeoUID != 35250133 & GeoUID != 35250427 ) #these GeoUID's have 0 kid population, so let's drop so we don't have zeros

#calc spatial availability and other associated variables at the DA 2021 level
SAvail_im_DA2021 <- avail_2021 %>%
  group_by(GeoUID, 
           mode) %>%
  summarize(COMMUNITY = first(COMMUNITY),
            total_tt = sum(travel_time_p50*kid_popadj),
            V_im = sum(V_ij),
            kid_popadj_m = sum(kid_popadj),
            DA_pop_5to14 = mean(DA_pop_5to14, na.rm=T),
            DA_prev_LIMAT_under18 = mean(DA_prev_LIMAT_under18),
            .groups = "drop") |>
  mutate(emissions_total_car_tt = ifelse(mode == "c", 0.1*total_tt, 0),
         v_im_kid_popadj = V_im/kid_popadj_m,
         v_im_kid_popadj = ifelse(is.na(v_im_kid_popadj) | is.nan(v_im_kid_popadj), 0, v_im_kid_popadj),
         v_im_kid_popadj_LIMAT = v_im_kid_popadj*(DA_prev_LIMAT_under18/100),
         v_im_kid_popadj_LIMAT = ifelse(is.na(v_im_kid_popadj_LIMAT) | is.nan(v_im_kid_popadj_LIMAT), 0, v_im_kid_popadj_LIMAT),
         V_i_kid_popadj_LIMAT = V_im*(DA_prev_LIMAT_under18/100),
         V_i_kid_popadj_LIMAT = ifelse(is.na(V_i_kid_popadj_LIMAT) | is.nan(V_i_kid_popadj_LIMAT), 0, V_i_kid_popadj_LIMAT)) |>
  filter(GeoUID != 35250211 & GeoUID != 35250242 & GeoUID != 35250491 & GeoUID != 35250982 ) #these GeoUID's have 0 kid population, so let's drop so we don't have zeros
```

```{r}
#add the geometries -- census DAs
SAvail_im_DA2011 <- SAvail_im_DA2011 |>
  left_join(cen_data_2011_hamiltononly |> dplyr::select(GeoUID), by="GeoUID") |> st_set_geometry("geometry")

SAvail_im_DA2016 <- SAvail_im_DA2016 |>
  left_join(cen_data_2016_hamiltononly |> dplyr::select(GeoUID), by="GeoUID") |> st_set_geometry("geometry")

SAvail_im_DA2021 <- SAvail_im_DA2021 |>
  left_join(cen_data_2021_hamiltononly |> dplyr::select(GeoUID), by="GeoUID") |> st_set_geometry("geometry")

#Create 1 sf with data joined (no changes, just 2011 and 2016)
SAvail_im_DA <-
  rbind(SAvail_im_DA2011 |> mutate(year ="2011"),
        SAvail_im_DA2016 |> mutate(year ="2016"),
        SAvail_im_DA2021 |> mutate(year ="2021")) |>
  mutate(mode = case_when(mode == "c" ~ "Motorized",
                          mode == "w" ~ "Non-motorized"))
```

```{r}
#calc changes between the years - but do it all at the 2021 DA grid. So let's calculate all SAvails at the level of the 2021 grid. 

#first for 2011 @ 2021 grid
SAvail_im_DA2011_forGeoUID2021 <- avail_2011 %>%
  group_by(GeoUID_2021, 
           mode) %>%
  summarize(COMMUNITY = first(COMMUNITY),
            total_tt = sum(travel_time_p50*kid_popadj),
            V_im = sum(V_ij),
            kid_popadj_m = sum(kid_popadj),
            DA_pop_5to14 = mean(DA_pop_5to14, na.rm=T),
            DA_prev_LIMAT_under18 = mean(DA_prev_LIMAT_under18),
            .groups = "drop") |>
  mutate(emissions_total_car_tt = ifelse(mode == "c", 0.1*total_tt, 0),
         v_im_kid_popadj = V_im/kid_popadj_m,
         v_im_kid_popadj = ifelse(is.na(v_im_kid_popadj) | is.nan(v_im_kid_popadj), 0, v_im_kid_popadj),
         v_im_kid_popadj_LIMAT = v_im_kid_popadj*(DA_prev_LIMAT_under18/100),
         v_im_kid_popadj_LIMAT = ifelse(is.na(v_im_kid_popadj_LIMAT) | is.nan(v_im_kid_popadj_LIMAT), 0, v_im_kid_popadj_LIMAT),
         V_i_kid_popadj_LIMAT = V_im*(DA_prev_LIMAT_under18/100),
         V_i_kid_popadj_LIMAT = ifelse(is.na(V_i_kid_popadj_LIMAT) | is.nan(V_i_kid_popadj_LIMAT), 0, V_i_kid_popadj_LIMAT))

#then for 2016 @ 2021 grid
SAvail_im_DA2016_forGeoUID2021 <- avail_2016 %>%
  group_by(GeoUID_2021, 
           mode) %>%
  summarize(COMMUNITY = first(COMMUNITY),
            total_tt = sum(travel_time_p50*kid_popadj),
            V_im = sum(V_ij),
            kid_popadj_m = sum(kid_popadj),
            DA_pop_5to14 = mean(DA_pop_5to14, na.rm=T),
            DA_prev_LIMAT_under18 = mean(DA_prev_LIMAT_under18),
            .groups = "drop") |>
  mutate(emissions_total_car_tt = ifelse(mode == "c", 0.1*total_tt, 0),
         v_im_kid_popadj = V_im/kid_popadj_m,
         v_im_kid_popadj = ifelse(is.na(v_im_kid_popadj) | is.nan(v_im_kid_popadj), 0, v_im_kid_popadj),
         v_im_kid_popadj_LIMAT = v_im_kid_popadj*(DA_prev_LIMAT_under18/100),
         v_im_kid_popadj_LIMAT = ifelse(is.na(v_im_kid_popadj_LIMAT) | is.nan(v_im_kid_popadj_LIMAT), 0, v_im_kid_popadj_LIMAT),
         V_i_kid_popadj_LIMAT = V_im*(DA_prev_LIMAT_under18/100),
         V_i_kid_popadj_LIMAT = ifelse(is.na(V_i_kid_popadj_LIMAT) | is.nan(V_i_kid_popadj_LIMAT), 0, V_i_kid_popadj_LIMAT))

#then for 2021 @ 2021 grid
SAvail_im_DA2021_forGeoUID2021 <- avail_2021 %>%
  group_by(GeoUID, 
           mode) %>%
  summarize(COMMUNITY = first(COMMUNITY),
            total_tt = sum(travel_time_p50*kid_popadj),
            V_im = sum(V_ij),
            kid_popadj_m = sum(kid_popadj),
            DA_pop_5to14 = mean(DA_pop_5to14, na.rm=T),
            DA_prev_LIMAT_under18 = mean(DA_prev_LIMAT_under18),
            .groups = "drop") |>
  mutate(emissions_total_car_tt = ifelse(mode == "c", 0.1*total_tt, 0),
         v_im_kid_popadj = V_im/kid_popadj_m,
         v_im_kid_popadj = ifelse(is.na(v_im_kid_popadj) | is.nan(v_im_kid_popadj), 0, v_im_kid_popadj),
         v_im_kid_popadj_LIMAT = v_im_kid_popadj*(DA_prev_LIMAT_under18/100),
         v_im_kid_popadj_LIMAT = ifelse(is.na(v_im_kid_popadj_LIMAT) | is.nan(v_im_kid_popadj_LIMAT), 0, v_im_kid_popadj_LIMAT),
         V_i_kid_popadj_LIMAT = V_im*(DA_prev_LIMAT_under18/100),
         V_i_kid_popadj_LIMAT = ifelse(is.na(V_i_kid_popadj_LIMAT) | is.nan(V_i_kid_popadj_LIMAT), 0, V_i_kid_popadj_LIMAT))
```

```{r}
#Now calculate the changes.. first 2011 to 2016, then 2016 to 2021 (are the trends similar?), then 2011 to 2021 (are the trends similar)
SAvail_im_DA_changes_2011_16 <- full_join(SAvail_im_DA2011_forGeoUID2021,
                                  SAvail_im_DA2016_forGeoUID2021,
                                  by=c("GeoUID_2021",
                                       "mode")) %>%
  transmute(GeoUID_2021,
            mode = case_when(mode == "c" ~ "motorized",
                             mode == "w" ~ "non-motorized"),
            COMMUNITY = dplyr::coalesce(COMMUNITY.x, COMMUNITY.y),
            c_total_tt = total_tt.y - total_tt.x, #2016 minus 2011 tt
            c_total_tt = ifelse(is.na(c_total_tt), -total_tt.x, c_total_tt),
            c_total_ttperkid = (total_tt.y/kid_popadj_m.y) - (total_tt.x/kid_popadj_m.x),
            c_total_ttperkid = ifelse(is.na(c_total_ttperkid), -(total_tt.x/kid_popadj_m.x), c_total_ttperkid),
            c_V_im = V_im.y -V_im.x,
            c_V_im = ifelse(is.na(c_V_im), -V_im.x,c_V_im),
            c_V_im_perc = (V_im.y -V_im.x)/V_im.x,
            c_kid_popadj_m = kid_popadj_m.y - kid_popadj_m.x,
            c_DA_pop_5to14 = DA_pop_5to14.y - DA_pop_5to14.x,
            c_DA_prev_LIMAT_under18 = DA_prev_LIMAT_under18.y - DA_prev_LIMAT_under18.x,
            emissions_total_car_tt_2016 = emissions_total_car_tt.y,
            emissions_total_car_tt_2011 = emissions_total_car_tt.x,
            c_emissions_total_car_tt = emissions_total_car_tt.y - emissions_total_car_tt.x,
            c_emissions_total_car_tt = ifelse(is.na(c_emissions_total_car_tt), -emissions_total_car_tt.x, c_emissions_total_car_tt),
            emissions_perkid_2011 = emissions_total_car_tt.x/kid_popadj_m.x,
            emissions_perkid_2016 = emissions_total_car_tt.y/kid_popadj_m.y,
            c_emissions_perkid = ((emissions_perkid_2016 - emissions_perkid_2011)/
                                      emissions_perkid_2011),
            c_emissions_perkid = ifelse(is.na(emissions_perkid_2016), -emissions_perkid_2011, c_emissions_perkid),
            c_v_im_kid_popadj = v_im_kid_popadj.y - v_im_kid_popadj.x,
            c_v_im_kid_popadj = ifelse(is.na(c_v_im_kid_popadj), -v_im_kid_popadj.x, c_v_im_kid_popadj),
            c_v_im_kid_popadj_perc = (v_im_kid_popadj.y - v_im_kid_popadj.x)/v_im_kid_popadj.x,
            c_v_im_kid_popadj_LIMAT = v_im_kid_popadj_LIMAT.y - v_im_kid_popadj_LIMAT.x,
            c_V_i_kid_popadj_LIMAT = V_i_kid_popadj_LIMAT.y - V_i_kid_popadj_LIMAT.x) |>
  left_join(cen_data_2021_hamiltononly|>dplyr::select(c("GeoUID")), 
            by=c("GeoUID_2021" = "GeoUID")) %>% st_as_sf()

# then 2016 to 2021
SAvail_im_DA_changes_2016_21 <- full_join(SAvail_im_DA2016_forGeoUID2021,
                                  SAvail_im_DA2021_forGeoUID2021,
                                  by=c("GeoUID_2021"="GeoUID",
                                       "mode")) %>%
  transmute(GeoUID_2021,
            mode = case_when(mode == "c" ~ "motorized",
                             mode == "w" ~ "non-motorized"),
            COMMUNITY = dplyr::coalesce(COMMUNITY.x, COMMUNITY.y),
            c_total_tt = total_tt.y - total_tt.x, #2021 minus 2016 tt
            c_total_tt = ifelse(is.na(c_total_tt), -total_tt.x, c_total_tt),
            c_total_ttperkid = (total_tt.y/kid_popadj_m.y) - (total_tt.x/kid_popadj_m.x),
            c_total_ttperkid = ifelse(is.na(c_total_ttperkid), -(total_tt.x/kid_popadj_m.x), c_total_ttperkid),
            c_V_im = V_im.y -V_im.x,
            c_V_im = ifelse(is.na(c_V_im), -V_im.x,c_V_im),
            c_V_im_perc = (V_im.y -V_im.x)/V_im.x,
            c_kid_popadj_m = kid_popadj_m.y - kid_popadj_m.x,
            c_DA_pop_5to14 = DA_pop_5to14.y - DA_pop_5to14.x,
            c_DA_prev_LIMAT_under18 = DA_prev_LIMAT_under18.y - DA_prev_LIMAT_under18.x,
            emissions_total_car_tt_2021 = emissions_total_car_tt.y,
            emissions_total_car_tt_2016 = emissions_total_car_tt.x,
            c_emissions_total_car_tt = emissions_total_car_tt.y - emissions_total_car_tt.x,
            c_emissions_total_car_tt = ifelse(is.na(c_emissions_total_car_tt), -emissions_total_car_tt.x, c_emissions_total_car_tt),
            emissions_perkid_2016 = emissions_total_car_tt.x/kid_popadj_m.x,
            emissions_perkid_2021 = emissions_total_car_tt.y/kid_popadj_m.y,
            c_emissions_perkid = ((emissions_perkid_2021 - emissions_perkid_2016)/
                                      emissions_perkid_2016),
            c_emissions_perkid = ifelse(is.na(emissions_perkid_2021), -emissions_perkid_2016, c_emissions_perkid),
            c_v_im_kid_popadj = v_im_kid_popadj.y - v_im_kid_popadj.x,
            c_v_im_kid_popadj = ifelse(is.na(c_v_im_kid_popadj), -v_im_kid_popadj.x, c_v_im_kid_popadj),
            c_v_im_kid_popadj_perc = (v_im_kid_popadj.y - v_im_kid_popadj.x)/v_im_kid_popadj.x,
            c_v_im_kid_popadj_LIMAT = v_im_kid_popadj_LIMAT.y - v_im_kid_popadj_LIMAT.x,
            c_V_i_kid_popadj_LIMAT = V_i_kid_popadj_LIMAT.y - V_i_kid_popadj_LIMAT.x) |>
  left_join(cen_data_2021_hamiltononly|>dplyr::select(c("GeoUID")), 
            by=c("GeoUID_2021" = "GeoUID")) %>% st_as_sf()

#then, 2011 compared to 2021
SAvail_im_DA_changes_2011_21 <- full_join(SAvail_im_DA2011_forGeoUID2021,
                                  SAvail_im_DA2021_forGeoUID2021,
                                  by=c("GeoUID_2021"="GeoUID",
                                       "mode")) %>%
  transmute(GeoUID_2021,
            mode = case_when(mode == "c" ~ "motorized",
                             mode == "w" ~ "non-motorized"),
            COMMUNITY = dplyr::coalesce(COMMUNITY.x, COMMUNITY.y),
            c_total_tt = total_tt.y - total_tt.x, #2021 minus 2011 tt
            c_total_tt = ifelse(is.na(c_total_tt), -total_tt.x, c_total_tt),
            c_total_ttperkid = (total_tt.y/kid_popadj_m.y) - (total_tt.x/kid_popadj_m.x),
            c_total_ttperkid = ifelse(is.na(c_total_ttperkid), -(total_tt.x/kid_popadj_m.x), c_total_ttperkid),
            c_V_im = V_im.y -V_im.x,
            c_V_im = ifelse(is.na(c_V_im), -V_im.x,c_V_im),
            c_V_im_perc = (V_im.y -V_im.x)/V_im.x,
            c_kid_popadj_m = kid_popadj_m.y - kid_popadj_m.x,
            c_DA_pop_5to14 = DA_pop_5to14.y - DA_pop_5to14.x,
            c_DA_prev_LIMAT_under18 = DA_prev_LIMAT_under18.y - DA_prev_LIMAT_under18.x,
            emissions_total_car_tt_2021 = emissions_total_car_tt.y,
            emissions_total_car_tt_2011 = emissions_total_car_tt.x,
            c_emissions_total_car_tt = emissions_total_car_tt.y - emissions_total_car_tt.x,
            c_emissions_total_car_tt = ifelse(is.na(c_emissions_total_car_tt), -emissions_total_car_tt.x, c_emissions_total_car_tt),
            emissions_perkid_2011 = emissions_total_car_tt.x/kid_popadj_m.x,
            emissions_perkid_2021 = emissions_total_car_tt.y/kid_popadj_m.y,
            c_emissions_perkid = ((emissions_perkid_2021 - emissions_perkid_2011)/
                                      emissions_perkid_2011),
            c_emissions_perkid = ifelse(is.na(emissions_perkid_2021), -emissions_perkid_2011, c_emissions_perkid),
            c_v_im_kid_popadj = v_im_kid_popadj.y - v_im_kid_popadj.x,
            c_v_im_kid_popadj = ifelse(is.na(c_v_im_kid_popadj), -v_im_kid_popadj.x, c_v_im_kid_popadj),
            c_v_im_kid_popadj_perc = (v_im_kid_popadj.y - v_im_kid_popadj.x)/v_im_kid_popadj.x,
            c_v_im_kid_popadj_LIMAT = v_im_kid_popadj_LIMAT.y - v_im_kid_popadj_LIMAT.x,
            c_V_i_kid_popadj_LIMAT = V_i_kid_popadj_LIMAT.y - V_i_kid_popadj_LIMAT.x) |>
  left_join(cen_data_2021_hamiltononly|>dplyr::select(c("GeoUID")), 
            by=c("GeoUID_2021" = "GeoUID")) %>% st_as_sf()
```

```{r}
#repeat the above, but for all 1 mode
SAvail_i_DA2011 <- avail_2011 %>%
  group_by(GeoUID) %>%
  summarize(COMMUNITY = first(COMMUNITY),
            total_tt = sum(travel_time_p50*kid_popadj, na.rm = T),
            V_i = sum(V_ij, na.rm = T),
            DA_pop_5to14 = mean(DA_pop_5to14, na.rm=T),
            kid_pop_DAavg = mean(kid_pop, na.rm = T),
            DA_prev_LIMAT_under18 = mean(DA_prev_LIMAT_under18, na.rm = T),
            .groups = "drop") |>
  filter(GeoUID != 35250242 & GeoUID != 35250133 & GeoUID != 35250457 ) #these GeoUID's have 0 kid population, so let's drop so we don't have zeros
SAvail_i_DA2016 <- avail_2016 %>%
  group_by(GeoUID) %>%
  summarize(COMMUNITY = first(COMMUNITY),
            total_tt = sum(travel_time_p50*kid_popadj),
            V_i = sum(V_ij, na.rm = T),
            DA_pop_5to14 = mean(DA_pop_5to14, na.rm=T),
            kid_pop_DAavg = mean(kid_pop, na.rm = T),
            DA_prev_LIMAT_under18 = mean(DA_prev_LIMAT_under18, na.rm = T),
            .groups = "drop") |>
  filter(GeoUID != 35250398 & GeoUID != 35250133 & GeoUID != 35250427 ) #these GeoUID's have 0 kid population, so let's drop so we don't have zeros

SAvail_i_DA2021 <- avail_2021 %>%
  group_by(GeoUID) %>%
  summarize(COMMUNITY = first(COMMUNITY),
            total_tt = sum(travel_time_p50*kid_popadj),
            V_i = sum(V_ij, na.rm = T),
            DA_pop_5to14 = mean(DA_pop_5to14, na.rm=T),
            kid_pop_DAavg = mean(kid_pop, na.rm = T),
            DA_prev_LIMAT_under18 = mean(DA_prev_LIMAT_under18, na.rm = T),
            .groups = "drop") |>
  filter(GeoUID != 35250211 & GeoUID != 35250242 & GeoUID != 35250491 & GeoUID != 35250982 ) #these GeoUID's have 0 kid population, so let's drop so we don't have zeros

#add the geometries -- census DAs
SAvail_i_DA2011 <- SAvail_i_DA2011 |>
  left_join(cen_data_2011_hamiltononly  |> dplyr::select(GeoUID), by="GeoUID") |> mutate(Year = "2011") |> st_set_geometry("geometry")

SAvail_i_DA2016 <- SAvail_i_DA2016 |>
  left_join(cen_data_2016_hamiltononly |> dplyr::select(GeoUID), by="GeoUID") |> mutate(Year = "2016") |> st_set_geometry("geometry")

SAvail_i_DA2021 <- SAvail_i_DA2021 |>
  left_join(cen_data_2021_hamiltononly |> dplyr::select(GeoUID), by="GeoUID") |> mutate(Year = "2021") |> st_set_geometry("geometry")

#join them together!
SAvail_i_DA_extra <- rbind(SAvail_i_DA2011, SAvail_i_DA2016, SAvail_i_DA2021)
rm(SAvail_i_DA2011,SAvail_i_DA2016,SAvail_i_DA2021)
```

```{r student-popabs-lowincperc-poprate-plot, eval=FALSE}
tmap_defaults <-
  tm_scale_bar(position = c("LEFT", "BOTTOM"), breaks = c(0, 5, 10, 15))+
  tm_compass(size = 1.5, position = c("right", 'top')) +
  tm_layout(legend.position = c("left", "top")) #legend.hist.size = 10, 

student_pop_absolute_plot <-
  tm_shape(SAvail_i_DA_extra |> mutate(extra_col_for_panel = "HAMILTON") |> st_as_sf()) +
  tm_polygons(col = "DA_pop_5to14", border.alpha=0, 
              palette = "Greens",
              labels = c("[0-40)", "[40-50)", "[50-75)",
                         "[75-610 (2011 max.))","[610-835 (2016 max.))","[835-1345 (2021 max.)]"),
              breaks = c(0,40,50,75, 610, 835, 1345),
              title = "Pop. aged 5 to 14")+
  tm_facets(by=c("Year"), nrow=1)+
    tm_credits(c("City total: 58,265","City total: 58,865","City total: 62,195"),
             position = c("LEFT", "BOTTOM")) +
  tm_shape(ham_bay, bbox=ham_community_bounds) + tm_polygons(col="lightblue", border.alpha = 0) +
  tm_shape(hydro_p_LakeOntario, bbox=ham_community_bounds) + tm_polygons(col="lightblue", border.alpha = 0)+
  tm_shape(ham_city_bound)+  tm_borders(col = "grey80", lwd=0.5)+
  tmap_defaults +
  tm_layout(bg.color = "grey99",
            panel.label.bg.color = "white",
            panel.label.height = 0.8)

student_pop_rate_plot <-
  tm_shape(SAvail_i_DA_extra) +
  tm_polygons(col = "kid_pop_DAavg", border.alpha=0, 
              palette = "Purples",
              #style = "jenks",
              labels = c("[0-0.0018)", "[0.0018-0.0025)", "[0.0025-0.0038)",
                         "[0.0038-0.66]"),
               breaks = c(0, 0.0018, 0.0025, 0.0038,0.66),
              title = "Avg. pop. aged 5 to 14\nper residential unit"
  )+
  tm_facets(by=c("Year"), nrow=1)+
  tm_shape(ham_bay, bbox=ham_community_bounds) + tm_polygons(col="lightblue", border.alpha = 0) +
  tm_shape(hydro_p_LakeOntario, bbox=ham_community_bounds) + tm_polygons(col="lightblue", border.alpha = 0)+
  tm_shape(ham_city_bound)+  tm_borders(col = "grey80", lwd=0.5)+
  tmap_defaults +
  tm_layout(bg.color = "grey99",
            panel.show=FALSE)

LIMAT_under18_DA_plot <-
  tm_shape(SAvail_i_DA_extra |>
             mutate(DA_prev_LIMAT_under18 = 
                      ifelse(is.na(DA_prev_LIMAT_under18), 0, DA_prev_LIMAT_under18))) +
  tm_polygons(col = "DA_prev_LIMAT_under18", border.alpha=0, 
              palette = "Reds",
              labels = c("[0-10.0)", "[10-18)", "[18-33)","[33-150)"),
              breaks = c(0, 10, 18, 33, 150),
              colorNA = "black",
              title = "% LIM-AT households\n with dependents < 18")+
  tm_facets(by=c("Year"), nrow=1)+
  tm_shape(ham_bay, bbox=ham_community_bounds) + tm_polygons(col="lightblue", border.alpha = 0) +
  tm_shape(hydro_p_LakeOntario, bbox=ham_community_bounds) + tm_polygons(col="lightblue", border.alpha = 0)+
  tm_shape(ham_city_bound)+  tm_borders(col = "grey80", lwd=0.5)+
  tmap_defaults +
  tm_layout(bg.color = "grey99",
            panel.show=FALSE)

stud_pop_rate_LIM_plot <- tmap_arrange(student_pop_absolute_plot, student_pop_rate_plot, LIMAT_under18_DA_plot, nrow = 3)

tmap_save(stud_pop_rate_LIM_plot, paste0(here::here(),"/Figures/Fig3.tiff"), height=7, width=10, dpi=600)
```

```{r importing-taz-and-associated-flows, include=FALSE}
#reading boundaries of TAZs and PDs from the TTS2016R package (same TAZ for both 2011 and 2016)
#remotes::install_github("soukhova/TTS2016R")
library(TTS2016R) # A R package of the 2016 TTS
data(ggh_taz)
data(ggh_pd)

ham_taz <- ggh_taz %>% dplyr::filter(REGION==6) #Filter out everything other than Planning District 6 = Hamilton
```

```{r include=FALSE}
#the tts origin-destination trips, by mode
load(file = paste0(here::here(),"/data-prep/data-inputs/TTS/od_trips_perc_2011.RData"))
load(file = paste0(here::here(),"/data-prep/data-inputs/TTS/od_trips_perc_2016.RData"))

ham_taz_centroids <- ham_taz |> st_centroid() |> dplyr::select(GTA06)

od_trips_perc_car <- rbind(
  rbind(od_trips_perc_2011 |> group_by(Origin) |> 
          summarize(TAZOrig_car_perc = 
                      sum(TAZOrig_car_trips, na.rm = T)/sum(TAZOrig_walk_trips+TAZOrig_car_trips, na.rm = T)) |>
          mutate(year = "2011")),
  od_trips_perc_2016 |> group_by(Origin) |> 
    summarize(TAZOrig_car_perc = 
                sum(TAZOrig_car_trips, na.rm = T)/sum(TAZOrig_walk_trips+TAZOrig_car_trips, na.rm = T)) |>
    mutate(year = "2016"))

od_trips_perc_car <- left_join(ham_taz,od_trips_perc_car, by=c("GTA06"="Origin"))

od_trips_perc_walk <- rbind(
  rbind(od_trips_perc_2011 |> group_by(Origin) |> 
          summarize(TAZOrig_walk_perc = 
                      sum(TAZOrig_walk_trips)/sum(TAZOrig_walk_trips+TAZOrig_car_trips)) |>
          mutate(year = "2011")),
  od_trips_perc_2016 |> group_by(Origin) |> 
    summarize(TAZOrig_walk_perc = 
                sum(TAZOrig_walk_trips)/sum(TAZOrig_walk_trips+TAZOrig_car_trips)) |>
    mutate(year = "2016"))

od_trips_perc_walk <- left_join(ham_taz, od_trips_perc_walk, by=c("GTA06"="Origin"))

desire_lines_ham_2011 <- od2line(od_trips_perc_2011, ham_taz_centroids)
desire_lines_ham_2011 <- desire_lines_ham_2011 |> mutate(all = TAZOrig_car_trips + TAZOrig_walk_trips,
                                                         Year = "2011")

desire_lines_ham_2016 <- od2line(od_trips_perc_2016, ham_taz_centroids)
desire_lines_ham_2016 <- desire_lines_ham_2016 |> mutate(all = TAZOrig_car_trips + TAZOrig_walk_trips,
                                                         Year = "2016")

desire_lines_ham <- rbind(desire_lines_ham_2011, desire_lines_ham_2016)
rm(desire_lines_ham_2011, desire_lines_ham_2016)
```

```{r ploting-od-taz-flows, eval=FALSE}
tmap_defaults <-
  tm_scale_bar(position = c("LEFT", "BOTTOM"), breaks = c(0, 5, 10, 15))+
  tm_compass(size = 1.5, position = c("right", 'top')) +
  tm_layout(legend.position = c("left", "top")) #legend.hist.size = 10, 

car_OD_flow_plot <-  
  tm_shape(ham_bay, bbox=ham_community_bounds) + tm_polygons(col="lightblue", border.alpha = 0) +
  tm_shape(hydro_p_LakeOntario, bbox=ham_community_bounds) + tm_polygons(col="lightblue", border.alpha = 0)+
  tm_shape(od_trips_perc_car |> mutate(mode = "motorized"), bbox=SAvail_i_DA_extra) +
  tm_polygons(col = "TAZOrig_car_perc", border.alpha = 0.4, border.col = "grey20", lwd=0.2,
              palette = "Greys",
              breaks = c(0, 0.1, 0.2, 0.3, 0.4,.50,.6,0.7,0.7,0.9, 1),
              title = "Proportion of mode use",
              textNA = "Unavailable",
              colorNA = "white")+
  #tm_shape(SAvail_i_DA_extra) + tm_borders(alpha = 0.4, col = "grey20", lwd=0.2)+
  tm_shape(ham_taz) + tm_borders(alpha=0.4, col = "grey40", lwd=0.2) +
  tm_shape(ham_community_bounds %>% st_cast("MULTILINESTRING")) + 
  tm_lines(col = "COMMUNITY_", 
           palette = c("#365C8DFF", "#277F8EFF", "#1FA187FF", "#4AC16DFF", "#9FDA3AFF", "#FDE725FF"),
           title.col = "Hamilton communities", lwd = 1) + 
  tm_shape(ham_taz_centroids) + tm_dots(alpha=0.5, col="darkblue", size=0.01) +
  tm_shape(desire_lines_ham |> mutate(mode = "motorized")) +
  tm_lines(palette = "Reds", breaks = c(6, 22, 26, 52, 353),
           title.col = "Number of trips",
           col = "TAZOrig_car_trips",
           alpha = 0.9,
           scale = 3,
           lwd = "all",
           legend.lwd.show = FALSE) +
  tm_facets(by = c("mode","Year"), nrow=1)+
  tmap_defaults +
  tm_layout(bg.color = "grey99",
            panel.label.bg.color = "white",
            panel.label.height = 0.8)


walk_OD_flow <- tm_shape(ham_bay, bbox=ham_community_bounds) + tm_polygons(col="lightblue", border.alpha = 0) +
  tm_shape(hydro_p_LakeOntario, bbox=ham_community_bounds) + tm_polygons(col="lightblue", border.alpha = 0)+
  tm_shape(od_trips_perc_walk |> mutate(mode = "non-motorized"), bbox=SAvail_i_DA_extra) +
  tm_polygons(col = "TAZOrig_walk_perc", border.alpha = 0.4, border.col = "grey20", lwd=0.2,
              palette = "Greys",
              breaks = c(0, .25, .50, .75, 1),
              title = "Proportion of mode use",
              textNA = "Unavailable",
              colorNA = "white",
              legend.show=FALSE)+
  #tm_shape(SAvail_i_DA_extra) + tm_borders(alpha = 0.4, col = "cornflowerblue", lwd=0.2)+
  tm_shape(ham_taz) + tm_borders(alpha=0.4, col = "grey40", lwd=0.2) +
  tm_shape(ham_community_bounds %>% st_cast("MULTILINESTRING")) + 
  tm_lines(col = "COMMUNITY_", 
           palette = c("#365C8DFF", "#277F8EFF", "#1FA187FF", "#4AC16DFF", "#9FDA3AFF", "#FDE725FF"),
           title.col = "Hamilton communities", lwd = 1, legend.col.show=FALSE) + 
  tm_shape(ham_taz_centroids) + tm_dots(alpha=0.5, col="darkblue", size=0.01) +
  tm_shape(desire_lines_ham |> filter(TAZOrig_walk_trips >= 1) 
           |> mutate(mode = "non-motorized")) +
  tm_lines(palette = "Reds", breaks = c(6, 22, 26, 52, 353),
           title.col = "Number of trips (non-motorized)",
           col = "TAZOrig_walk_trips",
           alpha = 0.9,
           scale = 4,
           lwd = "all",
           legend.col.show = FALSE,
           legend.lwd.show = FALSE) +
  tm_facets(by = c("mode","Year"), nrow=1)+
  tmap_defaults +
  tm_layout(bg.color = "grey99",
            panel.label.bg.color = "white",
            panel.label.height = c(0.8,0,0))+
  tm_add_legend(type = "symbol",
                col = "darkblue",
                labels = "TAZ centroid",
                size = 0.1) 

OD_flow_plot <- tmap_arrange(car_OD_flow_plot,
                             walk_OD_flow, nrow = 2)
OD_flow_plot
tmap_save(OD_flow_plot, paste0(here::here(),"/Figures/Fig4.tiff"), height=4.5, width=8, dpi=600)
```

```{r quartiles-of-tts-estimated-tt}
od_trips_perc_tt <- data.frame(x=c(gamma2011_motor$data, exp2011_nonmotor$data,
                                   gamma2016_motor$data, exp2016_nonmotor$data),
                               mode = c(rep("motorized", length(gamma2011_motor$data)),
                                        rep("non-motorized", length(exp2011_nonmotor$data)),
                                        rep("motorized", length(gamma2016_motor$data)),
                                        rep("non-motorized", length(exp2016_nonmotor$data))),
                               year = c(rep("2011", length(gamma2011_motor$data)),
                                        rep("2011", length(exp2011_nonmotor$data)),
                                        rep("2016", length(gamma2016_motor$data)),
                                        rep("2016", length(exp2016_nonmotor$data)))
)


q_motorized_2011 <- stats::quantile(od_trips_perc_tt |>
                                      filter(mode == "motorized", year == "2011") |>
                                      pull(x),
                                    probs = c(0.25, 0.5, 0.75), na.rm=T)

q_nonmotorized_2011 <- stats::quantile(od_trips_perc_tt  |>
                                         filter(mode == "non-motorized",
                                                year == "2011") |> 
                                         pull(x),
                                       probs = c(0.25, 0.5, 0.75), na.rm=T)

q_motorized_2016 <- stats::quantile(od_trips_perc_tt  |>
                                      filter(mode == "motorized",
                                             year == "2016") |>
                                      pull(x),
                                    probs = c(0.25, 0.5, 0.75), na.rm=T)

q_nonmotorized_2016 <- stats::quantile(od_trips_perc_tt |> 
                                         filter(mode == "non-motorized",
                                                year == "2016") |>
                                         pull(x),
                                       probs = c(0.25, 0.5, 0.75), na.rm=T)


q_1 <- data.frame(
  label = paste0("Q1:\n", c(q_motorized_2011[1], q_nonmotorized_2011[1]|> round(),
                            q_motorized_2016[1], q_nonmotorized_2016[1]|> round())),
  mode   = c("motorized", "non-motorized", "motorized", "non-motorized"),
  year = c("2011", "2011", "2016", "2016"),
  x     = c(q_motorized_2011[1], q_nonmotorized_2011[1] |> round(),
            q_motorized_2016[1], q_nonmotorized_2016[1]|> round()),
  y     = c(0.11, 0.11, 0.11, 0.11)
)

q_2 <- data.frame(
  label = paste0("Q2:\n", c(q_motorized_2011[2], q_nonmotorized_2011[2]|> round(),
                            q_motorized_2016[2], q_nonmotorized_2016[2]|> round())),
  mode   = c("motorized", "non-motorized", "motorized", "non-motorized"),
  year = c("2011", "2011", "2016", "2016"),
  x     = c(q_motorized_2011[2], q_nonmotorized_2011[2] |> round(),
            q_motorized_2016[2], q_nonmotorized_2016[2]|> round()),
  y     = c(0.11, 0.11, 0.11, 0.11)
)

q_3 <- data.frame(
  label = paste0("Q3:\n", c(q_motorized_2011[3], q_nonmotorized_2011[3]|> round(),
                            q_motorized_2016[3], q_nonmotorized_2016[3]|> round())),
  mode   = c("motorized", "non-motorized", "motorized", "non-motorized"),
  year = c("2011", "2011", "2016", "2016"),
  x     = c(q_motorized_2011[3], q_nonmotorized_2011[3] |> round(),
            q_motorized_2016[3], q_nonmotorized_2016[3]|> round()),
  y     = c(0.11, 0.11, 0.11, 0.11)
)
```

```{r tts-theoretical-curve-creation}
x <- data.frame(t = seq(0, 45, 0.1))
X_shorter <-data.frame(t = seq(0, 27, 0.1))

x_motorized_2011 <- x %>%
  mutate(f = dgamma(t,
                    gamma2011_motor$estimate[1],
                    gamma2011_motor$estimate[2]),
         mode = "motorized",
         year = "2011")

x_nonmotorized_2011 <- X_shorter %>%
  mutate(f = dexp(t,
                  exp2011_nonmotor$estimate[1]),
         mode = "non-motorized",
         year = "2011")

x_motorized_2016 <- x %>%
  mutate(f = dgamma(t,
                    gamma2016_motor$estimate[1],
                    gamma2016_motor$estimate[2]),
         mode = "motorized",
         year = "2016")

x_nonmotorized_2016 <- X_shorter %>%
  mutate(f = dexp(t,
                  exp2016_nonmotor$estimate[1]),
         mode = "non-motorized",
         year = "2016")

tld_theoretical <- rbind(x_motorized_2011,
                         x_nonmotorized_2011,
                         x_motorized_2016,
                         x_nonmotorized_2016) %>%
  mutate(mode = factor(mode, levels = c("motorized", "non-motorized")),
         year = factor(year, levels = c("2011", "2016")))
```

```{r ploting-empirical-and-theo-curve-TLD-tts, eval=FALSE}
TLD_empirical_wtheo_curve_plot <- ggplot() +
  geom_histogram(data = od_trips_perc_tt, 
                 aes(x = x, 
                     y = ..density..),
                 colour = "grey70",
                 fill = "grey70",
                 boundary = 0,
                 binwidth = 3) +
  geom_vline(data = q_1, mapping = aes(xintercept = x), colour = "grey60") +
  geom_vline(data = q_2, mapping = aes(xintercept = x), colour = "grey60") +
  geom_vline(data = q_3, mapping = aes(xintercept = x), colour = "grey60") +
  geom_line(data = tld_theoretical, aes(x = t, y = f), colour = "blue", linewidth=0.8, alpha=0.6) + 
  xlab("Estimated travel time associated with TTS OD flows (minutes)") +
  ylab("Density") +
  scale_x_continuous(breaks = seq(0,45,10), expand=c(0,0))+
  scale_y_continuous(breaks = seq(0,0.12,0.04), limits = c(0,0.12))+
  facet_grid(~mode~year)+
  geom_text(data = q_1, 
            mapping = aes(x = x, y = y, label = label), colour = "grey20", size=3.5) +
  geom_text(data = q_2,
            mapping = aes(x = x, y = y, label = label), colour = "grey20", size=3.5) +
  geom_text(data = q_3,
            mapping = aes(x = x, y = y, label = label), colour = "grey20", size=3.5) +
  theme_classic() +
  theme(axis.title = element_text(size = 11),
        panel.border = element_rect(colour = "grey80", fill=NA),
        strip.text = element_text(size=11)) 
TLD_empirical_wtheo_curve_plot
ggsave(paste0(here::here(),"/Figures/Fig5.tiff"), height=4.5, width=6, dpi=600)
```

```{r, eval=FALSE}
#create 4 prob density plots to demonstrate the change in per parcel spatial availability per year per mode-using group
df_Vij <- data.frame(
    mode = c(avail_2011$mode, avail_2016$mode, avail_2021$mode),
   Year= c(rep("2011", each=nrow(avail_2011)), rep("2016", each=nrow(avail_2016)), rep("2021", each=nrow(avail_2021))),
   Vij = c(avail_2011$V_ij, avail_2016$V_ij, avail_2021$V_ij),
   Measure = "Vij") |> 
  mutate(mode = ifelse(mode == "c", "Motorized", "Non-motorized")) |>
  mutate(Vij = ifelse(mode == "Motorized" & Vij > 0.01, NA, Vij)) |>
  mutate(Vij = ifelse(mode == "Non-motorized" & Vij > 0.003, NA, Vij))  |> 
           filter(!is.na(Vij))

df_vij <- data.frame(
    mode = c(avail_2011$mode, avail_2016$mode, avail_2021$mode),
   Year= c(rep("2011", each=nrow(avail_2011)), rep("2016", each=nrow(avail_2016)), rep("2021", each=nrow(avail_2021))),
   vij = c(avail_2011$V_ij/avail_2011$kid_popadj,
           avail_2016$V_ij/avail_2016$kid_popadj,
          avail_2021$V_ij/avail_2021$kid_popadj),
   Measure = "vij") |> filter(!is.na(vij))|>
  mutate(mode = ifelse(mode == "c", "Motorized", "Non-motorized"))

density_theme <-  theme(legend.position = c(0.9,1),
        legend.title = element_blank(),
        axis.title = element_blank(),
        legend.key.size = unit(0.25, "cm"),
        legend.text = element_text(size=6))
# Basic density plot for parcel-level 
Vij_dens_plot <-
  ggplot(df_Vij, aes(x=Vij, color=NULL, fill=Year)) +
  #scale_x_log10() +
  geom_density(alpha=0.4, linewidth=0.25) +
  scale_fill_manual(values=viridis_pal()(3)) +
  facet_wrap(~mode, nrow=2, scale="free") +
  theme_minimal() +
  density_theme

vij_dens_plot <-
  ggplot(df_vij, aes(x=vij, color=NULL, fill=Year)) +
  #scale_x_log10() +
  geom_density(alpha=0.4, adjust=3, linewidth=0.25) +
  scale_fill_manual(values=viridis_pal()(3)) +
  xlim(c(0,3))+
  facet_wrap(~mode, nrow=2) +
  theme_minimal()+
  density_theme

#repeat the above, but for the DA level scores
Vij_dens_DA_plot <-
  ggplot(SAvail_im_DA |> 
           mutate(V_im = ifelse(mode == "Non-motorized" & V_im > 1.5, NA, V_im)) |>
           mutate(V_im = ifelse(mode == "Motorized" & V_im > 250, NA, V_im))  |> 
           filter(!is.na(V_im)),
         aes(x=V_im, color=NULL, fill=year)) +
  geom_density(alpha=0.4, linewidth=0.25) +
  scale_fill_manual(values=viridis_pal()(3)) +
  facet_wrap(~mode, nrow=2, scales = "free") +
  theme_minimal() +
  density_theme

vij_dens_DA_plot <-
  ggplot(SAvail_im_DA, aes(x=v_im_kid_popadj, color=NULL, fill=year)) +
  geom_density(alpha=0.4, linewidth=0.25) +
  scale_fill_manual(values=viridis_pal()(3)) +
  xlim(c(0,3))+
  facet_wrap(~mode, nrow=2) +
  theme_minimal()+
  density_theme

Vijvi_dens_parcel_DA_plot <- plot_grid(
  Vij_dens_plot, Vij_dens_DA_plot,
  vij_dens_plot, vij_dens_DA_plot,
  labels = c('Parcel Vi', 'DA Vi',
              "Parcel vi", "DA vi"),
  nrow=2, ncol=2, label_size = 9)

ggsave(Vijvi_dens_parcel_DA_plot, file=paste0(here::here(),"/Figures/Fig6.tiff"),
                                        height=4.5, width=6, dpi=600)
```

```{r}
ALL_SCHOOLS_Elem_formapping2 <- ALL_SCHOOLS_Elem_formapping |> mutate(Mode = "motorized")
ALL_SCHOOLS_Elem_formapping3 <- ALL_SCHOOLS_Elem_formapping |> mutate(Mode = "non-motorized")
ALL_SCHOOLS_Elem_formapping2 <- rbind(ALL_SCHOOLS_Elem_formapping2, ALL_SCHOOLS_Elem_formapping3)
rm(ALL_SCHOOLS_Elem_formapping3)
```

```{r, eval=FALSE}
Vim_201120162021_plot <-  
  tm_shape(SAvail_im_DA |> filter(V_im >0), bbox=SAvail_im_DA) +
  tm_polygons(col = "V_im", border.alpha = 0, border.col = "grey20", lwd=0.2,
              palette = "Purples",
              alpha=0.7,
              style="quantile", n=10,
              #labels = c("[>0-0.2)", "[0.2-15.2)", "[15.2-54.8)", "[54.8-1200)"),
              title = expression(V[i]^m),
              textNULL = "Unavailable",
              colorNULL = "white")+
  tm_facets(by = c("mode","year"), nrow=1)+
  tm_shape(ham_community_bounds %>% st_cast("MULTILINESTRING")) + 
  tm_lines(col = "COMMUNITY_URB", 
           palette = c("#365C8DFF", "#277F8EFF", "#1FA187FF", "#4AC16DFF", "#9FDA3AFF", "#FDE725FF"),
           title.col = "Hamilton communities\n(% urbanisation)", lwd = 1) + 
  tm_shape(ALL_SCHOOLS_Elem_formapping2) +
   tm_symbols(shape = "combo_status",
             size= "OTGC",
             alpha=0.8,
             scale = 0.4,
             shapes = c(1,
                        17,24,
                        15,22,
                        18, 23),
          title.shape = "School status",
          title.size = "OTGC",
          shapes.labels =  c(
          "No change (btwn 2011-21)", 
          "Expanded (btwn 2011-16)", 
          "Relocated + expanded (btwn 2011-16)",
          "Closed (btwn 2011-16)", 
          "Closed (btwn 2016-21)",
          "Opened (btwn 2011-16)", 
          "Opened (btwn 2016-21)")
  ) +
  tm_facets(by=c("Mode","combo_year"))+
  tm_credits(c("60,220 spatial availability \n(99.4% of the 60,567 city-wide OTGC)",
               "58,101 spatial availability\n(99.7% of the 58,287 city-wide OTGC)",
               "57,509 spatial availability\n(99.7% of the 58,697 city-wide OTGC)",
               
                "347 spatial availability \n(0.6% of the 60,567 city-wide OTGC)",
               "186 spatial availability\n(0.3% of the 58,287 city-wide OTGC)",
               "187 spatial availability\n(0.3% of the 58,697 city-wide OTGC)"),
             position = c("LEFT", "BOTTOM")) +
  tm_shape(ham_bay, bbox=ham_community_bounds) + tm_polygons(col="lightblue", border.alpha = 0) +
  tm_shape(hydro_p_LakeOntario, bbox=ham_community_bounds) + tm_polygons(col="lightblue", border.alpha = 0)+
  tmap_defaults +
  tm_layout(bg.color = "grey99",
            panel.label.bg.color = "white",
            panel.label.height = 0.8)

vvim_201120162021_plot <-  
  tm_shape(SAvail_im_DA  |> filter(v_im_kid_popadj >0), bbox=SAvail_im_DA) +
  tm_polygons(col = "v_im_kid_popadj", border.alpha = 0, border.col = "grey20", lwd=0.2,
              palette = "RdYlGn",
              midpoint = 1.0,
              title = expression(v[i]^m),
              style="quantile", n=10,
              # breaks = c(0, 0.61, 0.88, 1.18, 2.2), #note the highest value is ~10.29, I'm breaking the values early for the purpose of visualisation
              # labels = c("[0-0.6)", "[0.6-0.9)", "[0.9-1.2)", "[1.2-10.3)"),
              textNULL = "Unavailable",
              colorNULL = "white")+
  tm_facets(by = c("mode","year"), nrow=1)+
  tm_shape(ham_community_bounds %>% st_cast("MULTILINESTRING")) + 
  tm_lines(col = "COMMUNITY_URB", 
           palette = c("#365C8DFF", "#277F8EFF", "#1FA187FF", "#4AC16DFF", "#9FDA3AFF", "#FDE725FF"),
           title.col = "Hamilton communities\n(% urbanisation)", lwd = 1, legend.col.show=FALSE) + 
tm_shape(ALL_SCHOOLS_Elem_formapping2) +
  tm_symbols(shape = "combo_status",
             size= "OTGC",
             alpha=0.8,
             scale = 0.4,
             shapes = c(1,
                        17,24,
                        15,22,
                        18, 23),
          title.shape = "School status",
          title.size = "OTGC",
          shapes.labels =  c(
          "No change (btwn 2011-21)", 
          "Expanded (btwn 2011-16)", 
          "Relocated + expanded (btwn 2011-16)",
          "Closed (btwn 2011-16)", 
          "Closed (btwn 2016-21)",
          "Opened (btwn 2011-16)", 
          "Opened (btwn 2016-21)"),
          legend.size.show = FALSE,
          legend.shape.show = FALSE) +
  tm_facets(by=c("Mode","combo_year"))+
  tm_credits(c("1.09 avg. spatial availability per capita",
               "1.05 avg. spatial availability per capita",
               "0.99 avg. spatial availability per capita",
                "0.85 avg. spatial availability per capita",
               "0.71 avg. spatial availability per capita",
               "0.68 avg. spatial availability per capita"),
          position = c("LEFT", "BOTTOM")) +
  tm_shape(ham_bay, bbox=ham_community_bounds) + tm_polygons(col="lightblue", border.alpha = 0) +
  tm_shape(hydro_p_LakeOntario, bbox=ham_community_bounds) + tm_polygons(col="lightblue", border.alpha = 0)+
  tmap_defaults +
  tm_layout(bg.color = "grey99",
            panel.label.bg.color = "white",
            panel.label.height = 0.8)

Vim_vvim_201120162021_plot <- tmap_arrange(Vim_201120162021_plot, vvim_201120162021_plot, nrow=2)
tmap_save(Vim_vvim_201120162021_plot, paste0(here::here(),"/Figures/Fig7.tiff"), height=12, width=10, dpi=300)
```



```{r, eval=FALSE}
#comparison objects for mapping -- first only motorized
comparision_mapping_motorized <- left_join(
  SAvail_im_DA_changes_2011_16 |> st_drop_geometry()|> filter(mode == "motorized") |> select(c("GeoUID_2021", "c_V_im", "c_v_im_kid_popadj")) |> rename("c_V_im_2011_16"="c_V_im", "c_v_im_kid_popadj_2011_16"="c_v_im_kid_popadj"), 
  SAvail_im_DA_changes_2016_21 |> st_drop_geometry() |> filter(mode == "motorized") |> select(c("GeoUID_2021", "c_V_im", "c_v_im_kid_popadj")) |> rename("c_V_im_2016_21"="c_V_im", "c_v_im_kid_popadj_2016_21"="c_v_im_kid_popadj"),
  by="GeoUID_2021")

comparision_mapping_motorized <- left_join(
  comparision_mapping_motorized, 
  SAvail_im_DA_changes_2011_21 |> filter(!st_is_empty(geometry)) |> filter(mode == "motorized") |> select(c("GeoUID_2021", "c_V_im", "c_v_im_kid_popadj")) |> 
    rename("c_V_im_2011_21"="c_V_im", "c_v_im_kid_popadj_2011_21"="c_v_im_kid_popadj"),
  by="GeoUID_2021")

comparision_mapping_motorized1 <- data.frame(
  GeoUID_2021 = comparision_mapping_motorized$GeoUID_2021,
  value_type = c(rep("1) c_Vi", each=length(comparision_mapping_motorized$c_V_im_2011_16)),
                 rep("2) c_vi", each=length(comparision_mapping_motorized$c_v_im_kid_popadj_2011_16)),
                 rep("1) c_Vi", each=length(comparision_mapping_motorized$c_V_im_2016_21)),
                 rep("2) c_vi", each=length(comparision_mapping_motorized$c_v_im_kid_popadj_2016_21)),
                 rep("1) c_Vi", each=length(comparision_mapping_motorized$c_V_im_2011_21)),
                 rep("2) c_vi", each=length(comparision_mapping_motorized$c_v_im_kid_popadj_2011_21))),
  year = c(rep("1) 2011-2016", each=length(comparision_mapping_motorized$c_V_im_2011_16)),
                 rep("1) 2011-2016", each=length(comparision_mapping_motorized$c_v_im_kid_popadj_2011_16)),
                 rep("2) 2016-2021", each=length(comparision_mapping_motorized$c_V_im_2016_21)),
                 rep("2) 2016-2021", each=length(comparision_mapping_motorized$c_v_im_kid_popadj_2016_21)),
                 rep("3) 2011-2021", each=length(comparision_mapping_motorized$c_V_im_2011_21)),
                 rep("3) 2011-2021", each=length(comparision_mapping_motorized$c_v_im_kid_popadj_2011_21))),
  value = c(comparision_mapping_motorized$c_V_im_2011_16, comparision_mapping_motorized$c_v_im_kid_popadj_2011_16,
            comparision_mapping_motorized$c_V_im_2016_21, comparision_mapping_motorized$c_v_im_kid_popadj_2016_21,
            comparision_mapping_motorized$c_V_im_2011_21, comparision_mapping_motorized$c_v_im_kid_popadj_2011_21)
  )

comparision_mapping_motorized_Vi <- left_join(comparision_mapping_motorized1, comparision_mapping_motorized |> select("GeoUID_2021", "geometry"), by = "GeoUID_2021") |> st_as_sf() |> filter(value_type == "1) c_Vi") |> mutate(mode="Motorized")
comparision_mapping_motorized_vvi <- left_join(comparision_mapping_motorized1, comparision_mapping_motorized |> select("GeoUID_2021", "geometry"), by = "GeoUID_2021") |> st_as_sf() |> filter(value_type == "2) c_vi")|> mutate(mode="Motorized")

#now, non-motorized:
comparision_mapping_nonmotorized <- left_join(
  SAvail_im_DA_changes_2011_16 |> st_drop_geometry()|> filter(mode == "non-motorized") |> select(c("GeoUID_2021", "c_V_im", "c_v_im_kid_popadj")) |> rename("c_V_im_2011_16"="c_V_im", "c_v_im_kid_popadj_2011_16"="c_v_im_kid_popadj"), 
  SAvail_im_DA_changes_2016_21 |> st_drop_geometry() |> filter(mode == "non-motorized") |> select(c("GeoUID_2021", "c_V_im", "c_v_im_kid_popadj")) |> rename("c_V_im_2016_21"="c_V_im", "c_v_im_kid_popadj_2016_21"="c_v_im_kid_popadj"),
  by="GeoUID_2021")

comparision_mapping_nonmotorized <- left_join(
  comparision_mapping_nonmotorized, 
  SAvail_im_DA_changes_2011_21 |> filter(!st_is_empty(geometry)) |> filter(mode == "non-motorized") |> select(c("GeoUID_2021", "c_V_im", "c_v_im_kid_popadj")) |> 
    rename("c_V_im_2011_21"="c_V_im", "c_v_im_kid_popadj_2011_21"="c_v_im_kid_popadj"),
  by="GeoUID_2021")

comparision_mapping_nonmotorized1 <- data.frame(
  GeoUID_2021 = comparision_mapping_nonmotorized$GeoUID_2021,
  value_type = c(rep("1) c_Vi", each=length(comparision_mapping_nonmotorized$c_V_im_2011_16)),
                 rep("2) c_vi", each=length(comparision_mapping_nonmotorized$c_v_im_kid_popadj_2011_16)),
                 rep("1) c_Vi", each=length(comparision_mapping_nonmotorized$c_V_im_2016_21)),
                 rep("2) c_vi", each=length(comparision_mapping_nonmotorized$c_v_im_kid_popadj_2016_21)),
                 rep("1) c_Vi", each=length(comparision_mapping_nonmotorized$c_V_im_2011_21)),
                 rep("2) c_vi", each=length(comparision_mapping_nonmotorized$c_v_im_kid_popadj_2011_21))),
  year = c(rep("1) 2011-2016", each=length(comparision_mapping_nonmotorized$c_V_im_2011_16)),
                 rep("1) 2011-2016", each=length(comparision_mapping_nonmotorized$c_v_im_kid_popadj_2011_16)),
                 rep("2) 2016-2021", each=length(comparision_mapping_nonmotorized$c_V_im_2016_21)),
                 rep("2) 2016-2021", each=length(comparision_mapping_nonmotorized$c_v_im_kid_popadj_2016_21)),
                 rep("3) 2011-2021", each=length(comparision_mapping_nonmotorized$c_V_im_2011_21)),
                 rep("3) 2011-2021", each=length(comparision_mapping_nonmotorized$c_v_im_kid_popadj_2011_21))),
  value = c(comparision_mapping_nonmotorized$c_V_im_2011_16, comparision_mapping_nonmotorized$c_v_im_kid_popadj_2011_16,
            comparision_mapping_nonmotorized$c_V_im_2016_21, comparision_mapping_nonmotorized$c_v_im_kid_popadj_2016_21,
            comparision_mapping_nonmotorized$c_V_im_2011_21, comparision_mapping_nonmotorized$c_v_im_kid_popadj_2011_21)
  )

comparision_mapping_nonmotorized_Vi <- left_join(comparision_mapping_nonmotorized1, comparision_mapping_nonmotorized |> select("GeoUID_2021", "geometry"), by = "GeoUID_2021") |> st_as_sf() |> filter(value_type == "1) c_Vi") |> mutate(mode="Non-motorized")
comparision_mapping_nonmotorized_vvi <- left_join(comparision_mapping_nonmotorized1, comparision_mapping_nonmotorized |> select("GeoUID_2021", "geometry"), by = "GeoUID_2021") |> st_as_sf() |> filter(value_type == "2) c_vi")|> mutate(mode="Non-motorized")
```

```{r}
ALL_SCHOOLS_Elem_formapping_21 <- SCHOOLS |>
  filter(Year == "2011 and 2016" & Year_2 == "2016 and 2021" & Status == "Expanded" & Status_2 == "NoChange") |>
  mutate(combo_status = "2) Expanded between 2011-16",
         combo_change_year = "2011-2016")
ALL_SCHOOLS_Elem_formapping_22 <- SCHOOLS |>
  filter(Year == "2011 and 2016" & Year_2 == "2016 and 2021" & Status == "Expanded" & Status_2 == "NoChange") |>
  mutate(combo_status = "2) Expanded between 2011-16",
         combo_change_year = "2011-2021")

ALL_SCHOOLS_Elem_formapping_31 <- SCHOOLS |>
  filter(Year == "2016" & Year_2 == "2016 and 2021" & Status == "Moved" & Status_2 == "NoChange") |>
  mutate(combo_status = "3) Relocated + expanded between 2011-16",
         combo_change_year = "2011-2016")
ALL_SCHOOLS_Elem_formapping_32 <- SCHOOLS |>
  filter(Year == "2016" & Year_2 == "2016 and 2021" & Status == "Moved" & Status_2 == "NoChange") |>
  mutate(combo_status = "3) Relocated + expanded between 2011-16",
         combo_change_year = "2011-2021")

ALL_SCHOOLS_Elem_formapping_51 <- SCHOOLS |>
  filter(Year == "2016" & Year_2 == "2016 and 2021" & Status == "New" & Status_2 == "NoChange") |>
  mutate(combo_status = "6) Opened between 2011-16",
         combo_change_year = "2011-2016")
ALL_SCHOOLS_Elem_formapping_52 <- SCHOOLS |>
  filter(Year == "2016" & Year_2 == "2016 and 2021" & Status == "New" & Status_2 == "NoChange") |>
  mutate(combo_status = "6) Opened between 2011-16",
         combo_change_year = "2011-2021") 

ALL_SCHOOLS_Elem_formapping_81 <- SCHOOLS |>
  filter(is.na(Year) & Year_2 == "2021" & is.na(Status) & Status_2 == "New") |>
  mutate(combo_status = "7) Opened between 2016-21",
         combo_change_year = "2016-2021") 
ALL_SCHOOLS_Elem_formapping_82 <- SCHOOLS |>
  filter(is.na(Year) & Year_2 == "2021" & is.na(Status) & Status_2 == "New") |>
  mutate(combo_status = "7) Opened between 2016-21",
         combo_change_year = "2011-2021") 

ALL_SCHOOLS_Elem_formapping_71 <- SCHOOLS |>
  filter(Year == "2011" & is.na(Year_2) & Status == "Removed" & is.na(Status_2)) |>
  mutate(combo_status = "4) Closed between 2011-16",
         combo_change_year = "2011-2016") 
ALL_SCHOOLS_Elem_formapping_72 <- SCHOOLS |>
  filter(Year == "2011" & is.na(Year_2) & Status == "Removed" & is.na(Status_2)) |>
  mutate(combo_status = "4) Closed between 2011-16",
         combo_change_year = "2011-2021") 

ALL_SCHOOLS_Elem_formapping_61 <- SCHOOLS |>
  filter(Year == "2011 and 2016" & Year_2 == "2016" & Status == "NoChange" & Status_2 == "Removed") |>
  mutate(combo_status = "5) Closed between 2016-21",
         combo_change_year = "2016-2021") 
ALL_SCHOOLS_Elem_formapping_62 <- SCHOOLS |>
  filter(Year == "2011 and 2016" & Year_2 == "2016" & Status == "NoChange" & Status_2 == "Removed") |>
  mutate(combo_status = "5) Closed between 2016-21",
         combo_change_year = "2011-2021") 

ALL_SCHOOLS_Elem_formapping3 <- rbind(
  ALL_SCHOOLS_Elem_formapping_21,ALL_SCHOOLS_Elem_formapping_22,
  ALL_SCHOOLS_Elem_formapping_31,ALL_SCHOOLS_Elem_formapping_32,
  ALL_SCHOOLS_Elem_formapping_51,ALL_SCHOOLS_Elem_formapping_52,
  ALL_SCHOOLS_Elem_formapping_61,ALL_SCHOOLS_Elem_formapping_62,
  ALL_SCHOOLS_Elem_formapping_71,ALL_SCHOOLS_Elem_formapping_72,
  ALL_SCHOOLS_Elem_formapping_81, ALL_SCHOOLS_Elem_formapping_82
  )

rm(ALL_SCHOOLS_Elem_formapping_21,ALL_SCHOOLS_Elem_formapping_22,
  ALL_SCHOOLS_Elem_formapping_31,ALL_SCHOOLS_Elem_formapping_32,
  ALL_SCHOOLS_Elem_formapping_51,ALL_SCHOOLS_Elem_formapping_52,
  ALL_SCHOOLS_Elem_formapping_61,ALL_SCHOOLS_Elem_formapping_62,
  ALL_SCHOOLS_Elem_formapping_71,ALL_SCHOOLS_Elem_formapping_72,
  ALL_SCHOOLS_Elem_formapping_81, ALL_SCHOOLS_Elem_formapping_82)


ALL_SCHOOLS_Elem_formapping3 <- ALL_SCHOOLS_Elem_formapping3 |>
  mutate(combo_change_year = case_when(combo_change_year== "2011-2016" ~ "1) 2011-2016",
                                       combo_change_year== "2016-2021" ~ "2) 2016-2021",
                                       combo_change_year== "2011-2021" ~ "3) 2011-2021"))
```

```{r, eval=FALSE}
#New figure 7 showing the changes -- first motor only
motor_Vi_CHANGE_plot <-  
  tm_shape(comparision_mapping_motorized_Vi |> filter(!st_is_empty(geometry)),
           bbox=SAvail_im_DA_changes_2011_21) +
  tm_polygons(col = "value", border.alpha = 0, border.col = "grey20", lwd=0.2, alpha=0.6,
              palette = "RdBu", midpoint=0,
              style="quantile", n=10,
              #breaks = c(-20, -4, -0.2, 0, 20),
              midpoint = 0,
              #labels = c("[-208 to -4)", "[-4 to -0.2)", "[-0.2 to 0)","[0 to 331]"),
              title = expression("Change in "*V[i]^{Motorized}),
              colorNA = "white")+
  tm_facets(by = c("year"), nrow=1)+
  tm_shape(ham_community_bounds %>% st_cast("MULTILINESTRING")) + 
  tm_lines(col = "COMMUNITY_URB", 
           palette = c("#365C8DFF", "#277F8EFF", "#1FA187FF", "#4AC16DFF", "#9FDA3AFF", "#FDE725FF"),
           title.col = "Hamilton communities\n(% urbanisation)", lwd = 1, legend.col.show=FALSE) + 
  tm_shape(ALL_SCHOOLS_Elem_formapping3)+
  tm_symbols(shape = "combo_status",
             alpha=0.7,
             scale = 0.3,
             shapes = c(17,24,
                        15,22,
                        18, 23),
          title.shape = "Schools that changed",
          shapes.labels =  c(
          "Expanded (btwn 2011-16)",
          "Relocated + expanded (btwn 2011-16)",
          "Closed (btwn 2011-16)",
          "Closed (btwn 2016-21)",
          "Opened (btwn 2011-16)",
          "Opened (btwn 2016-21)")
          #legend.size.show = FALSE,
          #legend.shape.show = FALSE
          ) +
  tm_facets(by = c("combo_change_year"), nrow=1)+
  tm_shape(ham_bay, bbox=ham_community_bounds) + tm_polygons(col="lightblue", border.alpha = 0) + 
  tm_shape(hydro_p_LakeOntario, bbox=ham_community_bounds) + tm_polygons(col="lightblue", border.alpha = 0)+
  tmap_defaults +
  tm_layout( bg.color = "grey99",
             panel.label.bg.color = "white",
             panel.label.height = 0.8,
             legend.outside = TRUE,
             panel.labels = c("2011-2016", "2016-2021", "2011-2021"))

motor_vvi_CHANGE_plot <-  
  tm_shape(comparision_mapping_motorized_vvi |> filter(!st_is_empty(geometry)),
           bbox=SAvail_im_DA_changes_2011_21) +
  tm_polygons(col = "value", border.alpha = 0, border.col = "grey20", lwd=0.2, alpha=0.6,
              palette = "RdBu", midpoint=0,
              style="quantile", n=10,
              #breaks = c(-20, -4, -0.2, 0, 20),
              midpoint = 0,
              #labels = c("[-208 to -4)", "[-4 to -0.2)", "[-0.2 to 0)","[0 to 331]"),
              title = expression("Change in "*v[i]^{Motorized}),
              colorNA = "white")+
  tm_facets(by = c("year"), nrow=1)+
  tm_shape(ham_community_bounds %>% st_cast("MULTILINESTRING")) + 
  tm_lines(col = "COMMUNITY_URB", 
           palette = c("#365C8DFF", "#277F8EFF", "#1FA187FF", "#4AC16DFF", "#9FDA3AFF", "#FDE725FF"),
           title.col = "Hamilton communities\n(% urbanisation)", lwd = 1, legend.col.show=FALSE) +  
  tm_shape(ALL_SCHOOLS_Elem_formapping3)+
  tm_symbols(shape = "combo_status",
             alpha=0.7,
             scale = 0.3,
             shapes = c(17,24,
                        15,22,
                        18, 23),
          title.shape = "Schools that changed",
          shapes.labels =  c(
          "Expanded (btwn 2011-16)",
          "Relocated + expanded (btwn 2011-16)",
          "Closed (btwn 2011-16)",
          "Closed (btwn 2016-21)",
          "Opened (btwn 2011-16)",
          "Opened (btwn 2016-21)"),
          legend.shape.show = FALSE
          ) +
  tm_facets(by = c("combo_change_year"), nrow=1)+
  tm_shape(ham_bay, bbox=ham_community_bounds) + tm_polygons(col="lightblue", border.alpha = 0) + 
  tm_shape(hydro_p_LakeOntario, bbox=ham_community_bounds) + tm_polygons(col="lightblue", border.alpha = 0)+
  tmap_defaults +
  tm_layout( bg.color = "grey99",
             panel.label.bg.color = "white",
             panel.label.height = 0.8,
             legend.outside = TRUE,
             panel.show = FALSE)

#now repeat, but non-motorized - changes in 2011-2016, 2016 to 2021 and 2011 through 2021
nonmotor_Vi_CHANGE_plot <-  
  tm_shape(comparision_mapping_nonmotorized_Vi |> filter(!st_is_empty(geometry)),
           bbox=SAvail_im_DA_changes_2011_21) +
  tm_polygons(col = "value", border.alpha = 0, border.col = "grey20", lwd=0.2, alpha=0.6,
              palette = "RdBu", midpoint=0,
              style="quantile", n=10,
              #breaks = c(-20, -4, -0.2, 0, 20),
              midpoint = 0,
              #labels = c("[-208 to -4)", "[-4 to -0.2)", "[-0.2 to 0)","[0 to 331]"),
              title = expression("Change in "*V[i]^{Non-motorized}),
              colorNA = "white")+
  tm_facets(by = c("year"), nrow=1)+
  tm_shape(ham_community_bounds %>% st_cast("MULTILINESTRING"))+ 
  tm_lines(col = "COMMUNITY_URB", 
           palette = c("#365C8DFF", "#277F8EFF", "#1FA187FF", "#4AC16DFF", "#9FDA3AFF", "#FDE725FF"),
           title.col = "Hamilton communities\n(% urbanisation)", lwd = 1, legend.col.show=FALSE) + 
  tm_shape(ALL_SCHOOLS_Elem_formapping3)+
  tm_symbols(shape = "combo_status",
             alpha=0.7,
             scale = 0.3,
             shapes = c(17,24,
                        15,22,
                        18, 23),
          title.shape = "Schools that changed",
          shapes.labels =  c(
          "Expanded (btwn 2011-16)",
          "Relocated + expanded (btwn 2011-16)",
          "Closed (btwn 2011-16)",
          "Closed (btwn 2016-21)",
          "Opened (btwn 2011-16)",
          "Opened (btwn 2016-21)"),
          legend.shape.show = FALSE
          ) +
  tm_facets(by = c("combo_change_year"), nrow=1)+
  tm_shape(ham_bay, bbox=ham_community_bounds) + tm_polygons(col="lightblue", border.alpha = 0) + 
  tm_shape(hydro_p_LakeOntario, bbox=ham_community_bounds) + tm_polygons(col="lightblue", border.alpha = 0)+
  tmap_defaults +
  tm_layout( bg.color = "grey99",
             panel.label.bg.color = "white",
             panel.label.height = 0.8,
             legend.outside = TRUE,
             panel.show = FALSE)

nonmotor_vvi_CHANGE_plot <-  
  tm_shape(comparision_mapping_nonmotorized_vvi |> filter(!st_is_empty(geometry)),
           bbox=SAvail_im_DA_changes_2011_21) +
  tm_polygons(col = "value", border.alpha = 0, border.col = "grey20", lwd=0.2, alpha=0.6,
              palette = "RdBu", midpoint=0,
              style="quantile", n=10,
              #breaks = c(-20, -4, -0.2, 0, 20),
              midpoint = 0,
              #labels = c("[-208 to -4)", "[-4 to -0.2)", "[-0.2 to 0)","[0 to 331]"),
              title = expression("Change in "*v[i]^{Non-motorized}),
              colorNA = "white")+
  tm_facets(by = c("year"), nrow=1)+
  tm_shape(ham_community_bounds %>% st_cast("MULTILINESTRING")) + 
  tm_lines(col = "COMMUNITY_URB", 
           palette = c("#365C8DFF", "#277F8EFF", "#1FA187FF", "#4AC16DFF", "#9FDA3AFF", "#FDE725FF"),
           title.col = "Hamilton communities\n(% urbanisation)", lwd = 1) + 
  tm_shape(ALL_SCHOOLS_Elem_formapping3)+
  tm_symbols(shape = "combo_status",
             alpha=0.7,
             scale = 0.3,
             shapes = c(17,24,
                        15,22,
                        18, 23),
          title.shape = "Schools that changed",
          shapes.labels =  c(
          "Expanded (btwn 2011-16)",
          "Relocated + expanded (btwn 2011-16)",
          "Closed (btwn 2011-16)",
          "Closed (btwn 2016-21)",
          "Opened (btwn 2011-16)",
          "Opened (btwn 2016-21)"),
          legend.shape.show = FALSE
          ) +
  tm_facets(by = c("combo_change_year"), nrow=1)+
  tm_shape(ham_bay, bbox=ham_community_bounds) + tm_polygons(col="lightblue", border.alpha = 0) + 
  tm_shape(hydro_p_LakeOntario, bbox=ham_community_bounds) + tm_polygons(col="lightblue", border.alpha = 0)+
  tmap_defaults +
  tm_layout(bg.color = "grey99",
             panel.label.bg.color = "white",
             panel.label.height = 0.8,
             legend.outside = TRUE,
             panel.show = FALSE)

Vim_vvim_201120162021_CHANGE_plot <- tmap_arrange(motor_Vi_CHANGE_plot,
                                                  nonmotor_Vi_CHANGE_plot,
                                                  motor_vvi_CHANGE_plot,
                                                  nonmotor_vvi_CHANGE_plot, nrow=4)

tmap_save(Vim_vvim_201120162021_CHANGE_plot, paste0(here::here(),"/Figures/Fig8.tiff"), height=12, width=10, dpi=300) #I manually adjusted the text size of the legend of the first figure to be more similar to the rest of the legends
```


```{r, eval=FALSE}
motor_ttim_20112021_CHANGE_plot <-  
  tm_shape(SAvail_im_DA_changes_2011_21 |> 
             filter(!st_is_empty(geometry)) |>
             filter(mode == "motorized"), bbox=SAvail_im_DA) +
  tm_polygons(col = "c_total_ttperkid", border.alpha = 0, border.col = "grey20", lwd=0.2, alpha=0.6,
              palette = "-RdYlGn", midpoint=0, 
              style="quantile", n=10,
              title = c("Motorized travel time minutes\nper pop-aged 5 to 14"))+
  tm_shape(ham_community_bounds %>% st_cast("MULTILINESTRING")) + 
  tm_lines(col = "COMMUNITY_URB", 
           palette = c("#365C8DFF", "#277F8EFF", "#1FA187FF", "#4AC16DFF", "#9FDA3AFF", "#FDE725FF"),
           title.col = "Hamilton communities\n(% urbanisation)", lwd = 1, legend.col.show=FALSE) + 
  tm_shape(ALL_SCHOOLS_Elem_formapping3 |> filter(combo_change_year == "3) 2011-2021"))+
  tm_symbols(shape = "combo_status",
             alpha=0.7,
             scale = 0.3,
             shapes = c(17,24,
                        15,22,
                        18, 23),
          title.shape = "Schools that changed",
          shapes.labels =  c(
          "Expanded (btwn 2011-16)",
          "Relocated + expanded (btwn 2011-16)",
          "Closed (btwn 2011-16)",
          "Closed (btwn 2016-21)",
          "Opened (btwn 2011-16)",
          "Opened (btwn 2016-21)")
          #legend.shape.show = FALSE
          ) +
  tmap_defaults +
  tm_shape(ham_bay, bbox=ham_community_bounds) + tm_polygons(col="lightblue", border.alpha = 0) + 
  tm_shape(hydro_p_LakeOntario, bbox=ham_community_bounds) + tm_polygons(col="lightblue", border.alpha = 0)+
  tm_layout(bg.color = "grey99",
             panel.label.bg.color = "white",
             panel.label.height = 0.9,
             panel.labels = "Motorized minutes",
             legend.outside = TRUE)



nonmotor_ttim_20112021_CHANGE_plot <-  
  tm_shape(SAvail_im_DA_changes_2011_21 |> 
             filter(!st_is_empty(geometry)) |>
             filter(mode == "non-motorized"), bbox=SAvail_im_DA) +
  tm_polygons(col = "c_total_ttperkid", border.alpha = 0, border.col = "grey20", lwd=0.2, alpha=0.6,
              palette = "RdYlGn", midpoint=0,
              style="quantile", n=10,
              title = c("Non-motorized travel time minutes\nper pop-aged 5 to 14"))+
  tm_shape(ham_community_bounds %>% st_cast("MULTILINESTRING")) + 
  tm_lines(col = "COMMUNITY_URB", 
           palette = c("#365C8DFF", "#277F8EFF", "#1FA187FF", "#4AC16DFF", "#9FDA3AFF", "#FDE725FF"),
           title.col = "Hamilton communities\n(% urbanisation)", lwd = 1) + 
  tm_shape(ALL_SCHOOLS_Elem_formapping3 |> filter(combo_change_year == "3) 2011-2021"))+
  tm_symbols(shape = "combo_status",
             alpha=0.7,
             scale = 0.3,
             shapes = c(17,24,
                        15,22,
                        18, 23),
          title.shape = "Schools that changed",
          shapes.labels =  c(
          "Expanded (btwn 2011-16)",
          "Relocated + expanded (btwn 2011-16)",
          "Closed (btwn 2011-16)",
          "Closed (btwn 2016-21)",
          "Opened (btwn 2011-16)",
          "Opened (btwn 2016-21)"),
          legend.shape.show = FALSE
          ) +
  tmap_defaults +
  tm_shape(ham_bay, bbox=ham_community_bounds) + tm_polygons(col="lightblue", border.alpha = 0) + 
  tm_shape(hydro_p_LakeOntario, bbox=ham_community_bounds) + tm_polygons(col="lightblue", border.alpha = 0)+
  tm_layout( bg.color = "grey99",
             panel.label.bg.color = "white",
             panel.label.height = 0.9,
             panel.labels = "Non-motorized minutes",
             legend.outside = TRUE)
  

ttim_20112021_CHANGE_plot <- tmap_arrange(motor_ttim_20112021_CHANGE_plot,
                                                  nonmotor_ttim_20112021_CHANGE_plot, nrow=2)

tmap_save(ttim_20112021_CHANGE_plot, 
          paste0(here::here(),"/Figures/Fig9.tiff"),
          height=5.5,
          width=7.5, 
          dpi=600)
```

```{r, eval=FALSE}
#some community summary tables?
SAvail_im_DA2011  |> st_drop_geometry() |> group_by(COMMUNITY, mode) |> summarise(
  LIM = mean(DA_prev_LIMAT_under18, na.rm = T)*mean(kid_popadj_m, na.rm = T),
  sum_total_tt = sum(total_tt),
  emis_perkid = sum(emissions_total_car_tt)/sum(kid_popadj_m),
  sum_V_im = sum(V_im),
  mn_v_im = mean(v_im_kid_popadj),
  mn_v_im_LIM = mean(v_im_kid_popadj_LIMAT))

SAvail_im_DA2016  |> st_drop_geometry() |> group_by(COMMUNITY, mode) |> summarise(
  LIM = mean(DA_prev_LIMAT_under18, na.rm = T)*mean(kid_popadj_m, na.rm = T),
  sum_total_tt = sum(total_tt),
  emis_perkid = sum(emissions_total_car_tt)/sum(kid_popadj_m),
  sum_V_im = sum(V_im),
  mn_v_im = mean(v_im_kid_popadj),
  mn_v_im_LIM = mean(v_im_kid_popadj_LIMAT))                                                
```

```{r creating-desc-stats-table-tt, echo=FALSE}
#forming a complete descriptive statistic table
# Statistics <- data.frame("Statistic" = c("Parcel pts", "Trips",
#                                          "TT min.", "TT 1st qu.", "TT mean", "TT 3rd qu.", "TT max."))
# `2011` <- data.frame(`Y2011` = c(ALL_nearest_network_point %>% filter(Year != "2016") %>% pull(ROLL_NUM) %>% length() %>% round() ,
#                                 ALL_PARCELS %>% filter(ParYear != "2016" & Level == "Elementary") %>% pull(ROLL_NUM) %>% length()%>% round(),
#                                 ALL_PARCELS %>% filter(ParYear != "2016" & Level == "Elementary") %>% pull(car_tt) %>% min()%>% round(),
#                                 ALL_PARCELS %>% filter(ParYear != "2016" & Level == "Elementary") %>% pull(car_tt) %>% quantile(0.25) %>% as.numeric()%>% round(), 
#                                 ALL_PARCELS %>% filter(ParYear != "2016" & Level == "Elementary") %>% pull(car_tt) %>% mean()%>% round(),
#                                 ALL_PARCELS %>% filter(ParYear != "2016" & Level == "Elementary") %>% pull(car_tt) %>% quantile(0.75) %>% as.numeric()%>% round(),
#                                 ALL_PARCELS %>% filter(ParYear != "2016" & Level == "Elementary") %>% pull(car_tt) %>% max()%>% round()
#                                 ))
# `2016` <- data.frame(`Y2016` = c(ALL_nearest_network_point %>% filter(Year != "2011") %>% pull(ROLL_NUM) %>% length()%>% round(),
#                                 ALL_PARCELS %>% filter(ParYear != "2011" & Level == "Elementary") %>% pull(ROLL_NUM) %>% length()%>% round(),
#                                 ALL_PARCELS %>% filter(ParYear != "2011" & Level == "Elementary") %>% pull(car_tt) %>% min()%>% round(),
#                                 ALL_PARCELS %>% filter(ParYear != "2011" & Level == "Elementary") %>% pull(car_tt) %>% quantile(0.25) %>% as.numeric()%>% round(), 
#                                 ALL_PARCELS %>% filter(ParYear != "2011" & Level == "Elementary") %>% pull(car_tt) %>% mean()%>% round(),
#                                 ALL_PARCELS %>% filter(ParYear != "2011" & Level == "Elementary") %>% pull(car_tt) %>% quantile(0.75) %>% as.numeric()%>% round(),
#                                 ALL_PARCELS %>% filter(ParYear != "2011" & Level == "Elementary") %>% pull(car_tt) %>% max()%>% round()
#                                 ))
# desc_stats_tt <- cbind(Statistics,`2011`, `2016`)
# 
# #kable tabling
# desc_stats_tt %>%
#   kableExtra::kable(format = "latex",
#         align="lrrrrrr",
#         booktabs = T,
#         col.names = c("Statistic", "2011", "2016"),
#         caption = "\\label{tab:desc-stats-table-tt}Descriptive statistics of the parcels, trips, and calculated origin-destination car travel times.") %>%
#   kableExtra::kable_styling(full_width = "T",
#                 latex_options = c("scale_down"),
#                 position = "center")
```


```{r include=FALSE}
#calc changes between the years - but between communities with geom for mapping

#LIMAT: here we assume 2016 and 2011 LIMAT are only comparable... 2021 reflects one-time covid payments that temporary brought people out of poverty.
t2011 <-avail_2011 |> group_by(GeoUID_2021) |>
  summarise(COMMUNITY = first(COMMUNITY),
            LIMAT_2011 =  mean(DA_prev_LIMAT_under18, na.rm=T),
            kid_popadj_2011 = sum(kid_popadj, na.rm=T)) 

t2016 <-avail_2016 |> group_by(GeoUID_2021) |>
  summarise(COMMUNITY = first(COMMUNITY),
            LIMAT_2016 =  mean(DA_prev_LIMAT_under18, na.rm=T),
            kid_popadj_2016 = sum(kid_popadj, na.rm=T)) 

t2021 <-avail_2021 |> group_by(GeoUID) |>
  summarise(COMMUNITY = first(COMMUNITY),
            LIMAT_2021 =  mean(DA_prev_LIMAT_under18, na.rm=T),
            kid_popadj_2021 = sum(kid_popadj, na.rm=T))

ct201621_2011 <- full_join(t2011, t2016, 
                        by=c("GeoUID_2021"="GeoUID_2021", "COMMUNITY")) |>
  full_join(t2021, 
            by=c("GeoUID_2021"="GeoUID", "COMMUNITY")) |>
  group_by(COMMUNITY) |> 
  summarise(LIMAT_2011 = mean(LIMAT_2011, na.rm=T),
            LIMAT_2016 = mean(LIMAT_2016, na.rm=T),
            kid_popadj_2011 = sum(kid_popadj_2011, na.rm=T),
            kid_popadj_2021 = sum(kid_popadj_2021, na.rm=T)) |>
  mutate(cLIMAT = ((LIMAT_2016-LIMAT_2011)/LIMAT_2011) , #|> scales::percent(accuracy = 2L)
         ckid_popadj  = ((kid_popadj_2021-kid_popadj_2011 )/kid_popadj_2011) )
  #mutate_if(is.numeric, round, 1) 

#OTGC
cs2021_2011 <- SCHOOLS |> st_drop_geometry() |> group_by(COMMUNITY) |> 
  summarise(OTGC2011 = sum(OTGC2011, na.rm=T), 
            OTGC2021 = sum(OTGC2021, na.rm=T)) |>
  mutate(cOTGC = ((OTGC2021-OTGC2011)/OTGC2011) ) 
#mutate_if(is.numeric, round, 1) 

#pop,
# motorized: V, vi, tt per kid 
# non-motorized: V, vi, tt per kid 
SAvail_im_COMM2011 <- avail_2011 %>%
  group_by(COMMUNITY, 
           mode) %>%
  summarize(total_tt_2011 = sum(travel_time_p50*kid_popadj),
            V_im_2011 = sum(V_ij),
            kid_popadj_m_2011 = sum(kid_popadj),
            .groups = "drop") |>
  mutate(total_tt_kid_2011 = total_tt_2011/kid_popadj_m_2011,
         v_im_kid_popadj_2011 = V_im_2011/kid_popadj_m_2011) 

SAvail_im_COMM2021 <- avail_2021 %>%
  group_by(COMMUNITY, 
           mode) %>%
  summarize(total_tt_2021 = sum(travel_time_p50*kid_popadj),
            V_im_2021 = sum(V_ij),
            kid_popadj_m_2021 = sum(kid_popadj),
            .groups = "drop") |>
  mutate(total_tt_kid_2021 = total_tt_2021/kid_popadj_m_2021,
         v_im_kid_popadj_2021 = V_im_2021/kid_popadj_m_2021) 

cSAvail_im_COMM2011_2021 <- left_join(SAvail_im_COMM2011, SAvail_im_COMM2021, by =c("COMMUNITY","mode"))|>
  mutate(c_total_tt = ((total_tt_2021-total_tt_2011)/total_tt_2011) ,
         c_V_im = ((V_im_2021-V_im_2011)/V_im_2011) ,
         c_kid_popadj_m = ((kid_popadj_m_2021-kid_popadj_m_2011)/kid_popadj_m_2011) ,
         c_total_tt_kid = ((total_tt_kid_2021-total_tt_kid_2011)/total_tt_kid_2011) ,
         cv_im_kid_popadj = ((v_im_kid_popadj_2021-v_im_kid_popadj_2011)/v_im_kid_popadj_2011) )

ct201621_2011 #LIMAT and pop
cs2021_2011 #OTGC
cSAvail_im_COMM2011_2021
```


```{r include=FALSE}
# ADD 2016 and 2021 data for each variable to this!! cSAvail_im_COMM2011_2021_df
cSAvail_im_COMM2011_2021_df <- data.frame(
  COMMUNITY = cSAvail_im_COMM2011_2021$COMMUNITY,
  mode = cSAvail_im_COMM2011_2021$mode,
  LIMAT_2011 = rep(ct201621_2011$LIMAT_2011, each=2),
  cLIMAT = rep(ct201621_2011$cLIMAT, each=2),
  kid_popadj_2011 = rep(ct201621_2011$kid_popadj_2011, each=2),
  kid_popadj_2021 = rep(ct201621_2011$kid_popadj_2021, each=2),
  ckid_popadj = rep(ct201621_2011$ckid_popadj, each=2),
  OTGC2011 = rep(cs2021_2011$OTGC2011, each=2),
  cOTGC = rep(cs2021_2011$cOTGC, each=2),

  V_im_2011 = cSAvail_im_COMM2011_2021$V_im_2011,
  V_im_2021 = cSAvail_im_COMM2011_2021$V_im_2021,
  c_V_im_perc = cSAvail_im_COMM2011_2021$c_V_im,
  v_im_kid_popadj_2011 = cSAvail_im_COMM2011_2021$v_im_kid_popadj_2011,
  c_v_im_perc = cSAvail_im_COMM2011_2021$cv_im_kid_popadj,
  
  total_tt_2011 = cSAvail_im_COMM2011_2021$total_tt_2011,
  c_total_tt = cSAvail_im_COMM2011_2021$c_total_tt,
  total_tt_kid_2011 = cSAvail_im_COMM2011_2021$total_tt_kid_2011,
  c_total_tt_kid = cSAvail_im_COMM2011_2021$c_total_tt_kid )|>
  arrange(desc(LIMAT_2011))
```

```{r include=FALSE}
tdata_1 <- cSAvail_im_COMM2011_2021_df |> 
  filter(mode == "c")|> 
  dplyr::select(c("COMMUNITY",
                  "LIMAT_2011",
                  "kid_popadj_2011",
                  "OTGC2011"))

tdata_1 <- insertRow(tdata_1 |> as.matrix(),2,
          cSAvail_im_COMM2011_2021_df |> 
            filter(mode == "c" & COMMUNITY == "HA") |> 
            dplyr::select(c("COMMUNITY", 
                            "cLIMAT", 
                            "ckid_popadj",
                            "cOTGC")) |> as.matrix())

tdata_1 <- insertRow(tdata_1,4,
          cSAvail_im_COMM2011_2021_df |> 
            filter(mode == "c" & COMMUNITY == "DU") |> 
            dplyr::select(c("COMMUNITY", 
                            "cLIMAT", 
                            "ckid_popadj",
                            "cOTGC")) |> as.matrix())

tdata_1 <- insertRow(tdata_1,6,
          cSAvail_im_COMM2011_2021_df |> 
            filter(mode == "c" & COMMUNITY == "SC") |> 
            dplyr::select(c("COMMUNITY", 
                            "cLIMAT", 
                            "ckid_popadj",
                            "cOTGC")) |> as.matrix())

tdata_1 <- insertRow(tdata_1,8,
          cSAvail_im_COMM2011_2021_df |> 
            filter(mode == "c" & COMMUNITY == "GL") |> 
            dplyr::select(c("COMMUNITY", 
                            "cLIMAT", 
                            "ckid_popadj",
                            "cOTGC")) |> as.matrix())

tdata_1 <- insertRow(tdata_1,10,
          cSAvail_im_COMM2011_2021_df |> 
            filter(mode == "c" & COMMUNITY == "FL") |> 
           dplyr::select(c("COMMUNITY", 
                            "cLIMAT", 
                            "ckid_popadj",
                            "cOTGC")) |> as.matrix())

tdata_1 <- insertRow(tdata_1,12,
          cSAvail_im_COMM2011_2021_df |> 
            filter(mode == "c" & COMMUNITY == "AN") |> 
            dplyr::select(c("COMMUNITY", 
                            "cLIMAT", 
                            "ckid_popadj",
                            "cOTGC")) |> as.matrix())
```


```{r include=FALSE}
tdata_2 <- cSAvail_im_COMM2011_2021_df |> 
  filter(mode == "c")|> 
  dplyr::select(c("COMMUNITY",
                  "V_im_2011",
                  "v_im_kid_popadj_2011",
                  "total_tt_kid_2011"))

tdata_2 <- insertRow(tdata_2 |> as.matrix(),2,
          cSAvail_im_COMM2011_2021_df |> 
            filter(mode == "c" & COMMUNITY == "HA") |> 
            dplyr::select(c("COMMUNITY", 
                            "c_V_im_perc", 
                            "c_v_im_perc",
                            "c_total_tt_kid")) |> as.matrix())

tdata_2 <- insertRow(tdata_2,4,
          cSAvail_im_COMM2011_2021_df |> 
            filter(mode == "c" & COMMUNITY == "DU") |> 
            dplyr::select(c("COMMUNITY", 
                            "c_V_im_perc", 
                            "c_v_im_perc",
                            "c_total_tt_kid")) |> as.matrix())

tdata_2 <- insertRow(tdata_2,6,
          cSAvail_im_COMM2011_2021_df |> 
            filter(mode == "c" & COMMUNITY == "SC") |> 
            dplyr::select(c("COMMUNITY", 
                            "c_V_im_perc", 
                            "c_v_im_perc",
                            "c_total_tt_kid")) |> as.matrix())

tdata_2 <- insertRow(tdata_2,8,
          cSAvail_im_COMM2011_2021_df |> 
            filter(mode == "c" & COMMUNITY == "GL") |> 
            dplyr::select(c("COMMUNITY", 
                            "c_V_im_perc", 
                            "c_v_im_perc",
                            "c_total_tt_kid")) |> as.matrix())

tdata_2 <- insertRow(tdata_2,10,
          cSAvail_im_COMM2011_2021_df |> 
            filter(mode == "c" & COMMUNITY == "FL") |> 
            dplyr::select(c("COMMUNITY", 
                            "c_V_im_perc", 
                            "c_v_im_perc",
                            "c_total_tt_kid")) |> as.matrix())

tdata_2 <- insertRow(tdata_2,12,
          cSAvail_im_COMM2011_2021_df |> 
            filter(mode == "c" & COMMUNITY == "AN") |> 
            dplyr::select(c("COMMUNITY", 
                            "c_V_im_perc", 
                            "c_v_im_perc",
                            "c_total_tt_kid")) |> as.matrix())

tdata_3 <- cSAvail_im_COMM2011_2021_df |> 
  filter(mode == "w")|> 
  dplyr::select(c("COMMUNITY",
                  "V_im_2011",
                  "v_im_kid_popadj_2011",
                  "total_tt_kid_2011"))

tdata_3 <- insertRow(tdata_3 |> as.matrix(),2,
          cSAvail_im_COMM2011_2021_df |> 
            filter(mode == "w" & COMMUNITY == "HA") |> 
            dplyr::select(c("COMMUNITY", 
                            "c_V_im_perc", 
                            "c_v_im_perc",
                            "c_total_tt_kid")) |> as.matrix())

tdata_3 <- insertRow(tdata_3,4,
          cSAvail_im_COMM2011_2021_df |> 
            filter(mode == "w" & COMMUNITY == "DU") |> 
            dplyr::select(c("COMMUNITY", 
                            "c_V_im_perc", 
                            "c_v_im_perc",
                            "c_total_tt_kid")) |> as.matrix())

tdata_3 <- insertRow(tdata_3,6,
          cSAvail_im_COMM2011_2021_df |> 
            filter(mode == "w" & COMMUNITY == "SC") |> 
            dplyr::select(c("COMMUNITY", 
                            "c_V_im_perc", 
                            "c_v_im_perc",
                            "c_total_tt_kid")) |> as.matrix())

tdata_3 <- insertRow(tdata_3,8,
          cSAvail_im_COMM2011_2021_df |> 
            filter(mode == "w" & COMMUNITY == "GL") |> 
            dplyr::select(c("COMMUNITY", 
                            "c_V_im_perc", 
                            "c_v_im_perc",
                            "c_total_tt_kid")) |> as.matrix())

tdata_3 <- insertRow(tdata_3,10,
          cSAvail_im_COMM2011_2021_df |> 
            filter(mode == "w" & COMMUNITY == "FL") |> 
            dplyr::select(c("COMMUNITY", 
                            "c_V_im_perc", 
                            "c_v_im_perc",
                            "c_total_tt_kid")) |> as.matrix())

tdata_3 <- insertRow(tdata_3,12,
          cSAvail_im_COMM2011_2021_df |> 
            filter(mode == "w" & COMMUNITY == "AN") |> 
            dplyr::select(c("COMMUNITY", 
                            "c_V_im_perc", 
                            "c_v_im_perc",
                            "c_total_tt_kid")) |> as.matrix())

tdata_1 <- t(tdata_1) |> data.frame() 
tdata_2 <- t(tdata_2) |> data.frame() 
tdata_3 <- t(tdata_3) |> data.frame()
```

```{r}
tdata <- rbind(tdata_1,tdata_2,tdata_3)
tdata <- tdata[-c(1,5,9),]
tdata <- tdata[-c(6,9),] #also removing tts.. not needed
test <- data.frame(c("LIM-AT", "Kid pop.", "OTGC", "V (mt)", "v (mt)", "V (nmt)", "v (nmt)"))
tdata <- tdata|>mutate_if(is.character,as.numeric)
tdata <- cbind(test,tdata)
colnames(tdata) <- c("type","HA" ,"HA.1", "DU", "DU.1", "SC", "SC.1", "GL","GL.1","FL", "FL.1","AN","AN.1")
tdata <- tdata |> add_row(type = "Motorized") |> add_row(type = "Non-motorized")

tdata <- tdata[c(1,2,3,8,4,5,9,6,7),]
tdata <- tdata %>% replace(is.na(.), 0)

#tdata <- tdata %>% mutate_if(is.numeric, round, 2) 
```

# Introduction

Public services accessible within communities tend to oscillate: economic and demographic shifts, rural and urban configurations and political in/action all induce change. These forces spur pressures to reorganize and consolidate public facilities, potentially improving access for some but not for all residents in a community [@Christiaanse_2020; @Rosik_PulawskaObiedowska_Goliszek_2021]. Public schools are a compelling case study in this respect. Across the globe, school closure and consolidation policies have been pursued by governments to reduce the per-student cost of operating public education systems [@rongReviewResearchLowcarbon2022; @Dai_Wang_Zhang_Liao_Liu_2019]. Research has highlighted that these polices have knock-on implications, including the weakening of communities' social infrastructure [@butlerClosureRideau2019a; @irwinSchoolClosure2012; @AuttiHyryBeihammer2014] and negative household-level fiscal impacts such as a reduction of property values [@MerrallWhatsASchool2024]. Operationally, savings may be experienced by government, but they are paid at different levels by students, families, communities and society.

A school offers many things to a community, and one relevant dimension is how it shapes travel. This dimension is often overlooked by decision-makers tasked with implementing school closure and consolidation policies [@bierbaumMobilityJusticeLinking2021; @Lee_Lubienski_2017]. When schools and residential locations are co-located, the journey-to-school presents an excellent opportunity for physical activity [@desjardinsFramingActive2024]. However, school closures exchange these opportunities for active transportation with the near-certainty of motorized travel [@morencyStepsReserve2009; @morencyHowMany2007; @rongReviewResearchLowcarbon2022]. Indeed, motorized travel to school is the second-largest contributor to carbon emissions from personal daily travel, following the journey-to-work [@rongReviewResearchLowcarbon2022; @pantelakiImpactHomeschoolCommuting2024]. Unfortunately, these environmental impacts are rarely considered when school closure/consolidation policies are implemented [@sageman2022], and these policies are a relatively common occurrence globally. For instance, 65% of comprehensive schools (e.g. grades 1 through 9) in rural Finland since 1990 closed [@AuttiHyryBeihammer2014], 10% of elementary schools (kindergarten through grade 8) in Chicago, USA in 2013 [@Lee_Lubienski_2017], and 7% of primary and lower secondary schools (kindergarten through grade 9) were closed in Denmark between 2010-2011 [@Beuchert_Humlum_Nielsen_Smith_2018].

In this context, we investigate the case of Hamilton, a mid-sized city in Canada that pursed school closure and consolidation policies following changes to educational funding provided by the province of Ontario. We quantify the transportation implications of these policies using the capacity of schools in 2011, 2016 and 2021, after several waves of school closures and consolidations. To this end, we use a novel multimodal extension of a singly-constrained accessibility measure known as spatial availability [@soukhovIntroducingSpatialAvailability2023; @soukhovMultimodalSpatialAvailability2024]. We use this measure to estimate active (i.e., walking) and motorized (i.e., car) accessibility while constraining the supply of the service to the capacity schools. In this way, this work furnishes evidence to document how government austerity hurts public goals (such as physical activity) and locks school boards and families into motorized patterns of travel for the foreseeable future. 

To foreshadow the paper's conclusions, our findings indicate that school seats have became less spatially available in the city. This change happened unevenly, with certain communities being disproportionately affected. The school closure and consolidation policy pursued by the school board may have achieved cost savings in facility operation and maintenance. However, it has come at a cost to families, students, and communities, resulting in lost opportunities for healthier life-styles and an inevitable increase in motorized travel [@hammerWhy2012; @roseKids2013; @buckWhy2019]. To increase the diffusion of this analysis, all work is transparent and reproducible, following best practices in the spatial sciences [@brunsdonOpeningPractice2021; @paezOpenSpatial2021c]. For this reason, all associated code and data are publicly available within the lead author's [GitHub repository](https://github.com/soukhova/School-closures-accessibility-impacts).

# Background

## Overview of proximity and equity in the school accessibility literature

The examination of accessibility to public services is well-established, including studies of parks [@reyesalking2014; @elmurrWalkingAccessibilityParks2021], healthcare [@pereiraGeographicAccessCOVID192021], and public transportation [@moniruzzamanAccessibility2012; @tiznadoaitkenPublicTransportAccessibility2021], among many other services [e.g., @bittencourtEvaluatingAccessibilityAvailability2023; @kelobonye2020measuring]. 

Schools are a service that has been studied across several transportation dimensions. For instance, @marquesAccessibilityPrimarySchools2020 demonstrates that lower-income neighbourhoods in Portugal tend to have lower accessibility to schools compared to more advantaged neighbourhoods. Similar conclusions are drawn in West Virginia, US by @Talen_2001, England by @burgess2011parental, Baton Rouge, US by @williamsDisparitiesAccessibilityPublic2014, SÃ£o Paulo and Curitiba, Brazil by @morenomonroyPublicTransportSchool2018, @pizzolQualifyingAccessibilityEducation2021, and @bittencourtEvaluatingAccessibilityAvailability2023, and Santiago de Chile by @tiznadoaitkenPublicTransportAccessibility2021. Research has also demonstrated that school closures are seldom politically neutral decisions. For instance, spatial trends were explored in the context of England by @pinchChangingGeographyPreschool1987, areas of declining school-aged populations in Dreseden, Germany by @mullerAssessmentSchoolClosures2011, rural Finnish communities by @AuttiHyryBeihammer2014, and Chicago, US by @Lee_Lubienski_2017.

The methods applied to measure school accessibility have also been varied. For example, @marquesAccessibilityPrimarySchools2020 presents indicators of school seats per student along with the shortest distance from origin to schools within a school catchment. Similar methods are also used in @Talen_2001 and @burgess2011parental. Several authors propose refinements to these methods; @mullerAssessmentSchoolClosures2011, for instance, considers travel time by public transit from origins to schools, whereas @pizzolQualifyingAccessibilityEducation2021 considers travel times by different modes and multiple schools from a single origin along with other indicators related to school quality. By contrast, @williamsDisparitiesAccessibilityPublic2014, @Lee_Lubienski_2017, @morenomonroyPublicTransportSchool2018, @tiznadoaitkenPublicTransportAccessibility2021, and @bittencourtEvaluatingAccessibilityAvailability2023 use more complex approaches such as the two-step floating catchment area (2SFCA). The 2SFCA is popular in measure in evaluating access to healthcare services [@paez2019] and yields a supply-to-demand ratio that accounts for the population demanding a service and the quantity that is supplied within a certain distance range [@shenLocationCharacteristicsInnercity1998; @luoMeasuresSpatialAccessibility2003]. The consideration of the supply of service is pertinent in the case of schools and is acknowledged to as a limitation to using simpler accessibility measures [@pizzolQualifyingAccessibilityEducation2021].

In addition to competition for school-seats, theoretically, the use of faster modes (e.g., motorized modes) offers an advantage in terms of a wider range in school-seat choice. Though some of the works reviewed consider multiple modes, explicit attention to the modal _advantage_ has not been discussed. To this end, in this work we use spatial availability, a singly-constrained measure of spatial accessibility [@soukhovIntroducingSpatialAvailability2023; @soukhovMultimodalSpatialAvailability2024]. Spatial availability allows for the representation of the number of 'school-seats' that are spatially available to students by mode of transportation (i.e., motorized and active travel), considering the school-aged student population by zone. Further, spatial availability can be represented as school-seats per capita, mathematically equivalent to the supply-to-demand ratio of the 2SFCA (see appendix in @soukhovIntroducingSpatialAvailability2023). Adopting this interpretation enhances the interpretability of the spatial availability analysis and its comparability between years.

## Hamilton's school closures and consolidation

Hamilton is a mid-size city (\~570,000 pop) in the province of Ontario, Canada, with rural, suburban and urban characteristics [@governmentofcanadaProfileTableCensus2022]. The city's public English education system is managed by the Hamilton-Wentworth District School Board (HWDSB) and the Hamilton-Wentworth Catholic District School Board (HWCDSB). Together, HWDSB and HWDCSB provide public English education to the majority of school-aged children in Hamilton [@faoOntarioSchoolBoards2023]. And like many others school boards in Ontario, HWDSB and HWCDSB faced fiscal pressures from the province. For example, in 2013, the HWDSB released its Long Term Facilities Master Plan (LTFMP) [@hwdsbLongTermFacilities2013], which nominally meant to ensure "equitable, affordable and sustainable learning facilities". This plan indicated that 80% of its elementary schools (attended by students aged approximately 5 to 14) would be subject to a "Pupil Accommodation Review", an unprecedented amount of Reviews relative to other school boards [@seasons2014ARCCatalogues2014]. 

The announcement of these Pupil Accommodation Reviews promptly led to public outcry, since the outcome of Pupil Accommodation Reviews historically translated into school closures and consolidations [@craggsBoardEvaluatingFuture2013; @seasonsSchoolClosurePolicy2014]. The large number of scheduled Reviews was likely driven by the existing funding pressures faced by the school boards. The school boards rely almost entirely on provincial funding which is allocated through a pupil-enrolment based formula [@mackenzieBlueprintFixOntario2018; @irwinSchoolClosure2012]. However, this funding formula has demonstrably become insufficient to maintain schools in a state of good repair [@auditorgeneralofontarioAnnualReport20152015]. Additionally, school boards are under intense pressure to justify their spending to the province, and the 2012 Ontario Budget exacerbated matters by calling for school closures as a means of achieving efficiencies [@irwinSchoolClosure2012]. Furthermore, existing "top-up" programs designed to assist with operation and maintenance costs, such as the School Facilities Operation and Renewal Grant, were gradually phased out and removed by 2018 [@tdsbLiftingMinistryEducations2024]. Against this backdrop, the Pupil Accommodation Review guidelines technically outlined a "community-focused" process for assessing the value that a school provides to students, the community, and the local economy [@seasonsSchoolClosurePolicy2014; @ministryofeducationPupilAccommodationReview2006]. However in practice, critical residents felt the outcomes of the Pupil Accommodation Reviews were predetermined [@thompsonItJustGalls2024]: older schools were slated to be closed, and a wholesome breakdown of costs to repair and maintain schools was not made available [@kleinhuisSeriousConcernsSchool2013]. The process introduced unbalanced incentives for school boards: as a concerned resident summarised at the time, "[b]y closing three schools, the HWDSB would have a strong case with the Ministry of Education to receive full funding for a new school" [@kleinhuisSeriousConcernsSchool2013]. Ontario's Ministry of Education's framework promotes the closing and consolidation of schools rather than cost-effective solutions for keeping older schools open [@kleinhuisSeriousConcernsSchool2013].

As forewarned, Pupil Accommodation Reviews led to school closures and consolidations. Between 2013 and 2016, `r SCHOOLS %>% filter(Status == "Removed") %>% pull(SchoolID) %>% length()` of the `r SCHOOLS %>% filter(Year == "2011 and 2016" | Year == "2011") %>% pull(SchoolID) %>% length()` elementary schools in Hamilton were closed. Likely influenced by the unpopularity of school closures, in 2017, the provincial government introduced a moratorium on starting any _new_ Pupil Accommodation Reviews. In the subsequent years, HWDSB worked to clear its backlog by completing the Accommodation Reviews that had already been initiated, resulting in the closure of `r SCHOOLS %>% filter(Status_2 == "Removed") %>% pull(SchoolID) %>% length()` additional schools between 2017 to 2021 [@hwdsb2023LongTermFacilities2023]. While the number of elementary school locations declined by `r -((SCHOOLS %>% filter(Year_2 != "2016") %>% pull(SchoolID) %>% length() - SCHOOLS %>% filter(Year != "2016") %>% pull(SchoolID) %>% length())/SCHOOLS %>% filter(Year != "2016") %>% pull(SchoolID) %>% length()) %>% scales::percent()` between 2011-2021, HWDSB intends to conduct future Pupil Accommodation Reviews as initially scheduled, awaiting the end of the moratorium before scheduling new dates [@hwdsb2023LongTermFacilities2023].

A justification for closures and consolidations are estimated operational savings based on "projected" reductions in student population and "under-utilized" school capacity [@craggsAxeCouldFall2012; @tdsbLiftingMinistryEducations2024; @opsbaRightSchoolsRight2024]. However, city-wide, these policies led to overall reductions in school capacity per student. While many schools where closed and a few expanded (e.g., consolidated), the overall number of school seats in the city declined `r  -(( ((avail_2021 |> group_by(SchoolID) |> summarize(OTGC = first(OTGC2021)) |> select(OTGC) |> sum())) - (avail_2011 |> group_by(SchoolID) |> summarize(OTGC = first(OTGC2011)) |> select(OTGC) |> sum())) / (avail_2011 |> group_by(SchoolID) |> summarize(OTGC = first(OTGC2011)) |> select(OTGC) |> sum()) ) |> scales::percent()` between 2011 and 2021, and the impacts were felt unevenly across the city.

<!--
It should be noted that although closures dominated the Pupil Accommodation Review process, some schools were "consolidated", that is, a school or two were closed and another school was expanded or opened to accommodate students from closed schools. Since school locations decreased proportionally more than school-seats, elementary schools in Hamilton are on average larger in 2021 than they were in 2012.

In 2024, the moratorium on Pupil Accommodation Reviews is still in place and school boards are motivated by the same funding conditions. In absence of new revenue-generating levers and under the same funding formula with even lower inflation adjusted per-pupil funding, many school boards are calling for an end to the moratorium [@opsbaRightSchoolsRight2024; @tdsbLiftingMinistryEducations2024; @draaismaTDSBConsideringCuts2024]. In the meantime, some school boards have reduced specialized and community-wide programming [@tdsbLiftingMinistryEducations2024]. Under the status-quo, the end of the moratorium is likely to result in further school closures. These decisions, made under an austere funding formula and flawed school board incentives does not create an environment where solutions for a sustainable public education system can thrive. 
-->

Furthermore, existing research indicates that schools have a plethora of benefits not captured by their maintenance and operational costs [@butlerClosureRideau2019a; @irwinSchoolClosure2012; @AuttiHyryBeihammer2014], and in this paper we focus on the transportation implications. For students who live in proximity to schools, closures or consolidations directly eliminate the potential for active trips, and consequently physical activity. Closing a school permanently reduces the potential for active trips and further entrenches reliance on motorized travel. Additionally, from the perspective of modal equity, school-aged populations with access to motorized transport gain a speed-time advantage, providing them with greater flexibility and choice in accessing school-seats.

The spatial and population-level distribution of these impacts are of question for this paper. Specifically, the paper's aim is to investigate how these policies impacted the motorized and non-motorized (active) school-seat accessibility landscape. We hypothesize that school closure and consolidation policies reduced the availability of school-seats for many students. By extension, this loss in accessibility and the displacement of active trips likely resulted in decreased potential active travel minutes and increased motorized travel minutes, with these impacts distributed inequitably across space and populations. To test these hypotheses, the paper examines the following:

- Did accessibility, namely spatial availability, change for home-to-school trips following school closures and consolidations?
- Which communities, particularly those with a higher prevalence of low-income households, experience the greatest non-motorized (active) and motorized spatial availability losses?

# Data

This work focuses on the evaluation of the impacts of school closures and consolidations in Hamilton for the years 2011, 2016 and 2021. The primary outcome of interest is the multimodal school-seat spatial availability. To investigate this, the following data is prepared for each studied year: 1) school configurations, 2) student population, prevalence of low-income households, and residential parcel locations, and 3) estimated trip length by mode of transportation. The following three sub-sections describe this data.

## Schools 

For this study, we use the locations of elementary schools and their capacities for each of three studied years: 2011, 2016, and 2021. 

Concerning school locations, the City's school boards provided the authors with locations and associated school catchments for the 2010-2011 and 2015-2016 academic years. School locations in 2021 were retrieved from the City's open data portal [@hamiltonEducationalInstitutions2024]. In Hamilton, the majority of student-aged population attend school in one of the two English public school boards [@faoOntarioSchoolBoards2023]. School catchments for the public and public-catholic catchments indicate the default school for households. However, families can opt for their children to attend schools out of catchment. In fact, according to the regional travel survey (the Transportation Tomorrow Survey, or TTS), 21%-23% <!--calculated in 03-travel-times-TTS.qmd--> of motorized school trips for populations aged 5 through 14 were made to out-of-catchment schools in 2011 and 2016, the most recent TTS available at the time of writing [@data_management_group_tts_2018]. 

In addition to school locations, all schools were also tagged with a school status regarding their operational status (i.e., open or closed) and/or changes in location or school-seat capacity. A summary of the status of schools through 2011 to 2021 is shown in @fig-Fig1. @fig-Fig1 also displays a count of the number of schools with the status between years, the number of schools overall present in each year, and the symbolic representation of a school status that are used in Figures throughout the paper. Overall, a school can have one of seven school statuses in any given year. Either: 1) the school did not change throughout 2011 to 2021, 2) the school expanded (i.e., increased school-seat capacity) or was 3) relocated and expanded (N.B., schools expanded only between 2011 through 2016 as they were typically done _before_ school closures and no new Pupil Accommodation Review was commenced after 2017), 4) the school closed sometime after 2011 and before 2016 or 5) after 2016 and before 2021, and 6) the school opened sometime after 2011 and before 2016 or 7) after 2016 and before 2021.

```{r}
#| label: fig-Fig1
#| fig-cap: "Overview of the number of schools in Hamilton in 2011, 2016 and 2021 along with the type of school status change."
#| echo: false
#| out-width: "100%"

knitr::include_graphics(paste0(here::here(),file="/Figures/Fig1.jpg"))
#grid.raster(readTIFF(paste0(here::here(),"/Figures/Fig1.tiff")))
```

For the spatial availability analysis, the capacity of each school is also required for each year. This capacity is the number of 'seats' available at the school as calculated by the provincial Ministry of Education. It is referred to as the on-the-ground capacity (OTGC) of a school. However, it is important to note that schools rarely operate at exactly their OTGC, they are typically either over-enrolled or under-enrolled. 

Current and historic OTGCs for schools are not publicly available [@ontarioSchoolFacilityInventory2017], so we used a set of known OTGC values gathered from Pupil Accommodation Review documents and multivariate regression to estimate and validate these values. Two regression models were created: one for public schools and another for public catholic schools. The independent variables in these models were 1) a dummy variable indicating the level of the school (*MidElem*, *JrElem*, *Elem*); 2) the school's building footprint (*F*) in $m^2$; and 3) the school's Euclidean distance from the centroid of Hamilton's central business district area (*DistCBD*) in metres.

Formally, elementary schools are defined as schools that provide instruction to any combination of grades between kindergarten to grade 8 (i.e. typically children aged 5 to 14). As such, elementary includes middle schools that only instruct grades 6 to 8 (*MidElem*), primary schools that only instruct kindergarten to grade 5 or 6 (*JrElem*), and all grade elementary schools (*Elem*) which instruct all grades from kindergarten to grade 8. *MidElem* and *JrElem* school grade instruction type is only present in the public school board.

- The building footprint *F* was retrieved from an archived spatial data set [@DMTI_Spatial_2015] and footprints from newer schools in 2016 and 2021 from OSM [@OpenStreetMap_2021]. 

- *DistCBD* was calculated 'as the crow flies' from each school to the centroid of the Hamilton CBD (43.256684$\circ$N, 79.869039$\circ$W). Notably, this variable can also be seen as a proxy for school construction age as older buildings in Hamilton are generally located closer to the CBD, the "old" Hamilton community [@Merrall_2021].

Equations (\ref{eq:OTGC-public}) and (\ref{eq:OTGC-catholic}) are the OTGC regression model for public schools and public catholic schools respectively. As seen in Table \ref{Tab1-OTGC}, the coefficient of determination for these models are quite high, at $R^2 = 0.999$ and $R^2 = 0.998$ for the public and public catholic school boards respectively, and the residual standard deviation is $\sigma = 0.212$ and $sigma = 0.331$. 

```{=tex}
\begin{equation}
\label{eq:OTGC-public}
OTGC_{Public} = F^{0.346}-e^{0.00003*DistCBD}+e^{3.123*JrElem}+e^{3.752*Elem}+ e^{3.068*MidElem} 
\end{equation}
```

```{=tex}
\begin{equation}
\label{eq:OTGC-catholic}
OTGC_{Public Catholic} =F^{0.471}-e^{0.00003*DistCBD}+e^{2.333*Elem}
\end{equation}
```

\input{Tab1.tex} <!--made in the hamONdests repo-->

Taken together, @fig-Fig2 displays the city's elementary schools locations, status, and their observed or estimated OTGCs for 2011, 2016 and 2021. For additional context on the degree of residential urbanization in Hamilton, the percentage of residential parcels considered 'urban' compared to 'suburban' or 'rural' is reflected at an aggregated spatial unit across all six plots in @fig-Fig2. This land-use classification is available within the 2021 residential parcel file described in the following sub-section. In @fig-Fig2, it can be seen that the majority of schools that changed status are in the HWDSB, with OTGC decreasing in 2016 and 2021 compared to the previous year. Most school closures took place in the central and eastern parts of Hamilton's urban area (Hamilton Central), as well as in rural areas of western Hamilton (Flamborough). When schools did open or expand, it was primarily in the more recently urbanized southeastern area of Hamilton (Glanbrook), with a few also in Hamilton Central to offset some of the lost capacity.

```{r}
#| label: fig-Fig2
#| fig-cap: "The on-the-ground capacity (OTGC) of schools and school status for year 2011, 2016 and 2021 for both the HWDSB and HWCDSB. Schools are presented overtop a layer visualising the degree of residential urbanisation in 2021."
#| echo: false
#| out-width: "120%"

grid.raster(readTIFF(paste0(here::here(),"/Figures/Fig2.tiff")))
```


## Students, residential locations and low-income prevelance

Secondly, a detailed account of the average student population, low-income prevalence of households, and where they may live is required for each studied year. 

Concerning the student population and poverty, information from the 2011, 2016 and 2021 Canadian Census [@Statistics_Canada_2011; @Statistics_Canada_2016; @Statistics_Canada_2021] was sourced using the {cancensus} R package [@von_Bergmann_Shkolnik_Jacobs_2021]. The census releases population data by age group category, so the population aged between 5-9 years and 10-14 years were retained. A common poverty measure across all three census years is the low-income after-tax measure (LIM-AT), which reflects the proportion of private households that are below the median after-tax income in the region [@governmentofcanadaDictionaryCensusPopulation2017]. The LIM-AT prevalence for households with children under 18 was retrained for this paper as there is no LIM-AT prevalence tabulated for households with exclusively elementary-aged children. Population and LIM-AT variables were taken at the Dissemination Area (DA) level, the finest geographic unit publicly available. DAs are designed by Statistics Canada with the aim of population uniformity hence DAs greatly vary in area but represent between approximately 400 and 700 (1st and 3rd quartile) in total population. The population aged 5 to 14 and the proportion of LIM-AT are visualised in the first and last rows in @fig-Fig3. LIM-AT prevalence is notably more concentrated within the centre of Hamilton (Hamilton Central) through 2011 to 2021, overlapping the most urbanised land-use and the largest amount of schools closed (@fig-Fig2). Also of note, LIM-AT prevalence drastically decreased in 2021 as a result of Pandemic benefits that reduced income inequality [@governmentofcanadaDailyPandemicBenefits2022]. 

Student residential locations were approximated at the level of residential parcels. Centroids for parcels in 2011, 2016 and 2021 were retrieved from @Teranet_2009, representing $134,340$, $139,467$ and $143,890$ unique locations, respectively. Each residential unit in a parcel was populated with the average number of children aged 5-14 in the corresponding dissemination area (DA). Due to the proprietary nature of the parcel data, the second row in @fig-Fig3 shows an aggregation of the information: the average rate of 5-14 year old population per residential unit (parcel) at the DA level. Notably, though the rate of 5-14 year old population per parcel is higher in more peripheral (and rural) communities, there are many DAs within Hamilton Central that have high rates and populations that are similar to those in these more peripheral communities.   

```{r}
#| label: fig-Fig3
#| fig-cap: "The magnitude (top row) and rate per residential unit (middle row) of elementary aged student population per DA in 2011, 2016 and 2021. Bottom row: the proportion of low-income households (prevelance of low-income after-tax, LIM-AT, measured by the 2011, 2016 and 2021 Canadian Census) with dependents under 18 years old shown. All scales are represented in quartiles."
#| echo: false
#| out-width: "120%"
#| fig-pos: "H"

grid.raster(readTIFF(paste0(here::here(),"/Figures/Fig3.tiff")))
```

## Trip length by mode

To reflect multimodal travel behaviour, two types of data was estimated and compiled. The process for obtaining and preparing this data is described as follows.

First, we retrieved information about the mode used and origin-destination locations of home-to-school trips from the 2011 and 2016 TTS [@data_management_group_tts_2018]; the 2021 TTS survey is unavailable at the time of writing so 2016 flows are assumed for the 2021 year. The TTS is a travel survey conducted in the Greater Golden Horseshoe Area in Ontario typically every five years. With a target 5% sampling rate, the survey is expanded to be representative at the traffic analysis zone (TAZ) level of geography. TAZ are spatial units created for the purpose of the TTS and pulled from the R data package {TTS2016R} [@soukhovTTS2016RDataSet2023]; a few DAs typically nest within each TAZ. The trip-level travel data extracted for this paper represent `r od_trips_perc_2011$TAZOrig_car_trips |> sum() |> prettyNum(big.mark = ",")` and `r od_trips_perc_2016$TAZOrig_car_trips |> sum() |> prettyNum(big.mark = ",")` motorized trips (mode used includes private car passenger, school bus, taxi, and transit) and `r od_trips_perc_2011$TAZOrig_walk_trips |> sum() |> prettyNum(big.mark = ",")` and `r od_trips_perc_2016$TAZOrig_walk_trips |> sum() |> prettyNum(big.mark = ",")` non-motorized trips (mode used includes walk and cycling) for 5 to 14 year olds from home-to-school in 2011 and 2016 respectively. The intensity of modal home-to-school flows are visualised in @fig-Fig4 along with the boundaries of the TAZ and DAs. Also in @fig-Fig4, not all TAZs capture an elementary school trip by both modes. For this reason, the proportion of motorized modal share is aggregated at the community level. Hamilton (Ancaster - 2011: `r community_car_perc_2011$TAZOrig_car_perc[1] |> percent()`and 2016:`r community_car_perc_2016$TAZOrig_car_perc[1] |> percent()`, Dundas - 2011: `r community_car_perc_2011$TAZOrig_car_perc[2] |> percent()` and 2016: `r community_car_perc_2016$TAZOrig_car_perc[2] |> percent()`, Flamborough - 2011: `r community_car_perc_2011$TAZOrig_car_perc[3] |> percent()` and 2016: `r community_car_perc_2016$TAZOrig_car_perc[3] |> percent()`, Glanbrook - 2011: `r community_car_perc_2011$TAZOrig_car_perc[4] |> percent()` and 2016: `r community_car_perc_2016$TAZOrig_car_perc[4] |> percent()`, Hamilton Central - 2011: `r community_car_perc_2011$TAZOrig_car_perc[5] |> percent()` and 2016:`r community_car_perc_2016$TAZOrig_car_perc[5] |> percent()`, and Stoney Creek - 2011: `r community_car_perc_2011$TAZOrig_car_perc[6] |> percent()` and 2016: `r community_car_perc_2016$TAZOrig_car_perc[6] |> percent()`). 

```{r}
#| label: fig-Fig4
#| fig-cap: "The origin-destination flows from home-based motorized and non-motorized school trips for students between 5-14 years old as retrieved from TTS 2011 and 2016. Flows are mapped atop the proportion of TAZ non/motorized modal share from the TTS 2011 and 2016, DA boundaries, and Hamilton community boundaries."
#| echo: false
#| out-width: "120%"
#| fig-pos: "H"

grid.raster(readTIFF(paste0(here::here(),"/Figures/Fig4.tiff")))
```

Next, travel times matrices for motorized and active travel were calculated using {r5r} package [@Pereira2021r5r]. Travel time matrices were estimated for all TAZ centroids to TAZ centroids (matrices of size for 2011 and 2016: 234 x 234) as they are not reported in the TTS. Additionally, matrices were estimated for all residential parcels to schools (matrices of size 134,340 x 147 for 2011, 139,467 x 137 for 2016, and 143,890 x 132 for 2021) for additional granularity. {r5r} is a R-based interface to the R5 routing engine [@conveyalConveyalR5Routing2022]. For simplicity, we assume motorized travel is by car and non-motorized travel is by walking, as these are the most common modes in their respective categories. For travel time calculations, we set a maximum threshold of 60 minutes and use the free-flow OpenStreetMap road network of Hamilton [@geofabrikOntarioOpenStreetMapGeofabrik2022]. While all car trips are retained, walking trips over 27 minutes were filtered out. This duration corresponds to a distance of 1.6 km (assuming a walking speed of 3.6 km/h), which is the home-to-school distance threshold for qualifying for motorized transport provided by the school board [@HWDSB_2019]. We use this threshold to assume that trips longer than 27 minutes are highly unlikely to be made on foot.

In terms of the travel impedance function: we assume that children can go to any elementary school, however, there is a preference for facilities that are more proximate. Based on this assumption, we matched the associated TAZ-to-TAZ travel times to all observed student-to-school travel flows from the TTS; these are visualised as grey bar columns in @fig-Fig5. Using these observed values, the  _theoretical_ trip length distribution (TLD) functions are calibrated. TLDs can be interpreted as travel impedance functions as they represent the propensity of realized travel, by trip length [@horbachov_theoretical_2018; @batista_estimation_2019]. The TLDs are calibrated using the maximum likelihood and moment matching techniques and the Nelder-Mead and Brent methods for direct optimization available within the {fitdistrplus} R package [@fitdistrplus_2015]. The theoretical TLD for each mode and available study year is visualised in blue in @fig-Fig5. Based on goodness-of-fit criteria and diagnostics, the gamma and exponential distributions were selected for the motorized and non-motorized modal distributions respectively. The gamma distribution is defined by the shape ($\alpha$) parameter of `r round(gamma2011_motor$estimate[1], 3)` (2011) and `r round(gamma2016_motor$estimate[1], 3)` (2016) and the rate ($\beta$) of `r round(gamma2011_motor$estimate[2], 3)` (2011) and `r round(gamma2016_motor$estimate[2], 3)` (2016). The exponential distribution is defined by the rate ($\beta$) parameter of `r round(exp2011_nonmotor$estimate[1], 3)` (2011) and `r round(exp2016_nonmotor$estimate[1], 3)` (2016). For reference, the gamma distribution and the exponential distribution function are displayed in Equations (\ref{eq:exp-dist}) and (\ref{eq:gamma-dist}) where $x$ is $c_{ij}$:

```{=tex}
\begin{equation}
\label{eq:exp-dist}
f(x) = \beta e ^{-\beta x}
\end{equation}
```

```{=tex}
\begin{equation}
\label{eq:gamma-dist}
\begin{aligned}
f(x, \alpha, \beta) = \frac {x^{\alpha-1}e^{-\frac{x}{\beta}}}{ \beta^{\alpha}\Gamma(\alpha)} \quad \text{for } 0 \leq x \leq \infty \\
\Gamma(\alpha) =  \int_{0}^{\infty} x^{\alpha-1}e^{-x} \,dx
\end{aligned}
\end{equation}
```

```{r}
#| label: fig-Fig5
#| fig-cap: "Observed (grey bars) and theoretical (blue curves) motorized and non-motorized impedance functions. Motorized theoretical impedance function is based on the gamma distribution function and non-motorized on the expoential distribution function"
#| echo: false
#| out-width: "100%"
#| fig-pos: "H"

grid.raster(readTIFF(paste0(here::here(),"/Figures/Fig5.tiff")))
```

Lastly, to achieve greater granularity, the TLDs calibrated using TAZ-to-TAZ flows are used to estimate travel impedance values for each parcel-to-school flow based on calculated parcel-to-school travel times. These values represent the likelihood that students in a parcel will travel to a school, informed by observed home-to-school flows from the TTS.

# Methods: Multimodal spatial availability

Accessibility can be defined as the "potential for spatial interaction". It is classically presented as the measure defined in @hansenHowAccessibilityShapes1959 and takes the following general multimodal formulation:

```{=tex}
\begin{equation}
\label{eq:multimodal-conventional-accessibility}
S_i^m = \sum_{j=1}^JO_j \cdot f^m(c_{ij}^m)
\end{equation}
```
\noindent where:

-   $m$ is a set of modes.
-   $c_{ij}^m$ is a measure of the cost of moving between $i$ and $j$ for each $m$.
-   $f^m(\cdot)$ is an impedance function of $c_{ij}^m$ for each $m$; it can take the form of any monotonically decreasing function chosen based on positive or normative criteria [@paez2012measuring].
-   $i$ is a set of origin locations ($i = 1,\cdots,N$).
-   $j$ is a set of destination locations ($j = 1,\cdots,J$).
-   $O_j$ is the number of opportunities at location $j$.
-   $S$ is Hansen-type accessibility as weighted sum of opportunities.

As indicators of urban structure, Hansen-type accessibility measures like Equation (\ref{eq:multimodal-conventional-accessibility}) are informative in reflecting the magnitude of access but meaning of the value itself is elusive. The significance of 10,000 accessible school-seats is hard to pin down: how many opportunities must any single student have access to? Furthermore, this opaque interpretation especially is complicated when comparing accessibility of school seats between years, such as different years as in this work. The interpretability of Hansen-type accessibility has been discussed in numerous studies, including recently by @hu_2019_measuring, @kelobonye2020measuring, and in greater depth by @merlin2017competition along with @soukhovIntroducingSpatialAvailability2023 and @soukhovMultimodalSpatialAvailability2024. The interpretation of accessibility depends on how many people demand the opportunity, especially for exclusive opportunity-types like schools-seats (i.e., one school-seat is for one student).

In this paper, our work benefits from new developments in accessibility research, particularly the multimodal spatial availability measure [@soukhovIntroducingSpatialAvailability2023; @soukhovMultimodalSpatialAvailability2024]. Spatial availability is a singly-constrained accessibility measure that can account for competition of students using different modes potentially interacting with scarce opportunities, such as school seats. The measureâs sinlge constraint ensures that the marginals at the destination are met and thus the number of estimated school seats (opportunities) are preserved and allocated proportionally to the mode-using student populations. This proportional allocation of opportunities yields an interpretable and meaningful measure of opportunity access, particularly when comparing across modes, at the spatial resolution of a residential parcel, and multiple time periods. See @soukhovMultimodalSpatialAvailability2024 for further discussion. 

The multimodal spatial availability $V_{i}^m$ is defined as given by Equation (\ref{eq:spatial-availability}):

```{=tex}
\begin{equation}
\label{eq:spatial-availability}
V_{i}^{m} = \sum_{j=1}^J O_j\ F^{tm}_{ij}
\end{equation}
```
\noindent where:

-   $F^{tm}_{ij}$ is a balancing factor that depends on the population and cost of movement in the system as part of the gravity modelling framework and is captured in Equation (\ref{eq:balancing-factors}) for mode $m$.
-   $O_j$ is the number of opportunities at $j$.
-   $V_i^m$ is the number of spatially available opportunities from the perspective of $i$ for mode $m$.

$F^{tm}_{ij}$ can also be understood as the joint probability of allocating opportunities, where $F^{pm}_{i}$ is the population-based balancing factor that grants a larger share of opportunities to larger $m$ population spatial units and $F^{cm}_{ij}$ is the impedance-based balancing factor that grants a larger share of the opportunities to less $m$-travel costly centers. Together $F^{tm}_{ij}$ ensures proportional allocation such that opportunities $O$ (like school-seats) are preserved for the whole region (i.e., $O = \sum_{j} O_j = \sum_{i} V_i = \sum_{m}\sum_{i} V_i^m$ ) and is reflected in Equation (\ref{eq:balancing-factors}):

```{=tex}
\begin{equation}
\label{eq:balancing-factors}
F^{tm}_{ij} = \frac{F^{pm}_{i} \cdot F^{cm}_{ij}}{\sum_{i} F^{pm}_{i} \cdot F^{cm}_{ij}}
\end{equation}
```
\noindent where:

- The factor for allocation by population for each $m$ at each $i$ is $F^{pm}_{i} = \frac{P_{i}^m}{\sum_{m}\sum_{i} P_{i}^m}$
- The factor for allocation by travel cost for each $m$ at each $i$ and $j$ is $F^{cm}_{ij} = \frac{f^m(c^m_{ij})}{\sum_{m}\sum_{i} f^m(c^m_{ij})}$

It should be noted that, when summed over all spatial units in the region, the population-based allocation factors $F^{pm}_{i}$ always equal 1 ($\sum_{m}\sum_{i} F^{pm}_{i}= 1$), likewise for impedance-based allocation factors $F^{cm}_{i}$ ($\sum_{m}\sum_{i} F^{cm}_{ij} = 1$).

Hansen-type accessibility is not designed to preserve the number of opportunities in the region, it simply counts the intensity of opportunities that those in a zone can potentially interact with (weighted by the friction of distance). Also, as discussed in @soukhovIntroducingSpatialAvailability2023, popular competitive accessibility measures such as the two-step floating catchment area (2SFCA) [@josephMeasuringPotentialPhysical1982; @weibullAxiomaticApproachMeasurement1976; @shenLocationCharacteristicsInnercity1998; @luoMeasuresSpatialAccessibility2003] are internally inconsistent, and the only way it preserves the number of opportunities is if the effect of the impedance function is ignored when expanding the values of opportunities per capita to obtain the total number of opportunities. On the other hand, the proportional allocation procedure associated with calculating multimodal spatial availability $V_i^m$ consistently returns a number of opportunities available to populations by mode that matches the total number of opportunities in the region when summed. By doing this consistently, it is possible to define a measure of multimodal spatial availability per capita as presented in Equation (\ref{eq:SA-per-capita}) for use as a benchmark to compare against the regional opportunities per capita ($\frac{\sum_{j} O_j}{\sum_{i} P_i}$).

```{=tex}
\begin{equation}
\label{eq:SA-per-capita}
v_i^m = \frac{V_i^m}{P_i^m}
\end{equation}
```

To summarise the methodology and the data as described in Section 3, multimodal spatial availability $V_i^m$ and multimodal spatial availability per student $v_i^m$ is calculated for each parcel for each studied year as follows:

- First, all residential parcels are associated to their respective census DA, TTS TAZ, and community boundary based on spatial location. Each parcel is assigned a number of 'potential' motorized and non-motorized student aged population (from DA) and modal share (from TTS) to calculate a motorized and non-motorized population balancing factor $F_{i}^{pm}$. For each parcel, the elementary-aged student population per parcel (@fig-Fig3 second row) and the motorized and non-motorized share as informed by the TTS aggregated by community (@fig-Fig4) is retained. 
- Second, the school capacity $O_j$ is estimated and associated with each school (@fig-Fig2). All residential locations are assumed to be able to access all schools by non-motorized and/or motorized mode. All origins (residential locations) can reach all schools by motorized mode, but few residential locations can reach schools within a 27 minute non-motorized trip. 
- Third, the motorized and non-motorized impedance-balancing factors $F_{ij}^{cm}$ are calculated using a mode-specific impedance function (@fig-Fig5) based on the respective estimated travel times for each origin (parcel) to school combination. Using network estimated travel time sensitive to observed parcel origin to school destination flows conceptually addresses the aggregation error that could result from using less granular zonal units to represent origin/destinations [@kaneParcelsPointsProximity2020; @kwanSpaceTimeIntegralMeasures1998; @hewkoMeasuringNeighbourhoodSpatial2002]. 
- Finally, outputs from all three stages are joined together. $F_{i}^{pm}$ joined with $F_{ij}^{cm}$ yields the total balancing factor $F^{tm}_{ij}$ which serves to proportionally allocate the school capacity $O_j$ to each parcel. The value is multimodal spatial availability $V_i^m$ which can be interpreted as the number of school-seats that are available to the mode-using population at that parcel. $V_i^m$ is then summed and represented at the DA and community level along with the calculated $v_i^m$ for interpretation.

# Results

To clarify terminology for readers, $V_i^m$ is the number of school-seats available to populations by mode (either motorized or non-motorized) that matches the total number of opportunities in the region as a result of the proportional allocation mechanism. In other words, we describe $V_i^m$ as the number of school-seats available to a mode-using population. Each $i$ (parcel, DA, or community) maintains that singly-constrained relationship. $v_i^m$ is the per capita spatial availability to mode-using populations. 

The probability density plots of the spatial availability values $V_i^m$ and the per capita spatial availability $v_i^m$ values for both modes (motorized and non-motorized) and all three years are displayed in @fig-Fig6 as a city-wide overview. The left column displays parcel-level values, and the right reflects parcel-level values aggregated at the 2021 DA grid. Both the parcel and DA level values reflect the spatial unit at which they were calculated or aggregated. However, the values of the $V_i^m$ plots are not directly comparable since the x- and y- axes are set at different scale limits to highlight between year differences. However, overall trends in their distribution can be compared: in all four $V_i^m$ plots, the 2011 data is more right-skewed than more current years, indicating that spatial availability values used to be higher (e.g., more school-seat access). School closures and consolidations had an impact despite the background dynamics of assumed student population, mode use, travel time and parcel location. The DA level $V_i^m$ plots show the distribution of each DA value, which is the summation of all parcel $V_i^m$ values within a DA. In 2011, DAs can be observed to also have more right-skewed spatial availability values than previous years. In contrast, the 2016 and 2021 distributions are more intense and heavily skewed toward lower values.

Zonal per capita $v_i^m$ values can be compared across the years as the school-age population per spatial unit (e.g., parcel or DA) is used to normalize the respective $V_i^m$ value. $v_i^m$ values are presented in the bottom four plots of @fig-Fig6. It can be observed that the same 2011 right-skewed trend persists across all modes. Motorized mode-using students have access to more spatially available school seats than non-motorized mode using students (in 2011, approximately 1.3 school-seats per student as compared to 0.7 and in 2021 approximately 1.2 compared to 0.5). Due to school-seats per student at the DA level being an interpretable aggregation, values at this level will be the discussion focus of the remainder of this paper.

```{r}
#| label: fig-Fig6
#| fig-cap: "Spatial availability (Vi) and per capita spatial availability (vi) probability density distributions for the city of Hamilton in 2011, 2016 and 2021. Aggregated at the parcel level (left column) and DA level (right column)."
#| echo: false
#| out-width: "100%"
#| fig-pos: "H"

grid.raster(readTIFF(paste0(here::here(),"/Figures/Fig6.tiff")))
```

Representing the right column of @fig-Fig6 spatially, @fig-Fig7 displays the spatial availability for each DA for a given mode-using population $m$ (e.g., the sum of school seat availability per parcel in each DA for motorized or non-motorized students). @fig-Fig7 visualizes the spatial distribution of motorized and non-motorized school seat availability for 2011, 2016, and 2021. As a reminder, the sum of $V_i^m$ values for both motorized and non-motorized populations in a given year equals the city-wide OTGC (i.e., school seats across both the HWDSB and HWCDSB). This is due to $V_i^m$'s proportional allocation mechanism, singly-constraining opportunities through the proportion allocation balancing factors. In this way, $V_i^m$ values can be interpreted as a proportion of the total OTGC for that year, as the sum of $V_i^m$ for both modes in a year equals the total OTGC for that year.

Referring to the first two rows of $V_i^m$ plots in @fig-Fig7 (purples), it is notable that the magnitudes of $V_i^m$ values for the motorized and non-motorized populations are tremendously different. Again, each $V_i^m$ value reflects the number of school seats spatially available to the mode-using population at that zonal level, so due to the lower non-motorized modal share (refer to @fig-Fig4), non-motorized values will be lower. However, both mode-using populations have higher spatial availability values (darker purples) in DAs that are more proximate to schools. Hence, all DAs have higher values within Hamilton Central and those more proximate to schools in less-urban communities. This trend persists across 2011, 2016 and 2021, aligning with intuition: populations with shorter travel times to with relatively greater schools are calculated to have high school seat spatial availability. Motorized populations have shorter travel times at DAs further in distance from schools, while non-motorized populations are only competitive at proximate distances. 

The bottom two rows of $v_i^m$ plots in @fig-Fig7 (yellows to greens) demonstrate the spatial availability per mode-using student population e.g., $V_i^m$ divided by the number of students aged 5-14 using a motorized mode or non-motorized mode. It is notable that for motorized populations, their spatial availability per student is above 1 (green) within the center of the city. Conversely, this rate is only available to non-motorized populations in DAs that are in less-densely populated rural areas that are school proximate and very few pockets of Hamilton Central in 2011 and 2016. In 2021, even fewer DAs within Hamilton Central have non-motorized spatial availability rates above 1. 

```{r}
#| label: fig-Fig7
#| fig-cap: "Multimodal spatial availability (purples) and spatial availability per mode-using student (diverging reds and greens) aggregated at the DA level for 2011, 2016 and 2021. Scales are represented in deciles."
#| echo: false
#| out-width: "120%"
#| fig-pos: "H"

grid.raster(readTIFF(paste0(here::here(),"/Figures/Fig7.tiff")))
```

To further explore these changes, the difference in $V_i^m$ (first two rows) and difference in $v_i^m$ (second two rows) between 2011-2016, 2016-2021 and overall between 2011-2021 are displayed in @fig-Fig8 along with schools that changed during that time period. 2011-2016 and 2016-2021 add together to equal 2011-2021 changes quite clearly, e.g. in the third row, the 2011-16 plots a small decrease within the core of the city, and 2016-2021 demonstrates a more significant decrease in the core and western peripheral communities. Together, 2011-2021 plot reflects the changes in these two plots. 

A few notable spatial trends can be observed in @fig-Fig8. First, DAs in proximity to schools that closed (square points) see losses in $V_i^m$ (reds) for both motorized and especially non-motorized populations. For non-motorized populations, all closed school resulted in a decrease in $V_i^m$. The majority of school closures took place in the central and eastern parts of Hamilton's urban area (Hamilton Central), as well as in rural areas of western Hamilton (Flamborough). Hence, losses characterise those neighbourhoods. Secondly, gains in $V_i^m$ (blues) are seen where schools are opened (diamond points) or expanded (triangle points), especially for motorized populations. These gains are most notably in the more recently urbanized southeastern area of Hamilton (Glanbrook), along with a few pockets of DAs in proximity to new or expanded schools in Hamilton Central. Thirdly, the concentration of students in proximity to schools and the extent of their OTGC matters from the perspecitve of modal advantage. In areas with fewer proximate school options and lower OTGC relative to the amount of students, a change in a school results in a big impact on spatial availability values. For instance, in the community of Ancaster, one school expanded in the rural area in this community between 2011-2016. The motorized student population, especially in rural DAs, saw gains in spatial availability while non-motorized populations saw losses. Students in proximity to the schools in Ancaster have high non-motorized spatial availability, but when the school was expanded (and due to an under-served population) motorized populations saw an increase in spatial availability at the direct expense of non-motorized populations' spatial availability.

Exploring changes in $V_i^m$ provides a holistic view of spatial availability for a given DA. However, if the focus is on the ratio of spatial availability per student, the bottom two rows in @fig-Fig8 offer more insight. For instance, a community may have had an initially average rate of school seats per student but is expecting an increase in student population so it expands a school. However, due to an increase in population, the spatial availability per student overall still decreases between these two time periods. This case appears to occur in Ancaster between 2011 to 2016: while motorized $V_i^m$ increased, motorized $v_i^m$ slightly decreased, and non-motorized $v_i^m$ decreased relatively more than non-motorized $V_i^m$. As shown in @fig-Fig3, the student population and the number of students per residential unit increased more rapidly than the expanded school could accommodate, leading to a decrease in $v_i^m$ values in DAs proximate to expanded schools.

Similarly, in the southeastern community of Glanbrook, student populations grew from 2011 to 2021, and new schools opened. However, $v_i^m$ rates decreased because OTGC did not keep pace with student population growth. As another example, in Hamilton Central and the eastern community of Stoney Creek, changes in $V_i^m$ are unpatterned, while $v_i^m$ demonstrate more uniform decreases, with the pattern varying by modal-range for motorized versus non-motorized populations. In these communities, the student population remained relatively stable, though OTGC decreased overall. $v_i^m$ is illuminating to consider when comparing changes in spatial availability rates. 

```{r}
#| label: fig-Fig8
#| fig-cap: "Change in multimodal spatial availability and spatial availability per mode-using student from 2011 to 2016, 2016 to 2021, and together from 2011 to 2021. Change is the subtraction of parcel-level results in that given year and summed for each DA in the 2021 Canadian Census DA grid. Scales are represented in deciles."
#| echo: false
#| out-width: "120%"
#| fig-pos: "H"

grid.raster(readTIFF(paste0(here::here(),"/Figures/Fig8.tiff")))
```

Changes in multimodal spatial availability is important: A summary of spatial availability per Hamilton community and associated dimensions in 2021, along with the percentage change between 2011 and 2021, is presented in @tbl-Tab2.

```{r, warning=FALSE}
#| label: tbl-Tab2
#| tbl-cap: "Spatial availability and associated dimensions aggregated by communities in 2011 and percentage change by 2021. Motorized and non-motorized values are labeled with mt and nmt respectively."

pal <- function(x) {
  f_neg <- scales::col_numeric(
    palette = c('red', '#ffffff'),
    domain = c(-1, 0)
  )
  f_pos_smaller <- scales::col_numeric(
    palette = c('#ffffff', 'palegreen3'),
    domain = c(0.00000001, 1.5)
  )
  f_pos <- scales::col_numeric(
    palette = c('palegreen3', 'palegreen3'),
    domain = c(1.50000001, 13)
  )
  ifelse(x <= 0, f_neg(x), 
         ifelse(x > 0 & x <= 1.5, 
                f_pos_smaller(x), f_pos(x)))
}

tdata_1 <- tdata |>
  select(c("HA.1","DU.1","SC.1","GL.1","FL.1","AN.1"))|> #rounding
  mutate_if(is.numeric, round, digits=3)

tdata_2 <- tdata |>
  select(c("type","HA","DU","SC","GL","FL","AN"))|> #rounding
  mutate_if(is.numeric, round, digits=1)

tdata <- data.frame(type = tdata_2$type, 
           HA = tdata_2$HA,
           HA.1 = tdata_1$HA.1,
           DU = tdata_2$DU,
           DU.1 = tdata_1$DU.1,
           SC = tdata_2$SC,
           SC.1 = tdata_1$SC.1,
           GL = tdata_2$GL,
           GL.1 = tdata_1$GL.1,
           FL = tdata_2$FL,
           FL.1 = tdata_1$FL.1,
           AN = tdata_2$AN,
           AN.1 = tdata_1$AN.1)

flextable(tdata) |>
  
  bold(part = "header") |> #bolding header
  
  bg(j = c("HA.1", "DU.1", "SC.1", "GL.1","FL.1","AN.1"), bg = pal) |> #adding background colurs to % changes

  mk_par(j = c(3), value = as_paragraph(fmt_pct(HA.1))) |> #formatting the % as with the percentage sign
  mk_par(j = c(5), value = as_paragraph(fmt_pct(DU.1))) |>
  mk_par(j = c(7), value = as_paragraph(fmt_pct(SC.1))) |>
  mk_par(j = c(9), value = as_paragraph(fmt_pct(GL.1))) |>
  mk_par(j = c(11), value = as_paragraph(fmt_pct(FL.1))) |>
  mk_par(j = c(13), value = as_paragraph(fmt_pct(AN.1))) |>

  set_header_labels(values = c("","Hamilton C.", "% Î", "Dundas" ,"% Î",
                                    "Stoney Creek", "% Î", "Glanbrook", "% Î",
                                    "Flamborough", "% Î", "Ancaster", "% Î")) |> #changing names of headers

merge_at(i = 4, j = 1:13) |> #merging all cells at row 4 to create "Motorized" label
merge_at(i = 7, j = 1:13) |> #merging all cells at row 4 to create "Non-motorized" label
bold(i=c(4,7), j=1:13, part = "body") |> #bolding labels
hline(i =c(3,4,6,7), j=1:13) |>  #adding horizontal line above and below the labels

align(align = "center", part = "all") |>
fontsize(size = 7, part = "all") |>
  set_table_properties(layout = "autofit")
```

Due to spatial availability's proportional allocation mechanism and this cases' calculation at the parcel level, results can also be summarized by community (@tbl-Tab2). The majority of schools were closed in Hamilton Central as seen in the largest reduction in OTGC by percentage and magnitude. Hamilton Central represents `r (cSAvail_im_COMM2011_2021_df |> filter(COMMUNITY == "HA" & mode == "c") |> dplyr::select("kid_popadj_2021") |> sum() / cSAvail_im_COMM2011_2021_df |> filter(mode == "c") |> dplyr::select("kid_popadj_2021") |> sum() )|> scales::percent()` of the 5-14 year old population in 2021. Though the population decreased a modest amount from 2011 to 2021, the rate of school-seat spatial availability decreased disproportionately more (population by `r cSAvail_im_COMM2011_2021_df |> filter(COMMUNITY == "HA" & mode=="c") |> dplyr::select("ckid_popadj") |> sum() |> scales::percent(0.1)` and spatial availability by `r (((cSAvail_im_COMM2011_2021_df |> filter(COMMUNITY == "HA") |> dplyr::select("V_im_2021") |> sum()) - (cSAvail_im_COMM2011_2021_df |> filter(COMMUNITY == "HA") |> dplyr::select("V_im_2011") |> sum() )) /  ((cSAvail_im_COMM2011_2021_df |> filter(COMMUNITY == "HA") |> dplyr::select("V_im_2011") |> sum() ))) |> scales::percent(0.1)` for both modes). Schools and additional OTGC was not sufficiently expanded to provide the same levels of spatial availability as in 2011. This disproportionate decrease in spatial availability to students is greater in Hamilton Central by magnitude than any other community. 

From the perspective of equity, Hamilton Central has the highest LIM-AT prevalence, with `r ct201621_2011 |> filter(COMMUNITY == "HA") |> dplyr::select("LIMAT_2016") |> pull() |> round() |> paste0("%")` of households LIM-AT in 2016, more than 3 times greater than Ancaster, Flamborough and Glanbrook, communities with the lowest level of LIM-AT prevalence. Is the disproportionate decrease in spatial availability within Hamilton Central fair? In some ways it is: communities with the lowest LIM-AT prevalence appear to benefit from gains in motorized spatial availability. Glanbrook, Flamborough and Ancaster together account for `r ((ct201621_2011 |> filter(COMMUNITY == "FL" | COMMUNITY == "GL" | COMMUNITY == "AN") |> dplyr::select("kid_popadj_2021") |> sum()) / (ct201621_2011|> dplyr::select("kid_popadj_2021") |> sum()) ) |> scales::percent()` of the 5-14 year old population in 2021. However, they access `r ((cSAvail_im_COMM2011_2021 |> filter(COMMUNITY == "FL" | COMMUNITY == "GL" | COMMUNITY == "AN") |> dplyr::select("V_im_2021") |> sum()) / (cSAvail_im_COMM2011_2021|> dplyr::select("V_im_2021") |> sum()) ) |> scales::percent()` of the spatial availability of school seats. Hamilton Central currently captures `r ((cSAvail_im_COMM2011_2021 |> filter(COMMUNITY == "HA") |> dplyr::select("V_im_2021") |> sum()) / (cSAvail_im_COMM2011_2021|> dplyr::select("V_im_2021") |> sum()) ) |> scales::percent()` of the spatial availability for its `r ((ct201621_2011 |> filter(COMMUNITY == "HA") |> dplyr::select("kid_popadj_2021") |> sum()) / (ct201621_2011|> dplyr::select("kid_popadj_2021") |> sum() )) |> scales::percent(0.1)` of the population. With student aged population growing in other communities, OTGC should be expanded - potentially to levels that Hamilton had in 2011 or beyond (`r (cSAvail_im_COMM2011_2021 |> filter(COMMUNITY == "HA" & mode == "c") |> dplyr::select("v_im_kid_popadj_2011")) |> pull() |> round(1)` school-seats per motorized mode using student and `r (cSAvail_im_COMM2011_2021 |> filter(COMMUNITY == "HA" & mode == "w") |> dplyr::select("v_im_kid_popadj_2011")) |> pull() |> round(1)` school-seats per active mode using student). However, should those gains come at a loss to other communities, especially those with a significantly higher proportion of households who are lower-income, a strong determinant of transport poverty?

Furthermore, while there are gains in motorized spatial availability in certain communities by some metrics, there are losses in non-motorized spatial availability per student from 2011 to 2021 in all communities. And the losses are drastic. Communities with high community average spatial availability per students with values above 1 school-seat per student saw losses, as well as communities below this value. 

# Discussion and conclusions

In this paper, we compared how multimodal spatial availability changed after waves of school closures and consolidations in Hamilton between 2011 to 2021. To do so, we constructed the student-aged population, OTGC of schools and their locations, and their travel behaviour to generate spatial availability landscapes for the three study years 2011, 2016 and 2021. We aggregated the resulting values at the DA and community level and descriptively compared differences. We demonstrated that city-wide there are decreases in $V_i^m$ for both mode-using populations: the majority of students in the city have access to fewer school-seats than they would have in 2011. Furthermore, as the majority of closed schools are within the core of the city: the more urban Hamilton Central and urban-areas of other communities saw the largest amount of this decrease. And at a local-scale, students in residences proximate to schools that closed also saw dramatic reduce in non-motorized spatial availability values.  

Evidently, the number of OTGC in the city decreased between 2011 and 2021, so some sort of decrease was to be expected. However, should that decrease be felt most intensely within neighbourhoods with the highest LIM-AT? By students who have the potential to travel actively to school? Normatively, our cities should be increasing spatial availability for non-motorized mode users given the benefits of active travel and the climate crisis. Hamilton's policies from 2011 through 2021 drastically reduced non-motorized spatial availability, and gains in motorized spatial availability especially in more rural areas. The proportion of non-motorized mode use is low in both 2011 and 2021, however, the closure of schools that are more proximate to student-population density eliminates the potential of those trips ever becoming active. 

Overall, the closure of `r -((SCHOOLS %>% filter(Year_2 != "2016") %>% pull(SchoolID) %>% length() - SCHOOLS %>% filter(Year != "2016") %>% pull(SchoolID) %>% length())/SCHOOLS %>% filter(Year != "2016") %>% pull(SchoolID) %>% length()) %>% scales::percent()` of elementary schools in Hamilton between 2011 and 2021 resulted in `r -(((cSAvail_im_COMM2011_2021$V_im_2021 |> sum()) - (cSAvail_im_COMM2011_2021$V_im_2011 |> sum()))  / cSAvail_im_COMM2011_2021$V_im_2011|> sum()) |> scales::percent()` decline in school-seat availability city-wide ( `r  -(( ((avail_2021 |> group_by(SchoolID) |> summarize(OTGC = first(OTGC2021)) |> select(OTGC) |> sum())) - (avail_2011 |> group_by(SchoolID) |> summarize(OTGC = first(OTGC2011)) |> select(OTGC) |> sum())) / (avail_2011 |> group_by(SchoolID) |> summarize(OTGC = first(OTGC2011)) |> select(OTGC) |> sum()) ) |> scales::percent()` fewer school-seats), but specifically a `r (((cSAvail_im_COMM2011_2021 |> filter(mode == "w") |> pull(V_im_2021) |> sum()) - (cSAvail_im_COMM2011_2021  |> filter(mode == "non-w") |> pull(V_im_2011) |> sum()))  / cSAvail_im_COMM2011_2021  |> filter(mode == "w") |> pull(V_im_2011) |> sum()) |> scales::percent()` decline in non-motorized spatial availability. Though non-motorized modal share was low in both 2011 and 2016, the _potential_ for active transport trips was significantly eroded as schools within a 27 minute walk catchment were closed in the more densely populated and central areas of the city. Further, the communities with the highest LIM-AT prevalence were the most impacted: communities like Hamilton Central and Dundas saw the most drastic loss in non-motorized spatial availability while communities with lower LIM-AT prevalence saw gains in motorized spatial availability (as a handful of rural schools opened). The motivation of operational savings associated with public service consolidation for the school boards did not account for the mobility-related burdens _certain_ families are now saddled with. The decision to consolidate schools, likely has increased the length of motorized travel, though this would need to be further investigated. A decrease in non-motorized trips will have daily impacts on students and their families [@mandicAdolescentsPerceptionsWalking2022; @pabayoImportanceActiveTransportation2012], the broader community [@pietrabissaSchoolAccessCity2023;@MerrallWhatsASchool2024; @bittencourtEvaluatingAccessibilityAvailability2023] and the environment [@pantelakiImpactHomeschoolCommuting2024; @rongReviewResearchLowcarbon2022]. 

Like many other localities [@Lee_Lubienski_2017; @AuttiHyryBeihammer2014; @Beuchert_Humlum_Nielsen_Smith_2018], Hamilton is not immune to top-down operational efficiency assessments that determine if community infrastructure is underutilized and closed. From the perspective of the provincial government of Ontario, the school closures which occurred in Hamilton resulted in operational savings-per-student. We demonstrate how these decisions resulted in both families and students paying a price through multimodal spatial availability.

By quantifying the multimodal spatial availability, namely motorized and non-motorized (active) travel, we explore the environmental and active-travel implications of school closure/consolidation policies in Hamilton. Our paper offers a methodology for spatial policy analysis scenario. The presented methodology can be used by researchers and decision-makers to plan and evaluate equitable and sustainable urban planning policies from a spatial perspective. At the core of the method is spatial availability [@soukhovIntroducingSpatialAvailability2023; @soukhovMultimodalSpatialAvailability2024], a singly-constrained accessibility measure that can be calculated at the finest spatial resolution (in our paper, parcel-level) and aggregated at whichever spatial unit is most meaningful for interpretation. We urge policy-makers to view the 'spatial availability' of public resources from a per-capita perspective, plan capacity and location of service provision with the cost of travel (and associated implications such as GHG emissions, active transportation mode, safety of active travel modes, etc.) that sufficiently serves the target population. In this work, we also suggest and assume a benchmark of 1.0 school-seats per student which accounts for sufficiency. Spatial availability can be used to obtain this benchmark since the total number of opportunities (i.e., school capacity) is preserved in the region of analysis unlike unconstrained forms of accessibility measurement e.g., Hansen-type measure [@hansenHowAccessibilityShapes1959]. As such, the assigned spatial availability can be divided by population at each zone to yield an interpretable per capita measurement.

Ultimately, this case study furnishes evidence that consolidation of schools was particularly ill-timed: with the advent of the COVID-19 pandemic, the education system lacked the resiliency to accommodate reduced classroom capacities and left parents who once lived within active transportation distance to schools relying on motorized transportation for their children. These top-down austerity measures left the Hamilton local school system more vulnerable to the impacts of COVID-19 by undervaluing the societal role of schools in neighbourhoods. By identifying the impact of school consolidation policies in Ontario we anticipate that researchers and decision-makers will have better information to center the wellbeing of all residents, including students, and the planet in urban planning policies.  

As with all studies, our work is associated with limitations on how results should be interpreted. The calculated spatial availability assumes any residential parcel can have a student (at the DA rate of students per residential unit) so all parcels are assigned a DA rate weighted by how many residential units are contained within the parcel. Each parcel is also assumed to visit any school, though travel times based on observed origin-destination behaviour (from the TTS) are more likely through the use of the empirical travel impedance functions. In this way, the spatial availability demonstrates what _potential interaction_ a student could have based on historic and average travel behaviour and shortest network-path travel times if residing in point in space. This representation is average, and by design obfuscates considerations that could make non-average and shortest-path travel unrealistic such as safety and built-environment concerns [@leeNeighborhoodEnvironmentsUtilitarian2021; @yumitaSchoolCommutingBarriers2021] nor considers significant non-transportation factors that impact fulsome school accessibility like school quality [@bittencourtEvaluatingAccessibilityAvailability2023]. An examination of these factors, be it through qualitative, mixed or quantitative methods, could be explored in future research, further building on the understanding of how school closures and consolidations impact communities.

Furthermore, this study does not consider transit, school-bus, or cycling modes which have implications on how the environmental and active transport implications can be interpreted. For instance, transit and school bus modes often taken more circuitous routes [@yumitaSchoolCommutingBarriers2021] but pool students thereby reducing emissions. Cycling reduces travel time over the same walking distance at no extra emitted GHG. Furthermore, GHG emissions emitted per minute of driving varies extensively depending on operating conditions and vehicle characteristics [@soukhovOccupancyGHGEmissions2022]. Though this work focuses on changes in accessibility, an examination of dimensions of environmental impacts such as the _realized_ change in active travel minutes and emissions due to school consolidation/closures can be examined.


# Declarations

**Ethical approval**
Not applicable

**Participate consent**
Not applicable

**Competing interests**
The authors declare there are no personal or financial conflicts of interest. 

**Authors' contributions**
A.S., A.P., C.D.H., and M.M. all contributed to the study conception and design. Material preparation, data collection
and formal analysis were performed by A.S., A.P, and C.D.H. All visuals and the first draft of the manuscript was written by A.S. A.S., A.P., C.D.H., and M.M. commented on earlier versions of the manuscript. A.S., A.P., C.D.H., and M.M.  reviewed the final manuscript.

**Funding declaration**
This work was supported by the Mobilizing Justice Partnership and the Canada Graduate ScholarshipsâDoctoral Program from the Social Sciences and Humanities Research Council of Canada (SSHRC).

**Availability of data and materials**
The manuscript text, code, analysis and data supporting this work is available in the lead author's GitHub repository : https://github.com/soukhova/School-closures-accessibility-impacts

\pagebreak

# References

::: {#refs}
:::


<!-- BELOW IS REJECTED TEXT / CODE -- WILL DELETE SOON -->

<!-- An intermediate product in spatial availability calculations are travel time, @fig-Fig8 displays the change in _potential_ travel time between 2011 and 2021 for motorized and non-motorized populations.   -->

<!-- Changes in school seat spatial availability throughout the years can be further interpreted. How does something tangibly measurable, such as motorized and non-motorized potential travel minutes change? @fig-Fig9 visualises these related intermediates for one-way home-to-school travel in a given day, namely the sum of the change in non-motorized minutes per DA. These travel time minutes are the difference between the aggregated 2021 and 2011 scenarios for non-motorized travel times multiplied by the proportion of walking/cycling mode-use and rate of student population associated with the parcels in each DA.  -->

<!-- Firstly, there are modal disparities. For motorized modes - the range in travel time change for students changed between -15 minutes to an increase in 2 minutes. As these are potential decreases in motorized minutes, a decrease is good. Increases are seen city-wide, as more of the population, on average, must use motorized transprot to access school-seat as fewer school-seats are proximate. However, this trend is not seen in Glanbrook. Most of the community see decreases in motorozied travel minutes. Indeed, schools opened and were expanded exactly where students are. But what about other communities?  -->

<!-- In terms of non-motorized minutes  -->

<!-- From an environmental perspective, increase in motorized minutes is good and increase in non-motorized minutes is bad. However, does the built environment support this? Captured active mobility.  -->

<!-- It can be seen that decreases are proximate to closed schools. Smaller decreases (and even a few increases) are apparent in a range further from closed schools, especially those also in proximity to the few opened/expanded schools. Intuitively, these trends mirror what is shown within the $V^{non-motorized}$ landscape in @fig-Fig7  -->

<!-- This decrease follows different patterns depending on the mode. $v_i^{non-motorized}$ is most impacted for parcels within a 27 minute walk travel time to schools that closed: these DAs demonstrate the most dramatic decrease. Smaller-area DAs (in Hamilton-Central) and larger-area DAs (in rural communities) proximate to closed schools present Q1 decreases (red). For $v_i^{motorized}$, the range offered by motorized mode (estimated by shortest-path car travel times) is city-wide, so since the majority of schools were centrally located, the decrease is concentrated within the downtown core of Hamilton Central. Some motorized-mode using populations in DAs do experience an increase in $V_i^m$ and $v_i^m$: these DAs are often relatively proximate to schools but more immediately outside walking range. Under competitive and constrained calculations, these DAs benefit from the losses in spatial availability that are predominately experienced by the non-motorized populations within Hamilton Central.  -->

<!-- ```{r} -->
<!-- #| label: fig-Fig8 -->
<!-- #| fig-cap: "Change in active travel minutes (top plot) and motorized travel minutes (bottom plot) between 2011 and 2021. Scales are represented in decibles." -->
<!-- #| echo: false -->
<!-- #| out-width: "90%" -->
<!-- #| fig-pos: "H" -->

<!-- grid.raster(readTIFF(paste0(here::here(),"/Figures/Fig8.tiff"))) -->
<!-- ``` -->


<!-- The data reviewed spans 10 years -- school closures that occured from 2011 until the 2017 memortorium on school closures, and census data from 2011 to 2021. The conversation on school closures is still pertinent. Recently, school boards have been calling the current provincial government to lift the momoratorium on closures, as school boards cannot run deficits and additional funding is frozen. school boards are forced to balance their budgets, so are cancelling programs as they cannot close under-utilised schools. School boards don't have their own agency, they are creatures of the province. This mimics the limiting of municipal powers, the munciaplity that is given power by the province over community affairs. 


We argue with this paper, that the trip from home to school is inherently a community level one. CLosing schools is unpopularly politically, but school boards were forced to do it due to limited budgets before the memorotium. Under the memortium and limited budget, school boards must cut program. They'd like the ability to close schools to balance budgets, however inthis paper - we argue this is determinental from the perspective of children's walkable access to schools and associatd environmental emissions. Furthermore, the trip to school is one that is inherently a community level affair. To close schools to sustain programs is a false choice: why not well funded schools in walkable proximities? Who is planning proximity if not local powers?   -->


<!-- School boards are also under increase fiscal pressure as inflation-adjusted per-pupil provincial funding, the main funding source for school boards, has continued to decline since 2018 [@opsbaOntariosEducationFunding2024]. -->

<!-- As will be later demonstrated in this paper, the increase in student population is spatially uneven. Areas with highest children population are characterized by newly developed low-density suburban housing. School boards cannot change residential land-use and built form that incentives an increase in student-aged population in neighbourhoods experiencing a decline in student-aged population and/or under-enrolled schools. -->

<!-- Our study is focued on travel implications, e.g., proximity. Many factors imapct accessibility such as quality. Holisitc funding of school system is required. Transportation is just a single important dimension. -->

<!-- While previous research has investigated existing conditions, such as highlighting that living closer to schools increases the likelihood of children's active travel [@wongModeShiftingSchool2011] and traffic safety implications of motorized modes negative impact on children's accessibility to schools [@tavakoliTrafficDangersPotential2024].  -->
