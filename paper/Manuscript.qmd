---
title: "The cost of school consolidations: impacts of reduced accessibility"
bibliography: 
  - "`r system('kpsewhich ../bibliography/bibliography.bib', intern=TRUE)`"
linenumbers: true
numbersections: true
format: docx
editor: source
execute: 
  freeze: auto
author:
  - name: "Anastasia Soukhov"
    email: "soukhoa@mcmaster.ca"
    affiliation: McMaster University SEES
    footnote: "Corresponding Author"
  - name: "Christopher D. Higgins"
    email: "cd.higgins@utoronto.ca"
    affiliation: University of Toronto
  - name: "Moataz Mohamed"
    email: "mmohame@mcmaster.ca "
    affiliation: McMaster University CE
  - name: "Antonio Paez"
    email: "paezha@mcmaster.ca"
    affiliation: McMaster University SEES
address:
  - code: McMaster University SEES
    address: "School of Earth, Environment and Society, McMaster University, 1241 Main St. West, Hamilton, ON, L8S 4K1, Canada"
  - code: McMaster University CE
    address: "Department of Civil Engineering, McMaster University, 1241 Main St. West, Hamilton, ON, L8S 4K1, Canada"
  - code: University of Toronto
    address: "Department of Human Geography, University of Toronto Scarborough, 1265 Military Trail, Toronto, ON, M1C 1A4, Canada"  
abstract: | 
  | The reduction of mobility-induced GHG emissions is a top priority for many communities around the world. From a different standpoint, communities are consistently under pressure to increase operational cost-efficiency savings, including the consideration of spatially consolidating public resource provision. This is the case for public schools, where governments are opting to close under-capacity schools and expand existing schools to accommodate lost capacity. This study quantifies the travel burdens of school consolidation/closure policy through the case of Hamilton, a mid-sized city in Ontario, Canada. Between the years 2011 and 2015, 7% of the elementary schools closed in the city. Specifically, we quantify how these closures changed the accessibility landscape for the elementary school aged population by using spatial availability, a novel singly-constrained accessibility measure. Spatial availability allows for an interpretable comparison between ‘before’ and ‘after’ policy implementation because of its unique proportional allocation property. Analysis is conducted at the parcel-level, all school-seats being eligible and travel behaviour based on observved home-to-school patterns for motorzied and non-motorized modes. Analysis on system-wide impacts such as potential GHG emission increases and walk minutes decreases are detailed. Overall, spatial availability decreased in the city. Though the school conslidation policy resulted in short-term operational cost-savings, families, students, and the environment now pay the price. This paper showcases how spatial availability can be used by decision- makers to quantify spatial and travel implications in policy.
keywords: [accessibility; spatial availability; carbon emissions; journey-to-school; walkability; active transportation; school consolidation policy; service provision thresholds]
---

```{r knitr-setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  cache = FALSE,
  warning = FALSE,
  message = FALSE,
  comment = '', 
  out.width = "1\\linewidth")
```

```{r, include=FALSE}
rm(list=ls())
```

<!--- 2016 and 2011 sp_avail is calculated in 'test-doc-2016run', LOAD THE BELOW! -->
```{r, include=FALSE}
library(dplyr) # A Grammar of Data Manipulation
library(ggplot2) # Create Elegant Data Visualisations Using the Grammar of Graphics
library(ggspatial) # Spatial Data Framework for ggplot2
library(here) # A Simpler Way to Find Your Files
library(patchwork) # The Composer of Plots
library(scales) # Scale Functions for Visualization
library(sf) # Simple Features for R
library(stplanr) # Sustainable Transport Planning
library(tidyverse) # Easily Install and Load the 'Tidyverse'
library(tmap) # Thematic Maps
library(units) # Measurement Units for R Vectors
```

```{r, include=FALSE}
load(file = paste0(here::here(),"/data-prep/data-products/cen_data_2011_hamiltononly.Rdata"))
cen_data_2011_hamiltononly <- cen_data_2011_1 |> filter(Region.Name == "Hamilton") #NOTE: GEOUID 35250242, 35250133, 35250457 do not have any child population
rm("cen_data_2011_1")
load(file=paste0(here::here(),"/data-prep/data-products/cen_data_2016_hamiltononly.Rdata"))
cen_data_2016_hamiltononly <- cen_data_2016_1 |> filter(Region.Name == "Hamilton") #NOTE: GEOUID 35250133, 35250398, 35250427 do not have any child population
rm("cen_data_2016_1")

ham_city_bound <- st_read(paste0(here::here(),"/data-prep/data-inputs/Boundaries/City_Boundary.shp"),
                          quiet = TRUE) |> st_transform(st_crs(cen_data_2011_hamiltononly))
ham_community_bounds <- st_read(paste0(here::here(),"/data-prep/data-inputs/Boundaries/Community_Boundaries.shp"),
                                quiet = TRUE) |> st_transform(st_crs(cen_data_2011_hamiltononly))
```

```{r, include=FALSE}
cen_data_2011_hamiltononly <- 
  cen_data_2011_hamiltononly %>% dplyr::select( #removing the variables we don't need for this analysis
    -c("Shape.Area", "Quality.Flags", "Type", "CD_UID", "NHS.Non.Return.Rate", "CSD_UID", "CT_UID", "CT_UID","NHS.Non.Return.Rate.1", "v_CA11N_2564..Median.after.tax.household.income..", "v_CA11F_17..15.to.19.years")) %>%
  rename( #renaming the variables
    "DA_households" = "Households",
    "DA_dwellings" = "Dwellings",
    "DA_tot_pop" = "Population",
    "DA_med_AT_family_income" = "v_CA11N_2458..Median.after.tax.family.income..",
    "DA_med_AT_lone-family_income" = "v_CA11N_2476..Median.after.tax.family.income..",
    "DA_prev_LIMAT_under18" = "v_CA11N_2609..Less.than.18.years..",
    "DA_pop_5to9" = "v_CA11F_11..5.to.9.years",
    "DA_pop_10to14" = "v_CA11F_14..10.to.14.years") %>%
  mutate(DA_pop_5to14 = DA_pop_5to9+(DA_pop_10to14)) |> #*0.9)) %>%
  dplyr::select(-c("DA_pop_5to9","DA_pop_10to14"))

cen_data_2016_hamiltononly <- 
  cen_data_2016_hamiltononly %>% dplyr::select( #removing the variables we don't need for this analysis
    -c("Shape.Area",  "Type", "CD_UID", "CSD_UID", "CT_UID", "CT_UID", "v_CA16_2398..Median.after.tax.income.of.households.in.2015....", "v_CA16_64..15.to.19.years")) %>%
  rename( #renaming the variables
    "DA_households" = "Households",
    "DA_dwellings" = "Dwellings",
    "DA_tot_pop" = "Population",
    "DA_med_AT_family_income" = "v_CA16_2448..Median.after.tax.income.of.economic.families.in.2015....",
    "DA_med_AT_lone-family_income" = "v_CA16_2460..Median.after.tax.income.of.lone.parent.economic.families.in.2015....",
    "DA_prev_LIMAT_under18" = "v_CA16_2543..0.to.17.years....",
    "DA_pop_5to9" = "v_CA16_25..5.to.9.years",
    "DA_pop_10to14" = "v_CA16_43..10.to.14.years") %>% mutate(DA_pop_5to14 = DA_pop_5to9+(DA_pop_10to14)) |> #*0.9)) %>%
    dplyr::select(-c("DA_pop_5to9","DA_pop_10to14"))
```

```{r, include=FALSE}
library(hamONdests) # A R package of Hamilton, Ontario destinations
data(Schools_2011_2016)
ALL_SCHOOLS_Elem <- Schools_2011_2016 %>% filter(Level == "Elementary")
rm("Schools_2011_2016")
data(School_Catchments_2011_2016)
ALL_SCHOOLS_CATCH_Elem <- School_Catchments_2011_2016 %>% filter(Level == "Elementary")
rm("School_Catchments_2011_2016")

load(file = paste0(here::here(),"/data-prep/data-products/TTS_gamma2011_motor.Rdata"))
load(file = paste0(here::here(),"/data-prep/data-products/TTS_gamma2016_motor.Rdata"))
load(file = paste0(here::here(),"/data-prep/data-products/TTS_exp2011_nonmotor.Rdata"))
load(file = paste0(here::here(),"/data-prep/data-products/TTS_exp2016_nonmotor.Rdata"))
```

```{r}
# # maybe consider using year 2021 as a comparision? 2011 vs 2016 vs 2021?
# SCHOOLS_2023 <- st_read("data-prep/data-inputs/Educational_Institutions-2023/Educational_Institutions.shp") |> filter(CATEGORY == "Elementary School" & (SCHOOL_BOA == "Hamilton-Wentworth Catholic District School Board" | SCHOOL_BOA == "Hamilton-Wentworth District School Board" )) |> st_transform(st_crs(cen_data_2011_hamiltononly))
```

```{r augmenting-catchment, include=FALSE}
ALL_SCHOOLS_CATCH_Elem_extra2011 <- ALL_SCHOOLS_CATCH_Elem |>
  left_join(ALL_SCHOOLS_Elem |> st_drop_geometry() |> group_by(CID2011) |> 
              summarize(OTGC = sum(OTGC2011, na.rm = T)), 
            by = c("CID" = "CID2011")) |> filter(!is.na(OTGC))

ALL_SCHOOLS_CATCH_Elem_extra2016 <- ALL_SCHOOLS_CATCH_Elem |>
  left_join(ALL_SCHOOLS_Elem |> st_drop_geometry() |> group_by(CID2016) |> 
              summarize(OTGC = sum(OTGC2016, na.rm = T)), 
            by = c("CID" = "CID2016")) |> filter(!is.na(OTGC))

ALL_SCHOOLS_CATCH_Elem_extra <- rbind(ALL_SCHOOLS_CATCH_Elem_extra2011, ALL_SCHOOLS_CATCH_Elem_extra2016)
rm(ALL_SCHOOLS_CATCH_Elem_extra2011,ALL_SCHOOLS_CATCH_Elem_extra2016)

#checks
sum(ALL_SCHOOLS_Elem$OTGC2011, na.rm=T) + sum(ALL_SCHOOLS_Elem$OTGC2016, na.rm=T)
ALL_SCHOOLS_CATCH_Elem_extra$OTGC |> sum(na.rm=T)

#reformating schools for mapping
ALL_SCHOOLS_Elem_nochangeorexpanded <- ALL_SCHOOLS_Elem |> filter(Year == "2011 and 2016") |> mutate(Year = ifelse(Year == "2011 and 2016", "2011", Year))
ALL_SCHOOLS_Elem_formapping <- rbind(ALL_SCHOOLS_Elem, ALL_SCHOOLS_Elem_nochangeorexpanded)
rm(ALL_SCHOOLS_Elem_nochangeorexpanded)
ALL_SCHOOLS_Elem_formapping <- ALL_SCHOOLS_Elem_formapping |> mutate(Year = ifelse(Year == "2011 and 2016", "2016", Year))
```

```{r descriptive-catchment-schools-plot, eval=FALSE}
tmap_defaults <-
  tm_scale_bar(position = c("LEFT", "BOTTOM"), breaks = c(0, 5, 10, 15))+
  tm_compass(size = 1.5, position = c("right", 'top')) +
  tm_layout(legend.position = c("left", "top")) #legend.hist.size = 10, 

catchment_schools_plot <-
  tm_shape(ALL_SCHOOLS_CATCH_Elem_extra) +
  tm_polygons(col = "OTGC", border.alpha=0.1, palette = "Greys",
              labels = c("[181-318)", "[318-406)", "[406-566)","[566-1417]"),
              breaks = c(181, 318, 406, 566, 1417),
              title = "On the ground\ncapacity (OTGC)")+
  tm_facets(by=c("System","Year"))+
  tm_shape(ALL_SCHOOLS_Elem_formapping) +
  tm_dots(col = "Status", size=0.1, title = "School status between\n2011 and 2016",
          palette = c("#ffd14d", "black", "darkgreen","#0E86D4","#90EE90"),
          labels = c("No change","Closed before 2016", "Expanded before 2016","Moved before 2016","New after 2011")          
  ) +
  tm_facets(by=c("Year","System"))+
  tmap_defaults +
  tm_layout(panel.labels = list(c('HWDCSB (Catholic Public)','HWDSB (Public)'),c('2011','2016')))

tmap_save(catchment_schools_plot, paste0(here::here(),"/Figures/catchment_schools_plot.png"), height=7, width=12, dpi=600)
```

```{r,include=FALSE}
load(file = paste0(here::here(),"/data-prep/data-products/avail_2011.RData"))
load(file = paste0(here::here(),"/data-prep/data-products/avail_2016.RData"))
```

```{r}
community_car_perc_2011 <- avail_2011 |>
  group_by(COMMUNITY) |> 
  summarize(TAZOrig_car_perc = mean(TAZOrig_car_perc, na.rm=T))

community_car_perc_2016 <- avail_2016 |> group_by(COMMUNITY) |> summarize(TAZOrig_car_perc = mean(TAZOrig_car_perc, na.rm=T))
```

```{r, eval=FALSE}
#check to make sure that V_i is equal to the total capacity in Hamilton. It is!
avail_2011$V_ij %>% sum()
ALL_SCHOOLS_Elem$OTGC2011 %>% sum(na.rm = TRUE)

avail_2016$V_ij %>% sum()
ALL_SCHOOLS_Elem$OTGC2016 %>% sum(na.rm = TRUE)

#this should equal 58,265, still does -- great!
avail_2011 %>%
  group_by(ID) %>%
  summarize(kid_popadj = sum(kid_popadj)) |> dplyr::select(kid_popadj) %>% sum()

#this should equal 58,865, still does -- great!
avail_2016 %>%
  group_by(ID) %>%
  summarize(kid_popadj = sum(kid_popadj)) |> dplyr::select(kid_popadj) %>% sum()
```

```{r}
SAvail_im_DA2011 <- avail_2011 %>%
  group_by(GeoUID, 
           mode) %>%
  summarize(COMMUNITY = first(COMMUNITY),
            total_tt = sum(travel_time_p50*kid_popadj),
            V_im = sum(V_ij),
            kid_popadj_m = sum(kid_popadj),
            DA_pop_5to14 = mean(DA_pop_5to14, na.rm=T),
            DA_prev_LIMAT_under18 = mean(DA_prev_LIMAT_under18),
            .groups = "drop") |>
  mutate(emissions_total_car_tt = ifelse(mode == "c", 0.1*total_tt, 0),
         v_im_kid_popadj = V_im/kid_popadj_m,
         v_im_kid_popadj_LIMAT = v_im_kid_popadj*(DA_prev_LIMAT_under18/100),
         v_im_kid_popadj_LIMAT = ifelse(is.na(v_im_kid_popadj_LIMAT) | is.nan(v_im_kid_popadj_LIMAT), 0, v_im_kid_popadj_LIMAT),
         V_i_kid_popadj_LIMAT = V_im*(DA_prev_LIMAT_under18/100),
         V_i_kid_popadj_LIMAT = ifelse(is.na(V_i_kid_popadj_LIMAT) | is.nan(V_i_kid_popadj_LIMAT), 0, V_i_kid_popadj_LIMAT)) |>
  filter(GeoUID != 35250242 & GeoUID != 35250133 & GeoUID != 35250457 ) #these GeoUID's have 0 kid population, so let's drop so we don't have zeros

SAvail_im_DA2016 <- avail_2016 %>%
  group_by(GeoUID, 
           mode) %>%
  summarize(COMMUNITY = first(COMMUNITY),
            total_tt = sum(travel_time_p50*kid_popadj),
            V_im = sum(V_ij),
            kid_popadj_m = sum(kid_popadj),
            DA_pop_5to14 = mean(DA_pop_5to14, na.rm=T),
            DA_prev_LIMAT_under18 = mean(DA_prev_LIMAT_under18),
            .groups = "drop") |>
  mutate(emissions_total_car_tt = ifelse(mode == "c", 0.1*total_tt, 0),
         v_im_kid_popadj = V_im/kid_popadj_m,
         v_im_kid_popadj = ifelse(is.na(v_im_kid_popadj) | is.nan(v_im_kid_popadj), 0, v_im_kid_popadj),
         v_im_kid_popadj_LIMAT = v_im_kid_popadj*(DA_prev_LIMAT_under18/100),
         v_im_kid_popadj_LIMAT = ifelse(is.na(v_im_kid_popadj_LIMAT) | is.nan(v_im_kid_popadj_LIMAT), 0, v_im_kid_popadj_LIMAT),
         V_i_kid_popadj_LIMAT = V_im*(DA_prev_LIMAT_under18/100),
         V_i_kid_popadj_LIMAT = ifelse(is.na(V_i_kid_popadj_LIMAT) | is.nan(V_i_kid_popadj_LIMAT), 0, V_i_kid_popadj_LIMAT)) |>
  filter(GeoUID != 35250398 & GeoUID != 35250133 & GeoUID != 35250427 ) #these GeoUID's have 0 kid population, so let's drop so we don't have zeros

#add the geometries -- census DAs
SAvail_im_DA2011 <- SAvail_im_DA2011 |>
  left_join(cen_data_2011_hamiltononly |> filter(Region.Name == "Hamilton") |> dplyr::select(GeoUID), by="GeoUID") |> st_set_geometry("geometry")

SAvail_im_DA2016 <- SAvail_im_DA2016 |>
  left_join(cen_data_2016_hamiltononly |> filter(Region.Name == "Hamilton") |> dplyr::select(GeoUID), by="GeoUID") |> st_set_geometry("geometry")
```
```{r}
#Create 1 sf with data joined, no changes
SAvail_im_DA <-
  rbind(SAvail_im_DA2011 |> mutate(year ="2011"),
        SAvail_im_DA2016 |> mutate(year ="2016")) |>
  mutate(mode = case_when(mode == "c" ~ "motorized",
                          mode == "w" ~ "non-motorized"))

#calc changes between the years - make that 1 sf
SAvail_im_DA_changes <- full_join(SAvail_im_DA2011|>st_drop_geometry(),
                                  SAvail_im_DA2016, by=c("GeoUID", "mode")) |>
  transmute(GeoUID,
            mode = case_when(mode == "c" ~ "motorized",
                             mode == "w" ~ "non-motorized"),
            COMMUNITY = dplyr::coalesce(COMMUNITY.x, COMMUNITY.y),
            c_total_tt = total_tt.y - total_tt.x, #2016 minus 2011 tt
            c_V_im = V_im.y -V_im.x,
            c_V_im_perc = (V_im.y -V_im.x)/V_im.x,
            c_kid_popadj_m = kid_popadj_m.y - kid_popadj_m.x,
            c_DA_pop_5to14 = DA_pop_5to14.y - DA_pop_5to14.x,
            c_DA_prev_LIMAT_under18 = DA_prev_LIMAT_under18.y - DA_prev_LIMAT_under18.x,
            c_emissions_total_car_tt = emissions_total_car_tt.y - emissions_total_car_tt.x,
            c_v_im_kid_popadj = v_im_kid_popadj.y - v_im_kid_popadj.x,
            c_v_im_kid_popadj_perc = (v_im_kid_popadj.y - v_im_kid_popadj.x)/v_im_kid_popadj.x,
            c_v_im_kid_popadj_LIMAT = v_im_kid_popadj_LIMAT.y - v_im_kid_popadj_LIMAT.x,
            c_V_i_kid_popadj_LIMAT = V_i_kid_popadj_LIMAT.y - V_i_kid_popadj_LIMAT.x,
            geometry) |> st_as_sf()

```

```{r}
#repeat but for all 1 mode
SAvail_i_DA2011 <- avail_2011 %>%
  group_by(GeoUID) %>%
  summarize(COMMUNITY = first(COMMUNITY),
            total_tt = sum(travel_time_p50*kid_popadj, na.rm = T),
            V_i = sum(V_ij, na.rm = T),
            DA_pop_5to14 = mean(DA_pop_5to14, na.rm=T),
            kid_pop_DAavg = mean(kid_pop, na.rm = T),
            DA_prev_LIMAT_under18 = mean(DA_prev_LIMAT_under18, na.rm = T),
            .groups = "drop") |>
  filter(GeoUID != 35250242 & GeoUID != 35250133 & GeoUID != 35250457 ) #these GeoUID's have 0 kid population, so let's drop so we don't have zeros

SAvail_i_DA2016 <- avail_2016 %>%
  group_by(GeoUID) %>%
  summarize(COMMUNITY = first(COMMUNITY),
            total_tt = sum(travel_time_p50*kid_popadj),
            V_i = sum(V_ij, na.rm = T),
            DA_pop_5to14 = mean(DA_pop_5to14, na.rm=T),
            kid_pop_DAavg = mean(kid_pop, na.rm = T),
            DA_prev_LIMAT_under18 = mean(DA_prev_LIMAT_under18, na.rm = T),
            .groups = "drop") |>
  filter(GeoUID != 35250398 & GeoUID != 35250133 & GeoUID != 35250427 ) #these GeoUID's have 0 kid population, so let's drop so we don't have zeros

#add the geometries -- census DAs
SAvail_i_DA2011 <- SAvail_i_DA2011 |>
  left_join(cen_data_2011_hamiltononly |> filter(Region.Name == "Hamilton") |> dplyr::select(GeoUID), by="GeoUID") |> mutate(Year = "2011") |> st_set_geometry("geometry")

SAvail_i_DA2016 <- SAvail_i_DA2016 |>
  left_join(cen_data_2016_hamiltononly |> filter(Region.Name == "Hamilton") |> dplyr::select(GeoUID), by="GeoUID") |> mutate(Year = "2016") |> st_set_geometry("geometry")

#join them together!
SAvail_i_DA_extra <- rbind(SAvail_i_DA2011, SAvail_i_DA2016)
rm(SAvail_i_DA2011,SAvail_i_DA2016)
```

```{r}
#now do this at the community level
ham_community_bounds <- ham_community_bounds |> 
  mutate(COMMUNITY = case_when(COMMUNITY_ == "Ancaster" ~ "AN",
                               COMMUNITY_ == "Dundas" ~ "DU",
                               COMMUNITY_ == "Flamborough" ~ "FL",
                               COMMUNITY_ == "Glanbrook" ~ "GL",
                               COMMUNITY_ == "Hamilton" ~ "HA",
                               COMMUNITY_ == "Stoney Creek" ~ "SC"))

SAvail_im_COMM2011 <- SAvail_im_DA2011 %>% st_drop_geometry() |>
  group_by(COMMUNITY, 
           mode) %>%
  summarize(total_tt = sum(total_tt, na.rm=T),
            V_im = sum(V_im, na.rm=T),
            kid_popadj_m = sum(kid_popadj_m, na.rm=T),
            COMM_prev_LIMAT_under18 = mean(DA_prev_LIMAT_under18, na.rm=T),
            emissions_total_car_tt = sum(emissions_total_car_tt, na.rm=T),
            .groups = "drop") |>
  mutate(v_im_kid_popadj = V_im/kid_popadj_m,
         v_im_kid_popadj_LIMAT = v_im_kid_popadj*(COMM_prev_LIMAT_under18/100),
         v_im_kid_popadj_LIMAT = ifelse(is.na(v_im_kid_popadj_LIMAT) | is.nan(v_im_kid_popadj_LIMAT), 0, v_im_kid_popadj_LIMAT),
         V_i_kid_popadj_LIMAT = V_im*(COMM_prev_LIMAT_under18/100),
         V_i_kid_popadj_LIMAT = ifelse(is.na(V_i_kid_popadj_LIMAT) | is.nan(V_i_kid_popadj_LIMAT), 0, V_i_kid_popadj_LIMAT))  |> left_join(ham_community_bounds |> dplyr::select(-c("OBJECTID")), by=c("COMMUNITY")) |> st_set_geometry("geometry")

SAvail_im_COMM2016 <- SAvail_im_DA2016 %>% st_drop_geometry() |>
  group_by(COMMUNITY, 
           mode) %>%
  summarize(total_tt = sum(total_tt, na.rm=T),
            V_im = sum(V_im, na.rm=T),
            kid_popadj_m = sum(kid_popadj_m, na.rm=T),
            COMM_prev_LIMAT_under18 = mean(DA_prev_LIMAT_under18, na.rm=T),
            emissions_total_car_tt = sum(emissions_total_car_tt, na.rm=T),
            .groups = "drop") |>
  mutate(v_im_kid_popadj = V_im/kid_popadj_m,
         v_im_kid_popadj_LIMAT = v_im_kid_popadj*(COMM_prev_LIMAT_under18/100),
         v_im_kid_popadj_LIMAT = ifelse(is.na(v_im_kid_popadj_LIMAT) | is.nan(v_im_kid_popadj_LIMAT), 0, v_im_kid_popadj_LIMAT),
         V_im_kid_popadj_LIMAT = V_im*(COMM_prev_LIMAT_under18/100),
         V_im_kid_popadj_LIMAT = ifelse(is.na(V_im_kid_popadj_LIMAT) | is.nan(V_im_kid_popadj_LIMAT), 0, V_im_kid_popadj_LIMAT))  |> left_join(ham_community_bounds |> dplyr::select(-c("OBJECTID")), by=c("COMMUNITY")) |> st_set_geometry("geometry")
```

```{r}
#repeat above but with just i, this is to get the correct LIM value.
SAvail_i_COMM2011 <- SAvail_im_DA2011 %>% st_drop_geometry() |>
  group_by(COMMUNITY) %>%
  summarize(COMM_prev_LIMAT_under18 = mean(DA_prev_LIMAT_under18, na.rm=T),
            .groups = "drop") 

SAvail_i_COMM2016 <- SAvail_im_DA2016 %>% st_drop_geometry() |>
  group_by(COMMUNITY) %>%
  summarize(COMM_prev_LIMAT_under18 = mean(DA_prev_LIMAT_under18, na.rm=T),
            .groups = "drop") 

#calc changes between the years - make that 1 sf
SAvail_i_COMM_changes <- full_join(SAvail_i_COMM2011 |> st_drop_geometry(),
                                   SAvail_i_COMM2016, by=c("COMMUNITY")) |>
  transmute(COMMUNITY,
            prev_LIMAT_2011 = COMM_prev_LIMAT_under18.x,
            prev_LIMAT_2016 = COMM_prev_LIMAT_under18.y,
            c_prev_LIMAT_perc = ((COMM_prev_LIMAT_under18.y - COMM_prev_LIMAT_under18.x)/
                                   COMM_prev_LIMAT_under18.x )|> scales::percent())
```


```{r}
#calc changes between the years - make that 1 sf
SAvail_im_COMM_changes <- full_join(SAvail_im_COMM2011|>st_drop_geometry(),
                                    SAvail_im_COMM2016, by=c("COMMUNITY", "mode")) |>
  transmute(COMMUNITY,
            mode = case_when(mode == "c" ~ "motorized",
                             mode == "w" ~ "non-motorized"),
            COMMUNITY_ = dplyr::coalesce(COMMUNITY_.x, COMMUNITY_.y),
            kid_2011 = kid_popadj_m.x,
            kid_2016 = kid_popadj_m.y,
            c_kid_perc = ((kid_popadj_m.y - kid_popadj_m.x)/kid_popadj_m.x) |> scales::percent(),
            kid_proportion_2011 = (kid_2011/sum(kid_2011)),
            kid_proportion_2016 = (kid_2016/sum(kid_2016)),
            c_kid_proportion_perc = ((kid_proportion_2016 - kid_proportion_2011)/kid_proportion_2011)
            |> scales::percent(),
            kid_proportion_2011_perc = (kid_proportion_2011) |> scales::percent(),
            kid_proportion_2016_perc = (kid_proportion_2016) |> scales::percent(),
            V_im_2011 = V_im.x,
            V_im_2016 = V_im.y,
            c_V_im_perc = ((V_im.y -V_im.x)/V_im.x) |> scales::percent(),
            V_im_proportion_2011 = (V_im.x/sum(V_im.x)),
            V_im_proportion_2016 = (V_im.y/sum(V_im.y)),
            c_V_im_proportion_perc = ((V_im_proportion_2016 - V_im_proportion_2011)/V_im_proportion_2011)
            |> scales::percent(),
            V_im_proportion_2011_perc = (V_im_proportion_2011) |> scales::percent(),
            V_im_proportion_2016_perc = (V_im_proportion_2016) |> scales::percent(),
            v_im_2011 = v_im_kid_popadj.x,
            v_im_2016 = v_im_kid_popadj.y,
            c_v_im_perc = ((v_im_kid_popadj.y - v_im_kid_popadj.x)/v_im_kid_popadj.x) |> scales::percent(),
            total_tt_2011 = total_tt.x,
            total_tt_2016 = total_tt.y,
            total_tt_proportion_2011 = (total_tt.x/sum(total_tt.x)),
            total_tt_proportion_2016 = (total_tt.y/sum(total_tt.y)),
            c_total_tt_proportion_perc = ((total_tt_proportion_2016 - total_tt_proportion_2011)/total_tt_proportion_2011)
            |> scales::percent(),
            total_tt_proportion_2011 = (total_tt_proportion_2011) |> scales::percent(),
            total_tt_proportion_2016 = (total_tt_proportion_2016) |> scales::percent(),
            c_total_tt_perc = ((total_tt.y - total_tt.x)/
                                 total_tt.x)|> scales::percent(),
            total_tt_perkid_2011 = total_tt.x/kid_2011,
            total_tt_perkid_2016 = total_tt.y/kid_2016,
            c_total_ttperkid_perc = ((total_tt_perkid_2016 - total_tt_perkid_2011)/
                                       total_tt_perkid_2011)|> scales::percent(),
            emissions_2011 = emissions_total_car_tt.x,
            emissions_2016 = emissions_total_car_tt.y,
            c_emissions_perc = ((emissions_total_car_tt.y - emissions_total_car_tt.x)/
                                  emissions_total_car_tt.x)|> scales::percent(),
            emissions_proportion_2011 = (emissions_2011/sum(emissions_2011)),
            emissions_proportion_2016 = (emissions_2016/sum(emissions_2016)),
            c_emissions_proportion = ((emissions_proportion_2016 - emissions_proportion_2011)/emissions_proportion_2011)
            |> scales::percent(),
            emissions_proportion_2011_perc = (emissions_proportion_2011) |> scales::percent(),
            emissions_proportion_2016_perc = (emissions_proportion_2016) |> scales::percent(),
            emissions_perkid_2011 = emissions_total_car_tt.x/kid_popadj_m.x,
            emissions_perkid_2016 = emissions_total_car_tt.y/kid_popadj_m.y,
            c_emissions_perkid_perc = ((emissions_perkid_2016 - emissions_perkid_2011)/
                                         emissions_perkid_2011)|> scales::percent(),
            geometry) |> 
  left_join(SAvail_i_COMM_changes, by="COMMUNITY") |> st_as_sf() 
```

```{r student-popabs-lowincperc-poprate-plot, eval=FALSE}
tmap_defaults <-
  tm_scale_bar(position = c("LEFT", "BOTTOM"), breaks = c(0, 5, 10, 15))+
  tm_compass(size = 1.5, position = c("right", 'top')) +
  tm_layout(legend.position = c("left", "top")) #legend.hist.size = 10, 

student_pop_absolute_plot <-
  tm_shape(SAvail_i_DA_extra |> mutate(extra_col_for_panel = "HAMILTON")) +
  tm_polygons(col = "DA_pop_5to14", border.alpha=0, 
              palette = "Greys",
              labels = c("[0-40)", "[40-50)", "[50-75)","[75-835]"),
              breaks = c(0, 40, 50, 75, 835),
              title = "Population aged 5 to 14"
  )+
  tm_facets(by=c("Year"), ncol=2, nrow=1)+
  tmap_defaults +
  tm_layout(panel.label.height = 0.8)


student_pop_rate_plot <-
  tm_shape(SAvail_i_DA_extra) +
  tm_polygons(col = "kid_pop_DAavg", border.alpha=0, 
              palette = "Blues",
              labels = c("[0-0.0018)", "[0.0018-0.0025)", "[0.0025-0.0038)","[0.0038-0.59]"),
              breaks = c(0, 0.0018, 0.0025, 0.0038, 0.60),
              title = "Average pop. aged 5 to 14\nper residential unit"
  )+
  tm_facets(by=c("Year"), ncol=2, nrow=1)+
  tmap_defaults +
  tm_layout(panel.show=FALSE)

LIMAT_under18_DA_plot <-
  tm_shape(SAvail_i_DA_extra) +
  tm_polygons(col = "DA_prev_LIMAT_under18", border.alpha=0, 
              palette = "Reds",
              labels = c("[0-4.3)", "[4.3-13.0)", "[13.0-30.8)","[30.8-100)"),
              breaks = c(0, 4.30, 13.00, 30.8, 150),
              textNA = "Unavailable",
              title = "Proportion of LIM-AT households\n with children < 18"
  )+
  tm_facets(by=c("Year"), ncol=2, nrow=1)+
  tmap_defaults  +
  tm_layout(panel.show=FALSE)

stud_pop_rate_LIM_plot <- tmap_arrange(student_pop_absolute_plot, student_pop_rate_plot, LIMAT_under18_DA_plot, nrow = 3)

tmap_save(stud_pop_rate_LIM_plot, paste0(here::here(),"/Figures/stud_pop_rate_LIM_plot.png"), height=7, width=12, dpi=600)
```

```{r importing-taz-and-associated-flows, include=FALSE}
#Read the boundaries of the traffic analysis zones (retrieved from the TTS 2016):
ggh_taz <- st_read(paste0(here::here(), "/data-prep/data-inputs/TTS/tts06_83_region.shp"),
                   quiet = TRUE) %>% 
  st_transform(crs = 32617)

# Prepare traffic analysis zones:
ggh_taz <- ggh_taz %>%
  transmute(GTA06 = as.character(GTA06),
            AREA = st_area(geometry) %>% 
              set_units(km^2) %>% 
              drop_units())
#Extract the IDs for all TAZ:
ghta_taz_id <- ggh_taz$GTA06

#Read the boundaries of the traffic analysis zones (retrieved from the TTS 2016):
ggh_pd <- st_read(paste0(here::here(), "/data-prep/data-inputs/TTS/tts06_pd_83.shp"),
                  quiet = TRUE) %>%
  st_transform(crs = 32617)

#Adding region names to the object as they are not included in the origin data: (http://dmg.utoronto.ca/pdf/tts/2016/2016TTS_Conduct.pdf)

ggh_pd <- ggh_pd %>%
  mutate(REGION_name = 
           ifelse(REGION == 1, "Toronto", 
                  ifelse(REGION == 2, "Durham", 
                         ifelse(REGION == 3, "York", 
                                ifelse(REGION == 4, "Peel", 
                                       ifelse(REGION == 5, "Halton", 
                                              ifelse(REGION == 6, "Hamilton", 
                                                     ifelse(REGION == 11, "Niagara", 
                                                            ifelse(REGION == 12, "Waterloo", 
                                                                   ifelse(REGION == 13, "Guelph", 
                                                                          ifelse(REGION == 14, "Wellington", 
                                                                                 ifelse(REGION == 15, "Orangeville", 
                                                                                        ifelse(REGION == 16, "Barrie", 
                                                                                               ifelse(REGION == 17, "Simcoe", 
                                                                                                      ifelse(REGION == 18, "Kawartha Lakes", 
                                                                                                             ifelse(REGION == 19, "Peterborough City", 
                                                                                                                    ifelse(REGION == 20, "Peterborough County", 
                                                                                                                           ifelse(REGION == 21, "Orillia", 
                                                                                                                                  ifelse(REGION == 22, "Dufferin", 
                                                                                                                                         ifelse(REGION == 23, "Brantford", 
                                                                                                                                                ifelse(REGION == 24, "Brant", "NOOOO")))))))))))))))))))))

# add 'REGION' from the planning distract object to the `ggh_taz`. 
#buffering to clean up the edges of these objects -> there wre issues using st_join. 
ggh_taz <- st_buffer(ggh_taz, dist=0)
ggh_pd <- st_buffer(ggh_pd, dist=0)

ggh_taz <- st_join(ggh_taz, ggh_pd %>% transmute(REGION),left = TRUE, largest = TRUE)
ham_taz <- ggh_taz %>% dplyr::filter(REGION==6) #Filter out everything other than Planning District 6 = Hamilton
```

```{r include=FALSE}
#the tts origin-destination trips, by mode
load(file = paste0(here::here(),"/data-prep/data-inputs/TTS/od_trips_perc_2011.Rdata"))
load(file = paste0(here::here(),"/data-prep/data-inputs/TTS/od_trips_perc_2016.Rdata"))

ham_taz_centroids <- ham_taz |> st_centroid() |> dplyr::select(GTA06)

od_trips_perc_car <- rbind(
  rbind(od_trips_perc_2011 |> group_by(Origin) |> 
          summarize(TAZOrig_car_perc = 
                      sum(TAZOrig_car_trips, na.rm = T)/sum(TAZOrig_walk_trips+TAZOrig_car_trips, na.rm = T)) |>
          mutate(year = "2011")),
  od_trips_perc_2016 |> group_by(Origin) |> 
    summarize(TAZOrig_car_perc = 
                sum(TAZOrig_car_trips, na.rm = T)/sum(TAZOrig_walk_trips+TAZOrig_car_trips, na.rm = T)) |>
    mutate(year = "2016"))

od_trips_perc_car <- left_join(ham_taz,od_trips_perc_car, by=c("GTA06"="Origin"))

od_trips_perc_walk <- rbind(
  rbind(od_trips_perc_2011 |> group_by(Origin) |> 
          summarize(TAZOrig_walk_perc = 
                      sum(TAZOrig_walk_trips)/sum(TAZOrig_walk_trips+TAZOrig_car_trips)) |>
          mutate(year = "2011")),
  od_trips_perc_2016 |> group_by(Origin) |> 
    summarize(TAZOrig_walk_perc = 
                sum(TAZOrig_walk_trips)/sum(TAZOrig_walk_trips+TAZOrig_car_trips)) |>
    mutate(year = "2016"))

od_trips_perc_walk <- left_join(ham_taz, od_trips_perc_walk, by=c("GTA06"="Origin"))

desire_lines_ham_2011 <- od2line(od_trips_perc_2011, ham_taz_centroids)
desire_lines_ham_2011 <- desire_lines_ham_2011 |> mutate(all = TAZOrig_car_trips + TAZOrig_walk_trips,
                                                         Year = "2011")

desire_lines_ham_2016 <- od2line(od_trips_perc_2016, ham_taz_centroids)
desire_lines_ham_2016 <- desire_lines_ham_2016 |> mutate(all = TAZOrig_car_trips + TAZOrig_walk_trips,
                                                         Year = "2016")

desire_lines_ham <- rbind(desire_lines_ham_2011, desire_lines_ham_2016)
rm(desire_lines_ham_2011, desire_lines_ham_2016)
```

```{r ploting-od-taz-flows, eval=FALSE}
car_OD_flow_plot <-  tm_shape(od_trips_perc_car |> mutate(mode = "motorized"), bbox=SAvail_i_DA_extra) +
  tm_polygons(col = "TAZOrig_car_perc", border.alpha = 0.4, border.col = "grey20", lwd=0.2,
              palette = "Greys",
              breaks = c(0, .25, .50, .75, 1),
              title = "Proportion of mode use",
              textNA = "Unavailable",
              colorNA = "white")+
  #tm_shape(SAvail_i_DA_extra) + tm_borders(alpha = 0.4, col = "grey20", lwd=0.2)+
  tm_shape(ham_taz) + tm_borders(alpha=0.4, col = "grey40", lwd=0.2) +
  tm_shape(ham_community_bounds) + tm_borders(alpha = 0.8, col = "lightblue", lwd=2)+
  tm_shape(ham_taz_centroids) + tm_dots(alpha=0.5, col="darkblue", size=0.01) +
  tm_shape(desire_lines_ham |> mutate(mode = "motorized")) +
  tm_lines(palette = "Reds", breaks = c(6, 22, 26, 49, 353),
           title.col = "Number of trips (motorized)",
           col = "TAZOrig_car_trips",
           alpha = 0.9,
           scale = 3,
           lwd = "all",
           legend.lwd.show = FALSE) +
  tm_facets(by = c("mode","Year"), nrow=1)+
  tmap_defaults +
  tm_layout(panel.label.height = 0.8)

walk_OD_flow <- tm_shape(od_trips_perc_walk |> mutate(mode = "non-motorized"), bbox=SAvail_i_DA_extra) +
  tm_polygons(col = "TAZOrig_walk_perc", border.alpha = 0.4, border.col = "grey20", lwd=0.2,
              palette = "Greys",
              breaks = c(0, .25, .50, .75, 1),
              title = "Proportion of mode use",
              textNA = "Unavailable",
              colorNA = "white",
              legend.show=FALSE)+
  #tm_shape(SAvail_i_DA_extra) + tm_borders(alpha = 0.4, col = "cornflowerblue", lwd=0.2)+
  tm_shape(ham_taz) + tm_borders(alpha=0.4, col = "grey40", lwd=0.2) +
  tm_shape(ham_community_bounds) + tm_borders(alpha = 0.8, col = "lightblue", lwd=2)+
  tm_shape(ham_taz_centroids) + tm_dots(alpha=0.5, col="darkblue", size=0.01) +
  tm_shape(desire_lines_ham |> filter(TAZOrig_walk_trips >= 1) 
           |> mutate(mode = "non-motorized")) +
  tm_lines(palette = "Greens", breaks = c(12, 23, 44, 67, 174),
           title.col = "Number of trips (non-motorized)",
           col = "TAZOrig_walk_trips",
           alpha = 0.9,
           scale = 4,
           lwd = "all",
           legend.lwd.show = FALSE) +
  tm_facets(by = c("mode","Year"), nrow=1)+
  tmap_defaults +
  tm_layout(panel.label.height = c(0.8,0,0)) +
  tm_add_legend(type = "line", 
                col = c("grey40","lightblue"),
                labels = c("TAZ boundary","Community boundary"))+
  tm_add_legend(type = "symbol",
                col = "darkblue",
                labels = "TAZ centroid")
OD_flow_plot <- tmap_arrange(car_OD_flow_plot, walk_OD_flow, nrow = 2)
tmap_save(OD_flow_plot, paste0(here::here(),"/Figures/OD_flow_plot.png"), height=7, width=12, dpi=600)
```

```{r quartiles-of-tts-estimated-tt}
od_trips_perc_tt <- data.frame(x=c(gamma2011_motor$data, exp2011_nonmotor$data,
                                   gamma2016_motor$data, exp2016_nonmotor$data),
                               mode = c(rep("motorized", length(gamma2011_motor$data)),
                                        rep("non-motorized", length(exp2011_nonmotor$data)),
                                        rep("motorized", length(gamma2016_motor$data)),
                                        rep("non-motorized", length(exp2016_nonmotor$data))),
                               year = c(rep("2011", length(gamma2011_motor$data)),
                                        rep("2011", length(exp2011_nonmotor$data)),
                                        rep("2016", length(gamma2016_motor$data)),
                                        rep("2016", length(exp2016_nonmotor$data)))
)


q_motorized_2011 <- stats::quantile(od_trips_perc_tt |>
                                      filter(mode == "motorized", year == "2011") |>
                                      pull(x),
                                    probs = c(0.25, 0.5, 0.75), na.rm=T)

q_nonmotorized_2011 <- stats::quantile(od_trips_perc_tt  |>
                                         filter(mode == "non-motorized",
                                                year == "2011") |> 
                                         pull(x),
                                       probs = c(0.25, 0.5, 0.75), na.rm=T)

q_motorized_2016 <- stats::quantile(od_trips_perc_tt  |>
                                      filter(mode == "motorized",
                                             year == "2016") |>
                                      pull(x),
                                    probs = c(0.25, 0.5, 0.75), na.rm=T)

q_nonmotorized_2016 <- stats::quantile(od_trips_perc_tt |> 
                                         filter(mode == "non-motorized",
                                                year == "2016") |>
                                         pull(x),
                                       probs = c(0.25, 0.5, 0.75), na.rm=T)


q_1 <- data.frame(
  label = paste0("Q1:\n", c(q_motorized_2011[1], q_nonmotorized_2011[1]|> round(),
                            q_motorized_2016[1], q_nonmotorized_2016[1]|> round())),
  mode   = c("motorized", "non-motorized", "motorized", "non-motorized"),
  year = c("2011", "2011", "2016", "2016"),
  x     = c(q_motorized_2011[1], q_nonmotorized_2011[1] |> round(),
            q_motorized_2016[1], q_nonmotorized_2016[1]|> round()),
  y     = c(0.11, 0.11, 0.11, 0.11)
)

q_2 <- data.frame(
  label = paste0("Q2:\n", c(q_motorized_2011[2], q_nonmotorized_2011[2]|> round(),
                            q_motorized_2016[2], q_nonmotorized_2016[2]|> round())),
  mode   = c("motorized", "non-motorized", "motorized", "non-motorized"),
  year = c("2011", "2011", "2016", "2016"),
  x     = c(q_motorized_2011[2], q_nonmotorized_2011[2] |> round(),
            q_motorized_2016[2], q_nonmotorized_2016[2]|> round()),
  y     = c(0.11, 0.11, 0.11, 0.11)
)

q_3 <- data.frame(
  label = paste0("Q3:\n", c(q_motorized_2011[3], q_nonmotorized_2011[3]|> round(),
                            q_motorized_2016[3], q_nonmotorized_2016[3]|> round())),
  mode   = c("motorized", "non-motorized", "motorized", "non-motorized"),
  year = c("2011", "2011", "2016", "2016"),
  x     = c(q_motorized_2011[3], q_nonmotorized_2011[3] |> round(),
            q_motorized_2016[3], q_nonmotorized_2016[3]|> round()),
  y     = c(0.11, 0.11, 0.11, 0.11)
)
```

```{r tts-theoretical-curve-creation}
x <- data.frame(t = seq(0, 45, 0.1))
X_shorter <-data.frame(t = seq(0, 27, 0.1))

x_motorized_2011 <- x %>%
  mutate(f = dgamma(t,
                    gamma2011_motor$estimate[1],
                    gamma2011_motor$estimate[2]),
         mode = "motorized",
         year = "2011")

x_nonmotorized_2011 <- X_shorter %>%
  mutate(f = dexp(t,
                  exp2011_nonmotor$estimate[1]),
         mode = "non-motorized",
         year = "2011")

x_motorized_2016 <- x %>%
  mutate(f = dgamma(t,
                    gamma2016_motor$estimate[1],
                    gamma2016_motor$estimate[2]),
         mode = "motorized",
         year = "2016")

x_nonmotorized_2016 <- X_shorter %>%
  mutate(f = dexp(t,
                  exp2016_nonmotor$estimate[1]),
         mode = "non-motorized",
         year = "2016")

tld_theoretical <- rbind(x_motorized_2011,
                         x_nonmotorized_2011,
                         x_motorized_2016,
                         x_nonmotorized_2016) %>%
  mutate(mode = factor(mode, levels = c("motorized", "non-motorized")),
         year = factor(year, levels = c("2011", "2016")))
```

```{r ploting-empirical-and-theo-curve-TLD-tts, eval=FALSE}
TLD_empirical_wtheo_curve_plot <- ggplot() + 
  geom_histogram(data = od_trips_perc_tt,
                 aes(x = x, 
                     y = ..density..),
                 colour = "grey80",
                 alpha = 0.5,
                 boundary = 0,
                 binwidth = 3) +
  geom_vline(data = q_1, mapping = aes(xintercept = x), colour = "grey60") +
  geom_vline(data = q_2, mapping = aes(xintercept = x), colour = "grey60") +
  geom_vline(data = q_3, mapping = aes(xintercept = x), colour = "grey60") +
  geom_line(data = tld_theoretical, aes(x = t, y = f), colour = "blue", size=0.8) + 
  xlab("Estimated TTS travel time (minutes)") +
  scale_x_continuous(breaks = seq(0,40,10), expand=c(0,0))+
  scale_y_continuous(breaks = seq(0,0.12,0.04), limits = c(0,0.12))+
  facet_grid(~mode~year)+
  geom_text(data = q_1, 
            mapping = aes(x = x, y = y, label = label), colour = "grey20", size=3) +
  geom_text(data = q_2,
            mapping = aes(x = x, y = y, label = label), colour = "grey20", size=3) +
  geom_text(data = q_3,
            mapping = aes(x = x, y = y, label = label), colour = "grey20", size=3) +
  theme_classic()
TLD_empirical_wtheo_curve_plot
ggsave(paste0(here::here(),"/Figures/TLD_empirical_wtheo_curve_plot.png"), height=7, width=12, dpi=600)
```

```{r, eval=FALSE}
Vim_20112016_plot <-  tm_shape(SAvail_im_DA, bbox=SAvail_im_DA) +
  tm_polygons(col = "V_im", border.alpha = 0, border.col = "grey20", lwd=0.2,
              palette = "Greys",
              style="quantile", n=4,
              title = expression(V[i]^m*' (quartiles)'),
              textNA = "Unavailable",
              colorNA = "white")+
  tm_facets(by = c("mode","year"), nrow=1)+
  tm_shape(ALL_SCHOOLS_Elem_formapping) +
  tm_dots(col = "Status", size=0.03, title = "School status between\n2011 and 2016",
          palette = c("ivory", "black", "darkgreen","#0E86D4","#90EE90"),
          labels = c("No change","Closed before 2016", "Expanded before 2016","Moved before 2016","New after 2011"), legend.show=FALSE) +
  tm_shape(ham_community_bounds) + tm_borders(alpha = 0.8, col = "lightblue", lwd=1.5)+
  tmap_defaults +
  tm_layout(panel.label.height = 0.8)

vvim_20112016_plot <-  tm_shape(SAvail_im_DA, bbox=SAvail_im_DA) +
  tm_polygons(col = "v_im_kid_popadj", border.alpha = 0, border.col = "grey20", lwd=0.2,
              palette = "RdYlGn",
              midpoint = 1.0,
              title = expression(v[i]^m),
              breaks = c(0, 0.5, 1, 1.5, 2, 2.1), #note the highest value is ~12, I'm breaking the values early for the purpose of visualisation
              labels = c("[0-0.5)", "[0.5-1)", "[1-1.5)", "[1.5-2)", "[>2)"),
              textNA = "Unavailable",
              colorNA = "white")+
  tm_facets(by = c("mode","year"), nrow=1)+
  tm_shape(ALL_SCHOOLS_Elem_formapping) +
  tm_dots(col = "Status", size=0.03, title = "School status between\n2011 and 2016",
          palette = c("ivory", "black", "darkgreen","#0E86D4","#90EE90"),
          labels = c("No change","Closed before 2016", "Expanded before 2016","Moved before 2016","New after 2011")          ) +
  tm_shape(ham_community_bounds) + tm_borders(alpha = 0.8, col = "lightblue", lwd=1.5)+
  tmap_defaults +
  tm_layout(panel.label.height = 0.8)

Vim_vvim_20112016_plot <- tmap_arrange(Vim_20112016_plot, vvim_20112016_plot, nrow=2)

tmap_save(Vim_vvim_20112016_plot, paste0(here::here(),"/Figures/Vim_vvim_20112016_plot.png"), height=7, width=12, dpi=600)
```


```{r, eval=FALSE}
Vim_20112016_CHANGE_plot <-  tm_shape(SAvail_im_DA_changes, bbox=SAvail_im_DA) +
  tm_polygons(col = "c_V_im", border.alpha = 0, border.col = "grey20", lwd=0.2,
              palette = "-PuOr", midpoint=0,
              breaks = c(-5, -4, -3, -2, -1, 0, 1, 2,3,4,5),
              labels = c("[>-5 to -4)", "[-4 to -3)", "[-3 to -2)","[-2 to -1)","[-1 to 0)", "[0 to 1)", 
                         "[1 to 2)", "[2 to 3)", "[3 to 4)", "[4 to <5)" ),
              title = expression("Change in "*V[i]^m),
              textNA = "Unavailable",
              colorNA = "white")+
  tm_facets(by = c("mode"), nrow=1)+
  tm_shape(ALL_SCHOOLS_Elem_formapping |> 
             filter(Status != "NoChange" & Status != "Moved")|>
             mutate(Status_change = case_when(Status == "Removed" ~ "Closed",
                                              (Status == "Expanded" | Status == "New" ) ~ "New or Expanded"))) +
  tm_dots(col = "Status_change", size=0.05, title = "Schools that changed status",
          palette = c("black", "#90EE90"), legend.show=FALSE) +
  tm_shape(ham_community_bounds) + tm_borders(alpha = 0.8, col = "lightblue", lwd=2)+
  tmap_defaults +
  tm_layout(panel.label.height = 0.8)

#tmap_save(Vim_20112016_CHANGE_plot, "Figures/Vim_20112016_CHANGE_plot.png", height=7, width=12, dpi=600)

vvim_20112016_CHANGE_plot <- tm_shape(SAvail_im_DA_changes, bbox=SAvail_im_DA) +
  tm_polygons(col = "c_v_im_kid_popadj", border.alpha = 0, border.col = "grey20", lwd=0.2,
              palette = "RdYlGn", midpoint=0,
              breaks = c(-0.1, -0.05, 0.00, 0.05, 0.1),
              labels = c("[>-0.1 to -0.05)", "[-0.05 to 0.00)", "[0.00 to 0.05)", "[0.05 to <0.1)"),
              title = expression("Change in "*v[i]^m),
              textNA = "Unavailable",
              colorNA = "white")+
  tm_facets(by = c("mode"), nrow=1)+
  tm_shape(ALL_SCHOOLS_Elem_formapping |> 
             filter(Status != "NoChange" & Status != "Moved")|>
             mutate(Status_change = case_when(Status == "Removed" ~ "Closed",
                                              (Status == "Expanded" | Status == "New" ) ~ "New or Expanded"))) +
  tm_dots(col = "Status_change", size=0.05, title = "Schools that changed status",
          palette = c("black", "#90EE90")) +
  tm_shape(ham_community_bounds) + tm_borders(alpha = 0.8, col = "lightblue", lwd=2)+
  tmap_defaults +
  tm_layout(panel.label.height = 0.8)

Vim_vvim_20112016_CHANGE_plot <- tmap_arrange(Vim_20112016_CHANGE_plot, vvim_20112016_CHANGE_plot, nrow=2)

tmap_save(Vim_vvim_20112016_CHANGE_plot, 
          paste0(here::here(),"/Figures/Vim_vvim_20112016_CHANGE_plot.png"),
          height=7,
          width=12, 
          dpi=600)
```

```{r, eval=FALSE}
walk_OD_flow <- tm_shape(od_trips_perc_walk |> mutate(mode = "non-motorized"), bbox=SAvail_i_DA_extra) +
  tm_polygons(col = "TAZOrig_walk_perc", border.alpha = 0.4, border.col = "grey20", lwd=0.2,
              palette = "Greys",
              breaks = c(0, .25, .50, .75, 1),
              title = "Proportion of mode use",
              textNA = "Unavailable",
              colorNA = "white",
              legend.show=FALSE)+
  #tm_shape(SAvail_i_DA_extra) + tm_borders(alpha = 0.4, col = "cornflowerblue", lwd=0.2)+
  tm_shape(ham_taz) + tm_borders(alpha=0.4, col = "grey40", lwd=0.2) +
  tm_shape(ham_community_bounds) + tm_borders(alpha = 0.8, col = "lightblue", lwd=2)+
  tm_shape(ham_taz_centroids) + tm_dots(alpha=0.5, col="darkblue", size=0.01) +
  tm_shape(desire_lines_ham |> filter(TAZOrig_walk_trips >= 1) 
           |> mutate(mode = "non-motorized")) +
  tm_lines(palette = "Greens", breaks = c(12, 23, 44, 67, 174),
           title.col = "Number of trips (non-motorized)",
           col = "TAZOrig_walk_trips",
           alpha = 0.9,
           scale = 4,
           lwd = "all",
           legend.lwd.show = FALSE) +
  tm_facets(by = c("mode","Year"), nrow=1)+
  tmap_defaults +
  tm_layout(panel.label.height = c(0.8,0,0)) +
  tm_add_legend(type = "line", 
                col = c("grey40","lightblue"),
                labels = c("TAZ boundary","Community boundary"))+
  tm_add_legend(type = "symbol",
                col = "darkblue",
                labels = "TAZ centroid")
OD_flow_plot <- tmap_arrange(car_OD_flow_plot, walk_OD_flow, nrow = 2)
tmap_save(OD_flow_plot, 
          paste0(here::here(),"/Figures/SA-and-SAperStud-20112016.png"),
          height=7, 
          width=12,
          dpi=600)
```

```{r, eval=FALSE}
SA_Vim_2011_plot <- ggplot() +
  geom_sf(data = SAvail_im_DA2011, aes(fill= V_im), color = NA) +
  scale_fill_binned(type = "viridis", na.value = "grey60",
                    breaks = c(min(SAvail_im_DA2011$V_im),
                               quantile(SAvail_im_DA2011$V_im,0.25)%>%as.numeric(),
                               median(SAvail_im_DA2011$V_im, na.rm=T),
                               quantile(SAvail_im_DA2011$V_im,0.75)%>%as.numeric(),
                               max(SAvail_im_DA2011$V_im, na.rm = T)))+
  geom_sf(data = ALL_SCHOOLS_Elem |> filter(Year != 2016), 
          size=0.5, colour = "Red", alpha=0.7)+
  geom_sf(data = ham_community_bounds, fill=NA, color = "grey30", alpha=0.7)+
  theme_minimal() +
  theme(legend.title = element_text(size=10),
        axis.text = element_blank(), #removes lat/long from the axises
        panel.grid.major=element_blank())+
  facet_wrap(~mode)

SA_Vim_2016_plot <- ggplot() +
  geom_sf(data = SAvail_im_DA2016, aes(fill= V_im), color = NA) +
  scale_fill_binned(type = "viridis", na.value = "grey60",
                    breaks = c(min(SAvail_im_DA2016$V_im),
                               quantile(SAvail_im_DA2016$V_im,0.25)%>%as.numeric(),
                               median(SAvail_im_DA2016$V_im, na.rm=T),
                               quantile(SAvail_im_DA2016$V_im,0.75)%>%as.numeric(),
                               max(SAvail_im_DA2016$V_im, na.rm = T)))+
  geom_sf(data = ALL_SCHOOLS_Elem |> filter(Year != 2011), 
          size=0.5, colour = "Red", alpha=0.7)+
  geom_sf(data = ham_community_bounds, fill=NA, color = "grey30", alpha=0.7)+
  theme_minimal() +
  theme(legend.title = element_text(size=10),
        axis.text = element_blank(), #removes lat/long from the axises
        panel.grid.major=element_blank())+
  facet_wrap(~mode)
```
```{r, eval=FALSE}
SA_vim_2011_plot <- ggplot() +
  geom_sf(data = SAvail_im_DA2011, aes(fill= v_im_kid_popadj), color = NA) +
  scale_fill_binned(type = "viridis",
                    breaks = c(min(SAvail_im_DA2011$v_im_kid_popadj, na.rm = T),
                               quantile(SAvail_im_DA2011$v_im_kid_popadj,0.25)%>%as.numeric(),
                               median(SAvail_im_DA2011$v_im_kid_popadj, na.rm=T),
                               quantile(SAvail_im_DA2011$v_im_kid_popadj,0.75)%>%as.numeric(),
                               max(SAvail_im_DA2011$v_im_kid_popadj, na.rm = T)))+
  geom_sf(data = ALL_SCHOOLS_Elem |> filter(Year != 2016), 
          size=0.5, colour = "Red", alpha=0.7)+
  geom_sf(data = ham_community_bounds, fill=NA, color = "grey30", alpha=0.7)+
  theme_minimal() +
  theme(legend.title = element_text(size=10),
        axis.text = element_blank(), #removes lat/long from the axises
        panel.grid.major=element_blank())+
  facet_wrap(~mode)

SA_vim_2016_plot <- ggplot() +
  geom_sf(data = SAvail_im_DA2016, aes(fill= v_im_kid_popadj), color = NA) +
  scale_fill_binned(type = "viridis",
                    breaks = c(min(SAvail_im_DA2016$v_im_kid_popadj, na.rm = T),
                               quantile(SAvail_im_DA2016$v_im_kid_popadj,0.25)%>%as.numeric(),
                               median(SAvail_im_DA2016$v_im_kid_popadj, na.rm=T),
                               quantile(SAvail_im_DA2016$v_im_kid_popadj,0.75)%>%as.numeric(),
                               max(SAvail_im_DA2016$v_im_kid_popadj, na.rm = T)))+
  geom_sf(data = ALL_SCHOOLS_Elem |> filter(Year != 2011), 
          size=0.5, colour = "Red", alpha=0.7)+
  geom_sf(data = ham_community_bounds, fill=NA, color = "grey30", alpha=0.7)+
  theme_minimal() +
  theme(legend.title = element_text(size=10),
        axis.text = element_blank(), #removes lat/long from the axises
        panel.grid.major=element_blank())+
  facet_wrap(~mode)
```

```{r, eval=FALSE}
SA_vim_LIMAT_2011_plot <- ggplot() +
  geom_sf(data = SAvail_im_DA2011, aes(fill= v_im_kid_popadj_LIMAT), color = NA) +
  scale_fill_binned(type = "viridis", 
                    breaks = c(min(SAvail_im_DA2011$v_im_kid_popadj_LIMAT, na.rm = T),
                               quantile(SAvail_im_DA2011$v_im_kid_popadj_LIMAT,0.25)%>%as.numeric()+0.000000001,
                               median(SAvail_im_DA2011$v_im_kid_popadj_LIMAT, na.rm=T),
                               quantile(SAvail_im_DA2011$v_im_kid_popadj_LIMAT,0.75)%>%as.numeric(),
                               max(SAvail_im_DA2011$v_im_kid_popadj_LIMAT, na.rm = T)))+
  geom_sf(data = ALL_SCHOOLS_Elem |> filter(Year != 2016), 
          size=0.5, colour = "Red", alpha=0.7)+
  geom_sf(data = ham_community_bounds, fill=NA, color = "grey30", alpha=0.7)+
  theme_minimal() +
  theme(legend.title = element_text(size=10),
        axis.text = element_blank(), #removes lat/long from the axises
        panel.grid.major=element_blank())+
  facet_wrap(~mode)

SA_vim_LIMAT_2016_plot <- ggplot() +
  geom_sf(data = SAvail_im_DA2016, aes(fill= v_im_kid_popadj_LIMAT), color = NA) +
  scale_fill_binned(type = "viridis", 
                    breaks = c(min(SAvail_im_DA2016$v_im_kid_popadj_LIMAT, na.rm = T),
                               quantile(SAvail_im_DA2016$v_im_kid_popadj_LIMAT,0.25)%>%as.numeric()+0.000000001,
                               median(SAvail_im_DA2016$v_im_kid_popadj_LIMAT, na.rm=T),
                               quantile(SAvail_im_DA2016$v_im_kid_popadj_LIMAT,0.75)%>%as.numeric(),
                               max(SAvail_im_DA2016$v_im_kid_popadj_LIMAT, na.rm = T)))+
  geom_sf(data = ALL_SCHOOLS_Elem |> filter(Year != 2011), 
          size=0.5, colour = "Red", alpha=0.7)+
  geom_sf(data = ham_community_bounds, fill=NA, color = "grey30", alpha=0.7)+
  theme_minimal() +
  theme(legend.title = element_text(size=10),
        axis.text = element_blank(), #removes lat/long from the axises
        panel.grid.major=element_blank())+
  facet_wrap(~mode)


SA_Vim_LIMAT_2011_plot <- ggplot() +
  geom_sf(data = SAvail_im_DA2011, aes(fill= V_i_kid_popadj_LIMAT), color = NA) +
  scale_fill_binned(type = "viridis", 
                    breaks = c(min(SAvail_im_DA2011$V_i_kid_popadj_LIMAT, na.rm = T),
                               quantile(SAvail_im_DA2011$V_i_kid_popadj_LIMAT,0.25)%>%as.numeric()+0.000000001,
                               median(SAvail_im_DA2011$V_i_kid_popadj_LIMAT, na.rm=T),
                               quantile(SAvail_im_DA2011$V_i_kid_popadj_LIMAT,0.75)%>%as.numeric(),
                               max(SAvail_im_DA2011$V_i_kid_popadj_LIMAT, na.rm = T)))+
  geom_sf(data = ALL_SCHOOLS_Elem |> filter(Year != 2016), 
          size=0.5, colour = "Red", alpha=0.7)+
  geom_sf(data = ham_community_bounds, fill=NA, color = "grey30", alpha=0.7)+
  theme_minimal() +
  theme(legend.title = element_text(size=10),
        axis.text = element_blank(), #removes lat/long from the axises
        panel.grid.major=element_blank())+
  facet_wrap(~mode)

SA_Vim_LIMAT_2016_plot <- ggplot() +
  geom_sf(data = SAvail_im_DA2016, aes(fill= V_i_kid_popadj_LIMAT), color = NA) +
  scale_fill_binned(type = "viridis", 
                    breaks = c(min(SAvail_im_DA2016$V_i_kid_popadj_LIMAT, na.rm = T),
                               quantile(SAvail_im_DA2016$V_i_kid_popadj_LIMAT,0.25)%>%as.numeric()+0.000000001,
                               median(SAvail_im_DA2016$V_i_kid_popadj_LIMAT, na.rm=T),
                               quantile(SAvail_im_DA2016$V_i_kid_popadj_LIMAT,0.75)%>%as.numeric(),
                               max(SAvail_im_DA2016$V_i_kid_popadj_LIMAT, na.rm = T)))+
  geom_sf(data = ALL_SCHOOLS_Elem |> filter(Year != 2011), 
          size=0.5, colour = "Red", alpha=0.7)+
  geom_sf(data = ham_community_bounds, fill=NA, color = "grey30", alpha=0.7)+
  theme_minimal() +
  theme(legend.title = element_text(size=10),
        axis.text = element_blank(), #removes lat/long from the axises
        panel.grid.major=element_blank())+
  facet_wrap(~mode)
```
```{r, eval=FALSE}
SA_Vim_2011_plot
SA_vim_2011_plot
SA_Vim_LIMAT_2011_plot
SA_vim_LIMAT_2011_plot

SA_Vim_2016_plot
SA_vim_2016_plot
SA_Vim_LIMAT_2016_plot
SA_vim_LIMAT_2016_plot
#*summarize LIM at city level
```

```{r, eval=FALSE}
SAvail_im_DA2011  |> st_drop_geometry() |> group_by(COMMUNITY, mode) |> summarise(
  LIM = mean(DA_prev_LIMAT_under18, na.rm = T)*mean(kid_popadj_m, na.rm = T),
  sum_total_tt = sum(total_tt),
  emis_perkid = sum(emissions_total_car_tt)/sum(kid_popadj_m),
  sum_V_im = sum(V_im),
  mn_v_im = mean(v_im_kid_popadj),
  mn_v_im_LIM = mean(v_im_kid_popadj_LIMAT))

SAvail_im_DA2016  |> st_drop_geometry() |> group_by(COMMUNITY, mode) |> summarise(
  LIM = mean(DA_prev_LIMAT_under18, na.rm = T)*mean(kid_popadj_m, na.rm = T),
  sum_total_tt = sum(total_tt),
  emis_perkid = sum(emissions_total_car_tt)/sum(kid_popadj_m),
  sum_V_im = sum(V_im),
  mn_v_im = mean(v_im_kid_popadj),
  mn_v_im_LIM = mean(v_im_kid_popadj_LIMAT))                                                
```

```{r creating-desc-stats-table-tt, echo=FALSE}
#forming a complete descriptive statistic table
# Statistics <- data.frame("Statistic" = c("Parcel pts", "Trips",
#                                          "TT min.", "TT 1st qu.", "TT mean", "TT 3rd qu.", "TT max."))
# `2011` <- data.frame(`Y2011` = c(ALL_nearest_network_point %>% filter(Year != "2016") %>% pull(ROLL_NUM) %>% length() %>% round() ,
#                                 ALL_PARCELS %>% filter(ParYear != "2016" & Level == "Elementary") %>% pull(ROLL_NUM) %>% length()%>% round(),
#                                 ALL_PARCELS %>% filter(ParYear != "2016" & Level == "Elementary") %>% pull(car_tt) %>% min()%>% round(),
#                                 ALL_PARCELS %>% filter(ParYear != "2016" & Level == "Elementary") %>% pull(car_tt) %>% quantile(0.25) %>% as.numeric()%>% round(), 
#                                 ALL_PARCELS %>% filter(ParYear != "2016" & Level == "Elementary") %>% pull(car_tt) %>% mean()%>% round(),
#                                 ALL_PARCELS %>% filter(ParYear != "2016" & Level == "Elementary") %>% pull(car_tt) %>% quantile(0.75) %>% as.numeric()%>% round(),
#                                 ALL_PARCELS %>% filter(ParYear != "2016" & Level == "Elementary") %>% pull(car_tt) %>% max()%>% round()
#                                 ))
# `2016` <- data.frame(`Y2016` = c(ALL_nearest_network_point %>% filter(Year != "2011") %>% pull(ROLL_NUM) %>% length()%>% round(),
#                                 ALL_PARCELS %>% filter(ParYear != "2011" & Level == "Elementary") %>% pull(ROLL_NUM) %>% length()%>% round(),
#                                 ALL_PARCELS %>% filter(ParYear != "2011" & Level == "Elementary") %>% pull(car_tt) %>% min()%>% round(),
#                                 ALL_PARCELS %>% filter(ParYear != "2011" & Level == "Elementary") %>% pull(car_tt) %>% quantile(0.25) %>% as.numeric()%>% round(), 
#                                 ALL_PARCELS %>% filter(ParYear != "2011" & Level == "Elementary") %>% pull(car_tt) %>% mean()%>% round(),
#                                 ALL_PARCELS %>% filter(ParYear != "2011" & Level == "Elementary") %>% pull(car_tt) %>% quantile(0.75) %>% as.numeric()%>% round(),
#                                 ALL_PARCELS %>% filter(ParYear != "2011" & Level == "Elementary") %>% pull(car_tt) %>% max()%>% round()
#                                 ))
# desc_stats_tt <- cbind(Statistics,`2011`, `2016`)
# 
# #kable tabling
# desc_stats_tt %>%
#   kableExtra::kable(format = "latex",
#         align="lrrrrrr",
#         booktabs = T,
#         col.names = c("Statistic", "2011", "2016"),
#         caption = "\\label{tab:desc-stats-table-tt}Descriptive statistics of the parcels, trips, and calculated origin-destination car travel times.") %>%
#   kableExtra::kable_styling(full_width = "T",
#                 latex_options = c("scale_down"),
#                 position = "center")
```

<!--
Additional methods considerations: circuity of trip by mode? Schoolbus is not as direct of a trip as car/taxi/bikeORwalk. Maybe we consider 3 modes instead of 2? The r5r travel time for car/taxi as well as walk/cycle can be used as is, but the travel time by school bus can be increased based on a trip distance factor (from TTS)? 

RESULTS an alternative layout idea?:
1. Multimodal spatial availability aggregated at the DA for each year and for each mode. Each DA is ~200 parcel points with their low-income and other-income spatial availability per mode; both these are summed together along with the rest of the parcel points per da. (6 plots - 3 modes per 2011 and 3 modes per 2016). 
2. Income-specific spatial availability aggregated at the DA for each population type. Similarly, each DA is ~200 parcel points with 3 mode-specific spatial availability per income-group; all three are summed together along with the rest of the parcel points per da.  (4 plots - 2 population-groups per 2011 and 2 population-groups per 2016).
3. EXAMINING THE INTERMEDIATES: the change in spatial availability per focused communities:
3.a. Hamilton-Central+Dundas experienced the majority of school closures, also have the highest LICO-AT as well as motorized transport. Glanbrook+StoneyCreek experienced the majority of new schools (two), also have low LICO-AT as well as non-motorized transport. So. 2 columns.  First column SA By Mode. SA By Mode in 2016 for HC+Dundas, then SA By Mode in 2016 for Glan+SC, then SA By Mode in 2016 Overall. Second column SA By Pop. SAY by LICO or not LICO in 2016 for HC+Dundas, then for GLAN+SC, then for overall. Showing SA for 2016 with brackets that say (+ or - X% to indicate difference from 2011).  
3.b. Examining the change in travel time per focused communities: same bar graph style as in 3.a. Will show have non-motorized travel time decreased in Ham-central, esp for LICO(?)
3.c. Change in emissions: same bar graph style as in 3.a. but for emissions. Will show have emissions increased, esp in Ham-central and LICO(?)
4. USING SPATIAL AVAILABILITY FOR PLANNING. Equity? We want to plan for school-seat availability _for_ active modes. Especially in areas with currently high LICO-AT. So lets plot spatial availability per non-motorized-LICO-AT capita. We'd like to see 1.2 SA per capita everywhere. We need improvements to the population, opportunities, and non motorized transport network (relative to all other modes/population groups) is the key point. -->

# Introduction

Communities are by nature in flux: economic and demographic shifts, rural and urban configurations, and political pressures stoke changes in community characteristics. These forces spur the re-organization and consolidation of public facilities in communities around the world where changes to service provision may improve the quality of service for some but not for all [@Christiaanse_2020; @Rosik_Pulawska-Obiedowska_Goliszek_2021]. Oftentimes, top-down consolidation decisions that are driven by operational cost-savings do not taken into consideration the full extent of benefit loss.

From this perspective, journey-to-school trips are tremendously important: this trip purpose is the largest contributor of carbon emissions from personal travel after journey-to-work trips [@rongReviewResearchLowcarbon2022; @pantelakiImpactHomeschoolCommuting2024]. In many communities globally, school locations are closing [@sageman2022] and trips made to school are increasingly motorized [@rongReviewResearchLowcarbon2022]. Nonetheless, school closure policies have been pursued by governments to optimize per-student operational cost-efficiency [@rongReviewResearchLowcarbon2022] but spatial and travel implications have often been overlooked by decision makers [@bierbaumMobilityJusticeLinking2021; @Lee_Lubienski_2017]. For instance, 65% of comprehensive schools (e.g. grades 1 through 9) in rural Finland since 1990 closed [@Autti_Hyry-Beihammer_2014], 10% of elementary schools (kindergarten through grade 8) in Chicago, USA in 2013 [@Lee_Lubienski_2017], and 7% of primary and lower secondary schools (kindergarten through grade 9) were closed in Denmark between 2010-2011 [@Beuchert_Humlum_Nielsen_Smith_2018].

In this study we focus on the spatial travel implications of school closure and consolidation policies. The quantification of lost potential active transportation trips and associated carbon emissions, due to school closure, and the unequal impact attributed to the increased reliance on a motorized commute is scarce in the literature. In this way, our contribution is both methodological and empirical. We quantify the accessibility changes before- and after the first wave of school closure/consolidations implemented in Hamilton, a mid-size city (\~570,000 pop) with rural, suburban and urban characteristics in Ontario, Canada [@governmentofcanadaProfileTableCensus2022]. 

In 2013, the City of Hamilton's largest English school board the Hamilton-Wentworth District School Board (HWDSB), serving the majority of students in the city, released their Long Term Facilities Master Plan [@hwdsbLongTermFacilities2013]. To ensure "equitable, affordable and sustainable learning facilities", the Master Plan indicated that 80% of it's elementary schools (i.e., schools attended by students aged 5 to 13) would be subject to accommodation strategies, including a "Accommodation Review" whose outcome is possibly closure/consolidation [@hwdsbLongTermFacilities2013; @craggsBoardEvaluatingFuture2013; @seasonsSchoolClosurePolicy2014]. These decisions were in part motivated by operational savings based on a projected reduction in student population and under-utilized school capacity [@craggsAxeCouldFall2012]. However, the case of Hamilton and the HWDSB is unlike others in the province: the HWDSB underwent an unprecedented number of Accommodation Reviews relative to other school boards [@seasons2014ARCCatalogues2014]. Though the Accommodation Review guidelines outline a community-focused process to deliberate a school's future viability to students, the community and the economy [@seasonsSchoolClosurePolicy2014; @ministryofeducationPupilAccommodationReview2006], concerned residences felt a fulsome breakdown of costs to repair schools were not made consistently available [@kleinhuisSeriousConcernsSchool2013]. Further, others pointed to flaud incentive structures motivating the HWDSB: "By closing three schools the HWDSB would have a strong case with the Ministry of Education to receive full funding for a new school" [@kleinhuisSeriousConcernsSchool2013]. Along with insufficient funding to maintain schools in a state of good repair [@auditorgeneralofontarioAnnualReport20152015], the operational savings as a case for school closures is a long-standing critique of the school "funding formula" established by the conservative provincial government in 1998 [@mackenzieBlueprintFixOntario2018]. In a backdrop of budget cuts, the funding formula pits financing of school maintenance and student needs against the financial compensation of staff and powers of local school boards (as they no longer have the ability to levee property taxes) [@mackenzieBlueprintFixOntario2018].

In the first wave of school accommodation reviews between 2013 and 2016, `r ALL_SCHOOLS_Elem %>% filter(Year == "2011" & Level == "Elementary" & Status == "Removed") %>% pull(SchoolID) %>% length()` elementary schools closed. From between 2011 (before the school closures) to 2016, these closures represented a `r ((ALL_SCHOOLS_Elem %>% filter(Year != "2016") %>% pull(SchoolID) %>% length() - ALL_SCHOOLS_Elem %>% filter(Year != "2011") %>% pull(SchoolID) %>% length())/ALL_SCHOOLS_Elem %>% filter(Year != "2016" & Level == "Elementary") %>% pull(SchoolID) %>% length()) %>% scales::percent()` and `r  (( ((avail_2011 |> group_by(SchoolID) |> summarize(OTGC = first(OTGC2011)) |> select(OTGC) |> sum())) - (avail_2016 |> group_by(SchoolID) |> summarize(OTGC = first(OTGC2016)) |> select(OTGC) |> sum())) / (avail_2016 |> group_by(SchoolID) |> summarize(OTGC = first(OTGC2016)) |> select(OTGC) |> sum()) ) |> scales::percent()` decline in elementary school locations and capacity, respectively, across the city though overall student population and households in the city did not significantly change between 2011 and 2016 ( `r avail_2011$kid_popadj %>% sum(na.rm=T) %>% prettyNum(big.mark=",")` (2011) and `r avail_2016$kid_popadj %>% sum(na.rm=T) %>% prettyNum(big.mark=",")` (2016)). 

From the perspective of public money no longer spent as a result of reduced school operational costs, who and in what way does the Hamilton community pay for these savings by means of accessibility and accessibility-related impacts? In this paper, we hypothesize that that this policy negatively impacted the trips-to-school for many students in addition to decreasing potential active-trip opportunities and increasing emissions. Spatial availability, a singly-constrained competitive accessibility measure [@soukhovIntroducingSpatialAvailability2023; @soukhovMultimodalSpatialAvailability2024], is used to quantify the before- and after- accessibility and associated impacts for the city of Hamilton and the elementary school-aged student population as a result of a province-wide school closure and consolidation policy.

This paper contributes the following: how does the (1) spatial availability, (2) loss in walk minutes and (3) associated carbon emissions change for home-to-school trips after a city closes and consolidates schools? Further, this work examines what communities, based on low-income prevalence, experienced the greatest losses as a result of this policy. The methods introduced in this paper can be used by decision-makers to evaluate the spatial and transport-related impacts of public service provision policy.

The remainder of the paper is organized as follows. Section 2 details the data and methods, particularly multimodal spatial availability, a singly-constrained competitive accessibility measure that considers demand for school-seats by students and friction of distance, as well associated data sources for the inputs into spatial availability. Section 3 showcases the results of the impact that the school consolidation policy had on Hamilton's school spatial availability landscape. Section 4 discusses the results and estimates potential walk minutes lost, where trip-related GHG emissions may have increased, and equity implications for the policy. Section 5 concludes the paper with key remarks. Furthermore, to increase the diffusion of this analysis, all work is completed in a R environment and all associated code and data will be open and reproducible within the lead author's [GitHub repository](https://github.com/soukhova).

# Data and Methods

Our focus is to evaluate the impact that the school consolidations between 2011 and 2016 had on the multimodal school spatial availability and travel-related GHG emission landscape of the city of Hamilton. 

To facilitate comparison, two scenarios are generated. The first and second reflect estimated as-is conditions in 2011 and 2016 assuming the respective school configurations, average student population and low-income prevalence of households, residential parcel locations, and estimated modal travel times in both years. The difference between these scenarios are quantified in terms of accessibility, emission and equity implications and discussed in context with the school consolidation policy.

Data is retrieved at different spatial granularity from the following six data sources.

## Schools 

**Firstly**, schools and associated school catchments are retrieve from the school boards. In Hamilton, the majority of student-aged population attends a school in one of the two English public school boards. One board is referred to as *public* (i.e., Hamilton Wentworth District School Board (HWDSB)) in our work and the other is referred to as *public-catholic* (Hamilton Wentworth Catholic District School Board (HWCDSB)). These catchments indicate what residential property is assigned to what school, by default. Families can decide to attend schools out of catchment, in fact 21%-23% <!--calculated in 03-travel-times-TTS.qmd--> of motorized Hamilton-based Hamilton school trips are out of catchment according to the regional travel survey, the Transportation Tomorrow Survey (TTS) in 2011 and 2016 [@data_management_group_tts_2018]. The elementary school locations and catchments are provided by the HWDSB and HWCDSB for the 2010-2011 and 2015-2016 academic years and visualised in @fig-Fig1.

Formally, elementary schools are defined as schools that provide instruction to any combination of grades between kindergarten to grade 8 (i.e. typically children aged 5 to 14). As such, elementary includes middle schools that only instruct grades 6 to 8 (*Mid*), primary schools which only instruct kindergarten to grade 5 or 6 (*JrElem*), and all grade elementary schools (*Elem*) which instruct all grades from kindergarten to grade 8.  The maximum number of students that may be enrolled in a school is calculated by the provincial Ministry of Education; this value is referred to as the on-the-ground capacity (*OTGC*) and is assigned to each school. The current/historic OTGC province-wide has been made publicly unavailable [@ontarioSchoolFacilityInventory2017]. However, for schools that underwent the full Accommodation Review process, the OTGC for a given year can be scraped from the generated publicly available School Information Profiles. A regression model was derived to estimate the OTGC for schools with no OTGC based on 1) the school's footprint (*F*) in units of (`m^2`), 2) school's shortest Euclidean distance from the centroid of Hamilton's central business district area (*DistCBD*) defined in units of (m), and 3) coefficients associated with a binary variable indicating the type of school grade instruction (*Mid*, *JrElem*, *Elem*). The building footprint from an archived spatial data set [@DMTI_Spatial_2015] and the 2016 footprints were retrieved from OSM [@OpenStreetMap_2021]. The center of the CBD is defined as a significant intersection in Hamilton Downtown Business Improvement Area [@Hamilton_2014]. This point serves as a pseudo-proxy for age of school construction as the oldest buildings are located within the Hamilton Downtown boundary [@Merrall_2021] and the age of schools is unavailable.

Equation (\ref{eq:OTGC-public}) and (\ref{eq:OTGC-catholic}) describes the estimated OTGC for public schools and catholic schools respectively. School status and OTGC summed by catchment is also visualised in @fig-Fig1. See the Table \ref{Tab:TabA1} in the Appendix for the associated regression results.

```{=tex}
\begin{equation}
\label{eq:OTGC-public}
OTGC_{Public} = F^{0.346}-e^{0.00003*DistCBD}+e^{3.123*JrElem_b}+e^{3.752*Elem_b}+ e^{3.068*Mid_b}
\end{equation}
```
```{=tex}
\begin{equation}
\label{eq:OTGC-catholic}
OTGC_{Catholic} =F^{0.471}-e^{0.00003*DistCBD}+e^{2.333*Elem_b}
\end{equation}
```

```{r}
#| label: fig-Fig1
#| fig-cap: "The school catchments, estimated on the ground capacities of schools summed per catchment, and school status for both public and public catholic school boards for year 2011 and 2016. OTGC is presented by quartiles."
#| echo: false

knitr::include_graphics(paste0(here::here(),"/Figures/catchment_schools_plot.png"))
```

## Students, residential locations and low-income prevelance
Secondly, student population and proportion of household low-income after tax (LIM-AT) prevalence is retrieved from the 2011 and 2016 Canadian Census [@Statistics_Canada_2011; @Statistics_Canada_2016]. The census releases population data by age group category and as pertinent to this paper, 5 to 9 year olds and 10 to 14 year olds. As more relevant to this paper, the LIM-AT prevelance for households with children under 18 (there is no LIM-AT prevelance tabulated for households with exclusively elementary aged children) is retrained. LIM-AT is refers to the proportion of private households that are below the median after-tax income [@governmentofcanadaDictionaryCensusPopulation2017]. These census variables are taken at the finest spatial unit of analysis disseminated by the Canadian census publicly available, the spatial dissemination area (DA). They are retrieved using the {cancensus} R package [@von_Bergmann_Shkolnik_Jacobs_2021]. DAs are designed by Statistics Canada with the aim of population uniformity hence DAs greatly vary in area but represent between approximately 400 and 700 (1st and 3rd quartile) in total population. The population aged 5 to 14 and the proportion of LIM-AT are visualised in the first and last row in @fig-Fig2.

Thirdly, centroids of residential parcels in 2011 and 2016 are used to represent residential locations [@Teranet_2009]. There are 134,340 and 139,467 residential locations in 2011 and 2016 respectively, representing `r cen_data_2011_hamiltononly$DA_households |> sum() |> prettyNum(big.mark = ",")` and `r cen_data_2016_hamiltononly$DA_households |> sum() |> prettyNum(big.mark = ",")` households (according to the Canadian Census [@Statistics_Canada_2011; @Statistics_Canada_2016]). As the number of children per residential location is unavailable publicly, the average number of 5 to 14 year olds for each DA is divided by the number of residential households in that DA. Then the potential number of children at each residential location is calculated by multiplying this DA rate. As the [@Teranet_2009] dataset is proprietary, the the middle row in @fig-Fig2 visualises an aggregation of the information: the average rate of 5-14 year olds per residential household at the DA level. 

```{r}
#| label: fig-Fig2
#| fig-cap: "The magnitude (top row) and rate per residential unit (middle row) of elementary aged student population per DA in 2011 and 2016. The proportion of low-income households with children under 18 years old is also shown (bottom row). All scales are represented in quartiles."
#| echo: false

knitr::include_graphics(paste0(here::here(),"/Figures/stud_pop_rate_LIM_plot.png"))
```

## Estimated travel times and emissions 

The fourth data source is an estimated travel time matrices from all residential locations to all elementary schools for both motorized (car) and non-motorized (walking) travel. The travel times are estimated using the R-package {r5r} [@Pereira2021r5r], a package that interfaces with the java-based R5 routing engine developed separately by Conveyal [@conveyalConveyalR5Routing2022]. For both modes, the inputs assume a maximum travel time threshold of 60 minutes and the free-flow OpenStreetMap road network of Hamilton (retrieved using Geofabrick [@geofabrikOntarioOpenStreetMapGeofabrik2022] and manually edited to only include the Hamilton boundary). Further, walk travel times that are only less than 27 min minutes were retained. This travel time is approximately equivalent to 1.6 km which is the minimum distance that is required from a school within-catchment to qualify for a school bus [@HWDSB_2019]. <!--put in statistics here-->

It is assumed that children can go to any elementary school, but certain schools are more likely to be attended depending on their proximity to their residential location. Based on this assumption, the fifth data source is empirical data regarding the mode-used and origin-destination locations of home-to-school trips from the 2011 and 2016 TTS [@data_management_group_tts_2018]. The TTS is representative travel survey conducted in the Greater Golden Horseshoe Area in Ontario every 5 years. The trip-level travel data extract for this paper represent `r od_trips_perc_2011$TAZOrig_car_trips |> sum() |> prettyNum(big.mark = ",")` and `r od_trips_perc_2016$TAZOrig_car_trips |> sum() |> prettyNum(big.mark = ",")` motorized trips (mode used includes private care passenger, school bus, taxi, and transit) and `r od_trips_perc_2011$TAZOrig_walk_trips |> sum() |> prettyNum(big.mark = ",")` and `r od_trips_perc_2016$TAZOrig_walk_trips |> sum() |> prettyNum(big.mark = ",")` non-motorized trips (mode used includes walk and cycling) for 5 to 13 year olds from home to school in 2011 and 2016 respectively. Data is available at the spatial resolution of Traffic Analysis Zones (TAZ). TAZ are spatial units created for the purpose of the TTS; a few DAs typically nest within each TAZ. {r5r} is used to estimated motorized and non-motorized travel from all TAZ centroids to all TAZ centroids and these estimated travel times are tied to the OD trips. The travel times and the intensity of modal home-to-school flows are visualised in @fig-Fig3 along with the boundaries of the TAZ and DAs. As can be seen in @fig-Fig3, not all TAZ capture an elementary school trip by both modes. For this reason, the proportion of modal-split is aggregated at the community level. Hamilton (Ancaster `r community_car_perc_2011$TAZOrig_car_perc[1] |> percent()`-`r community_car_perc_2016$TAZOrig_car_perc[1] |> percent()`, Dundas `r community_car_perc_2011$TAZOrig_car_perc[2] |> percent()`-`r community_car_perc_2016$TAZOrig_car_perc[2] |> percent()`, Flamborough `r community_car_perc_2011$TAZOrig_car_perc[3] |> percent()`-`r community_car_perc_2016$TAZOrig_car_perc[3] |> percent()`, Glanbrook `r community_car_perc_2011$TAZOrig_car_perc[4] |> percent()`-`r community_car_perc_2016$TAZOrig_car_perc[4] |> percent()`, Hamilton Central `r community_car_perc_2011$TAZOrig_car_perc[5] |> percent()`-`r community_car_perc_2016$TAZOrig_car_perc[5] |> percent()`, and Stoney Creek `r community_car_perc_2011$TAZOrig_car_perc[6] |> percent()`-`r community_car_perc_2016$TAZOrig_car_perc[6] |> percent()`).

```{r}
#| label: fig-Fig3
#| fig-cap: "The origin-destination flows from home-based motorized and non-motorized school trips for students between 5-13 years old as retrieved from TTS 2011 and 2016 mapped atop proportion of TAZ non/motorized modal share, DA boundaries, and community boundaries."
#| echo: false

knitr::include_graphics(paste0(here::here(),"/Figures/OD_flow_plot.png"))
```
Furthermore, as a sixth data source, an estimated travel time matrix for walk and car travel modes is calculated using {r5r} and the geographical centroids of the TTS origin-destination flows.  For both modes, the inputs assume a maximum travel time threshold of 60 minutes and the free-flow OpenStreetMap road network of Hamilton [@geofabrikOntarioOpenStreetMapGeofabrik2022]. The walk travel times are filtered to only include travel times under 27 minutes. These travel time matrices along with the origin-destination flows are used to create modal trip length distribution (TLD) functions. A TLD is a useful technique to calibrate impedance functions as they are a representation of the likelihood that a proportion of trips are taken at a specific travel cost [@horbachov_theoretical_2018; @batista_estimation_2019]. The empirical TLD is fit to a density distribution using maximum likelihood and moment matching techniques and the Nelder-Mead and Brent methods for direct optimization available within the {fitdistrplus} R package [@fitdistrplus_2015]. Based on goodness-of-fit criteria and diagnostics (included in Appendix), the gamma and exponential distribution is selected for the motorized and non-motorized modal distributions respectively. The gamma distribution is defined by the shape ($\alpha$) parameter of `r round(gamma2011_motor$estimate[1], 3)` (2011) and `r round(gamma2016_motor$estimate[1], 3)` (2016) and the rate ($\beta$) of `r round(gamma2011_motor$estimate[2], 3)` (2011) and `r round(gamma2016_motor$estimate[2], 3)` (2016). The exponential distribution is defined by the rate ($\beta$) parameter of `r round(exp2011_nonmotor$estimate[1], 3)` (2011) and `r round(exp2016_nonmotor$estimate[1], 3)` (2016). The TLDs for the motorized and non-motorized trips are shown in @fig-Fig4.

```{r}
#| label: fig-Fig4
#| fig-cap: "Empirical and theoretical motorized and non-motorized impedance functions."
#| echo: false

knitr::include_graphics(paste0(here::here(),"/Figures/TLD_empirical_wtheo_curve_plot.png"))
```

The sixth and final data source relates to motorized GHG well-to-wheel estimations. It assumed that all non-motorized trips produce no emissions and those that are motorized take the average emission factor of 0.1 kg CO2e per minute travel. This emission factor is assumed base on an average speed of 40 km/h, the 2,380 g $CO_{2}e$ produced when 1 L of gasoline is combusted and an internal combustion engine passenger vehicle fuel efficiency of 7 g/100km as discussed in @soukhovOccupancyGHGEmissions2022.

## Putting it all together: multimodal spatial availability

Accessibility is defined as "access to opportunities" or the "potential for spatial interaction". It is classically presented as the gravity-based measure popularized by @hansenHowAccessibilityShapes1959 and takes the following general multi-modal formulation (Equation (\ref{eq:multi-modal-conventional-accessibility})):
```{=tex}
\begin{equation}
\label{eq:multi-modal-conventional-accessibility}
S_i^m = \sum_{j=1}^JO_j \cdot f^m(c_{ij}^m)
\end{equation}
```
\noindent where:

-   $m$ is a set of modes.
-   $c_{ij}^m$ is a measure of the cost of moving between $i$ and $j$ for each $m$.
-   $f^m(\cdot)$ is an impedance function of $c_{ij}^m$ for each $m$; it can take the form of any monotonically decreasing function chosen based on positive or normative criteria [@paez2012measuring].
-   $i$ is a set of origin locations ($i = 1,\cdots,N$).
-   $j$ is a set of destination locations ($j = 1,\cdots,J$).
-   $O_j$ is the number of opportunities at location $j$.
-   $S$ is Hansen-type accessibility as weighted sum of opportunities.

As indicators of urban structure, Hansen-type measures are informative, but the meaning of 10,000 accessible school-seats is harder to pin down: how many opportunities must any single student have access to? Furthermore, in scenario comparisons, the interpretation of the percentage change in accessible school-seats is unclear. The interpretability of Hansen-type accessibility has been discussed in numerous studies, including recently by @hu_2019_measuring, @kelobonye2020measuring, and in greater depth by @merlin2017competition along with @soukhovIntroducingSpatialAvailability2023 and @soukhovMultimodalSpatialAvailability2024. The interpretation of accessibility is suggested to depend on how many people demand the opportunity, especially for exclusive opportunity-types like schools-seats (i.e., one school-seat is for one student).

In this paper, we benefit from new development in accessibility research, particularly the multimodal spatial availability measure [@soukhovIntroducingSpatialAvailability2023; @soukhovMultimodalSpatialAvailability2024]. Spatial availability is a singly-constrained accessibility measure that accounts for competition by students using different modes for exclusive opportunities, such as school seats. The measure’s single constraint ensures that the marginals at the destination are met and thus the number of estimated school seats (opportunities) are preserved and allocated proportionally to the mode-using student population. This proportional allocation of opportunities yields an interpretable and meaningful measure of opportunity access, particularly when comparing across modes, at the spatial resolution of a residential parcel, and multiple time periods. See @soukhovMultimodalSpatialAvailability2024 for further discussion, multimodal spatial availability  $V_{i}^m$ is defined as given by Equation (\ref{eq:spatial-availability}).

```{=tex}
\begin{equation}
\label{eq:spatial-availability}
V_{i}^{m} = \sum_{j=1}^J O_j\ F^{tm}_{ij}
\end{equation}
```
\noindent where:

-   $F^{tm}_{ij}$ is a balancing factor that depends on the population and cost of movement in the system as part of the gravity modelling framework and is captured in Equation (\ref{eq:balancing-factors}) for mode $m$.
-   $O_j$ is the number of opportunities at $j$.
-   $V_i^m$ is the number of spatially available opportunities from the perspective of $i$ for mode $m$.

$F^{tm}_{ij}$ can be understood as the joint probability of allocating opportunities, where $F^{pm}_{i}$ is the population-based balancing factor that grants a larger share of opportunities to larger $m$ population spatial units and $F^{cm}_{ij}$ is the impedance-based balancing factor that grants a larger share of the opportunities to less $m$-travel costly centers. Together $F^{tm}_{ij}$ ensures proportional allocation such that opportunities $O$ (like school-seats) are preserved for the whole region (i.e., $O = \sum_{j} O_j = \sum_{i} V_i = \sum_{m}\sum_{i} V_i^m$ ) and is reflected in Equation (\ref{eq:balancing-factors}):

```{=tex}
\begin{equation}
\label{eq:balancing-factors}
F^{tm}_{ij} = \frac{F^{pm}_{i} \cdot F^{cm}_{ij}}{\sum_{i} F^{pm}_{i} \cdot F^{cm}_{ij}}
\end{equation}
```
\noindent where:

- The factor for allocation by population for each $m$ at each $i$ is $F^{pm}_{i} = \frac{P_{i}^m}{\sum_{m}\sum_{i} P_{i}^m}$
- The factor for allocation by travel cost for each $m$ at each $i$ and $j$ is $F^{cm}_{ij} = \frac{f^m(c^m_{ij})}{\sum_{m}\sum_{i} f^m(c^m_{ij})}$

It should be noted, that the population-based allocation factors $F^{pm}_{i}$ when summed over all spatial units in the region always equals to 1 (i.e., $\sum_{m}\sum_{i} F^{pm}_{i}= 1$), likewise for impedance-based allocation factors $F^{cm}_{i}$ (i.e., $\sum_{m}\sum_{i} F^{cm}_{ij} = 1$).

Hansen-type accessibility is not designed to preserve the number of opportunities in the region, it simply counts the potential opportunities that those in a zone can interact with (weighted by the friction of distance). Also as discussed in @soukhovIntroducingSpatialAvailability2023, popular competitive accessibility measure such as the 2SFCA [@shenLocationCharacteristicsInnercity1998;@luoMeasuresSpatialAccessibility2003] ends up preserving the number of opportunities in the analysis region but the definitions of variables are internally obscured; the only way it preserves the number of opportunities is if the effect of the impedance function is ignored when expanding the values of opportunities per capita to obtain the total number of opportunities. On the other hand, the proportional allocation procedure associated with calculating multi-modal spatial availability $V_i^m$ consistently returns a number of opportunities available to all mode-using populations that matches the total number of opportunities in the region when summed. As a result of this consistency, it is possible to define a measure of multimodal spatial availability per capita ($P$) as presented in Equation (\ref{eq:SA-per-capita}) for use as a benchmark to compare against the regional opportunities per capita ($\frac{\sum_{j} O_j}{\sum_{i} P_i}$).

```{=tex}
\begin{equation}
\label{eq:SA-per-capita}
v_i^m = \frac{V_i^m}{P_i^m}
\end{equation}
```

For the reasons outlined, this paper uses the multimodal spatial availability $V_i^m$ and spatial availability per student $v_i^m$ measures to quantify accessibility changes. 

- First, all residential locations are associated to their respective census DA, TTS TAZ and community boundary (@fig-Fig3) based on spatial location. Each residential location is assigned a number of 'potential' motorized and non-motorized student aged population from these different data sources to calculate a motorized and non-motorized population balancing factor $F_{i}^{pm}$. For each residential location the following is retained: the 2011 and 2016 census average elementary-aged student population per residential location (@fig-Fig2 second row) and the average motorized and non-motorized split as informed by the TTS aggregated by community (@fig-Fig3).
- Second, the school capacity $O_j$ is estimated and associated with each school (@fig-Fig1). All residential locations are assumed to be able to access all schools by either motorized or non-motorized mode. All origins (residential locations) can reach all schools by motorized mode, but few residential locations can reach schools within a 27 minute non-motorized trip. 
- Third, the motorized and non-motorized impedance-balancing factors $F_{ij}^{cm}$ are calculated using the modal theoretical TLDs (@fig-Fig4) based on the respective travel times (data source four) for each origin (residential location) to school combination. 
- Finally, outputs from all three stages are joined together. $F_{i}^{pm}$ joined with $F_{ij}^{cm}$ yields the total balancing factor $F^{tm}_{ij}$ which serves to proportionally allocates the school capacity $O_j$ to each residential location. The value is multimodal spatial availability $V_i^m$ which can be interpreted as the number of school-seats that are available to the mode-using population at that residential location. $V_i^m$ is then summed and represented at the DA and Community level along with the calculated $v_i^m$ for interpretation.

# Results

```{r}
#| label: fig-Fig6
#| fig-cap: "Multimodal spatial availability (greys) and spatial availability per mode-using student (diverging reds and greens) aggregated at the level of DA for 2011 and 2016."
#| echo: false

knitr::include_graphics(paste0(here::here(),"/Figures/Vim_vvim_20112016_plot.png"))
```

The motorized and non-motorized spatial availability $V_i$ for both 2011 and 2016 is represented in the top half of @fig-Fig6. Though at different magnitudes, both populations using non- and motorized modes have higher spatial availability when more proximate to schools. Hence, all DAs have higher values within Hamilton Central and those more proximate to schools in less-urban communities. Trends appear similar for both 2011 and 2016: proximate populations using motorized modes benefit from a wider-range in high spatial availability than non-motorized modes. When $V_im$ is divided by the number of mode-using students in that DA, $v_i^m$ is derived (bottom half of @fig-Fig6). A similar spatial distribution seen in $V_i^m$ can be seen in $v_i^m$ plots, but as a rate of student population. If our aim is to provide sufficient availability to schools for both motorized and non-motorized populations (i.e., greater than 1.0 $v_i^m$ school-seat availability per student), this rate is only achieved in the core of the city for motorized modes, and notably only for non-motorized populations in DAs that are in less-densely populated rural areas that are school proximate and certain pockets of Hamilton Central. The majority of schools closed were within Hamilton Central, so non-motorized populations in DAs within Hamilton Central were the most negatively, and certain motorized populations captured these losses as gains in availability. 

```{r}
#| label: fig-Fig7
#| fig-cap: "Change in multimodal spatial availability and spatial availability per mode-using student between 2016 and 2011 at the level of DA of the 2016 Canadian Census."
#| echo: false

knitr::include_graphics(paste0(here::here(),"/Figures/Vim_vvim_20112016_CHANGE_plot.png"))
```

To emphasize how spatial availability changed between 2016 and 2011, the change in $V_i^m$ and $v_i^m$ is visualised for both modes in @fig-Fig7. Overall, a decrease in both $V_i^m$ and $v_i^m$ can be seen both modes modes around closed schools (black points). An increase near new or expanded schools (green points) is not as noteable as overall fewer school seats were added relative to population increase. The non-motorized mode-using populations are most impacted by the school closures/consolidations along with other competition factors such as increased children population in less urban areas and an increase in motorized mode use. For non-motorzied mode-using populations, $V_i^m$ decreases across the city. However, some motorized-mode using populations in DAs do experience an increase in $V_i^m$: these DAs are often relatively proximate to schools but more immediately outside walking-range. Under a competitive and constraint calculation, these DAs benefit from the losses in spatial availability that are predominately experienced by the non-motorized populations within Hamilton Central. 

<!--Maybe worth adding a plot of GHG emissions or change in tt?-->

# Discussion

<!--This will be a table with summaries of LIMAT, Kid pop, V_im change, v_im change, total travel time change, and emission changed by community and mode? We shoudl discuss to decide what's the best presentation.-->
```{r}
# SAvail_im_COMM_changes |> filter(mode == "motorized") |> st_drop_geometry() |> 
#   dplyr::select(c("COMMUNITY",
#                   "prev_LIMAT_2016", 
#                   "c_kid_perc", 
#                   "c_V_im_perc", 
#                   "c_v_im_perc", 
#                   "emissions_2011",
#                   "emissions_2016"
#                   #"c_emissions_perc",
#                   # "emissions_perkid_2011",
#                   # "emissions_perkid_2016",
#                   #"c_emissions_perkid_perc" 
#                   )) |> arrange(desc(prev_LIMAT_2016)) 
```

```{r include=FALSE}
SAvail_im_COMM_changes |> st_drop_geometry() |> 
  dplyr::select(c("COMMUNITY",
                  "prev_LIMAT_2016", #prevalance of LIM after-tax for households with children under 18
                  "mode", 
                  "kid_proportion_2016", #the proportion of children 5-14 age, sums to 100%
                  "c_kid_proportion_perc", #the % change in proportion between 2016-2011 i.e. (2016-2011)/2011, negative means decrease
                  "V_im_proportion_2016",  #the proportion of V_im, sums to 100%
                  "c_V_im_proportion_perc", #the % change in proportion between 2016-2011 i.e. (2016-2011)/2011, negative means decrease
                  "v_im_2016", #the proportion of V_im (in community) /kid_population (in community) = v_im, sums to 100%
                  "c_v_im_perc", #the % change in proportion between 2016-2011 i.e. (2016-2011)/2011, negative means decrease
                  "total_tt_2016", #summed travel time (kid_pop at each household * travel time of mode, summed for the community). Values sums to 100%
                  "c_total_tt_perc",  #the % change in proportion between 2016-2011 i.e. (2016-2011)/2011, negative means decrease
                  "emissions_perkid_2016", #summed motorized travel time * 0.1 g/min (kid_pop at each household * travel time of mode, summed for the community). Values sums to 100%
                  "c_emissions_perkid_perc"  #the % change in proportion between 2016-2011 i.e. (2016-2011)/2011, negative means decrease
  ))
```

Spatial availability can also be summarized by community. The majority of schools were closed in Hamilton Center, this community represents `r SAvail_im_COMM_changes |> st_drop_geometry() |> filter(COMMUNITY == "HA") |> dplyr::select("kid_proportion_2016") |> sum() |> scales::percent()` of the 5-14 year old population in 2016. Though the population between 2011 and 2016 decreased, the rate of school-seat spatial availability decreased disproportionately more (population by `r SAvail_im_COMM_changes |> st_drop_geometry() |> filter(COMMUNITY == "HA") |> transmute(calc = ((sum(kid_2016)-sum(kid_2011))/sum(kid_2011)) |> scales::percent()) |> first()` and spatial availability by `r `r SAvail_im_COMM_changes |> st_drop_geometry() |> filter(COMMUNITY == "HA") |> transmute(calc = ((sum(V_im_2016)-sum(V_im_2011))/sum(V_im_2011)) |> scales::percent())  |> first()`). This out of proportion decrease is greatest in Hamilton Central than any other community. This may have grave equity concerns as Hamilton Central has the highest LIM-AT prevalence, with `r SAvail_im_COMM_changes |> st_drop_geometry() |> filter(COMMUNITY == "HA" & mode == "motorized") |> dplyr::select("prev_LIMAT_2016") |> round() |> paste0("%")` of households LIM-AT in 2016, 3.7 times greater than Glanbrook with the lowest level of LIM-AT prevalence. Between 2016 and 2011, Hamilton Center had the lowest levels of emissions per student and saw the highest per student increase in 2016. Hamilton Center had the highest non-motorized trip potential, and it was reduced in part by the school closure policies.

Conversely, communities with the lowest LIM-AT benefit the most, notably in gains to motorized spatial availability. Glanbrook, Flamborough and Ancaster have the lowest prevalence of LIM-AT of any Hamilton Community and together account for `r SAvail_im_COMM_changes |> st_drop_geometry() |> filter(COMMUNITY == "FL" | COMMUNITY == "GL" | COMMUNITY == "AN") |> dplyr::select("kid_proportion_2016") |> sum() |> scales::percent()` of the 5-14 year old population in 2016. These communities experienced a growth in student population (or only a small decrease) and proportionally benefited from an increase in motorized spatial availability. 

Across the city, those who commute by non-motorized mode suffer from the most dramatic drop in student population and especially spatial availability across the city. In all communities, spatial availability decreases at greater levels than population. Notably, in Dundas (2nd highest LIM-AT), the only school in the community closed leaving the population in the community with no other option but to use motorized modes. Glanbrook (lowest LIM-AT), which experienced a sharp increase in student population along with non-motorized using population, suffered a lose in non-motorized spatial availability despite seeing the highest increase in motorized spatial availability. Overall, the gain in motorized spatial availability resulted in a further erosion of non-motorized spatial availability. This erosion results in a lose in active transport trips and an increase in emissions city-wide (`r SAvail_im_COMM_changes |> st_drop_geometry() |> transmute(em = (sum(emissions_2011))/(sum(kid_2011)) ) |> sum() |> round(digit=2)`kg CO2e per student in 2011 to `r SAvail_im_COMM_changes |> st_drop_geometry() |> transmute(em = (sum(emissions_2016))/(sum(kid_2016)) ) |> sum() |> round(digit=2)` in 2016). 

<!-- develop further?-->
Study limitations:

- potential students per households, potential trips to all schools
- estimated travel times, direct car or walk trip (shortest path). Not necessarily car, could be transit or school bus. Walking shortest-paths are also optimistic for children's travel: could be unsafe and not taken in reality and/or alternative more pleasant paths are taken.
- estimated emissions. GHG emissions per minute of driving varies extensively depending on operating conditions and vehicle characteristics [@soukhovOccupancyGHGEmissions2022].

<!-- Add an additional paper: discuss the potential impact of mode-switching on GHG emissions reductions [@pantelakiImpactHomeschoolCommuting2024].

Also, access to schools has broader implications; it has a relationship to residential and job choices [@pietrabissaSchoolAccessCity2023] and housing prices [@merrallWhatSchoolWorth2023]-->

# Concluding remarks

In this paper, we estimate the change in multimodal spatial availability as a result of school consolidations/closures between the years of 2011 and 2016 in an empirical case study of Hamilton, a mid-size city (\~550,000 pop) in Ontario, Canada. The spatial availability and spatial availability per student are visualized on a DA level; spatial availability for the city declined overall. This decline is then discussed by measuring potential walk minutes and GHG emissions (produced by additional car minutes that result since walk minutes are removed). Overall, the closure of `r ((ALL_SCHOOLS_Elem %>% filter(Year != "2016" & Level == "Elementary") %>% pull(SchoolID) %>% length() - ALL_SCHOOLS_Elem %>% filter(Year != "2011" & Level == "Elementary") %>% pull(SchoolID) %>% length())/ALL_SCHOOLS_Elem %>% filter(Year != "2016" & Level == "Elementary") %>% pull(SchoolID) %>% length()) %>% scales::percent()` of elementary schools in Hamilton resulted in: a `r (ALL_SCHOOLS_Elem %>% st_drop_geometry() %>% filter( (Year == "2011" | Year == "2011 and 2016") & Level == "Elementary") %>% dplyr::select(OTGC2011) %>% sum() - ALL_SCHOOLS_Elem %>% st_drop_geometry() %>% filter( (Year == "2016" | Year == "2011 and 2016") & Level == "Elementary") %>% dplyr::select(OTGC2016) %>% sum()) %>% prettyNum(big.mark=",", digits=1)` decline of school-seat capacity, a decline of `r SAvail_im_COMM_changes |> st_drop_geometry() |> filter(mode == "non-motorized") |> transmute(total_tt = total_tt_2016-total_tt_2011) |> sum() %>% abs() %>% prettyNum(big.mark=",", digits=1)` *potential* home-to-school walk-minutes (per one-way trips), an increase of `r SAvail_im_COMM_changes |> st_drop_geometry() |> filter(mode == "motorized") |> transmute(emissions = emissions_2016-emissions_2011) |> sum() %>% abs() %>% prettyNum(big.mark=",", digits=1)` kg CO2e as a result of increased car-minutes as a result of lost *potential* home-to-school walk-minutes (per one-way trips).

By quantifying the spatial availability, environmental, and active-travel implications of school closure/consolidation policies in Hamilton, we offer a methodology for spatial policy analysis scenario. This methodology can be used by researchers and decision-makers to plan and evaluate equitable and sustainable urban planning policies from a spatial perspective. We urge policy makers to view 'spatial availability' of public resources from a per-capita perspective, plan capacity and location of service provision with the cost of travel (and associated implications such as GHG emissions, active transportation mode, safety of active travel modes, etc.) that sufficiently serves the target population. In this paper we suggest and assume a benchmark of 1.0 school-seats per student which accounts for sufficy. Spatial availability can be used to obtain this benchmark since the total number of opportunities (i.e., school capacity) is preserved in the region of analysis unlike unconstrained forms of accessibility measurement e.g., Hansen-type measure [@hansenHowAccessibilityShapes1959]. As such, the assigned spatial availability can be divided by population at each zone to yield an interpretable per capita measurement.

Like many other localities, Hamilton is not immune to top-down financial efficient policy decisions to determine community infrastructure is underutilized and it be closed. From the perspective of the provincial government of Ontario, the school closures which occurred in Hamilton resulted in operational savings-per-student but we demonstrate how this resulted in both families and students paying a price through spatial availability, lost potential walk minutes, and increased GHG emissions. In the case of Hamilton Central, where households have the highest prevalence of LIM-AT in the city, those households suffer the most disproportionate decrease in motorized spatial availability and increase in percentage increase in emissions per capacity. As public schools should serve all students; the determination of spatial availability and spatial equity of impact, is critical to better inform decision-makers when evaluating school consolidation policies.

Ultimately, this case study furnishes evidence that consolidation of schools was particularly ill-timed: with the advent of the COVID-19 pandemic, the education system lacked the resiliency to accommodate reduced classroom capacities and left parents who once lived within active transportation distance to schools relying on motorized transportation for their children. These top-down austerity measures left the Hamilton local school system more vulnerable to the impacts of COVID-19 by undervaluing the societal role of schools in neighbourhoods. By identifying the impact of school consolidation policies in Ontario we anticipate that researchers and decision-makers will have better information to center the wellbeing of all residents, including students, and the planet in urban planning policies.  

# Appendix

The regression model for the OTGC for schools goes here.

# References


